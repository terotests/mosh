(function(){var t={},n=function(){!function(t){var n,e,i,r,o,a;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.after=function(t,n,e){e||(e="aft7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="t7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){a=1,this.polyfill();var t,s;if("undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var c=0,f=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var s=0;s<o.length;s++){var u=o[s];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.remove?h.nextTime>0?(h.fn(),delete r[l]):h.nextTime=a+h.step:(h.fn(),h.nextTime=a+h.step)),h.until&&h.until<a&&delete r[l]}t(f),c=a};f(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"later"},e.prototype=new n;var i=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,i,r,o,a;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){return t?(n||(n={}),n[t]?n[t]:void(n[t]=this)):void 0}),t._initLogRefresh=function(t){if("undefined"!=typeof global&&"undefined"!=typeof process&&!o){r||(r=require("fs"));var n=t.logFileRefresh||60;o=!0;var a=this;e().every(n,function(){r.readFile(t.logSettingsFile,"utf8",function(t,n){if(!t)try{var e=JSON.parse(n);if(e&&e.enable)for(var r in e.enable)e.enable.hasOwnProperty(r)&&(i[r]=e.enable[r]);if(e)for(var r in e)if(e.hasOwnProperty(r)){if("enable"==r)continue;a._options[r]=e[r]}}catch(o){}})})}},t.addMetrics=function(t,n){if(i[this._tag]){var e=this._metrics[t];e||(e=this._metrics[t]={cnt:0,latest:n,min:n,max:n,total:0}),n=1*n,isNaN(n)||(e.cnt++,e.total+=n,e.latest=n,e.max<n&&(e.max=n),e.min>n&&(e.min=n),e.avg=e.total/e.cnt)}},t.enable=function(t){if(t&&t)for(var n in t)t.hasOwnProperty(n)&&(i[n]=t[n])},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){n=n||{},this._tag=t,this._log=[],a||(a={}),this._options=a,"undefined"!=typeof global&&"undefined"!=typeof process&&(this._isNode=!0);for(var o in n)"enable"!=o&&n.hasOwnProperty(o)&&(a[o]=n[o]);if(n.logInterval=n.logInterval||1,n.metricsInterval=n.metricsInterval||10,this._metrics={},i||(i={}),n.enable)for(var o in n.enable)n.enable.hasOwnProperty(o)&&(i[o]=n.enable[o]);n.logSettingsFile&&this._initLogRefresh(n);var s=this,c=function(){if(i[s._tag]&&0!=s._log.length){if(s._options.logFile&&s._isNode){r||(r=require("fs"));var t="",n=(new Date).toISOString();t+=n,s._log.forEach(function(e,i){i>0&&(t+="\n"+n),e.forEach(function(n,e){return e>0&&(t+=","),s.isObject(n)?void(t+="[Object]"):s.isArray(n)?void(t+="[Array]"):void(t+=JSON.stringify(n))})}),t+="\n",r.appendFile(s._options.logFile,t,function(){})}if(s._options.console){if(!console.group)return console.log("--- "+s._tag+" ----- "),s._log.forEach(function(t){1==t.length&&console.log(t[0]),2==t.length&&console.log(t[0],t[1]),3==t.length&&console.log(t[0],t[1],t[2]),4==t.length&&console.log(t[0],t[1],t[2],t[3])}),void(s._log.length=0);console.group(s._tag),s._log.forEach(function(t){1==t.length&&console.log(t[0]),2==t.length&&console.log(t[0],t[1]),3==t.length&&console.log(t[0],t[1],t[2]),4==t.length&&console.log(t[0],t[1],t[2],t[3])}),console.groupEnd()}s._log.length=0}},f=function(){if(i[s._tag]&&s._options.console){if(s._logMemoryCnt&&s._logMemoryCnt>0&&(s._logMemoryCnt--,process&&process.memoryUsage)){var t=(require("util"),process.memoryUsage());s.value("rss",t.rss),s.value("heapTotal",t.heapTotal),s.value("heapUsed",t.heapUsed),s.value("heapUsage",parseInt(100*t.heapUsed/t.heapTotal)),s.value("fromTotalGb",parseFloat(100*t.heapTotal/1073741824).toFixed(2))}if(console&&console.group)console.group("Metrics"),console.table(s._metrics,["cnt","latest","min","max","avg"]),console.groupEnd();else{var n=0;for(var e in s._metrics){n++,1==n&&console.log("=== node.js METRICS ===");var t=s._metrics[e];console.log(e,t.cnt,t.latest,t.min,t.max,t.avg)}}}};e().every(n.logInterval,c),e().every(n.metricsInterval,f)}),t.log=function(){if(i[this._tag]){for(var t=[],n=0;n<arguments.length;n++)t.push(arguments[n]);this._log.push(t)}},t.recordHeap=function(t){this._logMemoryCnt=t},t.settings=function(t){if(t&&t)for(var n in t)t.hasOwnProperty(n)&&(i[n]=t[n])},t.value=function(t,n){this.addMetrics(t,n)}}(this)},r=function(t,n,e,i,o,a,s,c){var f,u=this;if(!(u instanceof r))return new r(t,n,e,i,o,a,s,c);var l=[t,n,e,i,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=r._classInfo.name)return new f(t,n,e,i,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};r._classInfo={name:"lokki"},r.prototype=new i,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.lokki=r,this.lokki=r):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.lokki=r:this.lokki=r}.call(new Function("return this")());var o=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},a=function(t,n,e,i,r,o,s,c){var f,u=this;if(!(u instanceof a))return new a(t,n,e,i,r,o,s,c);var l=[t,n,e,i,r,o,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=a._classInfo.name)return new f(t,n,e,i,r,o,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};a._classInfo={name:"lokkiLoki"},a.prototype=new o,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.lokkiLoki=a,this.lokkiLoki=a):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.lokkiLoki=a:this.lokkiLoki=a}.call(new Function("return this")());var s=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},c=function(t,n,e,i,r,o,a,s){var f,u=this;if(!(u instanceof c))return new c(t,n,e,i,r,o,a,s);var l=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=c._classInfo.name)return new f(t,n,e,i,r,o,a,s)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};c._classInfo={name:"testFs"},c.prototype=new s,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.testFs=c,this.testFs=c):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.testFs=c:this.testFs=c}.call(new Function("return this")());var f=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.pwFilesystem=function(){var t={groups:{},domains:{},users:{"505d18cbea690d03eb240729299468071c9f133758b6c527e2dddd458de2ad36":"ee8f858602fabad8e7f30372a4d910ab875b869d52d9206c0257d59678ba6031:id1:",dce8981dec48df66ed7b139dfd1a680aa1d404a006264f24fda9e0e598c1ac8a:"add2bbda7947ab86c2e9f277ccee254611bedd1e3b8542113ea36931c1fdbf3e:id2:"},udata:{id1:'{"userName":"Tero","domain":"","hash":"505d18cbea690d03eb240729299468071c9f133758b6c527e2dddd458de2ad36","groups":["users","admins"]}',id2:'{"userName":"Juha","domain":"","hash":"dce8981dec48df66ed7b139dfd1a680aa1d404a006264f24fda9e0e598c1ac8a","groups":["users"]}'}},n=_n("pwServer1",t);return n},t.serverSetup1=function(t){var n=h(),e={data:{path:"M22.441,28.181c-0.419,0-0.835-0.132-1.189-0.392l-5.751-4.247L9.75,27.789c-0.354,0.26-0.771,0.392-1.189,0.392c-0.412,0-0.824-0.128-1.175-0.384c-0.707-0.511-1-1.422-0.723-2.25l2.26-6.783l-5.815-4.158c-0.71-0.509-1.009-1.416-0.74-2.246c0.268-0.826,1.037-1.382,1.904-1.382c0.004,0,0.01,0,0.014,0l7.15,0.056l2.157-6.816c0.262-0.831,1.035-1.397,1.906-1.397s1.645,0.566,1.906,1.397l2.155,6.816l7.15-0.056c0.004,0,0.01,0,0.015,0c0.867,0,1.636,0.556,1.903,1.382c0.271,0.831-0.028,1.737-0.739,2.246l-5.815,4.158l2.263,6.783c0.276,0.826-0.017,1.737-0.721,2.25C23.268,28.053,22.854,28.181,22.441,28.181L22.441,28.181z",fill:"red",stroke:"black",sub:{data:{value1:"abba"},__id:"sub1"}},__id:"id1",__acl:"A:g:users@:rwx\nA:g:admins@:rwxadtTnNcCy"};t&&t.data&&(e.data=t.data);var i={my:{channel:{"journal.1":"","file.2":JSON.stringify(e),"journal.2":JSON.stringify([4,"fill","yellow","red","id1"])+"\n","ch.settings":JSON.stringify({version:2,channelId:"my/channel",journalLine:1,utc:14839287897}),forks:JSON.stringify({fromJournalLine:1,version:1,channelId:"my/channel/myFork",fromVersion:2,from:"my/channel",to:"my/channel/myFork",name:"test of fork",utc:14839287897}),myFork:{"journal.1":JSON.stringify([4,"fill","blue","yellow","id1"])+"\n","ch.settings":JSON.stringify({fromJournalLine:1,version:1,channelId:"my/channel/myFork",fromVersion:2,from:"my/channel",to:"my/channel/myFork",journalLine:1,name:"test of fork",utc:14839287897})}}}};t&&t.fileSystemData&&(i=t.fileSystemData);var r=_n("memoryServer1",i),o={groups:{},domains:{},users:{"505d18cbea690d03eb240729299468071c9f133758b6c527e2dddd458de2ad36":"ee8f858602fabad8e7f30372a4d910ab875b869d52d9206c0257d59678ba6031:id1:",dce8981dec48df66ed7b139dfd1a680aa1d404a006264f24fda9e0e598c1ac8a:"add2bbda7947ab86c2e9f277ccee254611bedd1e3b8542113ea36931c1fdbf3e:id2:"},udata:{id1:'{"userName":"Tero","domain":"","hash":"505d18cbea690d03eb240729299468071c9f133758b6c527e2dddd458de2ad36","groups":["users","admins"]}',id2:'{"userName":"Juha","domain":"","hash":"dce8981dec48df66ed7b139dfd1a680aa1d404a006264f24fda9e0e598c1ac8a","groups":["users"]}'}},a=_n("passWordServer",o);return a.then(function(){return r}).then(function(){var t=a.getRootFolder(),e=tn(t),i=r.getRootFolder(),o=B("http://localhost",1234),s=P(o,r.getRootFolder(),e);n.resolve({server:o,manager:s,fsRoot:i,auth:e,pwRoot:t})}),n},t.testFilesystem1=function(){({my:{channel:{"journal.1":"","file.2":JSON.stringify({data:{path:"M22.441,28.181c-0.419,0-0.835-0.132-1.189-0.392l-5.751-4.247L9.75,27.789c-0.354,0.26-0.771,0.392-1.189,0.392c-0.412,0-0.824-0.128-1.175-0.384c-0.707-0.511-1-1.422-0.723-2.25l2.26-6.783l-5.815-4.158c-0.71-0.509-1.009-1.416-0.74-2.246c0.268-0.826,1.037-1.382,1.904-1.382c0.004,0,0.01,0,0.014,0l7.15,0.056l2.157-6.816c0.262-0.831,1.035-1.397,1.906-1.397s1.645,0.566,1.906,1.397l2.155,6.816l7.15-0.056c0.004,0,0.01,0,0.015,0c0.867,0,1.636,0.556,1.903,1.382c0.271,0.831-0.028,1.737-0.739,2.246l-5.815,4.158l2.263,6.783c0.276,0.826-0.017,1.737-0.721,2.25C23.268,28.053,22.854,28.181,22.441,28.181L22.441,28.181z",fill:"red"},__id:"id1",__acl:"A:g:users@:rwx\nA:g:admins@:rwxadtTnNcCy"}),"journal.2":JSON.stringify([4,"fill","yellow","red","id1"])+"\n","ch.settings":JSON.stringify({version:2,channelId:"my/channel",journalLine:1,utc:14839287897}),forks:JSON.stringify({fromJournalLine:1,version:1,channelId:"my/channel/myFork",fromVersion:2,from:"my/channel",to:"my/channel/myFork",name:"test of fork",utc:14839287897}),myFork:{"journal.1":JSON.stringify([4,"fill","blue","yellow","id1"])+"\n","ch.settings":JSON.stringify({fromJournalLine:1,version:1,channelId:"my/channel/myFork",fromVersion:2,from:"my/channel",to:"my/channel/myFork",name:"test of fork",utc:14839287897})}}}})}}(this)},u=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof u))return new u(t,n,e,i,r,o,a,s);var l=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,l)}),"function"==typeof c){if(c._classInfo.name!=u._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};u._classInfo={name:"channelTesting"},u.prototype=new f,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.channelTesting=u,this.channelTesting=u):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.channelTesting=u:this.channelTesting=u}.call(new Function("return this")());var n=function(){!function(t){var n,e,i,r,o,a;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.after=function(t,n,e){e||(e="aft7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="t7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){a=1,this.polyfill();var t,s;if("undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var c=0,f=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var s=0;s<o.length;s++){var u=o[s];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.remove?h.nextTime>0?(h.fn(),delete r[l]):h.nextTime=a+h.step:(h.fn(),h.nextTime=a+h.step)),h.until&&h.until<a&&delete r[l]}t(f),c=a};f(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"later"},e.prototype=new n;var l=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,r=[],o=new Array(e);return this.then(function(){var t=h();return 0==n.length&&t.resolve([]),n.forEach(function(n,a){n.then?(r.push(n),n.then(function(n){o[a]=n,i++,i==e&&t.resolve(o)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var r=i.length,o=!1,a=!1,s=0,c=[],f=e||{};return this.then(function(){var n=h();return i.forEach(function(e){e.then?(c.push(e),e.then(function(e){s++,o=t(e,f),(o&&!a||0==a&&r==s)&&(n.resolve(f),a=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.genPlugin=function(t,n){this.plugin(t,function(){var t=Array.prototype.slice.call(arguments,0);console.log("Plugin args",t);var e=h();return this.then(function(){var i=Array.prototype.slice.call(arguments,0),r=t.concat(i),o=n.apply(this,r);e.resolve(o)},function(t){e.reject(t)}),e})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){console.log("--- calling the onFulfilled "),t(function(t){i.resolve(t)},function(t){i.resolve(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.nodeStyle=function(t,n){this.plugin(t,function(){var t,e,i=Array.prototype.slice.call(arguments,0),r=0;i.length>=0&&(t=i[i.length-1],"[object Function]"==Object.prototype.toString.call(t)&&(e=t,r=i.length-1));var o=wishes().pending();return this.then(function(){var t=wishes().pending(),a=Array.prototype.slice.call(arguments,0);console.log("Orig args",i),console.log("Then args",a);var s;0==i.length&&(s=a),0==a.length&&(s=i),s||(s=a.concat(i)),r=s.length,e&&r--,s[r]=function(n){if(n)return console.log("Got error ",n),t.reject(n),void o.reject(n);if(e){var i=Array.prototype.slice.call(arguments),r=e.apply(this,i);o.resolve(r)}else{var i=Array.prototype.slice.call(arguments,1);o.resolve.apply(o,i)}},t.then(function(t){o.resolve(t)}),console.log("nodeStyle after concat",s);n.apply(this,s);return t},function(t){o.reject(t)}),o})},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.plugin=function(n,e){return t[n]=e,this},t.props=function(t){var n=[];for(var e in t)t.hasOwnProperty(e)&&n.push({name:e,promise:t[e]});var i=n.length,r=0,o=[],a={};return this.then(function(){var t=wishes().pending();return n.forEach(function(n){var e=n.promise,s=n.name;e.then?(o.push(e),e.then(function(n){a[s]=n,r++,r==i&&t.resolve(a)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new h(t,n),r=this;return 1==this._state&&e().asap(function(){r.fulfill(r.value())}),2==this._state&&ater().asap(function(){r.reject(r.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},h=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof h))return new h(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};h._classInfo={name:"_promise"},h.prototype=new l;var n=function(){!function(t){var n,e,i,r,o,a;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.after=function(t,n,e){e||(e="aft7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="t7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){a=1,this.polyfill();var t,s;if("undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var c=0,f=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var s=0;s<o.length;s++){var u=o[s];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.remove?h.nextTime>0?(h.fn(),delete r[l]):h.nextTime=a+h.step:(h.fn(),h.nextTime=a+h.step)),h.until&&h.until<a&&delete r[l]}t(f),c=a};f(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"later"},e.prototype=new n;var l=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,r=[],o=new Array(e);return this.then(function(){var t=h();return 0==n.length&&t.resolve([]),n.forEach(function(n,a){n.then?(r.push(n),n.then(function(n){o[a]=n,i++,i==e&&t.resolve(o)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var r=i.length,o=!1,a=!1,s=0,c=[],f=e||{};return this.then(function(){var n=h();return i.forEach(function(e){e.then?(c.push(e),e.then(function(e){s++,o=t(e,f),(o&&!a||0==a&&r==s)&&(n.resolve(f),a=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.genPlugin=function(t,n){this.plugin(t,function(){var t=Array.prototype.slice.call(arguments,0);console.log("Plugin args",t);var e=h();return this.then(function(){var i=Array.prototype.slice.call(arguments,0),r=t.concat(i),o=n.apply(this,r);e.resolve(o)},function(t){e.reject(t)}),e})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){console.log("--- calling the onFulfilled "),t(function(t){i.resolve(t)},function(t){i.resolve(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.nodeStyle=function(t,n){this.plugin(t,function(){var t,e,i=Array.prototype.slice.call(arguments,0),r=0;i.length>=0&&(t=i[i.length-1],"[object Function]"==Object.prototype.toString.call(t)&&(e=t,r=i.length-1));var o=wishes().pending();return this.then(function(){var t=wishes().pending(),a=Array.prototype.slice.call(arguments,0);console.log("Orig args",i),console.log("Then args",a);var s;0==i.length&&(s=a),0==a.length&&(s=i),s||(s=a.concat(i)),r=s.length,e&&r--,s[r]=function(n){if(n)return console.log("Got error ",n),t.reject(n),void o.reject(n);if(e){var i=Array.prototype.slice.call(arguments),r=e.apply(this,i);o.resolve(r)}else{var i=Array.prototype.slice.call(arguments,1);o.resolve.apply(o,i)}},t.then(function(t){o.resolve(t)}),console.log("nodeStyle after concat",s);n.apply(this,s);return t},function(t){o.reject(t)}),o})},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.plugin=function(n,e){return t[n]=e,this},t.props=function(t){var n=[];for(var e in t)t.hasOwnProperty(e)&&n.push({name:e,promise:t[e]});var i=n.length,r=0,o=[],a={};return this.then(function(){var t=wishes().pending();return n.forEach(function(n){var e=n.promise,s=n.name;e.then?(o.push(e),e.then(function(n){a[s]=n,r++,r==i&&t.resolve(a)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new h(t,n),r=this;return 1==this._state&&e().asap(function(){r.fulfill(r.value())}),2==this._state&&ater().asap(function(){r.reject(r.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},h=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof h))return new h(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};h._classInfo={name:"_promise"},h.prototype=new l;var n=function(){!function(t){var n,e,i,r,o,a;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.after=function(t,n,e){e||(e="aft7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="t7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){a=1,this.polyfill();var t,s;if("undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var c=0,f=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var s=0;s<o.length;s++){var u=o[s];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.remove?h.nextTime>0?(h.fn(),delete r[l]):h.nextTime=a+h.step:(h.fn(),h.nextTime=a+h.step)),h.until&&h.until<a&&delete r[l]}t(f),c=a};f(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"later"},e.prototype=new n;var _=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)
},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t===!1&&e?void 0:(n||(n={}),n[t]?n[t]:void(n[t]=this))}),t.addCommands=function(t,n){if(this.isArray(t)){var e=this;return t.forEach(function(t){e.addCommands(t)}),this}this._commands.push({fnCmd:t,fnFail:n,async:!0})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._commands||(this._commands=[],this.waitingList=[],this._index=0);var i=this;n||e().every(1/30,function(){i.step()})}),t.step=function(){var t=this._index,n=this._commands.length;if(t!=n){for(var e=h(),i=e,r=h(),o=this;n>t;){var a=this._commands[t];!function(t){i=i.then(function(){var n=h();return t.fnCmd(function(){n.resolve(!0)},function(e){n.resolve(!0),t.fnFail&&t.fnFail(e)}),n}).fail(function(n){t.fnFail&&t.fnFail(n)})}(a),this._index++,t++}return i.then(function(){if(o.waitingList.shift(),r.resolve(!0),o.waitingList.length){var t=o.waitingList[0];t.resolve(!0)}}).fail(function(){}),this.waitingList.push(e),1==this.waitingList.length&&e.resolve(!0),r}}}(this)},d=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof d))return new d(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=d._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};d._classInfo={name:"sequenceStepper"},d.prototype=new _;var p=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){t.cont=function(t){if(this.isArray(t)){var n=this,e=this._list.slice(this._index+1);if(0==e.length)return void this.step();var i=[];t.forEach(function(t){var e=n._list.slice(n._index+1),r=y(n);n._subStreams.push(r),r.addObserver(e),i.push(r.pushValue(t))});var r=h();r.all(i).then(function(){var t=[];n._subStreams.length=0,i.forEach(function(n){t.push(n.value())}),n.resolve(t)}),r.resolve(!0)}else"undefined"!=typeof t&&(this._context.value=t),this.step()},t.ctxVar=function(t,n){if("undefined"==typeof n){var e=this._contextVars[t];return"undefined"==typeof e&&this._parent?this._parent.ctxVar(t):e}this._contextVars[t]=n},t.get=function(t){if(this._closure){var n=this._contextVars[t];return"undefined"==typeof n?this._parent.get(t):n}var n=this._contextVars[t];return"undefined"==typeof n&&this._parent?this._parent.get(t):n},t.getRest=function(){},t.getState=function(){return this._stopState},t.getValue=function(){return!this._context&&this._parent?this._parent.getValue():this._context&&!this._context.value&&!this._context.initWith&&this._parent?this._parent.getValue():this._context.value||this._context.initWith},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._context={},this._contextVars={},this._subStreams=[],this._stopState=0,t&&(this._parent=t),n&&(this._closure=!0)}),t.killAll=function(){this._subStreams&&this._subStreams.forEach(function(t){t.killAll()})},t.run=function(t){if(this._closure){if(this._parent)return void this._parent.run(t);console.error("No parent for closure")}this._stopState=1,this.cont(t)},t.set=function(t,n){if("undefined"!=typeof n){if(this._closure)if("undefined"!=typeof this._contextVars[t])this._contextVars[t]=n;else if(this._parent)return this._parent.set(t,n),this;return"undefined"==typeof this._contextVars[t]&&this._parent?(this._parent.set(t,n),this):(this._contextVars[t]=n,this)}},t.setContext=function(t){this._context=t},t.setParent=function(t){this._parent=t},t.start=function(t){this._list=t,this._index=-1,this.step()},t.step=function(){this._index++;var t=this._index;if(this._list[t]){var n=this._list[t];this.isObject(n)&&!this.isFunction(n)?n.closure?(n.closure.setParent(this),n.fn.apply(n.closure,[n.closure])):n.fn.apply(this,[this]):n.apply(this,[this])}else"undefined"==typeof this._context.value&&(this._context.value=this._context.initWith),this._stopState<2&&(this._stopState=7),this.resolve(this._context.value)},t.stopStream=function(){this._context.value||(this._context.value=this._context.initWith),this._stopState=3,this.resolve(this._context.value)}}(this)},v=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof v))return new v(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=v._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};p.prototype=h.prototype,v._classInfo={name:"streamProcessor"},v.prototype=new p;var m=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){var n;t.addObserver=function(t,n){if(this.isArray(t)){var e=this;return void t.forEach(function(t){e.addObserver(t,n)})}return this.isObject(t)&&!this.isFunction(t)?void this._observers.push(t):(this._observers.push({fn:t,closure:n}),this)},t.branch=function(t,n){var e=this,i=(new Date).getTime();return e._lastBranch=i,this.addObserver(function(r){var o=((new Date).getTime(),r.getValue());setTimeout(function(){var a=(new Date).getTime();if(!(n>a-i)){var s=0;(s=e.isActiveRunning())||(r=e.getLastProcess(),3==r.getState()&&(e._lastBranch=a,i=a,t(o)))}},n),r.run()}),this},t.branchIfOk=function(t,n){var e=this,i=(new Date).getTime();return e._lastBranch=i,this.addObserver(function(r){var o=((new Date).getTime(),r.getValue());setTimeout(function(){var a=(new Date).getTime();if(!(n>a-i)){var s=0;(s=e.isActiveRunning())||(r=e.getLastProcess(),7==r.getState()&&(e._lastBranch=a,i=a,t(o)))}},n),r.run()}),this},t.collectValuesFor=function(t){var n=this,e=(new Date).getTime();return n._lastBranch=e,this.addObserver(function(i){(new Date).getTime(),i.getValue();setTimeout(function(){var r=(new Date).getTime();if(!(t>r-e)){var o=n.isActiveRunning(),a=n.getLastProcess();return o>1&&i!=a?void i.stopStream(i.getValue()):void a.run()}},t)}),this},t.combineLatest=function(t){var n=this,e=[],i=t.length,r=function(){for(var t=!0,n=0;i>n;n++)"undefined"==typeof e[n]&&(t=!1);return t};return t.forEach(function(t,i){t.addObserver(function(t){e[i]=t.getValue(),r()&&n.pushValue(e),t.run()})}),this},t.filter=function(t){var n=this;return this.addObserver(function(e){var i=e.getValue(),r=[];return n.isArray(i)?(i.forEach(function(n){t(n)&&r.push(n)}),void(r.length?e.run(r):e.stopStream())):t(i)?void e.run(i):void e.stopStream()}),this},t.forContext=function(t){var n=this;n.addObserver(function(e){var i=e.getValue(),r=[];n.isArray(i)?i.forEach(function(n,i){r.push(t(n,i,e))}):r.push(t(i,0,e)),e.run(i)})},t.forEach=function(t){var n=this;return n.addObserver(function(e){var i=e.getValue(),r=[];n.isArray(i)?i.forEach(function(n){r.push(t(n))}):r.push(t(i)),e.run(i)}),this},t.getLastProcess=function(){var t=this._active.length;return t>0?this._active[t-1]:this._lastProcess},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t){this._childIndex=0,this._childStreams=[],this._values=[],this._active=[],this._lastProcess,this._observers=[],this._id=this.guid(),n||(n={}),n[this._id]=this,t&&(this._parentProcessor=t)}),t.isActiveRunning=function(){return this._active.length},t.killAll=function(){this._active.forEach(function(t){t.killAll(),t.stopStream()})},t.map=function(t){var n=this;return n.addObserver(function(e){var i=e.getValue(),r=[];n.isArray(i)?i.forEach(function(n){r.push(t(n))}):r.push(t(i)),e.run(r)}),this},t.pushValue=function(t){var n=h();return this.startProcess({initWith:t},n),n},t.reduce=function(t,n){var e=this;return e.addObserver(function(i){var r=i.getValue(),o=[];o=e.isArray(r)?r.reduce(t,n):[r].reduce(t,n),i.run(o)}),this},t.startProcess=function(t,n){var e=this._observers.slice(),i=v(this._parentProcessor);i.setContext(t),i.start(e),i._streamPromise=n,this._active.push(i);var r=this;i.then(function(t){var e=r._active.indexOf(i);r._active.splice(e,1),n.resolve(t),r._lastProcess=i})},t.step=function(){}}(this)},y=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof y))return new y(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=y._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};y._classInfo={name:"simpleStream"},y.prototype=new m;var g=function(){!function(t){var n,e,i;t.__dataTr=function(){},t._collectObject=function(t,n,e){this.isArray(n)||(n=n.split(","));var i={};n.forEach(function(n){i[n]=t[n](),t.on(n,function(){i[n]=t[n](),e(i)})}),e(i)},t._forMembers=function(t){var n=this;if(this.isArray())for(var e=0;e<this._data.length;e++){var i=this._data[e];this.isObject(i)&&i.__dataTr&&t(i)}else this._members.forEach(function(e){n[e]&&t(n[e])})},t._initializeData=function(t,n){if(t){this._data=t.data,this._docData=t;var e=this._client.getChannelData(),i=this._client._idToNs(this._docData.__id,this._client._ns);e.createWorker("_to_ch",[7,"*",null,null,i],{target:this}),e.createWorker("_to_ch",[5,"*",null,null,i],{target:this}),e.createWorker("_d_set",[4,"*",null,null,i],{target:this}),e.createWorker("_d_rem",[8,"*",null,null,i],{target:this}),e.createWorker("_d_ins",[7,"*",null,null,i],{target:this}),e.createWorker("_d_mv",[12,"*",null,null,i],{target:this}),e.createWorker("_d_cf",[5,"*",null,null,i],{obj:this}),e.createWorker("_d_cf",[4,"*",null,null,i],{obj:this});var r=t.data;if(r instanceof Array)for(var o in r)this[o]=I(r[o],n,this._client);else for(var o in r)if(r.hasOwnProperty(o)){var a=r[o];if(this.isFunction(a))continue;if(!this.isFunction(a)&&(a===Object(a)||a instanceof Array)){this[o]=new I(a,n,this._client);continue}this.isFunction(a)||this.isObject(a)||this.isArray(a)||this[o]||this.createPropertyUpdateFn(o,a)}}},t._objectCreateCmds=function(t,n){if(n||(n=[]),this.isObject(t)&&t.data)if(this.isArray(t.data)){n.push([2,t.__id,"",null,t.__id]);for(var e=0;e<t.data.length;e++){var i=t.data[e];if(this.isObject(i)){this._objectCreateCmds(i,n);var r=[7,e,i.__id,null,t.__id];n.push(r)}}}else{n.push([1,t.__id,"",null,t.__id]);for(var o in t.data)if(t.data.hasOwnProperty(o)){var a=t.data[o];if(this.isObject(a)){this._objectCreateCmds(a,n);var r=[5,o,a.__id,null,t.__id];n.push(r)}else{var r=[4,o,a,null,t.__id];n.push(r)}}}return n},t._parseURL=function(t){var n=t.split("://"),e=n.shift(),i=n.shift(),r=i.split("/"),o=r.shift(),a=o.split(":"),s=a[0],c=a[1],f=r.shift(),u=r.pop(),l=r.join("/");return{url:t,ip:s,port:c,sandbox:f,path:l,file:u,protocol:e}},t._reGuidRawData=function(t){if(this.isArray(t)){var n=this;t.forEach(function(t){n._reGuidRawData(t)})}else if(this.isObject(t))for(var e in t)t.hasOwnProperty(e)&&("__id"!=e?(this.isObject(t[e])&&this._reGuidRawData(t[e]),this.isArray(t[e])&&this._reGuidRawData(t[e])):t[e]=this.guid())},t._wrapToData=function(t){var n;if(t.__id&&t.data)n=t;else var n={data:t,__id:this.guid()};if(n.data&&this.isObject(n.data))for(var e in n.data)if("__oid"!=e){if(n.data.hasOwnProperty(e)){var i=n.data[e];if(this.isFunction(i))continue;this.isObject(i)&&(n.data[e]=this._wrapToData(i))}}else delete n.data[e];return n},t.addController=function(){console.error("** askChannelQuestion ** not implemented now ")},t.askChannelQuestion=function(){console.error("** askChannelQuestion ** not implemented now ")},t.at=function(t){var n=this._docData.data[t];return n?I(n,null,this._client):void 0},t.clear=function(){for(var t=this.length();t--;)this.pop()},t.clone=function(){return I(this.serialize())},t.copyToData=function(){var t=this.toData();return this._reGuidRawData(t),t},t.createArrayField=function(t,n){return this.set(this._docData.__id,t,n)},t.createField=function(t,n){return this.set(t,n||""),this},t.createObjectField=function(t,n){return this.set(this._docData.__id,t,n)},t.createPropertyUpdateFn=function(n,i){if(this.isObject(i)||this.isObject(this._docData.data[n]))return void(this[n]=I(i,null,this._client));t[n]||(t[n]=function(t){return"undefined"==typeof t?this._client.get(this._docData.__id,n):(this._client.set(this._docData.__id,n,t),this)},e[n]=!0)},t.createWorker=function(t,n,e,r){n[4]=this._client._idToNs(n[4],this._client._ns);var o=this._client.getChannelData();if(o.createWorker(t,n,e),r&&(i||(i={}),!i[t])){var a={};a[t]=r,o.setWorkerCommands(a),i[t]=!0}return this},t.emitValue=function(t,n){if(this._processingEmit)return this;if(this._processingEmit=!0,this._controllers)for(var e=0,i=0;i<this._controllers.length;i++){var r=this._controllers[i];r[t]&&(r[t](n),e++)}this._valueFn&&this._valueFn[t]&&this._valueFn[t].forEach(function(t){t(n)}),this._parent&&this._parent.emitValue&&this._parent.emitValue(t,n),this._processingEmit=!1},t.extendWith=function(n){for(var e in n){var i=n[e];this.isFunction(i)&&(t[e]=i)}},t.find=function(){return console.error("*** FIND IS NOT IMPLEMENTED *** "),null},t.forEach=function(t){this._docData.data.forEach(function(n){t(I(n))})},t.get=function(t){return this._client.get(this._docData.__id,t)},t.getData=function(t){if(this._docData)var n=this._client._fetch(this._docData.__id);else{if(!this._client)return;var n=this._client.getData()}if(t){var e=JSON.parse(JSON.stringify(n));n=this._client._transformObjFromNs(e)}return n},t.getID=function(){return this._docData.__id},t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.hasOwn=function(t){return"undefined"!=typeof this._docData.data[t]&&this[t]?!0:!1},t.indexOf=function(){return this._client.indexOf(this._docData.__id)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={},e={})}),t.insertAt=function(t,n){return this.push(n,t)},t.isArray=function(t){return"undefined"==typeof t?this._docData&&this._docData.data?this.isArray(this._docData.data):!1:"[object Array]"===Object.prototype.toString.call(t)},t.isDataTrait=function(t){return t._docData?!0:void 0},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this._docData&&this._docData.data?this.isObject(this._docData.data):!1:t===Object(t)},t.item=function(t){return this.at(t)},t.keys=function(t){for(var n in this._docData.data)this._docData.data.hasOwnProperty(n)&&t(n,this._docData.data[n],this._docData.data);return this},t.length=function(){return this._docData&&this._docData.data?this._docData.data.length:0},t.moveDown=function(){return this._client.moveDown(this._docData.__id),this},t.moveToIndex=function(t){return this._client.moveTo(this._docData.__id,t),this},t.moveUp=function(){return this._client.moveUp(this._docData.__id),this},t.onValue=function(t,n){this._valueFn||(this._valueFn={}),this._valueFn[t]||(this._valueFn[t]=[]),this._valueFn[t].indexOf(n)<0&&this._valueFn[t].push(n)},t.parent=function(t){if("undefined"!=typeof t)return this;if(this._docData){var t=this._docData.__p;return t?I(t):void 0}},t.pick=function(t){var n=y(),e=this;return this.then(function(){e._collectObject(e,t,function(t){n.pushValue(t)})}),n},t.pop=function(){var t=this.length();if(t){var n=this.at(t-1);return n&&n.remove(),n}},t.push=function(t,n){if(!this.isArray())return this;var e,i=!1;if(t._wrapToData){t=t.getData();var r=this._client._fetch(t.__id);r&&(i=!0)}if(e=t.__id&&t.data?this._client._transformObjToNs(t,this._client._ns):this._wrapToData(t),!i)for(var o=this._objectCreateCmds(e),a=0;a<o.length;a++)this._client.addCommand(o[a]);var s;if("undefined"!=typeof n){s=n;var r=this._client._fetch(this._docData.__id);if(0>s||s>r.data.length)return}else{var r=this._client._fetch(this._docData.__id);s=r.data.length}return this._client.addCommand([7,s,e.__id,null,this._docData.__id]),this},t.redo=function(t){return this._client.redo(t),this},t.redoStep=function(t){return this._client.redoStep(t),this},t.remove=function(){return this._client.remove(this._docData.__id),this},t.removeListener=function(t,n){if(this._events&&this._events[t]){var e=this._events[t].indexOf(n);e>=0&&this._events[t].splice(e,1),0==this._events[t].length&&delete this._events[t]}},t.renderTemplate=function(){console.error("RenderTemplate not implemented")},t.serialize=function(t){var n,e=this._docData.data;n=this.isArray(this._data)?[]:{};for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];if("undefined"==typeof r)continue;if(t&&(this.isObject(r)||this.isArray(r)))continue;n[i]=this.isObject(r)?I(r).serialize():r}return n},t.set=function(t,n){if(this.isFunction(n)){var e=this;return this.then(function(){return e.set(t,n(e.get(t)))}),this}if(this.isObject(n)){var i,r=n;r._wrapToData&&(r=r.getData()),i=r.__id&&r.data?this._client._transformObjToNs(r,this._client._ns):this._wrapToData(r);for(var o=this._objectCreateCmds(i),a=0;a<o.length;a++)this._client.addCommand(o[a]);this._client.setObject(this._docData.__id,t,i);var s=this._client._fetch(i.__id);return this.createPropertyUpdateFn(t,s),this}return this._client.set(this._docData.__id,t,n),this.createPropertyUpdateFn(t,n),this},t.toData=function(){var t=JSON.stringify(this._docData),n=JSON.parse(t);return n.__ctxCmdList&&delete n.__ctxCmdList,n.__cmdList&&delete n.__cmdList,n},t.toPlainData=function(){return this.getChannelData().toPlainData(this._docData)},t.undo=function(t){return this._client.undo(t),this},t.undoStep=function(t){return this._client.undoStep(t),this},t.unset=function(t){return this._client.unset(this._docData.__id,t),this},t.upgradeVersion=function(){return this._client.upgradeVersion(),this}}(this),function(t){var n;t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n=[])}),t.on=function(t,n){this._events||(this._events={}),this._events[t]||(this._events[t]=[]),this._events[t].push(n);var e=this;n._unbindEvent=function(){e.removeListener(t,n)}},t.removeListener=function(t,n){if(this._events&&this._events[t]){var e=this._events[t].indexOf(n);e>=0&&this._events[t].splice(e,1),0==this._events[t].length&&delete this._events[t]}},t.trigger=function(t,e){if(!(n.indexOf(t+this._guid)>=0)&&this._events&&this._events[t]){var i=this._events[t],r=this;n.push(t+this._guid);for(var o=i.length,a=0;o>a;a++)i[a](r,e);var s=n.indexOf(t+this._guid);n.splice(s,1)}}}(this),function(t){t.propWorker=function(t,n,e){return this.createWorker(n,[4,t,null,null,this.getID()],e),this}}(this),function(t){t.bindToReact=function(t,n){this.isArray(t)||(t=t.split(","));var e=this;return t.forEach(function(t){t=t.trim(),t&&e.on(t,function(){setTimeout(function(){n.forceUpdate()},0)})}),this}}(this),function(t){var n;t._es7Observe=function(t,n,e,i){if(!t.getData)return t;var n=t.getData();if(!this.isObject(n)&&!this.isArray(n))return n;var r,o=this,a=t._client.getChannelData(),s=Symbol("_mosh_id_");if(t.isArray()){r=[];for(var c=function(n){var e=!1;n.forEach(function(n){if(!e){if(e=!0,"update"==n.type,"splice"==n.type){n.removed.forEach(function(t){if(t[s])try{var n=t[s],e=I(n);if(e.isFulfilled()){if(!e.parent())return;o._atObserveEvent(!0),e.remove(),o._atObserveEvent(!1)}}catch(i){}});for(var i=n.addedCount,r=n.index;i--;){var a=n.object[r];t.push(a,r),r++}}e=!1}})},f=n.data.length,u=0;f>u;u++){var l=t.at(u);!function(t){r[u]=o._es7Observe(t,null,r,c),r[s]=t.getID()}(l)}a.createWorker("_obs_7",[7,"*",null,null,t.getID()],{target:r,parentObserver:c}),Array.observe(r,c)}else{r={},r[s]=t.getID(),a.createWorker("_obs_8",[8,"*",null,null,t.getID()],{target:e,parentObserver:i}),a.createWorker("_obs_12",[12,"*",null,null,t.getID()],{target:e,parentObserver:i});for(var h in n.data)n.data.hasOwnProperty(h)&&(r[h]=this.isObject(n.data[h])?this._es7Observe(t[h],null,r):n.data[h],a.createWorker("_obs_4",[4,h,null,null,t.getID()],{target:r}));Object.observe(r,function(n){var e=!1;n.forEach(function(n){if(!e){if(e=!0,"add"==n.type){var i=n.object[n.name];t.set(n.name,i)}if("update"==n.type){var i=n.object[n.name];t.set(n.name,i)}"delete"==n.type&&t.unset(n.name),e=!1}})})}return r},t._setBindLock=function(t){n=t},t.toObservable=function(t,n){return this._es7Observe(this,null,t,n)}}(this),function(t){var n,e,i,r,o;t._addFactoryProperty=function(t){n||(n=[]),n.push(t)},t._atObserveEvent=function(t){o=t},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){if(i||(i={}),this.isObject(t)){if(t.data&&t.__id){var r=i[t.__id];if(r)return r}}else if("string"==typeof t){var r=i[t];if(r)return r}if(n&&e)for(var o=0;o<n.length;o++){var a,s=n[o];if(t&&t.data?a=t.data[s]:t&&(a=t[s]),a){var c=e[a];if(c)return c}}}),t._findConnOptions=function(){if(this._connectionOptions)return this._connectionOptions;var t=this.parent();return t?t._findConnOptions():void 0},t._initWorkers=function(){var t=this;if(!r){var n=t._client.getChannelData();n.setWorkerCommands({_obs_4:function(t,n){o||(n.target[t[1]]=t[2])},_obs_7:function(t,n){if(!o){var e=t[1],i=I(t[2]);i.isFulfilled()&&(Array.unobserve(n.target,n.parentObserver),n.target[e]=i.toObservable(n.target,n.parentObserver),Array.observe(n.target,n.parentObserver))}},_obs_8:function(t,n){if(!o){var e=t[1];Array.unobserve(n.target,n.parentObserver),n.target.splice(e,1),Array.observe(n.target,n.parentObserver)}},_obs_12:function(t,n){if(!o){var e=parseInt(t[3]),i=parseInt(t[2]),r=n.target,a=r[e];Array.unobserve(r,n.parentObserver),r.splice(e,1),r.splice(i,0,a),Array.observe(r,n.parentObserver)}},_d_set:function(t,n){n.target.trigger(t[1],t[2])},_d_cf:function(t,n){var e=n.obj;if(4==t[0]&&(e[t[1]]||e.createPropertyUpdateFn(t[1],t[2])),5==t[0]&&!e[t[1]]){var i=e._docData.data[t[1]];i&&e.createPropertyUpdateFn(t[1],i)}},_d_rem:function(t,n){n.target.trigger("remove",t[1])},_to_ch:function(t,n){var e=n.target;if(e._client&&!e._client._isLocal){var i=e._client._fetch(t[2]);i&&I(i,null,e._client)}},_d_ins:function(t,n){n.target.trigger("insert",t[1])},_d_mv:function(t,n){n.target.trigger("move",{itemId:t[1],parentId:t[4],from:t[3],to:t[2]})}}),r=!0}},t._objEventWorker=function(){if(change){if(4==change[0]){var t=_docUp(),n=I();n.createPropertyUpdateFn(change[1],null);var e=t._find(options.modelid);if(e.__undone)return;options&&options.eventObj&&change[3]!=change[2]&&options.eventObj.trigger(change[1],change[2])}if(options2){options=options2}if(5==change[0]){var t=_docUp(),e=t._find(change[2]),i=t._find(change[4]);if(e.__undone)return;if(i.__undone)return;var r=I();if(r.findFromCache(change[4])){var n=I(change[4]),o=I(change[2]),a=change[1];if(!n)return;if(!o)return;n[a]=o}}if(8==change[0]){var t=_docUp(),e=t._find(change[2]);if(e.__undone)return;options.bListenMVC&&options.eventObj&&options.eventObj.trigger("remove",e.__removedAt)}if(7==change[0]){var t=_docUp(),s=t._find(change[4]),c=t._find(change[2]);if(s.__undone)return;if(c.__undone)return;var f=s.data.indexOf(c);options.bListenMVC&&options.eventObj&&options.eventObj.trigger("insert",f)}if(12==change[0]){var t=_docUp(),s=t._find(change[4]),f=parseInt(change[2]),u=s.data.length;if(s.__undone)return;for(var l=0;u>l;l++){var h=s.data[l];if(h.__id==change[1]){targetObj=h;break}}if(targetObj&&targetObj.__undone)return;var _=targetObj.__fromIndex;if(targetObj){var d=parseInt(change[2]);options.bListenMVC&&options.eventObj&&options.eventObj.trigger("move",{from:_,to:d})}}}},t._parseURL=function(t){var n=t.split("://"),e=n.shift(),i=n.shift(),r=i.split("/"),o=r.shift(),a=r.join("/"),s=o.split(":"),c=s[0],f=s[1],u=r.shift(),l=r.pop(),h=r.join("/"),_={protocol:e,ip:c,port:f,sandbox:u,fullPath:a,path:h,file:l};return _},t.addToCache=function(t,n){i||(i={}),t&&(i[t]=n)},t.channel=function(){return this._client},t.createChannel=function(t,n,e){var i=this;return h(function(r){e||(e={}),i._client.createChannel(t,n,e).then(function(n){if(n.result===!1)return void r(n);var e=i._request,o=I(e.protocol+"://"+e.ip+":"+e.port+"/"+t,i._initOptions);o.then(function(){r({result:!0,channel:o})})})})},t.createSubClass=function(t,n,e){var i=e,r=function(t,n,e,i,o,a,s,c){if(!(this instanceof r))return console.log("NOT instance of..."),new r(t,n,e,i,o,a,s,c);console.log("is instance of..."),console.log(this.__traitInit);var f=[t,n,e,i,o,a,s,c];if(this.__factoryClass){var u,l=this;if(this.__factoryClass.forEach(function(t){u=t.apply(l,f)}),"[object Function]"==Object.prototype.toString.call(u)){if(u._classInfo.name!=r._classInfo.name)return new u(t,n,e,i,o,a,s,c)}else if(u)return u}if(this.__traitInit){console.log("Calling the subclass trait init...");var l=this;this.__traitInit.forEach(function(t){t.apply(l,f)})}else"function"==typeof this.init&&this.init.apply(this,f)};return r._classInfo={name:this.guid()},i.prototype=I.prototype,r.prototype=new i,this.registerComponent(n,r),this._addFactoryProperty(t),r},t.diff=function(t){var n=O(),e=n.compareFiles(this.getData(!0),t.getData(!0));return e.cmds},t.disconnect=function(){return this._client&&this._client.disconnect(),this},t.fork=function(t,n){var e=this;return h(function(i){e._client.fork(t,n).then(function(n){if(n.result===!1)return void i(n);var r=e._request,o=I(r.protocol+"://"+r.ip+":"+r.port+"/"+t,e._initOptions);o.then(function(){i({result:!0,fork:o})})})})},t.getChannelClient=function(){return this._client},t.getChannelData=function(){return this._client.getChannelData()},t.getJournal=function(){var t=this.getChannelData();return t._journal.slice()},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){n=n||{};var i=this;if(this._initOptions=n,"string"==typeof t){if(!t.match("://"))return;var r=this._parseURL(t);this._request=r,n.ioLib&&console.log("had ioLib"),this._connectionOptions=n,this._socket=q(r.protocol+"://"+r.ip,r.port,n.ioLib);var o={};n.auth&&(o.auth=n.auth),this._client=L(r.fullPath,this._socket,o),this._client.then(function(t){if(console.log("channel client ready"),t.result===!1)return void i.trigger("login::failed");var n=i._client.getData();i._initializeData(n),i.addToCache(n.__id,i),i._initWorkers(),i.resolve(!0)})}else if(e)e&&!this._client&&(this._client=e),this.isObject(t)&&t.__id&&(this._initializeData(t),this.addToCache(t.__id,this)),i._initWorkers(),this.resolve(!0);else{this.isObject(t)&&!t.__id&&(t=this._wrapToData(t));var a=L(this.guid(),null,{localChannel:!0,localData:t});this._client=a;var i=this;this._client.then(function(){var t=i._client.getData();return t?(i._initializeData(t),i.addToCache(t.__id,i),i._initWorkers(),void i.resolve(!0)):void i.resolve(!0)})}}),t.localFork=function(){var t=this.getData(!0);return I(t)},t.openChannel=function(t){var n=this;return h(function(e){var i=(n._request,I(t,n._findConnOptions()));i.then(function(){e({result:!0,channel:i})})})},t.patch=function(t){var n=this;return t.forEach(function(t){var e=n._client._transformCmdToNs(t);n._client.addCommand(e,!0)}),this},t.playback=function(t){var n=this.getChannelData();return n.playback(t)},t.reconnect=function(){return this._client&&this._client.reconnect(),this},t.registerComponent=function(t,n){e||(e={}),e[t]||(e[t]=n)}}(this)},I=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof I))return new I(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=I._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};g.prototype=h.prototype,I._classInfo={name:"_data"},I.prototype=new g,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._data=I,this._data=I):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._data=I:this._data=I}.call(new Function("return this")());var b=function(){!function(t){t.fromAce=function(t){var n=[];return t.forEach(function(t){var e=t.range;"insertText"==t.action&&n.push([1,e.start.row,e.start.column,e.end.row,e.end.column,t.text]),"removeText"==t.action&&n.push([2,e.start.row,e.start.column,e.end.row,e.end.column,t.text]),"insertLines"==t.action&&n.push([3,e.start.row,e.start.column,e.end.row,e.end.column,t.lines]),"removeLines"==t.action&&n.push([4,e.start.row,e.start.column,e.end.row,e.end.column,t.lines,t.nl])}),n},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.reverse=function(t){var n=[];return t.forEach(function(t){{var e=t.slice();e[1],e[2],e[3],e[4]}return 1==e[0]?(e[0]=2,void n.unshift(e)):2==e[0]?(e[0]=1,void n.unshift(e)):3==e[0]?(e[0]=4,void n.unshift(e)):4==e[0]?(e[0]=3,void n.unshift(e)):void 0}),n},t.runToAce=function(t){var n=[],e=["","insertText","removeText","insertLines","removeLines"];return t.forEach(function(t){var i={action:e[t[0]],range:{start:{row:t[1],column:t[2]},end:{row:t[3],column:t[4]}}};t[0]<3?i.text=t[5]:i.lines=t[5],4==t[0]&&(i.nl=t[6]||"\n"),n.push(i)}),n},t.runToLineObj=function(t,n){n.forEach(function(n){var e=n[1],i=n[2],r=n[3],o=n[4];if(1==n[0])if("\n"==n[5]){var a=t.item(e);if(a){var s=a.text();a.text(s.slice(0,i));var c={text:s.slice(i)||""};t.insertAt(e+1,c)}else t.insertAt(e,{text:""}),t.insertAt(e+1,{text:""})}else{var a=t.item(e);if(a){var s=a.text();a.text(s.slice(0,i)+n[5]+s.slice(i))}else t.insertAt(e,{text:n[5]})}if(2==n[0])if("\n"==n[5]){var f=t.item(e),u=t.item(e+1),l="",h="";f&&(l=f.text()),u&&(h=u.text()),f?f.text(l+h):t.insertAt(e,{text:""}),u&&u.remove()}else{var a=t.item(e),s=a.text();a.text(s.slice(0,i)+s.slice(o))}if(3==n[0])for(var _=r-e,d=0;_>d;d++)t.insertAt(e+d,{text:n[5][d]});if(4==n[0])for(var _=r-e,d=0;_>d;d++){var a=t.item(e);a.remove()}})},t.runToString=function(t,n){if(!n||"undefined"==typeof t)return"";t+="";var e=t.split("\n");return n.forEach(function(t){var n=t[1],i=t[2],r=t[3],o=t[4];if(1==t[0])if("\n"==t[5]){var a=e[n]||"";e[n]=a.slice(0,i);var s=a.slice(i)||"";e.splice(n+1,0,s)}else{var a=e[n]||"";e[n]=a.slice(0,i)+t[5]+a.slice(i)}if(2==t[0])if("\n"==t[5]){var c=e[n]||"",f=e[n+1]||"";e[n]=c+f,e.splice(n+1,1)}else{var a=e[n]||"";e[n]=a.slice(0,i)+a.slice(o)}if(3==t[0])for(var u=r-n,l=0;u>l;l++)e.splice(n+l,0,t[5][l]);if(4==t[0])for(var u=r-n,l=0;u>l;l++)e.splice(n,1)}),e.join("\n")},t.simplify=function(t){var n,e=[],i=null;return t.forEach(function(t){n&&1==t[0]&&1==n[0]&&t[3]==t[1]&&n[1]==t[1]&&n[3]==t[3]&&n[4]==t[2]?i?(i[3]=t[3],i[4]=t[4],i[5]=i[5]+t[5]):(i=[],i[0]=1,i[1]=n[1],i[2]=n[2],i[3]=t[3],i[4]=t[4],i[5]=n[5]+t[5]):(i&&(e.push(i),i=null),1==t[0]?i=t.slice():e.push(t)),n=t}),i&&e.push(i),e}}(this)},j=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof j))return new j(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=j._classInfo.name)return new c(t,n,e,i,r,o,a,s)
}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};j._classInfo={name:"aceCmdConvert"},j.prototype=new b,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.aceCmdConvert=j,this.aceCmdConvert=j):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.aceCmdConvert=j:this.aceCmdConvert=j}.call(new Function("return this")());var w=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){var n,e,i,r,o,a,s;t._createModelCommands=function(t,n,e){e||(e=[]);var i;if(i=t.data&&t.__id?t.data:t,this.isObject(i)||this.isArray(i)){var r;if(r=t.__id?t:{data:i,__id:this.guid()},this.isArray(i))var o=[2,r.__fork||r.__id,[],null,r.__fork||r.__id];else var o=[1,r.__fork||r.__id,{},null,r.__fork||r.__id];n&&(r.__p=n.__id),e.push(o);for(var a in i)if(i.hasOwnProperty(a)){var s=i[a];if(this.isObject(s)||this.isArray(s)){var c=this._createModelCommands(s,r,e),o=[5,a,c.__fork||c.__id,null,r.__fork||r.__id];e.push(o)}else{var o=[4,a,s,null,r.__fork||r.__id];e.push(o)}}return r}},t.addedObjects=function(){var t=[];for(var n in i)i.hasOwnProperty(n)&&(e[n]||(t.push(n),a[n]=i[n]));return t},t.commonObjects=function(){var t=[];for(var r in n)e[r]&&i[r]&&t.push(r);return t},t.compareFiles=function(t,c){e={},i={},n={},r={},o={},a={},s={},this.findObjects(t,e),this.findObjects(c,i);var f={missing:this.missingObjects(),added:this.addedObjects(),common:this.commonObjects(),cMod:[],cmds:[]},u=this;f.common.forEach(function(t){var n=u.objectDiff(e[t],i[t]);f.cMod.push(n)});var u=this;return f.added.forEach(function(t){var e=[],i=n[t];u._createModelCommands(i,null,e),e.forEach(function(t){f.cmds.push(t)})}),f.cMod.forEach(function(t){t.cmds.forEach(function(t){f.cmds.push(t)})}),f},t.findObjects=function(t,e){if(t&&t.__id&&(e[t.__fork||t.__id]=t,n[t.__fork||t.__id]=t,r[t.__id]=t),t.data){var i=t.data;for(var o in i)if(i.hasOwnProperty(o)){var a=i[o];this.isObject(a)&&(s[a.__fork||a.__id]=t.__fork||t.__id,this.findObjects(a,e))}}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.missingObjects=function(){var t=[];for(var n in e)e.hasOwnProperty(n)&&(i[n]||(o[n]=e[n],t.push(n)));return t},t.objectDiff=function(t,e){var i={modified:[],posMoved:[],sourcesAndTargets:[],cmds:[]};if(t.data&&e.data&&this.isObject(t.data)&&!this.isArray(t.data)){var r=t.data,c={};for(var f in e.data)if(e.data.hasOwnProperty(f)){var u=r[f],l=t.__fork||t.__id;if(!this.isObject(u)&&!this.isArray(u)){c[f]=!0;var h=e.data[f];e.data[f]!=u&&(this.isObject(u)||this.isObject(h)?i.cmds.push(h&&h.__id?[5,f,e.data[f].__id,null,l]:[10,f,u.__id,null,l]):(i.modified.push({id:l,prop:f,from:u,to:e.data[f]}),i.cmds.push([4,f,e.data[f],u,l])))}}for(var f in t.data)if(t.data.hasOwnProperty(f)){if(c[f])continue;var u=t.data[f],l=t.__id;if(this.isObject(u)&&!this.isArray(u)){var h=e.data[f];!h&&u&&u.__id&&i.cmds.push([10,f,u.__id,null,l])}}}if(this.isArray(t.data)){for(var _=t.data,d=e.data,p=[],v=[],m=_.length,y=d.length,g=0;m>g;g++){var I=_[g];if(this.isObject(I)){var b=I.__fork||I.__id;o[b]?i.cmds.push([8,0,b,0,s[b]]):p.push(b)}}for(var j={},w={},O={},g=0;y>g;g++){var I=d[g];if(this.isObject(I)){var b=I.__fork||I.__id;j[b]=g,w[g]=b,a[b]&&(p.push(b),i.cmds.push([7,g,b,0,s[b]])),v.push(b)}}var F=[],g=0;p.forEach(function(t){F.push(j[t]),O[t]=g,g++}),i.restackIndex=j,i.restackList=F,i.reverseIndex=w,i.restack=this.restackOps(F);var C=[],S=p.slice();i.restack.forEach(function(t){if("a"==t[0]){var e=w[t[1]],r=w[t[2]],o=(j[r],S.indexOf(e));S.splice(o,1);var a=S.indexOf(r);S.splice(a,0,e);{n[e]}i.cmds.push([12,e,a,o,s[e]])}else{var e=w[t[1]],r=w[t[2]],o=(j[r],S.indexOf(e));S.splice(o,1);var a=S.indexOf(r)+1;S.splice(a,0,e),i.cmds.push([12,e,a,o,s[e]])}}),i.stackCmds=C,i.sourceArrayWork=S,i.sourcesAndTargets.push([p,v])}return i},t.restackOps=function(t){function n(t){for(var n=t.slice(0),i=t.slice(0),r=t.slice(0).sort(function(t,n){return t-n}),o={},a={},s=0;s<i.length;s++){var c=r.indexOf(i[s]);o[i[s]]=c,a[c]=i[s],n[s]=c}var f=n.slice(0).sort(function(t,n){return t-n}),u=n[0],l=n[0],h=[],_=0,d=function(){for(var t=0,e=n.length,i=0;e>t;t++){var r=n[t];r>l&&(l=r),u>r&&(u=r),t>0&&h.push(f[t]-f[t-1]),t>0&&(_+=Math.abs(f[t]-f[t-1])),i+=Math.abs(r-f[t])}return _/=e,i/e}();h.sort(function(t,n){return t-n});for(var p=(h[0],function(t){for(var e=function(e,i,r){var o=[],a=n.length;for(i||(i=0);a>e;e++){var s=n[e];if(s-r!=1){var c=e+i;0>c&&(c=0),c>=a&&(c=a-1),t(s,f[c],s,r,e,a)&&(n[e+1]&&n[e+1]<s&&n[e+1]>r||(o.push(s),r=s))}else o.push(s),r=s}return o},i=[],r=0;.1>r;){for(var o=-5;5>=o;o++)i.push(e(Math.floor(n.length*r),o,u-1));r+=.05}return i.sort(function(t,n){return n.length-t.length}),i[0]}),v=[p(function(t,n,e,i,r,o){return i>e?!1:r>0&&Math.abs(e-i)>h[r-1]?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),p(function(t,n,e,i,r,o){return i>e?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),p(function(t,n,e,i,r,o){return i>e?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),p(function(t,n,e,i,r,o){return i>e?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),p(function(t,n,e,i,r,o){return i>e?!1:Math.abs(t-n)<=d&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),p(function(t,n,e,i){return i>e?!1:Math.abs(e-i)<_?!0:Math.abs(t-n)<=_&&e>=i?!0:!1}),p(function(t,n,e,i){return e>i?!0:!1}),p(function(t,n,e,i){return i>e?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d&&e>=i?!0:!1}),p(function(t,n,e,i,r,o){return i>e?!1:r>0&&Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:r>0&&Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),p(function(t,n,e,i){if(i>e)return!1;if(i>=u){if(e>=i)return!0}else if(e==u)return!0;return!1})],m=[],y=0,s=0;s<v.length;s++){var g=v[s];g.length>y&&(m=g,y=g.length)}0==m.length&&(m=[f[Math.floor(f.length/2)]]);{var I=[],b=[];!function(){for(var t=u,e=m[0],i=m.length,r=n.indexOf(e),o=0,a=0,s=n.length;s>a;a++){var c=n[a];c>=t&&e>=c&&r>=a?(I.push(c),t=c):b.push(c),c==e&&(t=c,i-1>o?(o++,e=m[o],r=n.indexOf(e)):(e=l,r=s+1))}}()}b.sort(function(t,n){return t-n});!function(){for(var t=0,n=0,i=I[0],r=b.length;r>t;){var o=I[n],s=b[t];if("undefined"==typeof o){for(;r>t;)e.push(["b",a[s],a[i]]),i=s,t++,s=b[t];return}s>o?(i=o,n++):(e.push(["a",a[s],a[o]]),t++)}}();return n}var e=[];return n(t),e}}(this)},O=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof O))return new O(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=O._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};O._classInfo={name:"diffEngine"},O.prototype=new w;var F=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,i,r,o,a,s,c;t._cmd_aceCmd=function(t,n){var e=this._find(t[4]),i=t[1];if(!e||!i)return!1;if("string"!=typeof e.data[i])return!1;var o=j();e.data[i]=o.runToString(e.data[i],t[2]),r=n;var a=[4,i,e.data[i],null,t[4]];return this._cmd(a,e,null),n?this._cmd(t,e,null):this.writeCommand(t),r=!1,!0},t._cmd_createArray=function(t,n){var e=t[1];if(!e)return{error:21,cmd:t,text:"Object ID was null or undefined"};var i=this._getObjectHash();if(i[e])return{error:22,cmd:t,text:"Object with same ID ("+e+") was alredy created"};var r,o=this._getRemovedHash();return o[e]?(r=o[e],r.__p=null):r={data:[],__id:e},i[r.__id]=r,this._data.__orphan.push(r),!0},t._cmd_createObject=function(t,n){var e=t[1];if(!e)return{error:11,cmd:t,text:"Object ID was null or undefined"};var i=this._getObjectHash();if(i[e])return{error:12,cmd:t,text:"Object with same ID ("+e+") was alredy created"};var r,o=this._getRemovedHash();return o[e]?(r=o[e],r.__p=null):r={data:{},__id:e},i[r.__id]=r,this._data.__orphan.push(r),!0},t._cmd_moveToIndex=function(t){var n,e=this._find(t[4]),r=e.data.length,o=0;if(!e)return{error:2,cmd:1,text:"Object with ID ("+t[4]+") did not exist"};var a=null;for(o=0;r>o;o++){var s=e.data[o];if(s.__id==t[1]){n=s,a=o;break}}if(a!=t[3])return{error:121,cmd:t,text:"The old index was not what expected: "+a+" cmd have "+t[3]};if(!n)return{error:122,cmd:t,text:"Object to be moved ("+t[1]+") was not in the array"};var c=parseInt(t[2]);return isNaN(c)?{error:123,cmd:t,text:"Target index ("+c+") was not a number"}:e.data.length<=o||0>o?{error:124,cmd:t,text:"Invalid original index ("+o+") given"}:(i.fromIndex=o,e.data.splice(o,1),e.data.splice(c,0,n),this._cmd(t,null,t[1]),!0)},t._cmd_pushToArray=function(t,n){{var e=this._find(t[4]),i=this._find(t[2]),r=parseInt(t[1]);t[3],e.data.length}if(!e)return{error:71,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:72,cmd:t,text:"Did not find object with ID ("+t[2]+") "};if(i.__p)return{error:73,cmd:t,text:"The object already had a parent - need to remove first ("+t[2]+") "};if(isNaN(r))return{error:74,cmd:t,text:"toIndex was not a number"};if(!this.isArray(e.data))return{error:75,cmd:t,text:"Target Object was not an array"};if(r>e.data.length||0>r)return{error:76,cmd:t,text:"toIndex out of range"};e.data.splice(r,0,i),i.__p=e.__id;var o=this._data.__orphan.indexOf(i);return o>=0&&this._data.__orphan.splice(o,1),this._cmd(t,null,t[2]),!0},t._cmd_removeObject=function(t,n){var e=this._find(t[4]),i=this._find(t[2]),r=parseInt(t[1]);if(!e)return{error:81,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:82,cmd:t,text:"Did not find object with ID ("+t[2]+") "};if(!i.__p)return{error:83,cmd:t,text:"The removed item did not have a parent ("+t[2]+") "};var o=e.data.indexOf(i);if(isNaN(r))return{error:84,cmd:t,text:"oldPosition was not a number"};if(r!=o)return{error:85,cmd:t,text:"oldPosition was not same as current position"};var a=this._getRemovedHash();a[t[2]]=i,e.data.splice(o,1),this._cmd(t,null,t[2]),i.__p=null;var s=this._data.__orphan.indexOf(i);return 0>s&&this._data.__orphan.push(i),!0},t._cmd_setMeta=function(t,n){var e=this._find(t[4]),i=t[1];return i?"data"==i?!1:"__id"==i?!1:e?e[i]==t[2]?!1:(e[i]=t[2],this._cmd(t,e,null),n||this.writeCommand(t),!0):!1:!1},t._cmd_setProperty=function(t,n){var e=this._find(t[4]),i=t[1];if(!e)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var r=e.data[i];if(r==t[2])return{error:43,cmd:t,text:"Trying to set the same value to the object twice"};if("undefined"!=typeof r){if(r!=t[3])return{error:44,cmd:t,text:"The old value "+r+" was not the same as the commands old value"}}else if(this.isObject(r)||this.isArray(r))return{error:45,cmd:t,text:"Trying to set Object or Array value to a scalar property"};return e.data[i]=t[2],this._cmd(t,e,null),!0},t._cmd_setPropertyObject=function(t,n){var e=this._find(t[4]),i=t[1],r=this._find(t[2]);if(!e)return{error:51,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:52,cmd:t,text:"The property was not defined ("+t[1]+") "};if(!r)return{error:53,cmd:t,text:"Could not find the Object to be set with ID ("+t[2]+") "};if("undefined"!=typeof e.data[i])return{error:54,cmd:t,text:"The property ("+t[1]+") was already set, try unsetting first "};e.data[i]=r,r.__p=e.__id,this._cmd(t,null,t[2]);var o=this._data.__orphan.indexOf(r);return o>=0&&this._data.__orphan.splice(o,1),n||this._moveCmdListToParent(r),!0},t._cmd_unsetProperty=function(t){var n=this._find(t[4]),e=t[1];return n?e?this.isArray(n.data[e])?{error:103,cmd:t,text:"The Object data was Array ("+t[4]+") "}:(delete n.data[e],!0):{error:102,cmd:t,text:"The property was not defined ("+t[1]+") "}:{error:101,cmd:t,text:"Did not find object with ID ("+t[4]+") "}},t._fireListener=function(t,e){if(n){var i=t.__id+"::"+e,r=n[i];r&&r.forEach(function(n){n(t,t.data[e])})}},t._moveCmdListToParent=function(){},t._reverse_aceCmd=function(t){var n=this._find(t[4]),e=t[1],i=j(),r=i.reverse(t[2]),o=[4,e,n.data[e],null,t[4]],a=[13,e,r,null,t[4]],s=i.runToString(n.data[e],r);n.data[e]=s,this._cmd(o),this._cmd(a)},t._reverse_createArray=function(t){var n=t[1],e=this._getObjectHash(),i=e[n],r=this._getRemovedHash();r[n]=i,delete e[n];var o=this._data.__orphan.indexOf(i);o>=0&&this._data.__orphan.splice(o,1)},t._reverse_createObject=function(t){var n=t[1],e=this._getObjectHash(),i=e[n],r=this._getRemovedHash();r[n]=i,delete e[n];var o=this._data.__orphan.indexOf(i);o>=0&&this._data.__orphan.splice(o,1)},t._reverse_moveToIndex=function(t){var n,e=this._find(t[4]),i=e.data.length,r=0,o=null;for(r=0;i>r;r++){var a=e.data[r];if(a.__id==t[1]){n=a,o=r;break}}if(o!=t[2])throw"_reverse_moveToIndex with invalid index value";if(n){var s=parseInt(t[3]);e.data.splice(r,1),e.data.splice(s,0,n);var c=t.slice();c[2]=s,c[3]=t[2],this._cmd(c,null,c[1])}},t._reverse_pushToArray=function(t){{var n=this._find(t[4]),e=this._find(t[2]);n.data.length}if(n&&e){var i=n.data.length-1,r=n.data[i];if(r.__id==t[2]){var o=[8,i,r.__id,null,n.__id];n.data.splice(i,1),this._cmd(o,null,o[2])}}},t._reverse_removeObject=function(t){{var n=this._find(t[4]),e=this._find(t[2]),i=t[1];n.data.indexOf(e)}if(n&&e){n.data.splice(i,0,e);var r=[7,i,t[2],null,t[4]];this._cmd(r,null,t[2]);var o=this._data.__orphan.indexOf(e);o>=0&&this._data.__orphan.splice(o,1),e.__p=t[4]}},t._reverse_setMeta=function(t){var n=this._find(t[4]),e=t[1];if(n){var i=[3,e,t[3],t[2],t[4]];n[e]=t[3],this._cmd(i)}},t._reverse_setProperty=function(t){var n=this._find(t[4]),e=t[1];if(n){var i=[4,e,t[3],t[2],t[4]];n.data[e]=t[3],this._cmd(i)}},t._reverse_setPropertyObject=function(t){var n=this._find(t[4]),e=t[1],i=this._find(t[2]);if(n&&i){delete n.data[e],i.__p=null;var r=[10,e,null,null,t[4]];this._cmd(r)}},t._reverse_unsetProperty=function(t){var n=this._find(t[4]),e=this._find(t[2]),i=t[1];if(n&&i&&e){n.data[i]=e,e.__p=n.__id;var r=[5,i,e.__id,0,t[4]];this._cmd(r,null,e.__id)}},t._updateHotBuffer=function(t){var n=(new Date).getTime();for(var e in c)if(c.hasOwnProperty(e)){var i=c[e];if(t||n-i.ms>s.hotMs){if(i.lastCmd){var r=i.firstCmd,o=i.lastCmd;i.chObj.writeLocalJournal([4,r[1],o[2],r[3],r[4]])}else i.chObj.writeLocalJournal(i.firstCmd);delete c[e]}}},t.execCmd=function(t,n,e){try{if(!this.isArray(t))return!1;var i=o[t[0]];if(this._playBackOnFn&&!e)return!1;if(i){var r=i.apply(this,[t,n]);if(r===!0&&!e)if(n)this.writeLocalJournal(t);else if(4==t[0]&&s.hotMs){var a=t[4],f=a+":"+t[1],u=c[f];u?u.lastCmd=t:c[f]={ms:(new Date).getTime(),firstCmd:t,chObj:this}}else this._updateHotBuffer(!0),this.writeLocalJournal(t);return r}return{error:199,text:"Invalid command"}}catch(l){var h="";return l&&l.message&&(h=l.message),{error:199,cmd:t,text:"Exception raised "+h}}},t.getJournalCmd=function(t){return this._journal[t]},t.getJournalLine=function(){return this._journalPointer},t.getLocalJournal=function(){return this._journal},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(n||(n={},i={},s={},c={}),!o){a=new Array(30),o=new Array(30),o[1]=this._cmd_createObject,o[2]=this._cmd_createArray,o[3]=this._cmd_setMeta,o[4]=this._cmd_setProperty,o[5]=this._cmd_setPropertyObject,o[7]=this._cmd_pushToArray,o[8]=this._cmd_removeObject,o[10]=this._cmd_unsetProperty,o[12]=this._cmd_moveToIndex,o[13]=this._cmd_aceCmd,a[1]=this._reverse_createObject,a[2]=this._reverse_createArray,a[3]=this._reverse_setMeta,a[4]=this._reverse_setProperty,a[5]=this._reverse_setPropertyObject,a[7]=this._reverse_pushToArray,a[8]=this._reverse_removeObject,a[10]=this._reverse_unsetProperty,a[12]=this._reverse_moveToIndex,a[13]=this._reverse_aceCmd;var t=this;e().every(.5,function(){t._updateHotBuffer()})}}),t.playback=function(t){t=t||{};var n=h(),i=this._journal[0][5];if(!i)return void console.error("journal does not have timestamps");var r,o=t.ms||2e3;r=t.journal?t.journal:this._journal.slice();var a=r.length;this.reverseToLine(0);var s=(new Date).getTime(),c=0,f=this,u=i,l=0,_=function(){for(var t,i=(new Date).getTime(),h=i-s,d=a,p=c;d>p;){var v=r[p][5],m=v-u;if(t&&v-t>o){var y=v-h-parseInt(o/2);u=y,m=v-u}if(!(h>m))break;try{f.redo(1,r)}catch(g){console.error(g)}l++,p++,t=v}c=p,c==d&&(e().removeFrameFn(_),f._journal=r,f._playBackOnFn=null,n.resolve(!0))};return this._playBackOnFn=_,e().onFrame(_),n},t.redo=function(t,n){var e=this.getJournalLine();for(t=t||1;t-->0;){var i;if(i=n?n[e]:this._journal[e],!i)return;var r=this.execCmd(i,!1,!0);r!==!0&&console.error(r),e++,this._journalPointer++}},t.redoStep=function(t){t=t||{};var n=t.ms||400,e=this.getJournalLine();if(this._journal[e]){for(var i=this._journal[e][5],r=0;this._journal[e];){var o=this._journal[e][5],a=Math.abs(o-i);if(a>n)break;e++,r++}r>0&&this.redo(r)}},t.reverseCmd=function(t){if(t){var n=a[t[0]];if(n){var e=n.apply(this,[t]);return e}}},t.reverseNLines=function(t){for(var n=this.getJournalLine();n-1>=0&&t-->0;){var e=this._journal[n-1];this.reverseCmd(e),n--,this._journalPointer--}},t.reverseToLine=function(t){for(var n=this.getJournalLine();n-1>=0&&n>t;){var e=this._journal[n-1];this.reverseCmd(e),n--,this._journalPointer--}},t.setHotMs=function(t){s.hotMs=t},t.undo=function(t){0!==t&&("undefined"==typeof t&&(t=1),this.reverseNLines(t))},t.undoStep=function(t){t=t||{};var n=t.ms||400,e=this.getJournalLine();if(0!=e){for(var i=this._journal[e-1][5],r=0;e-1>=0;){var o=this._journal[e-1][5],a=Math.abs(o-i);if(a>n)break;e--,r++}r>0&&this.undo(r)}},t.writeCommand=function(){},t.writeLocalJournal=function(t){this._journal&&(this._journal.length>this._journalPointer&&(this._journal.length=this._journalPointer),t[5]||(t[5]=(new Date).getTime()),this._journal.push(t),this._journalPointer++)}}(this),function(t){var n,e;t._addToCache=function(t){t&&t.__id&&(this._objectHash[t.__id]=t)},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){return n||(n={}),n[t]?n[t]:void(n[t]=this)}),t._cmd=function(t,n,e){var i=t[0],r=t[4];this._wCmd(i,r,t),e&&e!=r&&this._wCmd(i,e,t)},t._createModelCommands=function(t,n,e){e||(e=[]);var i;if(i=t.data&&t.__id?t.data:t,this.isObject(i)||this.isArray(i)){var r;if(r=t.__id?t:{data:i,__id:this.guid()},this.isArray(i))var o=[2,r.__id,[],null,r.__id];else var o=[1,r.__id,{},null,r.__id];n&&(r.__p=n.__id),e.push(o);for(var a in i)if(i.hasOwnProperty(a)){var s=i[a];if(this.isObject(s)||this.isArray(s)){var c=this._createModelCommands(s,r,e),o=[5,a,c.__id,null,r.__id];e.push(o)}else{var o=[4,a,s,null,r.__id];e.push(o)}}return r}},t._createNewModel=function(t,n){if(this.isObject(t)||this.isArray(t)){var e={data:t,__id:this.guid()};if(this._objectHash[e.__id]=e,this.isArray(t))var i=[2,e.__id,[],null,e.__id];else var i=[1,e.__id,{},null,e.__id];n&&(e.__p=n.__id),this.writeCommand(i,e);for(var r in t)if(t.hasOwnProperty(r)){var o=t[r];if(this.isObject(o)||this.isArray(o)){var a=this._createNewModel(o,e);e.data[r]=a;var i=[5,r,a.__id,null,e.__id];this.writeCommand(i,e),this._moveCmdListToParent(a)}else{var i=[4,r,o,null,e.__id];this.writeCommand(i,e)}}return e}},t._find=function(t){var n=this._objectHash[t];return n?n:this._removedHash[t]},t._findObjects=function(t,n){if(!t)return null;if(!this.isObject(t))return t;t=this._wrapData(t),t.__id&&(this._objectHash[t.__id]=t);if(n&&(t.__p=n),t.data){var e=t.data;for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];if(this.isObject(r)){var o=this._findObjects(r,t.__id);o!==r&&(t.data[i]=o)}}}return t},t._getObjectHash=function(){return this._objectHash},t._getRemovedHash=function(){return this._removedHash},t._prepareData=function(t){var n=this._wrapData(t);return this._objectHash[n.__id]||(n=this._findObjects(n)),n},t._wCmd=function(t,n,i){if(this._workers[t]&&this._workers[t][n]){var r=this._workers[t][n],o=i[1],a=r["*"],s=r[o];a&&a.forEach(function(t){var n=t[0],r=t[1],o=e[n];o&&o(i,r)}),s&&s.forEach(function(t){var n=t[0],r=t[1],o=e[n];o&&o(i,r)})}},t._wrapData=function(t){if(t&&t._wrapData)return t._data;if(t.__id&&t.data)return t;var n=this._createNewModel(t);return n},t.createWorker=function(t,n,e){var i=n[0],r=n[4];this._workers[i]||(this._workers[i]={}),this._workers[i][r]||(this._workers[i][r]={});var o=this._workers[i][r],a=n[1];a||(a="*"),o[a]||(o[a]=[]),o[a].push([t,e])},t.getData=function(){return this._data},t.indexOf=function(t){if(t||(t=this._data),this.isObject(t)||(t=this._find(t)),t){var n=this._find(t.__p);if(n&&this.isArray(n.data))return n.data.indexOf(t)}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){if(n){this._objectHash||(this._objectHash={},this._removedHash={});var i=this;this._channelId=t,this._data=n,this._workers={},this._journal=e||[],this._journalPointer=this._journal.length;var r=this._findObjects(n);r!=n&&(this._data=r),this._data.__orphan||(this._data.__orphan=[]),e&&this.isArray(e)&&e.forEach(function(t){i.execCmd(t,!0)})}}),t.setWorkerCommands=function(t){e||(e={});for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},t.toPlainData=function(t){if("undefined"==typeof t&&(t=this._data),!this.isFunction(t)&&"function"!=typeof t){if(!this.isObject(t))return t;var n;if(this.isArray(t.data)){n=[];for(var e=t.data.length,i=0;e>i;i++)n[i]=this.toPlainData(t.data[i])}else{n={};for(var r in t.data)t.data.hasOwnProperty(r)&&(n[r]=this.toPlainData(t.data[r]))}return n}}}(this)},C=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof C))return new C(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=C._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};C._classInfo={name:"_channelData"},C.prototype=new F,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._channelData=C,this._channelData=C):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._channelData=C:this._channelData=C}.call(new Function("return this")());var S=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},x=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof x))return new x(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=x._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};x._classInfo={name:"channelObjects"},x.prototype=new S;var n=function(){!function(t){var n,e,i,r,o;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,a;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,a=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],a=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),a||(a=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var s=0,c=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var f=0;f<o.length;f++){var u=o[f];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.fn(),h.nextTime=a+h.step),h.until&&h.until<a&&delete r[l]}t(c),s=a};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"later"},e.prototype=new n;var l=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,r=[],o=new Array(e);return this.then(function(){var t=h();return 0==n.length&&t.resolve([]),n.forEach(function(n,a){n.then?(r.push(n),n.then(function(n){o[a]=n,i++,i==e&&t.resolve(o)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var r=i.length,o=!1,a=!1,s=0,c=[],f=e||{};return this.then(function(){var n=h();return i.forEach(function(e){e.then?(c.push(e),e.then(function(e){s++,o=t(e,f),(o&&!a||0==a&&r==s)&&(n.resolve(f),a=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){t(function(t){i.resolve(t)},function(t){i.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new h(t,n),r=this;return 1==this._state&&e().asap(function(){r.fulfill(r.value())}),2==this._state&&e().asap(function(){r.reject(r.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},h=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof h))return new h(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};h._classInfo={name:"_promise"},h.prototype=new l;var _=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t===!1&&e?void 0:(n||(n={}),n[t]?n[t]:void(n[t]=this))}),t.addCommands=function(t,n){if(this.isArray(t)){var e=this;return t.forEach(function(t){e.addCommands(t)}),this}this._commands.push({fnCmd:t,fnFail:n,async:!0})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._commands||(this._commands=[],this.waitingList=[],this._index=0);var i=this;if(!n){var r=function(){i.step()};e().every(1/30,r)}}),t.step=function(){var t=this._index,n=this._commands.length;if(t!=n){for(var e=h(),i=e,r=h(),o=this;n>t;){var a=this._commands[t];!function(t){i=i.then(function(){var n=h();return t.fnCmd(function(){n.resolve(!0)},function(e){n.resolve(!0),t.fnFail&&t.fnFail(e)}),n}).fail(function(n){t.fnFail&&t.fnFail(n)})}(a),this._index++,t++}return i.then(function(){if(o.waitingList.shift(),r.resolve(!0),o.waitingList.length){var t=o.waitingList[0];t.resolve(!0)}}).fail(function(){}),this.waitingList.push(e),1==this.waitingList.length&&e.resolve(!0),r}}}(this)},d=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof d))return new d(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=d._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};d._classInfo={name:"sequenceStepper"},d.prototype=new _;var A=function(){!function(t){t.addSocketToCh=function(t,n){this._channelSockets[t]||(this._channelSockets[t]=[]),this._channelSockets[t].indexOf(n)<0&&this._channelSockets[t].push(n)},t.getSocketsFromCh=function(t){return this._channelSockets[t]?this._channelSockets[t]:[]
},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){this._server=t,this._auth=e,this._channelSockets={};var i=this;this._server.on("connect",function(t){var r,o=[];t.on("requestChannel",function(e,a){n.findPath(e.channelId).then(function(s){s?(r=E(e.channelId,n,i),r.then(function(){r._groupACL(t,"r")?(t.join(e.channelId),i.addSocketToCh(e.channelId,t),o.push(e.channelId),a({success:!0,channelId:e.channelId})):a({success:!1,channelId:null})})):a({success:!1,channelId:null})})}),t.on("disconnect",function(){o.forEach(function(n){i.removeSocketFromCh(n,t)})}),t.on("auth",function(n,i){e?e.login(n.userId,n.password).then(function(n){if(n.result===!0){var e=n.userId,r=n.groups;console.log("AUTH groups ",n.groups),t.setAuthInfo(e,r),i({success:!0,userId:t.getUserId(),groups:n.groups})}else i({success:!1,userId:null})}):i({success:!1,userId:null})}),t.on("channelCommand",function(n,e){return t.getUserId()?t.isInRoom(n.channelId)?void r.run(n,function(t){e&&e(t)},t):void e({success:!1,reason:"not in room"}):void e({success:!1,reason:"socket is not authenticated."})})})}),t.removeSocketFromCh=function(t,n){if(this._channelSockets[t]){var e=this._channelSockets[t].indexOf(n);e>=0&&this._channelSockets[t].splice(e,1)}}}(this)},P=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof P))return new P(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=P._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};P._classInfo={name:"_serverChannelMgr"},P.prototype=new A,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._serverChannelMgr=P,this._serverChannelMgr=P):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._serverChannelMgr=P:this._serverChannelMgr=P}.call(new Function("return this")());var k=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return n||(n={}),t+=e.id(),n[t]?n[t]:void(n[t]=this)}),t._createChannelDir=function(t){var n=t;"/"==n.charAt(0)&&(n=n.substring(1));var e=n.split("/"),i=this._fs,r=i,o=h(),a=o,s=this;return e.forEach(function(t){t=t.trim(),0!=t.length&&(o=o.then(function(){return r.isFolder(t)}).then(function(n){return n?!0:r.createDir(t)}).then(function(){return r.getFolder(t)}).then(function(t){r=t}))}),o=o.then(function(){s._folder=r}),a.resolve(!0),o},t._createChannelSettings=function(){var t=this._folder,n=this;return h(function(e){var i=!1;t.isFile("ch.settings").then(function(e){return e?!0:(i=!0,t.writeFile("ch.settings",JSON.stringify({version:1,name:"Initial version",utc:(new Date).getTime(),channelId:n._channelId,journalLine:0})))}).then(function(){return t.readFile("ch.settings")}).then(function(t){var i=JSON.parse(t);n._settings=i,e(n._settings)})})},t._isFreeToFork=function(t){var n=t;"/"==n.charAt(0)&&(n=n.substring(1));var e=n.split("/"),i=this._fs,r=i,o=h(),a=o,s=!1;return e.forEach(function(t){t=t.trim(),0!=t.length&&(o=o.then(function(){return s?s:r.isFolder(t)}).then(function(t){return s?void 0:t?s:s=!0}).then(function(){return s?s:r.getFolder(t)}).then(function(t){return s?s:void(r=t)}))}),o=o.then(function(){return s}),a.resolve(!0),o},t._textLinesToArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t._writeSettings=function(){return this._folder.writeFile("ch.settings",JSON.stringify(this._settings))},t.childForkTree=function(){var t=(this._folder,this);return h(function(n){t.getForks().then(function(e){var i=[],r=[];if(!e||0==e.length)return void n([]);e.forEach(function(n){var e=D(n.to,t._fs);i.push(e.childForkTree())});var o=h();o.all(i).then(function(t){e.forEach(function(n,e){n.children=t[e],r.push(n)}),n(r)}),o.resolve(!0)})})},t.createChannel=function(t){var n,e=(this._folder,this);return h(function(i){if(n=t.chData,n||(n={data:{},__id:e.guid(),__acl:t.__acl}),n&&!n.__acl&&(n.__acl=t.__acl),!t.channelId||!t._userId)return void i({result:!1,text:"Could not create the channel, missing information"});var r={version:2,channelId:t.channelId,userId:t._userId,name:t.name||"",utc:(new Date).getTime()};console.log("Creating new channel with"),console.log(r),e._isFreeToFork(t.channelId).then(function(o){if(1==o){var a=D(t.channelId,e._fs);a.then(function(){return a.writeFile("file.2",JSON.stringify(n))}).then(function(){return a.set(r)}).then(function(){i({result:!0,channelId:t.channelId})}).fail(function(t){var n="";t&&t.message&&(n=t.message),i({result:!1,text:"Failed to create channel "+n})})}else console.error("Channel already created"),i({result:!1,text:"Channel is already in use"})}).fail(function(t){console.error(t),i({result:!1,text:"Creating the new channel failed"})})})},t.fork=function(t){var n=this._folder,e=this;return h(function(i){var r=e._settings,o=r.journalLine||0;"undefined"!=typeof t.journalLine&&(o=t.journalLine);var a={fromJournalLine:o,version:1,channelId:t.channelId,fromVersion:r.version,from:e._channelId,to:t.channelId,userId:t._userId,name:t.name,utc:(new Date).getTime()};console.log("fork called with "),console.log(a),e._isFreeToFork(t.channelId).then(function(r){1==r?n.appendFile("forks",JSON.stringify(a)+"\n").then(function(){var n=D(t.channelId,e._fs);n.then(function(){return n.set(a)}).then(function(){i(a)})}):(console.error("Channel already created"),i({result:!1,text:"Channel is already in use"}))}).fail(function(t){console.error(t),i({result:!1,text:"Creating the fork failed"})})})},t.get=function(t){var n=this._db,e=this;return h(function(i){e.then(function(){var e=n.table("settings");e.get(t).then(function(t){i(t.value)})})})},t.getCurrentVersion=function(){var t=(this._folder,this);return h(function(n){n(t._settings.version)})},t.getForks=function(){var t=this._folder,n=this;return h(function(e){n.then(function(){return t.readFile("forks")}).then(function(t){e(t?n._textLinesToArray(t):[])}).fail(function(){e([])})})},t.incrementVersion=function(){var t=(this._folder,this);return h(function(n){t.then(function(){var e=t._settings;e.version++,e.journalLine=0,t._writeSettings().then(function(){n(e.version)})})})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._channelId=t,this._latestVersion=1,this._fs=n;var e=this;e._createChannelDir(t).then(function(){return e._createChannelSettings()}).then(function(){e.resolve(!0)}).fail(function(t){console.error(t)})}),t.readBuildTree=function(t,n,e){var i=(this._folder,this);return h(t?function(r){var o=D(t,i._fs);o.then(function(){o.readBuildTree(null,n,null).then(function(t){var n=t[0].length;n>e&&t[0].splice(e,n-e),r(t)})})}:function(t){var e,r,o=[];i.then(function(){return i.readMain(n)}).then(function(t){return t&&(e=JSON.parse(t)),i.readJournal(n)}).then(function(n){if(r=n,i._settings.from&&!e){var a=i._settings;i.readBuildTree(a.from,a.fromVersion,a.fromJournalLine).then(function(e){o.push(n),e.forEach(function(t){o.push(t)}),t(o)})}else t([n,e])}).fail(function(t){console.error(t)})})},t.readJournal=function(t){var n=this._folder,e=this,i=t||e._settings.version;return h(function(t){n.readFile("journal."+i).then(function(n){return n?void t(e._textLinesToArray(n)):void t([])}).fail(function(){t([])})})},t.readMain=function(t){var n=this._folder,e=this,i=t||e._settings.version;return 1==i?h(function(t){t(null)}):n.readFile("file."+i)},t.set=function(t,n){var e=(this._folder,this._settings);if(this.isObject(t))for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);else e[t]=n;return this._writeSettings(e)},t.snapshot=function(t){var n=(this._folder,this);return h(function(e){var i;n.incrementVersion().then(function(e){return i=e-1,n.writeMain(t)}).then(function(){e(!0)})})},t.status=function(){var t=(this._folder,this);return h(function(n){t.then(function(){n(t._settings)})})},t.treeOfLife=function(t){var n=(this._folder,this);if(t){var e=D(t,this._fs);return e.treeOfLife()}return h(function(t){n.then(function(){n._settings.from?n.treeOfLife(n._settings.from).then(t):n.childForkTree().then(t)})})},t.writeFile=function(t,n){var e=this._folder;return"string"!=typeof n&&(n=JSON.stringify(n)),e.writeFile(t,n)},t.writeMain=function(t,n){var e=this._folder,i=this,r=n||i._settings.version;return"string"!=typeof t&&(t=JSON.stringify(t)),e.writeFile("file."+r,t)},t.writeToJournal=function(t){var n=this._folder,e=this;if(this.isArray(t[0])){var i="",r=0;return t.forEach(function(t){i+=JSON.stringify(t)+"\n",r++}),h(function(t){n.appendFile("journal."+e._settings.version,i).then(function(){e._settings.journalLine+=r,e._writeSettings(),t(!0)})})}return h(function(i){n.appendFile("journal."+e._settings.version,JSON.stringify(t)+"\n").then(function(){e._settings.journalLine++,e._writeSettings(),i(!0)})})}}(this)},D=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof D))return new D(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=D._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};k.prototype=h.prototype,D._classInfo={name:"_localChannelModel"},D.prototype=new k,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._localChannelModel=D,this._localChannelModel=D):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._localChannelModel=D:this._localChannelModel=D}.call(new Function("return this")());var T=function(){!function(t){var n,i;t._askChUpgrade=function(){var t=this._chManager.getSocketsFromCh(this._channelId),n=this;t.forEach(function(t){n._serverState.upgrade||(n._serverState.upgrade={}),n._serverState.upgrade[t.getId()]={askFull:!0,socket:t}})},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return n||(n={}),t+=e.id(),n[t]?n[t]:void(n[t]=this)}),t._doClientUpdate=function(){var t,n=this;if(n._serverState){if(n._serverState.upgrade)for(var e in n._serverState.upgrade)if(n._serverState.upgrade.hasOwnProperty(e)){var i=n._serverState.upgrade[e];if(i.socket){if(i.version!=n._serverState.version||i.askFull){var r=n._serverState.data.getData();i.socket.emit("upgrade_"+n._channelId,{version:n._serverState.version,journal:n._serverState.data._journal,data:r})}else{var o=i.last_update[1];i.socket.emit("upgrade_"+n._channelId,{partialFrom:o,partialEnds:n._serverState.data._journal.length,partial:n._serverState.data._journal.slice(o)})}delete n._serverState.upgrade[e]}}if(n._broadcastSocket&&n._policy){var a=n._policy.constructServerToClient(n._serverState);a&&(t||(t=n._broadcastSocket.to(n._channelId)),t.emit("s2c_"+n._channelId,a),n._model.writeToJournal(a.c).then(function(){}))}}},t._groupACL=function(t,n){var e=this;if(!e._acl)return!1;for(var i=t.getUserRoles(),r=!1,o=0;o<i.length;o++)if(e._acl.find("",i[o]+"@",n)){r=!0;break}return r},t._initCmds=function(){if(i||(i={}),!this._cmds){var t=this;this._cmds={treeOfLife:function(n,e,i){return t._groupACL(i,"r")?void t._model.treeOfLife().then(function(t){e(t)}):void e(null)},readBuildTree:function(n,e,i){return t._groupACL(i,"r")?void t._model.readBuildTree().then(function(n){t._model.status().then(function(t){e({status:t,build:n})})}):void e(null)},getForks:function(n,e,i){return t._groupACL(i,"r")?void t._model.getForks().then(function(t){e(t)}):void e(null)},channelStatus:function(n,e,i){return t._groupACL(i,"tc")?void t._model.status().then(function(t){e(t)}):void e(null)},raw:function(n,e,i){e(t._groupACL(i,"tc")?t._chData.getData():null)},createChannel:function(n,e,i){if(!t._groupACL(i,"w"))return void e(null);if(!n.data)return void e({ok:!1});if(!n.data.__acl){var r=t._serverState.data.getData();if(!r||!r.__acl)return void e({ok:!1});n.data.__acl=r.__acl}n.data._userId=i.getUserId(),t._model.createChannel(n.data).then(function(t){e(t)})},fork:function(n,e,i){return t._groupACL(i,"w")?n.data?(n.data._userId=i.getUserId(),void t._model.fork(n.data).then(function(t){e(t)})):void e({ok:!1}):void e(null)},snapshot:function(n,e,i){if(console.log("got snapshot command"),!t._groupACL(i,"w"))return void e(null);var r=t._serverState.data.getData();r.__orphan&&(r.__orphan.length=0),t._doClientUpdate(),console.log("About to call me._model.snapshot "),t._model.snapshot(r).then(function(){t._serverState.version++,t._serverState.data._journal.length=0,t._serverState.last_update[0]=0,t._serverState.last_update[1]=0,t._askChUpgrade(t._channelId),e({ok:!0})})},writeMain:function(n,e,i){return t._groupACL(i,"w")?void t._model.writeFile("main",n.data).then(function(){e({ok:!0})}):void e(null)},readMain:function(n,e,i){return t._groupACL(i,"r")?void t._model.readMain().then(function(t){e(t)}):void e(null)},readMainVersion:function(n,e,i){return t._groupACL(i,"r")?void t._model.readMain(n.data).then(function(t){e(t)}):void e(null)},upgradeRequest:function(n,e,i){return t._groupACL(i,"r")?(t._serverState.upgrade||(t._serverState.upgrade={}),n.data.socket=i,t._serverState.upgrade[i.getId()]=n.data,void e({result:!0})):void e(null)},c2s:function(n,e,i){if(!t._groupACL(i,"w"))return void e(null);for(var r=i.getUserId(),o=n.data.c.length,a=n.data.c,s=(new Date).getTime(),c=0;o>c;c++)a[c][5]=s,a[c][6]=r;var f=t._policy.deltaClientToServer(n.data,t._serverState);t._broadcastSocket||(t._broadcastSocket=i),e(f)},changeFrame:function(n,e,i){if(!t._groupACL(i,"w"))return void e(null);var r=t._tManager.execute(n.data);r.validCnt>0?(n.data.commands.length=r.validCnt,t._model.writeToJournal(n.data.commands).then(function(){i.broadcast.to(n.channelId).emit("frame_"+n.channelId,n),e(r)})):e(r)},writeJournal:function(n,e,i){return t._groupACL(i,"w")?void t._model.writeToJournal(n.data).then(function(){i.broadcast.to(n.channelId).emit("ch_"+n.channelId,n),e({ok:!0})}):void e(null)},readJournal:function(n,e,i){return t._groupACL(i,"r")?void t._model.readJournal().then(function(t){e(t)}):void e(null)},readJournalVersion:function(n,e,i){return t._groupACL(i,"r")?void t._model.readJournal(n.data).then(function(t){e(t)}):void e(null)}}}},t._updateLoop=function(){var t=this;e().every(.2,function(){t._doClientUpdate()})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){this._channelId=t,this._commands=d(t),this._chManager=e,this._model=D(t,n);var i=this;this._model.readBuildTree().then(function(e){for(var r=e.pop(),o=C(t+n.id(),r,[]),a=e.pop();a;)o._journalPointer=0,o._journal.length=0,a.forEach(function(t){o.execCmd(t)}),a=e.pop();i._serverState={data:o,version:i._model._settings.version,last_update:[0,o.getJournalLine()],_done:{}};var s=o.getData();s.__acl&&(i._acl=Z(s.__acl)),i._policy=Fn(),i._updateLoop(),i._chData=o,i.resolve(!0)}),this._initCmds()}),t.run=function(t,n,e){var i=this._cmds[t.cmd];i&&this._commands.addCommands(function(r){i(t,function(t){n(t),r()},e)})}}(this)},E=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof E))return new E(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=E._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};T.prototype=h.prototype,E._classInfo={name:"_channelController"},E.prototype=new T,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._channelController=E,this._channelController=E):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._channelController=E:this._channelController=E}.call(new Function("return this")());var R=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},N=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof N))return new N(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=N._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};N._classInfo={name:"_channels"},N.prototype=new R;var n=function(){!function(t){var n,e,i,r,o;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,a;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,a=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],a=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),a||(a=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var s=0,c=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var f=0;f<o.length;f++){var u=o[f];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.fn(),h.nextTime=a+h.step),h.until&&h.until<a&&delete r[l]}t(c),s=a};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"later"},e.prototype=new n;var l=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,r=[],o=new Array(e);return this.then(function(){var t=h();return 0==n.length&&t.resolve([]),n.forEach(function(n,a){n.then?(r.push(n),n.then(function(n){o[a]=n,i++,i==e&&t.resolve(o)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var r=i.length,o=!1,a=!1,s=0,c=[],f=e||{};return this.then(function(){var n=h();return i.forEach(function(e){e.then?(c.push(e),e.then(function(e){s++,o=t(e,f),(o&&!a||0==a&&r==s)&&(n.resolve(f),a=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){t(function(t){i.resolve(t)},function(t){i.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new h(t,n),r=this;return 1==this._state&&e().asap(function(){r.fulfill(r.value())}),2==this._state&&e().asap(function(){r.reject(r.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},h=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof h))return new h(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};h._classInfo={name:"_promise"},h.prototype=new l;var M=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t._getNsFromUrl=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getNsShorthand=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getReflections=function(){return _localReflections},t._getReflectionsFor=function(t){if(_localReflections){var n=_localReflections[t];if(n)return n}return[]},t._getReverseNs=function(t){return _nsReverse[t]},t._idFromNs=function(t){if(t){var n=t.length;"#"==t[n-1]&&(t=t.split("@").shift())}return t},t._idToNs=function(t,n){if(t){var e=t.length;if("#"==t[e-1]){var i=t.indexOf("@"),r=t.substring(i+1,e-1);r!=n&&(t=t.substring(0,i)+"@"+n+"#")}else t=t+"@"+n+"#"}return t},t._nsFromId=function(t){var n;if(t){t+="";var e=t.length;"#"==t[e-1]&&(n=t.split("@").pop(),n=n.split("#").shift())}return n},t._transformCmdFromNs=function(t,e){e||(e=this._ns);var i=n,r=t.slice(),o=i[t[0]],a=this;return o&&o.forEach(function(t){r[t]=a._idFromNs(r[t],e)}),r},t._transformCmdToNs=function(t,e){e||(e=this._ns);var i=n,r=t.slice(),o=i[t[0]];if(o)for(var a=0;a<o.length;a++){var s=o[a];r[s]=this._idToNs(r[s],e)}return r},t._transformObjFromNs=function(t,n){if(n||(n=this._ns),t&&t.__id){t.__p&&(t.__p=this._idFromNs(t.__p,n)),t.__id=this._idFromNs(t.__id,n);for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjFromNs(t.data[e],n)}return t},t._transformObjToNs=function(t,n){if(n||(n=this._ns),t&&t.__id){t.__id=this._idToNs(t.__id,n),t.__p&&(t.__p=this._idToNs(t.__p,n));for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjToNs(t.data[e],n)}return t},t._transformToNsBeforeInsert=function(t,n){var e=t.__ctxCmdList,i=this._nsFromId(n.__id);console.log(" _transformToNsBeforeInsert ");var r=this;return i?(e&&e.forEach(function(t){t.cmd=r._transformCmdToNs(t.cmd,i)}),t=r._transformObjToNs(t,i),t.__ctxCmdList=e,this._addToCache(t),t):t},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={1:[1],2:[1],4:[4],5:[2,4],7:[2,4],8:[2,4],10:[2,4],12:[1,4],13:[4],16:[3,4]})})}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t&&e?(t+=e.getId(),n||(n={}),n[t]?n[t]:void(n[t]=this)):void 0}),t._createTransaction=function(){this._currentFrame={id:this.guid(),version:1,from:this._data.getJournalLine(),fail_tolastok:!0,commands:[]}},t._fetch=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);return e?e:void 0},t._incoming=function(t){{var n=this;this._channelId}t.on("upgrade_"+this._channelId,function(t){if(n._upgradePending=!1,!n._disconnected&&t){if(t.partial){var e=n._clientState.data;e.reverseToLine(t.partialFrom),console.log("--- refreshing the partials, reversed to line --- ",t.partialFrom);var i=0;t.partial.forEach(function(t){if(!(i>0)){var r,o=n._transformCmdToNs(t);(r=e.execCmd(o,!0))!==!0&&(console.error("Partial ",r),i++)}}),0==i?(n._clientState.needsRefresh=!1,n._clientState.needsFullRefresh=!1,e._journal.length=t.partialEnds,n._clientState.last_update[0]=0,n._clientState.last_update[1]=e._journal.length,n._clientState.last_sent[0]=0,n._clientState.last_sent[1]=e._journal.length):n._clientState.needsFullRefresh=!0}if(t.data){var r=n._clientState.data.getData();n._transformObjToNs(t.data);var o=O().compareFiles(r,t.data);console.log("The diff ",JSON.stringify(o));var e=n._clientState.data,i=0;o.cmds.forEach(function(t){if(console.log("Diff cmd ",t),!(i>0)){var n;(n=e.execCmd(t,!0))!==!0&&(console.error("Full error ",n),i++)}}),0==i?(n._clientState.needsRefresh=!1,n._clientState.needsFullRefresh=!1,console.log("** full update should have gone ok ** "),e._journal.length=0,e._journal.push.apply(e._journal,t.journal),n._clientState.needsRefresh=!1,n._clientState.version=t.version,n._clientState.last_update[0]=0,n._clientState.last_update[1]=e._journal.length,n._clientState.last_sent[0]=0,n._clientState.last_sent[1]=e._journal.length,console.log("Version ",n._clientState.version)):(console.error("** errors with the full update ** "),n._clientState.needsFullRefresh=!0)}}}),t.on("s2c_"+this._channelId,function(t){if(!n._disconnected&&t){n._policy.deltaServerToClient(t,n._clientState)}})},t._onFrameLoop=function(t){var n=this,i=this._channelId,r=function(){if(n._policy&&!n._disconnected&&n._connected){n._clientState.needsRefresh&&(n._upgradePending||(console.log(" needsRefresh && !_upgradePending "),n.askUpgrade(n._clientState.needsFullRefresh)),n._upgradePending=!0);var e=n._policy.constructClientToServer(n._clientState);e&&t.send("channelCommand",{channelId:i,cmd:"c2s",data:e}).then(function(t){if(t&&t.errors&&t.errors.length>0){var e=!1;t.errors.forEach(function(t){44==t.error&&(e=!0)}),e&&(n._clientState.needsRefresh=!0)}})}};e().onFrame(r)},t.addCommand=function(t,n){if(this._currentFrame){var e=this._transformCmdFromNs(t,this._ns),i=this._transformCmdToNs(t,this._ns);this._data.execCmd(i,n)&&this._currentFrame.commands.push(e)}else{var i=this._transformCmdToNs(t,this._ns);this._data.execCmd(i,n)}},t.askUpgrade=function(t){this._socket&&this._socket.send("channelCommand",{channelId:this._channelId,cmd:"upgradeRequest",data:{version:this._clientState.version,last_update:this._clientState.last_update,askFull:t}}).then(function(){})},t.at=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);return i?i.data[n]:void 0},t.createChannel=function(t,n,e){if(!this._isLocal){var i=JSON.parse(JSON.stringify(e)),r=C(this.guid(),i,[]);i=r.getData(),i=this._transformObjFromNs(i);var o={channelId:t,name:n,chData:i},a=this;return h(function(t){a._socket.send("channelCommand",{channelId:a._channelId,cmd:"createChannel",data:o}).then(function(n){t(n)})})}},t.disconnect=function(){return this._disconnected=!0,this},t.fork=function(t,n){if(!this._isLocal){var e={version:this._channelStatus.version,channelId:t,name:n,journalLine:1};e.journalLine=this._clientState.last_update[1];var i=this;return h(function(t){i._socket.send("channelCommand",{channelId:i._channelId,cmd:"fork",data:e}).then(function(n){t(n)})})}},t.get=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);return i?i.data[n]:void 0},t.getChannelData=function(){return this._data},t.getData=function(){return this._data.getData()},t.indexOf=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e);return r}}return-1},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){if(e&&e.localChannel){this._channelId=t,this._options=e,this._socketGUID=this.guid(),this._isLocal=!0,this._socket=q(this._socketGUID,1);var i=this._socket.getEnum();this._ns=i,this._id=t+this._socket.getId();var r=this,o=e.localData;o=r._transformObjToNs(e.localData,i);var a=C(r._id,o,[]);return r._data=a,void r.resolve({result:!0,channelId:t})}if(t&&n){this._channelId=t,this._socket=n,this._options=e,this._changeFrames=[],this._pendingFrames=[];var i=n.getEnum();this._ns=i,this._id=t+n.getId();var r=this;this._onFrameLoop(n,i),this._incoming(n,i),console.log("channelClient init"),this._connCnt=0,n.on("disconnect",function(){r._connected=!1}),n.on("connect",function(){console.log("Socket sent connected"),r._connCnt++,e.auth&&n.send("auth",{userId:e.auth.username,password:e.auth.password}).then(function(e){return e.userId?(r._userId=e.userId,r._logged=!0,n.send("requestChannel",{channelId:t})):(r._logged=!1,!1)}).then(function(e){if(e&&e.channelId==t){if(r._connected=!0,r._connCnt>1){var i=r._policy.constructClientToServer(r._clientState);return i&&n.send("channelCommand",{channelId:t,cmd:"c2s",data:i}).then(function(){}),r.askUpgrade(),!1}return n.send("channelCommand",{channelId:t,cmd:"readBuildTree",data:""})}return!1}).then(function(n){if(n){var e=n.build;console.log("STATUS",JSON.stringify(n.status)),r._channelStatus=n.status;var o=e.pop();o=r._transformObjToNs(o,i);for(var a=C(r._id,o,[]),s=e.pop();s;)a._journalPointer=0,a._journal.length=0,s.forEach(function(t){a.execCmd(r._transformCmdToNs(t,i),!0)}),s=e.pop();r._clientState={data:a,client:r,needsRefresh:!1,version:r._channelStatus.version,last_update:[0,a.getJournalLine()],last_sent:[0,a.getJournalLine()]},r._policy=Fn(),r._data=a,r._createTransaction(),r.resolve({result:!0,channelId:t})
}else r.resolve({result:!1,text:"Authorization or connection failed"})})})}}),t.length=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);return e&&e.data?e.data.length||0:0},t.moveDown=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e),o=r-1;o>=0&&r>=0&&r!=o&&i.data.length>o&&this.addCommand([12,n,o,r,i.__id])}}},t.moveTo=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);if(i){var r=this._fetch(i.__p);if(r&&r.data){var o=r.data.indexOf(i);o>=0&&o!=n&&r.data.length>n&&this.addCommand([12,e,n,o,r.__id])}}},t.moveUp=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e),o=r+1;o>=0&&r>=0&&r!=o&&i.data.length>o&&this.addCommand([12,n,o,r,i.__id])}}},t.reconnect=function(){return this._disconnected=!1,this},t.redo=function(t){this._data.redo(t)},t.redoStep=function(t){this._data.redoStep(t)},t.remove=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e);r>=0&&this.addCommand([8,r,n,0,i.__id])}}},t.set=function(t,n,e){var i=this._idToNs(t,this._ns),r=this._data._find(i);if(r&&!this.isObject(e)){var o=r.data[n];o!=e&&this.addCommand([4,n,e,o,i])}},t.setObject=function(t,n,e){var i=this._idToNs(t,this._ns),r=this._data._find(i);if(r&&this.isObject(e)&&e.__id){var o=r.data[n];o||this.addCommand([5,n,e.__id,null,i])}},t.undo=function(t){this._data.undo(t)},t.undoStep=function(t){this._data.undoStep(t)},t.unset=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);if(i){var r=i.data[n];r&&r.__id&&this.addCommand([10,n,r.__id,null,e])}},t.upgradeVersion=function(){this._socket.send("channelCommand",{channelId:this._channelId,cmd:"snapshot",data:{}}).then(function(){})}}(this)},L=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof L))return new L(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=L._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};M.prototype=h.prototype,L._classInfo={name:"channelClient"},L.prototype=new M,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.channelClient=L,this.channelClient=L):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.channelClient=L:this.channelClient=L}.call(new Function("return this")());var V=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},J=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof J))return new J(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=J._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};J._classInfo={name:"channelClientModule"},J.prototype=new V;var U=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),"connect"==t&&this._connected&&n(this._socket),this},t.removeListener=function(t,n){if(this._ev&&this._ev[t])for(var e=this._ev[t],i=0;i<e.length;i++)if(e[i]==n)return void e.splice(i,1)},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.disconnect=function(){this._socket.messageTo({disconnect:!0}),me._connected=!1},t.emit=function(t,n,e){var i={name:t,data:n};if(e){i._callBackId=this.guid();var r=this,o=function(t){e(t),r.removeListener(i._callBackId,o)};this.on(i._callBackId,o)}this._socket.messageTo(i)},t.getEnum=function(){var t=this.socketId;return n[t]||(n[t]=e++),n[t]},t.getId=function(){return this.socketId},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,i,r){n||(n={},e=1);var o=this,a=this.guid();if(this.socketId=a,n[this.socketId]||(n[this.socketId]=e++),r){var s=function(){console.log("whenConnected called");var n=H(t,i,"openConnection","client",r),e=H(t,i,a,"client",r);e.on("clientMessage",function(t,n){console.log("clientMessage received ",n),n.connected?(o._socket=e,o._connected=!0,o.trigger("connect",e)):o.trigger(n.name,n.data)}),console.log("Sending message to _tcpEmu with real socket "),n.messageTo({socketId:a})},o=this;return r.on("disconnect",function(){o.trigger("disconnect")}),void(r.connected?(console.log("realSocket was connected"),s()):(console.log("realSocket was not connected"),r.on("connect",s)))}var c=H(t,i,"openConnection","client",r),f=H(t,i,a,"client",r);f.on("clientMessage",function(t,n){n.connected?(o._socket=f,o._connected=!0,o.trigger("connect",f)):o.trigger(n.name,n.data)}),c.messageTo({socketId:a})}),t.send=function(t,n){var e=this;return h(function(i){e.emit(t,n,i)})}}(this)},q=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof q))return new q(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=q._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};q._classInfo={name:"_clientSocket"},q.prototype=new U,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._clientSocket=q,this._clientSocket=q):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._clientSocket=q:this._clientSocket=q}.call(new Function("return this")());var W=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.getPrefix=function(){return this._ip+":"+this._port},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,i,r){e||(e={},n={});var o=this;if(this._ip=t,this._port=i,r)return void r.on("connection",function(e){console.log("socket.io got connection"),console.log("ip, port",t,i);var r,a=H(t,i,"openConnection","server",e);e.on("disconnect",function(){console.log("ioLib at server sent disconnect"),r&&r.close()}),a.on("serverMessage",function(a,s){if(s.socketId){var c=H(t,i,s.socketId,"server",e);r=c;var f=K(c,o);n[s.socketId]=f,o.trigger("connect",f),f.isConnected()?(console.log("Trying to send the connected message back to client"),c.messageFrom({connected:!0,socketId:s.socketId})):console.log("The socket was not connected")}})});var a=H(t,i,"openConnection","server");a.on("serverMessage",function(e,r){if(r.socketId){var a=H(t,i,r.socketId,"server"),s=K(a,o);n[r.socketId]=s,o.trigger("connect",s),o.trigger("connection",s),s.isConnected()&&a.messageFrom({connected:!0,socketId:r.socketId})}})})}(this)},B=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof B))return new B(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=B._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};B._classInfo={name:"_serverSocket"},B.prototype=new W,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._serverSocket=B,this._serverSocket=B):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._serverSocket=B:this._serverSocket=B}.call(new Function("return this")());var z=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){var i=this;return this._ev[t].forEach(function(t){t(i,n,e)}),this}}}(this),function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,i;t.close=function(){this.trigger("disconnect")},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e,o,a){this._server=t,this._port=n,this._role=o,this._socketId=e,this._dbName="tcp://"+this._server+":"+this._port+":"+this._socketId,i||(i="undefined"!=typeof r?r("tcp"):{log:function(){},error:function(){}}),a?(this._socket=a,this.socketPump(o)):this.memoryPump(o)}),t.memoryPump=function(t){var r=this,o=this._dbName+":to",a=this._dbName+":from";n||(n={}),n[o]||(n[o]=[]),n[a]||(n[a]=[]);var s=function(){if("server"==t){var e=n[o].slice();e.forEach(function(t){i.log("server got message ",t),r.trigger("serverMessage",t),n[o].shift()})}if("client"==t){var e=n[a].slice();e.forEach(function(t){r.trigger("clientMessage",t),n[a].shift()})}};e().every(.1,s)},t.messageFrom=function(t){var e=this._socket;if(e)return void e.emit(this._dbName,t);var i=this._dbName+":from";n[i].push(t)},t.messageTo=function(t){var e=this._socket;if(e)return i.log("_tcpEmu, emitting ",this._dbName,t),void e.emit(this._dbName,t);var r=this._dbName+":to";n[r].push(t)},t.socketPump=function(t){var n=this,e=this._socket;"server"==t&&(i.log("initializing the socketPump for server"),e.on(this._dbName,function(t){i.log("socketPump",n._dbName),n.trigger("serverMessage",t)})),"client"==t&&e.on(this._dbName,function(t){n.trigger("clientMessage",t)})}}(this)},H=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof H))return new H(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=H._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};H._classInfo={name:"_tcpEmu"},H.prototype=new z;var n=function(){!function(t){var n,e,i,r,o;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,a;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,a=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],a=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),a||(a=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var s=0,c=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var f=0;f<o.length;f++){var u=o[f];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.fn(),h.nextTime=a+h.step),h.until&&h.until<a&&delete r[l]}t(c),s=a};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"later"},e.prototype=new n;var G=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.delegateToRoom=function(t,e,i){var r=this._roomPrefix+":"+t;if(n&&n[r]){var o=this;n[r].forEach(function(t){t!=o&&t.emit(e,i)})}},t.disconnect=function(){var t=this;t._disconnected=!0,console.log("_serverSocketWrap disconnecting"),t.leaveFromRooms(),console.log("_serverSocketWrap left from rooms"),t.trigger("disconnect",t),t._disconnected=!0},t.emit=function(t,n){this._tcp.messageFrom({name:t,data:n})},t.getId=function(){return this._tcp._socketId},t.getUserId=function(){return this._userId},t.getUserRoles=function(){return this._roles},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){var e=this;this._roomPrefix=n.getPrefix(),this._server=n,this._tcp=t,t.on("disconnect",function(){console.log("tcpEmu sent disconnect"),e.disconnect()});t.on("serverMessage",function(t,n){return e._disconnected?void 0:n.disconnect?void e.disconnect():void(n._callBackId?e.trigger(n.name,n.data,function(t){e.emit(n._callBackId,t)}):e.trigger(n.name,n.data))}),this.broadcast={to:function(t){return{emit:function(n,i){e.delegateToRoom(t,n,i)}}}}}),t.isConnected=function(){return this._disconnected?!1:!0},t.isInRoom=function(t){return e?e[this.getId()].indexOf(t)>=0:!1},t.join=function(t){var i=this._roomPrefix+":"+t;n||(n={}),n[i]||(n[i]=[]),n[i].indexOf(this)<0&&(n[i].push(this),e||(e={}),e[this.getId()]||(e[this.getId()]=[]),e[this.getId()].push(t))},t.leave=function(t){var i=this._roomPrefix+":"+t;n||(n={}),n[i]||(n[i]=[]);var r;if((r=n[i].indexOf(this))>=0){n[i].splice(r,1);var o=this.getId(),a=e[o].indexOf(t);a>=0&&e[o].splice(a,1)}},t.leaveFromRooms=function(){var t=this.getId(),n=this;e&&e[t]&&e[t].forEach(function(t){n.leave(t)})},t.removeListener=function(){},t.setAuthInfo=function(t,n){this._userId=t,this._roles=n},t.to=function(t){var e=this._roomPrefix+":"+t;return{emit:function(t,i){console.log(" emit called "),n&&n[e]&&n[e].forEach(function(n){console.log(" emit with ",t,i),n.emit(t,i)})}}}}(this)},K=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof K))return new K(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=K._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};K._classInfo={name:"_serverSocketWrap"},K.prototype=new G;var Q=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},X=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof X))return new X(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=X._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};X._classInfo={name:"socketEmulator"},X.prototype=new Q;var Y=function(){!function(t){t.addPermission=function(t,n){for(var e=0;e<n.length;e++){var i=n[e];t.permissions.indexOf(i)<0&&(t.permissions+=i)}},t.allowGroup=function(t,n){var e=!1,i=this;this.map(function(r){return r.principal!=t||r.flags.indexOf("g")>=0||("A"==r.type&&(e=!0,i.addPermission(r,n)),"D"==r.type&&i.removePermission(r,n)),r}),e||this.push("A:g:"+t+":"+n)},t.allowUser=function(t,n){var e=!1,i=this;this.map(function(r){return r.principal!=t||r.flags.indexOf("g")>=0||("A"==r.type&&(e=!0,i.addPermission(r,n)),"D"==r.type&&i.removePermission(r,n)),r}),e||this.push("A::"+t+":"+n)},t.denyGroup=function(t,n){var e=!1,i=this;this.map(function(r){return r.principal!=t||r.flags.indexOf("g")>=0||(e=!0,"A"==r.type&&i.removePermission(r,n),"D"==r.type&&i.addPermission(r,n)),r}),e||this.push("D:g:"+t+":"+n)},t.denyUser=function(t,n){var e=!1,i=this;this.map(function(r){return r.principal!=t||r.flags.indexOf("g")>=0||("A"==r.type&&i.removePermission(r,n),"D"==r.type&&(e=!0,i.addPermission(r,n))),r}),e||this.push("D::"+t+":"+n)},t.filter=function(t){var n=this._acl.split("\n");return n.filter(t),this._acl=n.join("\n"),this},t.find=function(t,n,e){return this.has(t,n,e)},t.fromObject=function(t){return t.type+":"+t.flags+":"+t.principal+":"+t.permissions},t.getACL=function(){return this._acl},t.has=function(t,n,e){for(var i,r,o=0,a=0,s=0,c=this._acl.length,f=!1,u=0,l=!1,h=!1,_=0,d=0,p=!1;c>o;)if(":"!=this._acl.charAt(o))if("\n"!=this._acl.charAt(o))if(0!=a)1!=s?2!=s?3!=s?(a++,o++):(!l||h||p||e.indexOf(this._acl.charAt(o))>=0&&d++,a++,o++):(f?this._acl.charAt(o)==n.charAt(u++)?l=!0:(l=!1,h=!0):this._acl.charAt(o)==t.charAt(u++)?l=!0:(l=!1,h=!0),a++,o++):(r=this._acl.charAt(o),"g"==r&&(f=!0),"i"==r&&(p=!0),a++,o++);else{if(d>0&&e.length==d){if("A"==i)return!0;if("D"==i)return!1}p=!1,i=this._acl.charAt(o),a++,o++,l=!1,h=!1,u=0,_=0,d=0,f=!1}else a=0,s=0,o++;else a++,s++,o++;if(d>0&&e.length==d){if("A"==i)return!0;if("D"==i)return!1}return!1},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t){this._acl=t.trim()}),t.map=function(t){if(0==this._acl.length)return this;var n=this._acl.split("\n"),e=n.map(this.toObject).map(t).map(this.fromObject);return this._acl=e.join("\n").trim(),this},t.push=function(t){var n=this._acl.length;this._acl+=0==n||"\n"==this._acl.charAt(n-1)?t:"\n"+t,this._acl=this._acl.trim()},t.reduce=function(t,n){var e=this._acl.split("\n");return e.reduce(t,n),this._acl=e.join("\n"),this},t.removeAll=function(){this._acl=""},t.removePermission=function(t,n){for(var e=0;e<n.length;e++){var i=n[e];t.permissions.indexOf(i)>=0&&(t.permissions=t.permissions.replace(i,""))}},t.replaceLines=function(t){for(var n=this._acl.split("\n"),e=0;e<n.length;e++){var i=t(n[e]);i&&(n[e]=i)}},t.toObject=function(t){var n={};if(!t)return n;var e=t.split(":");return t.length>0&&(n.type=t.charAt(0),n.flags=e[1],n.principal=e[2],n.permissions=e[3]),n}}(this)},Z=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof Z))return new Z(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=Z._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};Z._classInfo={name:"nfs4_acl"},Z.prototype=new Y,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.nfs4_acl=Z,this.nfs4_acl=Z):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.nfs4_acl=Z:this.nfs4_acl=Z}.call(new Function("return this")());var n=function(){!function(t){var n,e,i,r,o;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,a;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,a=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],a=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),a||(a=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var s=0,c=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var f=0;f<o.length;f++){var u=o[f];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.fn(),h.nextTime=a+h.step),h.until&&h.until<a&&delete r[l]}t(c),s=a};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"later"},e.prototype=new n;var l=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,r=[],o=new Array(e);return this.then(function(){var t=h();return 0==n.length&&t.resolve([]),n.forEach(function(n,a){n.then?(r.push(n),n.then(function(n){o[a]=n,i++,i==e&&t.resolve(o)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var r=i.length,o=!1,a=!1,s=0,c=[],f=e||{};return this.then(function(){var n=h();return i.forEach(function(e){e.then?(c.push(e),e.then(function(e){s++,o=t(e,f),(o&&!a||0==a&&r==s)&&(n.resolve(f),a=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){t(function(t){i.resolve(t)},function(t){i.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new h(t,n),r=this;return 1==this._state&&e().asap(function(){r.fulfill(r.value())}),2==this._state&&e().asap(function(){r.reject(r.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},h=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof h))return new h(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};h._classInfo={name:"_promise"},h.prototype=new l;var $=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t._getGroupNames=function(t,n){var e=h(),i=e,r=[],o=this._groups;return t.forEach(function(t){return n.indexOf(t)>=0?void r.push({id:t,name:t}):void(i=i.then(function(){return o.readFile(t)}).then(function(n){return r.push({id:t,name:n}),r}).fail(function(n){console.error("Error reading group index with "+n+" FOR "+t)}))}),i=i.then(function(){return r}),e.resolve(!0),i},t.addUserToGroup=function(t,n){var e=this,i=e._udata;return h(function(e){i.readFile(t).then(function(e){var r=JSON.parse(e);return r.groups.indexOf(n)<0&&r.groups.push(n),i.writeFile(t,JSON.stringify(r))}).then(function(){e({result:!0,text:"User added to the group"})})})},t.changePassword=function(t,n){var e=this._users,i=this,r=i._udata;return h(function(o){r.readFile(t).then(function(r){var o=JSON.parse(r);return e.writeFile(o.hash,i.hash(n)+":"+t+":"+o.domain)}).then(function(){o({result:!0,text:"Password changed"})}).fail(function(){o([])})})},t.changeUsername=function(t,n,e){var i=this._users,r=this,o=r._udata;return h(function(a){var s,c,f,u;o.readFile(t).then(function(t){return c=JSON.parse(t),u=e||c.domain,i.readFile(c.hash)}).then(function(t){return s=t,s?i.removeFile(c.hash):void 0}).then(function(){return s?(f=r.hash(n+":"+u),i.writeFile(f,s)):void 0}).then(function(){return s?(c.hash=f,c.userName=n,c.domain=u,o.writeFile(t,JSON.stringify(c))):void 0}).then(function(){a(s?{result:!0,text:"Username changed"}:{result:!1,text:"Could not change the username"})}).fail(function(){a({result:!1,text:"Could not change the username"})})})},t.createUser=function(t,n,e,i){i=i||"",e||(e=this.guid());var r=this.hash(t+":"+i),o=this,a={userName:t,domain:i,hash:r,groups:[]};return h(function(t){o.then(function(){var s=o._users,c=o._udata;s.isFile(r).then(function(f){f?s.readFile(r).then(function(n){var e=n.split(":");t({result:!0,userId:e[1]})}):s.writeFile(r,o.hash(n)+":"+e+":"+i).then(function(){return c.writeFile(e,JSON.stringify(a))}).then(function(){t({result:!0,userId:e})})})})})},t.getUserData=function(t){var n=this,e=n._udata;return h(function(n){e.readFile(t).then(function(t){var e=JSON.parse(t);n(e)}).fail(function(){n(null)})})},t.getUserGroups=function(t){var n=(this._users,this),e=(n._users,n._udata);return h(function(n){e.readFile(t).then(function(t){var e=JSON.parse(t);n(e.groups)}).fail(function(){n([])})})},t.hash=function(t){return en().sha3_256(t+this._salt)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._salt=n?n:"31337",this._fs=t;var e=this;this._fs.createDir("users").then(function(){return e._fs.createDir("groups")}).then(function(){return e._fs.createDir("domains")}).then(function(){return e._fs.createDir("udata")}).then(function(){e._users=t.getFolder("users"),e._groups=t.getFolder("groups"),e._domains=t.getFolder("domains"),e._udata=t.getFolder("udata"),e.resolve(!0)})}),t.login=function(t,n,e){var i=this;e||(e="");var r=this.hash(t+":"+e);return h(function(t){i.then(function(){var e,o=i._users,a=i._udata,s=!1;o.readFile(r).then(function(t){var r=t.split(":"),o=r[0],c=r[1],f=o==i.hash(n);return f?(s=!0,e=c,a.readFile(c)):void 0}).then(function(n){s?(n=JSON.parse(n),t({result:!0,userId:e,groups:n.groups,text:"Login successful"})):t({result:!1,text:"Login failed"})}).fail(function(){t({result:!1,text:"Login failed"})})})})},t.removeUserGroup=function(t,n){var e=this,i=e._udata;return h(function(e){i.readFile(t).then(function(e){var r=JSON.parse(e),o=r.groups.indexOf(n);return r.groups.indexOf(n)>=0&&r.groups.splice(o,1),i.writeFile(t,JSON.stringify(r))}).then(function(){e({result:!0,text:"Removed user from group"})})})}}(this)},tn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof tn))return new tn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=tn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};$.prototype=h.prototype,tn._classInfo={name:"authFuzz"},tn.prototype=new $,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.authFuzz=tn,this.authFuzz=tn):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.authFuzz=tn:this.authFuzz=tn}.call(new Function("return this")());var nn=function(){!function(t){var n,e,i,r,o,a,s;t._initSha=function(){o||(n="0123456789abcdef".split(""),e=[1,256,65536,16777216],i=[6,1536,393216,100663296],r=[0,8,16,24],o=[1,0,32898,0,32906,2147483648,2147516416,2147483648,32907,0,2147483649,0,2147516545,2147483648,32777,2147483648,138,0,136,0,2147516425,0,2147483658,0,2147516555,0,139,2147483648,32905,2147483648,32771,2147483648,32770,2147483648,128,2147483648,32778,0,2147483658,2147483648,2147516545,2147483648,32896,2147483648,2147483649,0,2147516424,2147483648],a=[],s=[])},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){this._initSha()
}),t.keccak=function(t,i,c){var f="string"!=typeof t;f&&t.constructor==root.ArrayBuffer&&(t=new Uint8Array(t)),void 0===i&&(i=512,c=e);var u,l,h,_,d,p,v,m,y,g,I,b,j,w,O,F,C,S,x,A,P,k,D,T,E,R,N,M,L,V,J,U,q,W,B,z,H,G,K,Q,X,Y,Z,$,tn,nn,en,rn,on,an,sn,cn,fn,un,ln,hn,_n,dn,pn,vn,mn,yn,gn,In,bn,jn,wn=!1,On=0,Fn=0,Cn=t.length,Sn=(1600-2*i)/32,xn=4*Sn;for(_=0;50>_;++_)s[_]=0;u=0;do{for(a[0]=u,_=1;Sn+1>_;++_)a[_]=0;if(f)for(_=Fn;Cn>On&&xn>_;++On)a[_>>2]|=t[On]<<r[3&_++];else for(_=Fn;Cn>On&&xn>_;++On)l=t.charCodeAt(On),128>l?a[_>>2]|=l<<r[3&_++]:2048>l?(a[_>>2]|=(192|l>>6)<<r[3&_++],a[_>>2]|=(128|63&l)<<r[3&_++]):55296>l||l>=57344?(a[_>>2]|=(224|l>>12)<<r[3&_++],a[_>>2]|=(128|l>>6&63)<<r[3&_++],a[_>>2]|=(128|63&l)<<r[3&_++]):(l=65536+((1023&l)<<10|1023&t.charCodeAt(++On)),a[_>>2]|=(240|l>>18)<<r[3&_++],a[_>>2]|=(128|l>>12&63)<<r[3&_++],a[_>>2]|=(128|l>>6&63)<<r[3&_++],a[_>>2]|=(128|63&l)<<r[3&_++]);for(Fn=_-xn,On==Cn&&(a[_>>2]|=c[3&_],++On),u=a[Sn],On>Cn&&xn>_&&(a[Sn-1]|=2147483648,wn=!0),_=0;Sn>_;++_)s[_]^=a[_];for(h=0;48>h;h+=2)v=s[0]^s[10]^s[20]^s[30]^s[40],m=s[1]^s[11]^s[21]^s[31]^s[41],y=s[2]^s[12]^s[22]^s[32]^s[42],g=s[3]^s[13]^s[23]^s[33]^s[43],I=s[4]^s[14]^s[24]^s[34]^s[44],b=s[5]^s[15]^s[25]^s[35]^s[45],j=s[6]^s[16]^s[26]^s[36]^s[46],w=s[7]^s[17]^s[27]^s[37]^s[47],O=s[8]^s[18]^s[28]^s[38]^s[48],F=s[9]^s[19]^s[29]^s[39]^s[49],d=O^(y<<1|g>>>31),p=F^(g<<1|y>>>31),s[0]^=d,s[1]^=p,s[10]^=d,s[11]^=p,s[20]^=d,s[21]^=p,s[30]^=d,s[31]^=p,s[40]^=d,s[41]^=p,d=v^(I<<1|b>>>31),p=m^(b<<1|I>>>31),s[2]^=d,s[3]^=p,s[12]^=d,s[13]^=p,s[22]^=d,s[23]^=p,s[32]^=d,s[33]^=p,s[42]^=d,s[43]^=p,d=y^(j<<1|w>>>31),p=g^(w<<1|j>>>31),s[4]^=d,s[5]^=p,s[14]^=d,s[15]^=p,s[24]^=d,s[25]^=p,s[34]^=d,s[35]^=p,s[44]^=d,s[45]^=p,d=I^(O<<1|F>>>31),p=b^(F<<1|O>>>31),s[6]^=d,s[7]^=p,s[16]^=d,s[17]^=p,s[26]^=d,s[27]^=p,s[36]^=d,s[37]^=p,s[46]^=d,s[47]^=p,d=j^(v<<1|m>>>31),p=w^(m<<1|v>>>31),s[8]^=d,s[9]^=p,s[18]^=d,s[19]^=p,s[28]^=d,s[29]^=p,s[38]^=d,s[39]^=p,s[48]^=d,s[49]^=p,C=s[0],S=s[1],on=s[11]<<4|s[10]>>>28,an=s[10]<<4|s[11]>>>28,J=s[20]<<3|s[21]>>>29,U=s[21]<<3|s[20]>>>29,gn=s[31]<<9|s[30]>>>23,In=s[30]<<9|s[31]>>>23,tn=s[40]<<18|s[41]>>>14,nn=s[41]<<18|s[40]>>>14,H=s[2]<<1|s[3]>>>31,G=s[3]<<1|s[2]>>>31,x=s[13]<<12|s[12]>>>20,A=s[12]<<12|s[13]>>>20,sn=s[22]<<10|s[23]>>>22,cn=s[23]<<10|s[22]>>>22,q=s[33]<<13|s[32]>>>19,W=s[32]<<13|s[33]>>>19,bn=s[42]<<2|s[43]>>>30,jn=s[43]<<2|s[42]>>>30,_n=s[5]<<30|s[4]>>>2,dn=s[4]<<30|s[5]>>>2,K=s[14]<<6|s[15]>>>26,Q=s[15]<<6|s[14]>>>26,P=s[25]<<11|s[24]>>>21,k=s[24]<<11|s[25]>>>21,fn=s[34]<<15|s[35]>>>17,un=s[35]<<15|s[34]>>>17,B=s[45]<<29|s[44]>>>3,z=s[44]<<29|s[45]>>>3,N=s[6]<<28|s[7]>>>4,M=s[7]<<28|s[6]>>>4,pn=s[17]<<23|s[16]>>>9,vn=s[16]<<23|s[17]>>>9,X=s[26]<<25|s[27]>>>7,Y=s[27]<<25|s[26]>>>7,D=s[36]<<21|s[37]>>>11,T=s[37]<<21|s[36]>>>11,ln=s[47]<<24|s[46]>>>8,hn=s[46]<<24|s[47]>>>8,en=s[8]<<27|s[9]>>>5,rn=s[9]<<27|s[8]>>>5,L=s[18]<<20|s[19]>>>12,V=s[19]<<20|s[18]>>>12,mn=s[29]<<7|s[28]>>>25,yn=s[28]<<7|s[29]>>>25,Z=s[38]<<8|s[39]>>>24,$=s[39]<<8|s[38]>>>24,E=s[48]<<14|s[49]>>>18,R=s[49]<<14|s[48]>>>18,s[0]=C^~x&P,s[1]=S^~A&k,s[10]=N^~L&J,s[11]=M^~V&U,s[20]=H^~K&X,s[21]=G^~Q&Y,s[30]=en^~on&sn,s[31]=rn^~an&cn,s[40]=_n^~pn&mn,s[41]=dn^~vn&yn,s[2]=x^~P&D,s[3]=A^~k&T,s[12]=L^~J&q,s[13]=V^~U&W,s[22]=K^~X&Z,s[23]=Q^~Y&$,s[32]=on^~sn&fn,s[33]=an^~cn&un,s[42]=pn^~mn&gn,s[43]=vn^~yn&In,s[4]=P^~D&E,s[5]=k^~T&R,s[14]=J^~q&B,s[15]=U^~W&z,s[24]=X^~Z&tn,s[25]=Y^~$&nn,s[34]=sn^~fn&ln,s[35]=cn^~un&hn,s[44]=mn^~gn&bn,s[45]=yn^~In&jn,s[6]=D^~E&C,s[7]=T^~R&S,s[16]=q^~B&N,s[17]=W^~z&M,s[26]=Z^~tn&H,s[27]=$^~nn&G,s[36]=fn^~ln&en,s[37]=un^~hn&rn,s[46]=gn^~bn&_n,s[47]=In^~jn&dn,s[8]=E^~C&x,s[9]=R^~S&A,s[18]=B^~N&L,s[19]=z^~M&V,s[28]=tn^~H&K,s[29]=nn^~G&Q,s[38]=ln^~en&on,s[39]=hn^~rn&an,s[48]=bn^~_n&pn,s[49]=jn^~dn&vn,s[0]^=o[h],s[1]^=o[h+1]}while(!wn);var An="";for(_=0,h=i/32;h>_;++_)d=s[_],An+=n[d>>4&15]+n[15&d]+n[d>>12&15]+n[d>>8&15]+n[d>>20&15]+n[d>>16&15]+n[d>>28&15]+n[d>>24&15];return An},t.keccak_224=function(t){return this.keccak(t,224,e)},t.keccak_256=function(t){return this.keccak(t,256,e)},t.keccak_512=function(t){return this.keccak(t,512,e)},t.sha3_224=function(t){return this.keccak(t,224,i)},t.sha3_256=function(t){return this.keccak(t,256,i)},t.sha3_512=function(t){return this.keccak(t,512,i)}}(this)},en=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof en))return new en(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=en._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};en._classInfo={name:"_sha3"},en.prototype=new nn,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._sha3=en,this._sha3=en):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._sha3=en:this._sha3=en}.call(new Function("return this")());var rn=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},on=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof on))return new on(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=on._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};on._classInfo={name:"authModule"},on.prototype=new rn;var n=function(){!function(t){var n,e,i,r,o,a;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.after=function(t,n,e){e||(e="aft7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="t7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){a=1,this.polyfill();var t,s;if("undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var c=0,f=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var s=0;s<o.length;s++){var u=o[s];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.remove?h.nextTime>0?(h.fn(),delete r[l]):h.nextTime=a+h.step:(h.fn(),h.nextTime=a+h.step)),h.until&&h.until<a&&delete r[l]}t(f),c=a};f(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,r,o,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"later"},e.prototype=new n;var l=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,r=[],o=new Array(e);return this.then(function(){var t=h();return 0==n.length&&t.resolve([]),n.forEach(function(n,a){n.then?(r.push(n),n.then(function(n){o[a]=n,i++,i==e&&t.resolve(o)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var r=i.length,o=!1,a=!1,s=0,c=[],f=e||{};return this.then(function(){var n=h();return i.forEach(function(e){e.then?(c.push(e),e.then(function(e){s++,o=t(e,f),(o&&!a||0==a&&r==s)&&(n.resolve(f),a=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){t(function(t){i.resolve(t)},function(t){i.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new h(t,n),r=this;return 1==this._state&&e().asap(function(){r.fulfill(r.value())}),2==this._state&&e().asap(function(){r.reject(r.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},h=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof h))return new h(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};h._classInfo={name:"_promise"},h.prototype=new l;var an=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t._cursorAction=function(t,n,e){var i,r=h(),o=this._db.transaction(this._table,t),a=o.objectStore(this._table);if(n){var s,c;for(var f in n)n.hasOwnProperty(f)&&(c=f,s=IDBKeyRange.only(n[f]));if(!c)return void r.reject("invalid index key");var u=a.index(c);i=u.openCursor(s)}else i=a.openCursor();return o.oncomplete=function(){r.resolve(!0)},i.onerror=function(t){console.log(t)},i.onsuccess=function(t){var n=t.target.result;n&&(e(n),n.continue())},r},t.addRows=function(t){var n=h(),e=this._db.transaction([this._table],"readwrite");e.oncomplete=function(){n.resolve(!0)},e.onerror=function(t){n.reject(t)};var i=e.objectStore(this._table);for(var r in t){var o=i.add(t[r]);o.onsuccess=function(){}}return n},t.clear=function(){var t=h(),n=this._db.transaction(this._table,"readwrite"),e=n.objectStore(this._table),i=e.clear();return i.onerror=function(n){t.fail(n.target.errorCode)},i.onsuccess=function(){t.resolve(!0)},t},t.count=function(){var t=h(),n=this._db.transaction([this._table],"readonly");return n.objectStore(this._table).count().onsuccess=function(n){t.resolve(n.target.result)},t},t.forEach=function(t,n){return this._cursorAction("readonly",n,function(n){t(n.value,n)})},t.get=function(t){var n=h(),e=this._db.transaction(this._table,"readonly"),i=e.objectStore(this._table),r=i.get(t);return r.onerror=function(e){console.log("Could not get ",t),n.fail(e.target.errorCode)},r.onsuccess=function(){n.resolve(r.result)},n},t.getAll=function(t){var n=[],e=this;return h(function(i,r){e._cursorAction("readonly",t,function(t){n.push(t.value)}).then(function(){i(n)}).fail(r)})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._db=t,this._table=n}),t.readAndDelete=function(t){var n=[],e=this;return h(function(i,r){e._cursorAction("readwrite",t,function(t){n.push(t.value),t.delete()}).then(function(){i(n)}).fail(r)})},t.remove=function(t){var n=this;return h(function(e,i){n._cursorAction("readwrite",t,function(t){t.delete()}).then(function(){e(!0)}).fail(i)})},t.update=function(t,n){var e=h(),i=this,r=this._db.transaction([this._table],"readwrite"),o=r.objectStore(this._table);try{var a=o.get(t);a.onerror=function(t){return a.result?void e.fail(t.target.errorCode):void i.addRows([n]).then(function(){e.resolve(n)})},a.onsuccess=function(){if(!a.result)return void i.addRows([n]).then(function(){e.resolve(n)});var t=o.put(n);t.onerror=function(){e.fail("update failed ")},t.onsuccess=function(){e.resolve(n)}}}catch(s){return this.addRows([n])}return e}}(this)},sn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof sn))return new sn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=sn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};sn._classInfo={name:"dbTable"},sn.prototype=new an;var cn=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,e,i;t._initDB=function(){i||(i=window.indexedDB,n=!0,e=fn("sys.db",{tables:{databases:{createOptions:{keyPath:"name"}}}}))},t.clearDatabases=function(t){e.then(function(){var n=e.table("databases");n.forEach(function(n,e){t(n)&&(i.deleteDatabase(n.name),e.delete())})})},t.getDB=function(){return this._db},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(!this._db&&(this._initDB(),t)){var r=this,o=i.open(t,4);o.onerror=function(t){console.error(t.target.errorCode)},o.onsuccess=function(n){e.then(function(){var n=e.table("databases");n.addRows([{name:t}])}),r._db=n.target.result,r.resolve(!0)},o.onupgradeneeded=function(t){var e=t.target.result;if(r._db=e,n&&n.tables)for(var i in n.tables)if(n.tables.hasOwnProperty(i)){var o=n.tables[i],a=e.createObjectStore(i,o.createOptions);if(o.indexes)for(var s in o.indexes)if(o.indexes.hasOwnProperty(s)){var c=o.indexes[s];a.createIndex(s,s,c)}}}}}),t.table=function(t){return sn(this._db,t)}}(this)},fn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof fn))return new fn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=fn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};cn.prototype=h.prototype,fn._classInfo={name:"_localDB"},fn.prototype=new cn;var un=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t._isFile=function(t){var n=this._pathObj;return"undefined"==typeof n[t]||this.isObject(n[t])?!1:!0},t._isFolder=function(t){var n=this._pathObj;return"undefined"!=typeof n[t]&&this.isObject(n[t])?!0:!1},t.appendFile=function(t,n){var e=this;return h(function(i,r){var o=e._pathObj;return"string"!=typeof n?void r({result:!1,text:"Only string writes are accepted"}):void(e._isFile(t)?(o[t]+=n,i({result:!0})):(o[t]=n,i({result:!0,text:"Created the file"})))})},t.createDir=function(t){var n=this;return h(function(e){var i=n._pathObj;n._isFile(t)||n._isFolder(t)||(i[t]={}),e({result:!0})})},t.findPath=function(t){"/"==t.charAt(0)&&(t=t.substring(0));var n=t.trim().split("/"),e=this;return h(function(t){if(!n[0])return void t(e);var i,r;n.forEach(function(n){if(n&&0!=n.trim().length){if(!e)return void t(!1);i?i=i.then(function(t){return r=t,t?t.isFolder(n):!1}):(r=e,i=e.isFolder(n)),i=i.then(function(t){return t?r.getFolder(n):!1})}}),i.then(t)})},t.fromData=function(t){var n=this;return h(function(e,i){n._pathObj||(n._pathObj={});var r=[],o=h();for(var a in t)if(n.isObject(t[a])){n._pathObj[a]&&n._isFolder(a)||(n._pathObj[a]={});var s=ln(n._server,n._pathObj[a]);r.push(s.fromData(t[a]))}else t[a]===!0||(n._pathObj[a]=t[a]);o.all(r).then(function(){e(!0)}).fail(i),o.resolve(!0)})},t.getFolder=function(t){return this.getSubFolderObj(t)},t.getSubFolderObj=function(t){return this.isObject(this._pathObj[t])?ln(this._server,this._pathObj[t]):void 0},t.getTree=function(){var t=this.toData({getData:!1});return t},t.id=function(){return this._id},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._server=t,this._pathObj=n,this._id=this.guid()}),t.isFile=function(t){var n=this;return h(function(e){e(n._isFile(t))})},t.isFolder=function(t){var n=this;return h(function(e){e(n._isFolder(t))})},t.linesToJsonArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t.listFiles=function(){var t=this;return h(function(n){var e=t._pathObj,i=[];for(var r in e)t._isFile(r)&&i.push(r);n(i)})},t.listFolders=function(){var t=this;return h(function(n){var e=t._pathObj,i=[];for(var r in e)t._isFolder(r)&&i.push(r);n(i)})},t.readFile=function(t){var n=this;return h(function(e,i){var r=n._pathObj;return n._isFile(t)?void e(r[t]):void i("File does not exist")})},t.removeFile=function(t){var n=this;return h(function(e){var i=n._pathObj;n._isFile(t)&&delete i[t],e({result:!0,text:"file "+t+" removed"})})},t.toData=function(t){var n=(this._rootDir,this),t=t||{},e=t.fileFilter,i=t.dirFilter;return"undefined"==typeof t.getData&&(t.getData=!0),h(function(r){var o={};n.listFiles().then(function(i){var r=i.length,a=0,s=h();return i.forEach(function(i){return e&&!e(i)?(a++,void(a==r&&s.resolve(!0))):void(t.getData?n.readFile(i).then(function(t){o[i]=t,a++,a==r&&s.resolve(!0)}):(o[i]=!0,a++,a==r&&s.resolve(!0)))}),0==r&&s.resolve(!0),s}).then(function(){return n.listFolders()}).then(function(t){var r=t.length,a=0,s=h();return t.forEach(function(t){if(i&&!i(t))return a++,void(a==r&&s.resolve(!0));var c=n.getSubFolderObj(t);c.toData(e,i).then(function(n){o[t]=n,a++,a==r&&s.resolve(!0)})}),0==r&&s.resolve(!0),s}).then(function(){r(o)}).fail(function(){r({})})})},t.writeFile=function(t,n){var e=this;return h(function(i,r){var o=e._pathObj;return"string"!=typeof n?void r({result:!1,text:"Only string writes are accepted"}):e._isFolder(t)?void r({result:!1,text:"Modifying the file failed"}):(o[t]=n,void i({result:!0}))})}}(this)},ln=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof ln))return new ln(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=ln._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};ln._classInfo={name:"memoryFsFolder"},ln.prototype=new un,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.memoryFsFolder=ln,this.memoryFsFolder=ln):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.memoryFsFolder=ln:this.memoryFsFolder=ln}.call(new Function("return this")());var hn=function(){!function(t){var n;t._initServers=function(){n||(n={})},t.getRootFolder=function(){var t=this;return ln(t,t._fsData)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._serverName=t,this._initServers(),this._fsData=n||{},this.resolve(!0)})}(this)},_n=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof _n))return new _n(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=_n._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};hn.prototype=h.prototype,_n._classInfo={name:"fsServerMemory"},_n.prototype=new hn,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.fsServerMemory=_n,this.fsServerMemory=_n):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.fsServerMemory=_n:this.fsServerMemory=_n}.call(new Function("return this")());var dn=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,e;t._mkDir=function(t){if("string"!=typeof t)throw console.log(JSON.stringiry(t)),console.log("--- is not object"),"WRROR";n.existsSync(t)||n.mkdirSync(t,502,function(){})},t.appendFile=function(t,i){var r=this._rootDir;return h(function(o,a){if("string"!=typeof i)return void a({result:!1,text:"Only string writes are accepted"});t=e.basename(t);var s=r+"/"+t;n.appendFile(s,i,function(t){return t?void a(t):void o({result:!0,text:"File written"})})})},t.createDir=function(t){var n=this._rootDir,i=this;return h(function(r){var o=e.basename(t);i._mkDir(n+"/"+o),r({result:!0,text:"Directory created"})})},t.findPath=function(t){"/"==t.charAt(0)&&(t=t.substring(0));var n=t.trim().split("/"),e=this;return h(function(t){if(!n[0])return void t(e);var i,r;n.forEach(function(n){if(n&&0!=n.trim().length){if(!e)return void t(!1);i?i=i.then(function(t){return r=t,t?t.isFolder(n):!1}):(r=e,i=e.isFolder(n)),i=i.then(function(t){return t?r.getFolder(n):!1})}}),i.then(t)})},t.fromData=function(t){{var n=this;this._rootDir}return h(function(i,r){var o=[],a=h();for(var s in t){if(s.indexOf("..")>=0)return void r(".. symbol is not allowed in the file or path names");var c=e.basename(s);n.isObject(t[c])?!function(t,e){var i=h();o.push(i),n.createDir(e).then(function(){var i=n.getSubFolderObj(e);return i.fromData(t[e])}).then(function(){i.resolve()}).fail(function(){i.resolve()})}(t,c):"string"==typeof t[c]&&o.push(n.writeFile(c,t[c]))}a.all(o).then(function(){i(!0)}).fail(r),a.resolve(!0)})},t.getFolder=function(t){return this.getSubFolderObj(t)},t.getSubFolderObj=function(t){return pn(this._rootDir+"/"+t)},t.getTree=function(){return this.toData({getData:!1})},t.id=function(){return this._id},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t){if(this._rootDir=t,this._id=this.guid(),!t)throw" The directory must be specified ";if("string"!=typeof t)throw" The directory must be string ";if(t.indexOf("..")>=0||t.indexOf("~")>=0)throw"The directory must not contain relative path parts";n||(n=require("fs"),e=require("path"))}),t.isFile=function(t){var i=this._rootDir;return h(function(r){t=e.basename(t),n.stat(i+"/"+t,function(t,n){return t||!n.isFile()?void r(!1):void r(!0)})})},t.isFolder=function(t){var i=this._rootDir;return h(function(r){t=e.basename(t),n.stat(i+"/"+t,function(t,n){return t||!n.isDirectory()?void r(!1):void r(!0)})})},t.linesToJsonArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t.listFiles=function(){var t=this._rootDir;return h(function(e,i){n.readdir(t,function(r,o){if(r)return void i(r);var a=o.length,s=[];0==a&&e(s),o.forEach(function(i){n.stat(t+"/"+i,function(t,n){!t&&n.isFile()&&s.push(i),a--,0==a&&e(s)})})})})},t.listFolders=function(){var t=this._rootDir;return h(function(e,i){n.readdir(t,function(r,o){if(console.log(o),r)return void i(r);var a=o.length,s=[];0==a&&e(s),o.forEach(function(i){n.stat(t+"/"+i,function(t,n){!t&&n.isDirectory()&&(console.log("Dir "+i),s.push(i)),a--,0==a&&(console.log("Cnt == 0"),e(s))})})})})},t.readFile=function(t){var i=this._rootDir;return h(function(r,o){t=e.basename(t),n.readFile(i+"/"+t,"utf8",function(t,n){return t?void o(t):void r(n)})})},t.removeFile=function(t){var i=this._rootDir;return h(function(r,o){t=e.basename(t),n.unlink(i+"/"+t,function(n){return n?void o(n):void r({result:!0,text:"file "+t+" removed"})})})},t.toData=function(t){var n=(this._rootDir,this),t=t||{},e=t.fileFilter,i=t.dirFilter;return"undefined"==typeof t.getData&&(t.getData=!0),h(function(r){var o={};n.listFiles().then(function(i){var r=i.length,a=0,s=h();return i.forEach(function(i){return e&&!e(i)?(a++,void(a==r&&s.resolve(!0))):void(t.getData?n.readFile(i).then(function(t){o[i]=t,a++,a==r&&s.resolve(!0)}):(o[i]=!0,a++,a==r&&s.resolve(!0)))}),0==r&&s.resolve(!0),s}).then(function(){return n.listFolders()}).then(function(t){var r=t.length,a=0,s=h();return t.forEach(function(t){if(i&&!i(t))return a++,void(a==r&&s.resolve(!0));var c=n.getSubFolderObj(t);c.toData(e,i).then(function(n){o[t]=n,a++,a==r&&s.resolve(!0)})}),0==r&&s.resolve(!0),s}).then(function(){r(o)}).fail(function(){r({})})})},t.writeFile=function(t,i){var r=this._rootDir;return h(function(o,a){return"string"!=typeof i?void a({result:!1,text:"Only string writes are accepted"}):(t=e.basename(t),void n.writeFile(r+"/"+t,i,function(t){return t?void a(t):void o({result:!0,text:"File written"})}))})}}(this)},pn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof pn))return new pn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=pn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};pn._classInfo={name:"nodeFsFolder"},pn.prototype=new dn,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.nodeFsFolder=pn,this.nodeFsFolder=pn):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.nodeFsFolder=pn:this.nodeFsFolder=pn}.call(new Function("return this")());var vn=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){var i=t.getID()+e;return n||(n={}),n[i]?n[i]:void(n[i]=this)}),t._filePath=function(t){var n=this._path+"/"+t;return n=n.replace("//","/")},t._initCreateDir=function(t){{var n=this,e=this._db;this._server}return h(function(i,r){n._isFolder(t).then(function(i){if(i)return"OK";var r={name:n._normalize(n._path+t+"/"),parentFolder:n._path};return e.table("folders").addRows([r])}).then(function(){i({result:!0,text:"folder "+t+" created"})}).fail(r)})},t._initFromData=function(t){{var n=this;this._db,this._server}return h(function(e,i){var r=[],o=h();for(var a in t){if(a.indexOf("..")>=0)return i(".. symbol is not allowed in the file or path names"),void e(!1);var s=a;n.isObject(t[s])?!function(t,e){var i=h();r.push(i),n._initCreateDir(e).then(function(){var i=n.getSubFolderObj(e);return i._initFromData(t[e])}).then(function(){i.resolve()}).fail(function(){i.resolve()})}(t,s):"string"==typeof t[s]&&r.push(n._writeFile(s,t[s]))}o.all(r).then(function(){e(!0)}).fail(i),o.resolve(!0)})},t._isFile=function(t){var n=this;return h(function(e,i){n._loadFiles().then(function(n){for(var i=0;i<n.length;i++)if(n[i].name==t)return void e(!0);e(!1)}).fail(i)})},t._isFolder=function(t){var n=this;return h(function(e,i){t=n._normalize(n._path+"/"+t+"/"),n._loadFolders().then(function(n){for(var i=0;i<n.length;i++)if(n[i].name==t)return void e(!0);e(!1)}).fail(i)})},t._lastPath=function(t){for(var n=t.split("/"),t=n.pop();n.length>0;){if(t.length>0)return t;t=n.pop()}return t},t._loadFiles=function(){var t=this._db,n=this;return h(function(e){t.table("files").getAll({folderName:n._path}).then(function(t){n._fileCache=t,e(n._fileCache)})})},t._loadFolders=function(){var t=this._db,n=this;return h(function(e){t.table("folders").getAll({parentFolder:n._path}).then(function(t){n._folderCache=t,e(n._folderCache)})})},t._normalize=function(t){var n=t.replace("//","/");return n},t._onlyClearWrites=function(t){var n=this,e=this._db,i=this._server;return h(function(r,o){i.then(function(){return n._isFile(t)}).then(function(i){return i?"OK":e.table("files").addRows([{name:t,folderName:n._path}])}).then(function(){return e.table("fileWrites").remove({filePath:n._filePath(t)})}).then(function(){r({result:!0,text:"writes cleared"})}).fail(o)
})},t._removeFileFromCache=function(t){if(this._fileCache)for(var n=0;n<this._fileCache.length;n++)if(this._fileCache[n].name==t)return void this._fileCache.splice(n,1)},t._removeFolderFromCache=function(t){if(this._folderCache)for(var n=0;n<this._fileCache.length;n++)if(this._folderCache[n].name==t)return void this._folderCache.splice(n,1)},t._writeFile=function(t,n){{var e=this,i=this._db;this._server}return console.log("writeFile ",t,n),h(function(r,o){return"string"!=typeof n?void o({result:!1,text:"Only string writes are accepted"}):void e._isFile(t).then(function(n){return n?"OK":i.table("files").addRows([{name:t,folderName:e._path}])}).then(function(){return i.table("fileWrites").remove({filePath:e._filePath(t)})}).then(function(){return i.table("fileWrites").addRows([{filePath:e._filePath(t),data:n}])}).then(function(){r({result:!0,text:"file "+t+" written"})}).fail(o)})},t.appendFile=function(t,n){var e=this,i=this._db,r=this._server;return h(function(o,a){return"string"!=typeof n?void a({result:!1,text:"Only string writes are accepted"}):void r.then(function(){return e._isFile(t)}).then(function(n){return n?"OK":i.table("files").addRows([{name:t,folderName:e._path}])}).then(function(){return i.table("fileWrites").addRows([{filePath:e._filePath(t),data:n}])}).then(function(){o({result:!0,text:"file "+t+" written"})}).fail(a)})},t.createDir=function(t){var n=this,e=this._db,i=this._server;return h(function(r,o){i.then(function(){return n._isFolder(t)}).then(function(i){if(i)return"OK";var r={name:n._normalize(n._path+t+"/"),parentFolder:n._path};return e.table("folders").addRows([r])}).then(function(){r({result:!0,text:"folder "+t+" created"})}).fail(o)})},t.findPath=function(t){"/"==t.charAt(0)&&(t=t.substring(0));var n=t.trim().split("/"),e=this;return h(function(t){if(!n[0])return void t(e);var i,r;n.forEach(function(n){if(n&&0!=n.trim().length){if(!e)return void t(!1);i?i=i.then(function(t){return r=t,t?t.isFolder(n):!1}):(r=e,i=e.isFolder(n)),i=i.then(function(t){return t?r.getFolder(n):!1})}}),i.then(t)})},t.fromData=function(t){var n=this,e=(this._db,this._server);return h(function(i,r){var o=[],a=h();e.then(function(){for(var e in t){if(e.indexOf("..")>=0)return void r(".. symbol is not allowed in the file or path names");var s=e;n.isObject(t[s])?!function(){var e=h();o.push(e),n.createDir(s).then(function(){var e=n.getSubFolderObj(s);return e.fromData(t[s])}).then(function(){e.resolve()}).fail(function(){e.resolve()})}():"string"==typeof t[s]&&o.push(n.writeFile(s,t[s]))}a.all(o).then(function(){i(!0)}).fail(r),a.resolve(!0)})})},t.getFolder=function(t){return this.getSubFolderObj(t)},t.getSubFolderObj=function(t){var n=this._normalize(this._path+t+"/");return mn(this._server,n)},t.getTree=function(){var t=this.toData({getData:!1});return t},t.id=function(){return this._id},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._server=t,this._path=n,this._id=this.guid(),this._db=t.getDb()}),t.isFile=function(t){var n=this;return h(function(e){e(n._isFile(t))})},t.isFolder=function(t){var n=this;return h(function(e){e(n._isFolder(t))})},t.linesToJsonArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t.listFiles=function(){var t=this,n=(this._db,this._server);return h(function(e,i){n.then(function(){t._loadFiles().then(function(t){var n=[];t.forEach(function(t){n.push(t.name)}),e(n)})}).fail(i)})},t.listFolders=function(){var t=this,n=(this._db,this._server);return h(function(e,i){n.then(function(){t._loadFolders().then(function(t){var n=[];t.forEach(function(t){n.push(t.name)}),e(n)})}).fail(i)})},t.readFile=function(t){var n=this,e=this._db,i=this._server;return h(function(r,o){i.then(function(){return n._isFile(t)}).then(function(t){if(t)return"OK";throw"The file does not exist"}).then(function(){return e.table("fileWrites").getAll({filePath:n._filePath(t)})}).then(function(t){var n="";t.forEach(function(t){n+=t.data}),r(n)}).fail(o)})},t.removeFile=function(t){var n=this,e=this._db,i=this._server;return h(function(r,o){var a=!1;i.then(function(){return n._isFile(t)}).then(function(i){return a=i,i?e.table("fileWrites").remove({filePath:n._filePath(t)}):"OK"}).then(function(){return a?e.table("files")._cursorAction("readwrite",{folderName:n._path},function(e){var i=e.value;i.name==t&&(e.delete(),n._removeFileFromCache(t))}):"OK"}).then(function(){r({result:!0,text:"file "+t+" removed"})}).fail(o)})},t.toData=function(t){var n=this,t=t||{},e=t.fileFilter,i=t.dirFilter;return"undefined"==typeof t.getData&&(t.getData=!0),h(function(r){var o={};n.listFiles().then(function(i){var r=i.length,a=0,s=h();return i.forEach(function(i){return e&&!e(i)?(a++,void(a==r&&s.resolve(!0))):void(t.getData?n.readFile(i).then(function(t){o[i]=t,a++,a==r&&s.resolve(!0)}):(o[i]=!0,a++,a==r&&s.resolve(!0)))}),0==r&&s.resolve(!0),s}).then(function(){return n.listFolders()}).then(function(t){var r=t.length,a=0,s=h();return t.forEach(function(t){if(i&&!i(t))return a++,void(a==r&&s.resolve(!0));var c=n._lastPath(t),f=n.getSubFolderObj(c);f.toData(e,i).then(function(t){o[c]=t,a++,a==r&&s.resolve(!0)})}),0==r&&s.resolve(!0),s}).then(function(){r(o)}).fail(function(){r({})})})},t.writeFile=function(t,n){var e=this,i=this._db,r=this._server;return h(function(o,a){return"string"!=typeof n?void a({result:!1,text:"Only string writes are accepted"}):void r.then(function(){return e._isFile(t)}).then(function(n){return n?"OK":i.table("files").addRows([{name:t,folderName:e._path}])}).then(function(){return i.table("fileWrites").remove({filePath:e._filePath(t)})}).then(function(){return i.table("fileWrites").addRows([{filePath:e._filePath(t),data:n}])}).then(function(){o({result:!0,text:"file "+t+" written"})}).fail(a)})}}(this)},mn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof mn))return new mn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=mn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};mn._classInfo={name:"indexedDBFsFolder"},mn.prototype=new vn,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.indexedDBFsFolder=mn,this.indexedDBFsFolder=mn):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.indexedDBFsFolder=mn:this.indexedDBFsFolder=mn}.call(new Function("return this")());var yn=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){return n||(n={}),n[t]?n[t]:void(n[t]=this)}),t.createFrom=function(){},t.getDb=function(){return this._db},t.getID=function(){return this._id||(this._id=this.guid()),this._id},t.getRootFolder=function(){return mn(this,"/")},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){var e=this;this._serverName=t,this._dbName="vserver://"+t,this._db=fn(this._dbName,{tables:{folders:{createOptions:{keyPath:"name"},indexes:{parentFolder:{unique:!1}}},files:{createOptions:{autoIncrement:!0},indexes:{folderName:{unique:!1}}},fileWrites:{createOptions:{autoIncrement:!0},indexes:{filePath:{unique:!1}}}}}),this._db.then(function(){e._db.table("folders").count().then(function(t){t>=1?n?e.getRootFolder()._initFromData(n).then(function(){e.resolve(!0)}):e.resolve(!0):e._db.table("folders").addRows([{name:"/"}]).then(function(){n?e.getRootFolder()._initFromData(n).then(function(){e.resolve(!0)}):e.resolve(!0)})})})})}(this)},gn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof gn))return new gn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=gn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};yn.prototype=h.prototype,gn._classInfo={name:"fsServerIndexedDB"},gn.prototype=new yn,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.fsServerIndexedDB=gn,this.fsServerIndexedDB=gn):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.fsServerIndexedDB=gn:this.fsServerIndexedDB=gn}.call(new Function("return this")());var In=function(){!function(t){var n;t._initServers=function(){n||(n={})},t.getRootFolder=function(){var t=this._fsRoot;if(!t||t.length<15||t.indexOf("..")>=0)throw"Invalid root folder";var n=this;return pn(n._fsRoot)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(!t||t.length<15||t.indexOf("..")>=0)throw"Invalid root folder";this._fsRoot=t;var e=this;n?this.getRootFolder().fromData(n).then(function(){e.resolve(!0)}):this.resolve(!0)})}(this)},bn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof bn))return new bn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=bn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};In.prototype=h.prototype,bn._classInfo={name:"fsServerNode"},bn.prototype=new In,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.fsServerNode=bn,this.fsServerNode=bn):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.fsServerNode=bn:this.fsServerNode=bn}.call(new Function("return this")());var jn=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},wn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof wn))return new wn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=wn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};wn._classInfo={name:"localFs"},wn.prototype=new jn;var On=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.constructClientToServer=function(t){var n=t.data;t.last_sent||(t.last_sent=[]);var e=t.last_sent[1]||0,i=n._journal.length;if(t.last_update){e<t.last_update[1]&&(e=t.last_update[1]);var r=t.last_update[1]||0;if(r>=i)return null}if(e==i)return null;console.log("clientToServer"),console.log(t.last_update),console.log(e,i),t.last_sent[0]=e,t.last_sent[1]=i;var o={id:this.guid(),c:n._journal.slice(e,i),start:e,end:i,version:t.version};if(t.client)for(var a=0;a<o.c.length;a++){var s=o.c[a];o.c[a]=t.client._transformCmdFromNs(s)}return o},t.constructServerToClient=function(t){var n=t.data;t.last_update||(t.last_update=[]);var e=t.last_update[1]||0,i=n._journal.length;return e==i?null:(t.last_update[0]=e,t.last_update[1]=i,{c:n._journal.slice(e,i),start:e,end:i,version:t.version})},t.deltaClientToServer=function(t,n){if(t){n._done||(n._done={}),console.log("Processing client frame"),console.log(JSON.stringify(t));try{if(!t.id)return;if(n._done[t.id])return res;n._done[t.id]=!0;for(var e=n.data,i=[],r=0;r<t.c.length;r++){var o=t.c[r],a=e.execCmd(o);a!==!0&&i.push(a)}var s={errors:i};return console.log(JSON.stringify(s)),s}catch(c){return c.message}}},t.deltaServerToClient=function(t,n){if(t){var e=n.data;n.last_update||(n.last_update=[]);var i={goodCnt:0,oldCnt:0,newCnt:0,reverseCnt:0};console.log("deltaServerToClient"),console.log(n.last_update);var r=t.start;if(n.needsRefresh)return void console.log("** client needs refresh **");if(t.start>e._journal.length)return console.log("--- setting refresh on because of ---- "),console.log(" updateFrame.start > data._journal.length "),n.needsRefresh=!0,i.fail=!0,i;if(n.client)for(var o=t.start;o<t.end;o++){var a=t.c[o-t.start];t.c[o-t.start]=n.client._transformCmdToNs(a)}for(var o=t.start;o<t.end;o++){var s=e.getJournalCmd(o),a=t.c[o-t.start],c=!0;if(s){if(13==s[0]&&13==a[0]&&s[4]==a[4]&&s[1]==a[1]){var f=s[2],u=a[2];if(f.length!=u.length)c=!1;else for(var l=0;l<f.length&&c;l++){for(var h=f[l],_=u[l],d=0;5>d;d++)if(h[d]!=_[d]){console.log("not same ",d,h[d],_[d]),c=!1;break}if(c)if(this.isArray(h[5])){for(var h=h[5],_=_[5],p=Math.max(h.length||0,_.length||0),d=0;p>d;d++)if(h[d]!=_[d]){console.log("not same array ",d),c=!1;break}}else h[5]!=_[5]&&(c=!1);c||(console.log("was not the same"),console.log(a,"vs",s))}}else for(var v=0;4>=v;v++)s[v]!=a[v]&&(c=!1,console.log("was not the same"),console.log(a[v],"vs",s[v]));if(!c){e.reverseToLine(r);for(var o=r;o<t.end;o++){var a=t.c[o-t.start],m=e.execCmd(a,!0);if(m!==!0)return console.log("--- setting refresh on because of ---- "),console.log(JSON.stringify(m)),n.needsRefresh=!0,i.fail=!0,i.reason=m,i;i.reverseCnt++}return n.last_update[0]=t.start,n.last_update[1]=t.end,i}r=o,i.goodCnt++,i.oldCnt++}else{var m=e.execCmd(a,!0);if(m!==!0)return console.log("--- setting refresh on because of ---- "),console.log(JSON.stringify(m)),n.needsRefresh=!0,i.fail=!0,i.reason=m,i;r=o,i.goodCnt++,i.newCnt++}}return n.last_update[0]=t.start,n.last_update[1]=t.end,i}}}(this)},Fn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof Fn))return new Fn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=Fn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};Fn._classInfo={name:"_chPolicy"},Fn.prototype=new On,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._chPolicy=Fn,this._chPolicy=Fn):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._chPolicy=Fn:this._chPolicy=Fn}.call(new Function("return this")());var Cn=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},Sn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof Sn))return new Sn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=Sn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};Sn._classInfo={name:"channelPolicyModule"},Sn.prototype=new Cn;var xn=function(){!function(t){t.helloWorld=function(){return"Hello World"}}(this)},An=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof An))return new An(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=An._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};xn.prototype=I.prototype,An._classInfo={name:"subClassTemplate"},An.prototype=new xn,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.subClassTemplate=An,this.subClassTemplate=An):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.subClassTemplate=An:this.subClassTemplate=An}.call(new Function("return this")());var Pn=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},kn=function(t,n,e,i,r,o,a,s){var c,f=this;if(!(f instanceof kn))return new kn(t,n,e,i,r,o,a,s);var u=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=kn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};kn._classInfo={name:"moshModule"},kn.prototype=new Pn,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());