(function(){var t={},e=function(){!function(t){t.clearEvents=function(){delete this._ev},t.on=function(t,e){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(e),this},t.trigger=function(t,e,n){if(this._ev&&this._ev[t]){var i=this;return this._ev[t].forEach(function(t){t(i,e,n)}),this}}}(this),function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var e,n;t.close=function(){this.trigger("disconnect")},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,e,i,r,a){this._server=t,this._port=e,this._role=r,this._socketId=i,this._dbName="tcp://"+this._server+":"+this._port+":"+this._socketId,n||(n="undefined"!=typeof lokki?lokki("tcp"):{log:function(){},error:function(){}}),a?(this._socket=a,this.socketPump(r)):this.memoryPump(r)}),t.memoryPump=function(t){var i=this,a=this._dbName+":to",s=this._dbName+":from";e||(e={}),e[a]||(e[a]=[]),e[s]||(e[s]=[]);var o=function(){if("server"==t){var r=e[a].slice();r.forEach(function(t){n.log("server got message ",t),i.trigger("serverMessage",t),e[a].shift()})}if("client"==t){var r=e[s].slice();r.forEach(function(t){i.trigger("clientMessage",t),e[s].shift()})}};this._memoryFn=o,r().every(.1,o)},t.messageFrom=function(t){var n=this._socket;if(n)return void n.emit(this._dbName,t);var i=this._dbName+":from";e[i].push(t)},t.messageTo=function(t){var n=this._socket;if(n)return void n.emit(this._dbName,t);var i=this._dbName+":to";e[i].push(t)},t.release=function(){this.clearEvents();var t=this._socket;this._pumpListener&&t.removeListener(this._dbName,this._pumpListener),this._memoryFn&&this._memoryFn._release&&this._memoryFn._release()},t.socketPump=function(t){var e=this,n=this._socket;"server"==t&&(this._pumpListener=function(t){e.trigger("serverMessage",t)},n.on(this._dbName,this._pumpListener)),"client"==t&&(this._pumpListener=function(t){e.trigger("clientMessage",t)},n.on(this._dbName,this._pumpListener))}}(this)},n=function(t,e,i,r,a,s,o,c){var _,f=this;if(!(f instanceof n))return new n(t,e,i,r,a,s,o,c);var u=[t,e,i,r,a,s,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,u)}),"function"==typeof _){if(_._classInfo.name!=n._classInfo.name)return new _(t,e,i,r,a,s,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};n._classInfo={name:"_tcpEmu"},n.prototype=new e;var i=function(){!function(t){var e,n,i,r,a,s,o,c;t._easeFns=function(){o={easeIn:function(t){return t*t},easeOut:function(t){return-1*t*(t-2)},easeInOut:function(t){return.5>t?t*t:-1*t*(t-2)},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return(1-t)*(1-t)*(1-t)+1},pow:function(t){return Math.pow(t,parseFloat(1.5-t))},linear:function(t){return t}}},t.add=function(t,e,i){if(e||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),n.push([e,t,r])}else n.push(t)},t.addEasingFn=function(t,e){o[t]=e},t.after=function(t,e,n){n||(n="aft_"+s++),r[n]={step:Math.floor(1e3*t),fn:e,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.ease=function(t,e,n,i){var r=o[t];r||(r=o.pow);var a="e_"+s++;c[a]={easeFn:r,duration:e,cb:n,over:i}},t.every=function(t,e,n){n||(n="t7491_"+s++),r[n]={step:Math.floor(1e3*t),fn:e,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!e){this._easeFns(),s=1;var t,o;if("undefined"!=typeof window){var t=window.requestAnimationFrame,o=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(e){t||(t=window[e+"RequestAnimationFrame"],o=window[e+"CancelAnimationFrame"]||window[e+"CancelRequestAnimationFrame"])})}var _=new Function("try { return this == global; } catch(e) { return false; }")();_?t=function(t){return setImmediate(t)}:t||(t=function(t){return setTimeout(t,16)}),o||(o=function(t){clearTimeout(t)}),n=[],i={},r={},a=[],c={};var f=0,u=function(){var e=(new Date).getTime(),s=f-e;0==f&&(s=0);for(var o;o=n.shift();)"[object Array]"===Object.prototype.toString.call(o)?o[1].apply(o[0],o[2]):o();for(var _=0;_<a.length;_++){var h=a[_];h()}for(var l in c)if(c.hasOwnProperty(l)){var d=c[l];d.start||(d.start=e);var v=e-d.start,p=v/d.duration;p>=1&&(p=1,delete c[l]),d.cb(d.easeFn(p)),1==p&&d.over&&d.over()}for(var l in i)if(i.hasOwnProperty(l)){var d=i[l];d[0](d[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var d=r[l];d.nextTime<e&&(d.remove?d.nextTime>0?(d.fn(),delete r[l]):d.nextTime=e+d.step:(d.fn(),d.nextTime=e+d.step)),d.until&&d.until<e&&delete r[l]}t(u),f=e};u(),e=!0}}),t.once=function(t,e,n){i[t]=[e,n]},t.onFrame=function(t){a.push(t)},t.removeFrameFn=function(t){var e=a.indexOf(t);return e>=0?(t._onRemove&&t._onRemove(),a.splice(e,1),!0):!1}}(this)},r=function(t,e,n,i,a,s,o,c){var _,f=this;if(!(f instanceof r))return new r(t,e,n,i,a,s,o,c);var u=[t,e,n,i,a,s,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,u)}),"function"==typeof _){if(_._classInfo.name!=r._classInfo.name)return new _(t,e,n,i,a,s,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};r._classInfo={name:"later"},r.prototype=new i,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.later=r,this.later=r):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.later=r:this.later=r}.call(new Function("return this")());var a=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var e;e=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var n=e.length,i=0,r=[],a=new Array(n);return this.then(function(){var t=s();return 0==e.length&&t.resolve([]),e.forEach(function(e,s){e.then?(r.push(e),e.then(function(e){a[s]=e,i++,i==n&&t.resolve(a)},function(e){t.reject(e)})):t.reject("Not list of promises")}),t})},t.collect=function(t,e,n){var i;i=this.isArray(e)?e:[e];var r=i.length,a=!1,o=!1,c=0,_=[],f=n||{};return this.then(function(){var e=s();return i.forEach(function(n){n.then?(_.push(n),n.then(function(n){c++,a=t(n,f),(a&&!o||0==o&&r==c)&&(e.resolve(f),o=!0)},function(t){e.reject(t)})):e.reject("Not list of promises")}),e})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var e=this._childPromises.length;e--;){var n=this._childPromises.shift();if(n._onFulfill)try{var i=n._onFulfill(t);"undefined"!=typeof i?n.resolve(i):n.fulfill(t)}catch(r){n.reject(r)}else n.fulfill(t)}this._state=1,this.triggerStateChange()}},t.genPlugin=function(t,e){this.plugin(t,function(){var t=Array.prototype.slice.call(arguments,0);console.log("Plugin args",t);var n=s();return this.then(function(){var i=Array.prototype.slice.call(arguments,0),r=t.concat(i),a=e.apply(this,r);n.resolve(a)},function(t){n.reject(t)}),n})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,e){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(e)&&(this._onReject=e),!e&&this.isFunction(t)){var n=this;r().asap(function(){t(function(t){n.resolve(t)},function(t){n.resolve(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.nodeStyle=function(t,e){this.plugin(t,function(){var t,n,i=Array.prototype.slice.call(arguments,0),r=0;i.length>=0&&(t=i[i.length-1],"[object Function]"==Object.prototype.toString.call(t)&&(n=t,r=i.length-1));var a=wishes().pending();return this.then(function(){var t=wishes().pending(),s=Array.prototype.slice.call(arguments,0);console.log("Orig args",i),console.log("Then args",s);var o;0==i.length&&(o=s),0==s.length&&(o=i),o||(o=s.concat(i)),r=o.length,n&&r--,o[r]=function(e){if(e)return console.log("Got error ",e),t.reject(e),void a.reject(e);if(n){var i=Array.prototype.slice.call(arguments),r=n.apply(this,i);a.resolve(r)}else{var i=Array.prototype.slice.call(arguments,1);a.resolve.apply(a,i)}},t.then(function(t){a.resolve(t)}),console.log("nodeStyle after concat",o);e.apply(this,o);return t},function(t){a.reject(t)}),a})},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.plugin=function(e,n){return t[e]=n,this},t.props=function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push({name:n,promise:t[n]});var i=e.length,r=0,a=[],s={};return this.then(function(){var t=wishes().pending();return e.forEach(function(e){var n=e.promise,o=e.name;n.then?(a.push(n),n.then(function(e){s[o]=e,r++,r==i&&t.resolve(s)},function(e){t.reject(e)})):t.reject("Not list of promises")}),t})},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var e=this._childPromises.length;e--;){var n=this._childPromises.shift();if(n._onReject)try{n._onReject(t),n.reject(t)}catch(i){n.reject(i)}else n.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var e=this;t.onStateChange(function(){1==t._state&&e.resolve(t.value()),2==t._state&&e.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var n=!1;try{var e=this;t.then.call(t,function(t){n||(e.resolve(t),n=!0)},function(t){n||(e.reject(t),n=!0)})}catch(i){n||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,e){e||(e=function(){});var n=new s(t,e),i=this;return 1==this._state&&r().asap(function(){i.fulfill(i.value())}),2==this._state&&ater().asap(function(){i.reject(i.rejectReason())}),this._childPromises.push(n),n},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(e){e(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},s=function(t,e,n,i,r,a,o,c){var _,f=this;if(!(f instanceof s))return new s(t,e,n,i,r,a,o,c);var u=[t,e,n,i,r,a,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,u)}),"function"==typeof _){if(_._classInfo.name!=s._classInfo.name)return new _(t,e,n,i,r,a,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};s._classInfo={name:"_promise"},s.prototype=new a,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._promise=s,this._promise=s):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._promise=s:this._promise=s}.call(new Function("return this")());var o=function(){!function(t){var e,n,i;t.__dataTr=function(){},t._collectObject=function(t,e,n){this.isArray(e)||(e=e.split(","));var i={};e.forEach(function(e){i[e]=t[e](),t.on(e,function(){i[e]=t[e](),n(i)})}),n(i)},t._forMembers=function(t){var e=this;if(this.isArray())for(var n=0;n<this._data.length;n++){var i=this._data[n];this.isObject(i)&&i.__dataTr&&t(i)}else this._members.forEach(function(n){e[n]&&t(e[n])})},t._initializeData=function(t,e){if(t){this._data=t.data,this._docData=t;var n=this._client.getChannelData(),i=this._client._idToNs(this._docData.__id,this._client._ns);n.createWorker("_to_ch",[7,"*",null,null,i],{target:this}),n.createWorker("_to_ch",[5,"*",null,null,i],{target:this}),n.createWorker("_d_set",[4,"*",null,null,i],{target:this}),n.createWorker("_d_rem",[8,"*",null,null,i],{target:this}),n.createWorker("_d_ins",[7,"*",null,null,i],{target:this}),n.createWorker("_d_mv",[12,"*",null,null,i],{target:this}),n.createWorker("_d_cf",[5,"*",null,null,i],{obj:this}),n.createWorker("_d_cf",[4,"*",null,null,i],{obj:this}),n.createWorker("_d_ch",[42,"*",null,null,i],{target:this});var r=t.data;if(r instanceof Array){for(var a in r)this[a]=c(r[a],e,this._client);this._initIterator()}else for(var a in r)if(r.hasOwnProperty(a)){var s=r[a];if(this.isFunction(s))continue;if(!this.isFunction(s)&&(s===Object(s)||s instanceof Array)){this[a]=new c(s,e,this._client);continue}this.isFunction(s)||this.isObject(s)||this.isArray(s)||this[a]||this.createPropertyUpdateFn(a,s)}}},t._objectCreateCmds=function(t,e){if(e||(e=[]),this.isObject(t)&&t.data)if(this.isArray(t.data)){e.push([2,t.__id,"",null,t.__id]);for(var n=0;n<t.data.length;n++){var i=t.data[n];if(this.isObject(i)){this._objectCreateCmds(i,e);var r=[7,n,i.__id,null,t.__id];e.push(r)}}}else{e.push([1,t.__id,"",null,t.__id]);for(var a in t.data)if(t.data.hasOwnProperty(a)){var s=t.data[a];if(this.isObject(s)){this._objectCreateCmds(s,e);var r=[5,a,s.__id,null,t.__id];e.push(r)}else{var r=[4,a,s,null,t.__id];e.push(r)}}}return e},t._parseURL=function(t){var e=t.split("://"),n=e.shift(),i=e.shift(),r=i.split("/"),a=r.shift(),s=a.split(":"),o=s[0],c=s[1],_=r.shift(),f=r.pop(),u=r.join("/");return{url:t,ip:o,port:c,sandbox:_,path:u,file:f,protocol:n}},t._reGuidRawData=function(t){if(this.isArray(t)){var e=this;t.forEach(function(t){e._reGuidRawData(t)})}else if(this.isObject(t))for(var n in t)t.hasOwnProperty(n)&&("__id"!=n?(this.isObject(t[n])&&this._reGuidRawData(t[n]),this.isArray(t[n])&&this._reGuidRawData(t[n])):t[n]=this.guid())},t._wrapToData=function(t){var e;if(t.__id&&t.data)e=t;else var e={data:t,__id:this.guid()};if(e.data&&this.isObject(e.data))for(var n in e.data)if("__oid"!=n){if(e.data.hasOwnProperty(n)){var i=e.data[n];if(this.isFunction(i))continue;this.isObject(i)&&(e.data[n]=this._wrapToData(i))}}else delete e.data[n];return e},t.addController=function(){console.error("** askChannelQuestion ** not implemented now ")},t.askChannelQuestion=function(){console.error("** askChannelQuestion ** not implemented now ")},t.at=function(t){var e=this._docData.data[t];return e?c(e,null,this._client):void 0},t.clear=function(){for(var t=this.length();t--;)this.pop()},t.clone=function(){return c(this.serialize())},t.copyToData=function(){var t=this.toData();return this._reGuidRawData(t),t},t.createArrayField=function(t,e){return this.set(this._docData.__id,t,e)},t.createField=function(t,e){return this.set(t,e||""),this},t.createObjectField=function(t,e){return this.set(this._docData.__id,t,e)},t.createPropertyUpdateFn=function(e,i){if(this.isObject(i)||this.isObject(this._docData.data[e]))return void(this[e]=c(i,null,this._client));t[e]||(t[e]=function(t){return"undefined"==typeof t?this._client.get(this._docData.__id,e):(this._client.set(this._docData.__id,e,t),this)},n[e]=!0)},t.createWorker=function(t,e,n,r){e[4]=this._client._idToNs(e[4],this._client._ns);var a=this._client.getChannelData();if(a.createWorker(t,e,n),r&&(i||(i={}),!i[t])){var s={};s[t]=r,a.setWorkerCommands(s),i[t]=!0}return this},t.diff_set=function(t,e){return this.isObject(e)?this:(this._client.diffSet(this._docData.__id,t,e),this.createPropertyUpdateFn(t,e),this)},t.emitValue=function(t,e){if(this._processingEmit)return this;if(this._processingEmit=!0,this._controllers)for(var n=0,i=0;i<this._controllers.length;i++){var r=this._controllers[i];r[t]&&(r[t](e),n++)}this._valueFn&&this._valueFn[t]&&this._valueFn[t].forEach(function(t){t(e)}),this._parent&&this._parent.emitValue&&this._parent.emitValue(t,e),this._processingEmit=!1},t.extendWith=function(e){for(var n in e){var i=e[n];this.isFunction(i)&&(t[n]=i)}},t.find=function(){return console.error("*** FIND IS NOT IMPLEMENTED *** "),null},t.forEach=function(t){var e=this;this._docData.data.forEach(function(n){t(c(n,null,e._client))})},t.forTree=function(t,e){var n={},i=!1;if(e){var r=t.split(",");r.forEach(function(t){n[t.trim()]=!0,i=!0})}else e=t;e(this);var a=this;return this.isArray()?this.forEach(function(t){t.forTree(e)}):this.keys(function(t){if((!i||n[t])&&a[t]&&a.hasOwn(t)){var r=a[t];r.forTree&&r.forTree(e)}}),this},t.get=function(t){return console.log("Calling get for "+t),console.log("docData "+JSON.stringify(this._docData)),this._client.get(this._docData.__id,t)},t.getData=function(t){if(this._docData)var e=this._client._fetch(this._docData.__id);else{if(!this._client)return;var e=this._client.getData()}if(t){var n=JSON.parse(JSON.stringify(e));e=this._client._transformObjFromNs(n)}return e},t.getID=function(){return this._docData.__id},t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.hasOwn=function(t){return"undefined"!=typeof this._docData.data[t]&&this[t]?!0:!1},t.indexOf=function(){return this._client.indexOf(this._docData.__id)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){e||(e={},n={})}),t.insertAt=function(t,e){return this.push(e,t)},t.isArray=function(t){return"undefined"==typeof t?this._docData&&this._docData.data?this.isArray(this._docData.data):!1:"[object Array]"===Object.prototype.toString.call(t)},t.isDataTrait=function(t){return t._docData?!0:void 0},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this._docData&&this._docData.data?this.isObject(this._docData.data):!1:t===Object(t)},t.item=function(t){return this.at(t)},t.keys=function(t){for(var e in this._docData.data)this._docData.data.hasOwnProperty(e)&&t(e,this._docData.data[e],this._docData.data);return this},t.length=function(){return this._docData&&this._docData.data?this._docData.data.length:0},t.moveDown=function(){return this._client.moveDown(this._docData.__id),this},t.moveToIndex=function(t){return this._client.moveTo(this._docData.__id,t),this},t.moveUp=function(){return this._client.moveUp(this._docData.__id),this},t.onValue=function(t,e){this._valueFn||(this._valueFn={}),this._valueFn[t]||(this._valueFn[t]=[]),this._valueFn[t].indexOf(e)<0&&this._valueFn[t].push(e)},t.parent=function(t){if("undefined"!=typeof t)return this;if(this._docData){var t=this._docData.__p;return t?c(t):void 0}},t.pick=function(t){var e=simpleStream(),n=this;return this.then(function(){n._collectObject(n,t,function(t){e.pushValue(t)})}),e},t.pop=function(){var t=this.length();if(t){var e=this.at(t-1);return e&&e.remove(),e}},t.push=function(t,e){if(!this.isArray())return this;var n,i=!1;if(t._wrapToData){t=t.getData();var r=this._client._fetch(t.__id);r&&(i=!0)}if(n=t.__id&&t.data?this._client._transformObjToNs(t,this._client._ns):this._wrapToData(t),!i)for(var a=this._objectCreateCmds(n),s=0;s<a.length;s++)this._client.addCommand(a[s]);var o;if("undefined"!=typeof e){o=e;var r=this._client._fetch(this._docData.__id);if(0>o||o>r.data.length)return}else{var r=this._client._fetch(this._docData.__id);o=r.data.length}return this._client.addCommand([7,o,n.__id,null,this._docData.__id]),this},t.redo=function(t){return this._client.redo(t),this},t.redoStep=function(t){return this._client.redoStep(t),this},t.remove=function(){return this._client.remove(this._docData.__id),this},t.removeListener=function(t,e){if(this._events&&this._events[t]){var n=this._events[t].indexOf(e);n>=0&&this._events[t].splice(n,1),0==this._events[t].length&&delete this._events[t]}},t.renderTemplate=function(){console.error("RenderTemplate not implemented")},t.serialize=function(t){var e,n=this._docData.data;e=this.isArray(this._data)?[]:{};for(var i in n)if(n.hasOwnProperty(i)){var r=n[i];if("undefined"==typeof r)continue;if(t&&(this.isObject(r)||this.isArray(r)))continue;e[i]=this.isObject(r)?c(r).serialize():r}return e},t.set=function(t,e){if(this.isFunction(e)){var n=this;return this.then(function(){return n.set(t,e(n.get(t)))}),this}if(this.isObject(e)){var i,r=e;r._wrapToData&&(r=r.getData()),i=r.__id&&r.data?this._client._transformObjToNs(r,this._client._ns):this._wrapToData(r);for(var a=this._objectCreateCmds(i),s=0;s<a.length;s++)this._client.addCommand(a[s]);this._client.setObject(this._docData.__id,t,i);var o=this._client._fetch(i.__id);return this.createPropertyUpdateFn(t,o),this}return console.log("value set "+t+" = "+e),this._client.set(this._docData.__id,t,e),this.createPropertyUpdateFn(t,e),this},t.toData=function(){var t=JSON.stringify(this._docData),e=JSON.parse(t);return e.__ctxCmdList&&delete e.__ctxCmdList,e.__cmdList&&delete e.__cmdList,e},t.toPlainData=function(){return this.getChannelData().toPlainData(this._docData)},t.undo=function(t){return this._client.undo(t),this},t.undoStep=function(t){return this._client.undoStep(t),this},t.unset=function(t){return this._client.unset(this._docData.__id,t),this},t.upgradeVersion=function(){return this._client.upgradeVersion(),this}}(this),function(t){var e;t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){e||(e=[])}),t.on=function(t,e){this._events||(this._events={}),this._events[t]||(this._events[t]=[]),this._events[t].push(e);var n=this;e._unbindEvent=function(){n.removeListener(t,e)}},t.removeListener=function(t,e){if(this._events&&this._events[t]){var n=this._events[t].indexOf(e);n>=0&&this._events[t].splice(n,1),0==this._events[t].length&&delete this._events[t]}},t.trigger=function(t,n){if(!(e.indexOf(t+this._guid)>=0)&&this._events&&this._events[t]){var i=this._events[t],r=this;e.push(t+this._guid);for(var a=i.length,s=0;a>s;s++)i[s](r,n);var o=e.indexOf(t+this._guid);e.splice(o,1)}}}(this),function(t){t.propWorker=function(t,e,n){return this.createWorker(e,[4,t,null,null,this.getID()],n),this}}(this),function(t){var e,n,i,r,a;t._addFactoryProperty=function(t){e||(e=[]),e.push(t)},t._atObserveEvent=function(t){a=t},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){if(i||(i={}),this.isObject(t)){if(t._objEventWorker)return t;if(t.data&&t.__id){var r=i[t.__id];if(r)return r}}else if("string"==typeof t){var r=i[t];if(r)return r}if(e&&n)for(var a=0;a<e.length;a++){var s,o=e[a];if(t&&t.data?s=t.data[o]:t&&(s=t[o]),s){var c=n[s];if(c)return c}}}),t._findConnOptions=function(){if(this._connectionOptions)return this._connectionOptions;var t=this.parent();return t?t._findConnOptions():void 0},t._initIterator=function(){var t=this;"undefined"!=typeof Symbol&&"undefined"!=typeof Symbol.iterator&&(t[Symbol.iterator]=function(){var e=0;return{next:function(){var n=t.at(e++);return n?{value:n,done:!1}:{done:!0}}}})},t._initWorkers=function(){var t=this;if(!r){var e=t._client.getChannelData();e.setWorkerCommands({_obs_4:function(t,e){a||(e.target[t[1]]=t[2])},_obs_7:function(t,e){if(!a){var n=t[1],i=c(t[2]);i.isFulfilled()&&(Array.unobserve(e.target,e.parentObserver),e.target[n]=i.toObservable(e.target,e.parentObserver),Array.observe(e.target,e.parentObserver))}},_obs_8:function(t,e){if(!a){var n=t[1];Array.unobserve(e.target,e.parentObserver),e.target.splice(n,1),Array.observe(e.target,e.parentObserver)}},_obs_12:function(t,e){if(!a){var n=parseInt(t[3]),i=parseInt(t[2]),r=e.target,s=r[n];Array.unobserve(r,e.parentObserver),r.splice(n,1),r.splice(i,0,s),Array.observe(r,e.parentObserver)}},_d_set:function(t,e){e.target.trigger(t[1],t[2])},_d_cf:function(t,e){var n=e.obj;if(4==t[0]&&(n[t[1]]||n.createPropertyUpdateFn(t[1],t[2])),5==t[0]&&!n[t[1]]){var i=n._docData.data[t[1]];i&&n.createPropertyUpdateFn(t[1],i)}},_d_rem:function(t,e){e.target.trigger("remove",t[1])},_to_ch:function(t,e){var n=e.target;if(n._client&&!n._client._isLocal){var i=n._client._fetch(t[2]);i&&c(i,null,n._client)}},_d_ins:function(t,e){e.target.trigger("insert",t[1])},_d_mv:function(t,e){e.target.trigger("move",{itemId:t[1],parentId:t[4],from:t[3],to:t[2]})},_d_ch:function(t,e){e.target.trigger("childChanged",t)}}),r=!0}},t._objEventWorker=function(){if(change){if(4==change[0]){var t=_docUp(),e=c();e.createPropertyUpdateFn(change[1],null);var n=t._find(options.modelid);if(n.__undone)return;options&&options.eventObj&&change[3]!=change[2]&&options.eventObj.trigger(change[1],change[2])}if(options2){options=options2}if(5==change[0]){var t=_docUp(),n=t._find(change[2]),i=t._find(change[4]);if(n.__undone)return;if(i.__undone)return;var r=c();if(r.findFromCache(change[4])){var e=c(change[4]),a=c(change[2]),s=change[1];if(!e)return;if(!a)return;e[s]=a}}if(8==change[0]){var t=_docUp(),n=t._find(change[2]);if(n.__undone)return;options.bListenMVC&&options.eventObj&&options.eventObj.trigger("remove",n.__removedAt)}if(7==change[0]){var t=_docUp(),o=t._find(change[4]),_=t._find(change[2]);if(o.__undone)return;if(_.__undone)return;var f=o.data.indexOf(_);options.bListenMVC&&options.eventObj&&options.eventObj.trigger("insert",f)}if(12==change[0]){var t=_docUp(),o=t._find(change[4]),f=parseInt(change[2]),u=o.data.length;if(o.__undone)return;for(var h=0;u>h;h++){var l=o.data[h];if(l.__id==change[1]){targetObj=l;break}}if(targetObj&&targetObj.__undone)return;var d=targetObj.__fromIndex;if(targetObj){var v=parseInt(change[2]);options.bListenMVC&&options.eventObj&&options.eventObj.trigger("move",{from:d,to:v})}}}},t._parseURL=function(t){var e=t.split("://"),n=e.shift(),i=e.shift(),r=i.split("/"),a=r.shift(),s=r.join("/"),o=a.split(":"),c=o[0],_=o[1],f=r.shift(),u=r.pop(),h=r.join("/"),l={protocol:n,ip:c,port:_,sandbox:f,fullPath:s,path:h,file:u};return l},t.addToCache=function(t,e){i||(i={}),t&&(i[t]=e)},t.channel=function(){return this._client},t.createChannel=function(t,e,n){var i=this;return s(function(r){n||(n={}),i._client.createChannel(t,e,n).then(function(e){if(e.result===!1)return void r(e);var n=i._request,a=c(n.protocol+"://"+n.ip+":"+n.port+"/"+t,i._initOptions);a.then(function(){r({result:!0,channel:a})})})})},t.createSubClass=function(t,e,n){var i=n,r=function(t,e,n,i,a,s,o,c){if(!(this instanceof r))return console.log("NOT instance of..."),new r(t,e,n,i,a,s,o,c);console.log("is instance of..."),console.log(this.__traitInit);var _=[t,e,n,i,a,s,o,c];if(this.__factoryClass){var f,u=this;if(this.__factoryClass.forEach(function(t){f=t.apply(u,_)}),"[object Function]"==Object.prototype.toString.call(f)){if(f._classInfo.name!=r._classInfo.name)return new f(t,e,n,i,a,s,o,c)}else if(f)return f}if(this.__traitInit){console.log("Calling the subclass trait init...");var u=this;this.__traitInit.forEach(function(t){t.apply(u,_)})}else"function"==typeof this.init&&this.init.apply(this,_)};return r._classInfo={name:this.guid()},i.prototype=c.prototype,r.prototype=new i,this.registerComponent(e,r),this._addFactoryProperty(t),r},t.diff=function(t){var e=d(),n=e.compareFiles(this.getData(!0),t.getData(!0));return n.cmds},t.disconnect=function(){return this._client&&this._client.disconnect(),this},t.filter=function(t){var e=c([]);return this.localFork().forEach(function(n){t(n)&&e.push(n.toData(!0))}),e},t.fork=function(t,e){if(!t||this._client._isLocal)return this.localFork();var n=this;return s(function(i){n._client.fork(t,e).then(function(e){if(e.result===!1)return void i(e);var r=n._request,a=c(r.protocol+"://"+r.ip+":"+r.port+"/"+t,n._initOptions);a.then(function(){i({result:!0,fork:a})})})})},t.getChannelClient=function(){return this._client},t.getChannelData=function(){return this._client.getChannelData()},t.getJournal=function(){var t=this.getChannelData();return t._journal.slice()},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,e,n){e=e||{};var i=this;if(this._initOptions=e,"string"==typeof t){if(!t.match("://"))return;var r=this._parseURL(t);this._request=r,this._connectionOptions=e,this._socket=O(r.protocol+"://"+r.ip,r.port,e.ioLib);var a={};a.auth=e.auth?e.auth:{},e.initWithData&&(a.initWithData=this._wrapToData(e.initWithData)),this._client=b(r.fullPath,this._socket,a),this._client.then(function(t){if(t.result===!1)return void i.trigger("login::failed");var e=i._client.getData();i._initializeData(e),i.addToCache(e.__id,i),i._initWorkers(),i.resolve(!0)})}else if(n)n&&!this._client&&(this._client=n),this.isObject(t)&&t.__id&&(this._initializeData(t),this.addToCache(t.__id,this)),i._initWorkers(),this.resolve(!0);else{this.isObject(t)&&!t.__id&&(t=this._wrapToData(t));var s=b(this.guid(),null,{localChannel:!0,localData:t});this._client=s;var i=this,o=i._client.getData();if(!o)return void i.resolve(!0);i._initializeData(o),i.addToCache(o.__id,i),i._initWorkers(),i.resolve(!0)}}),t.localFork=function(){var t=this.getData(!0);return c(t)},t.map=function(t){var e=c([]),n=this.localFork(),i=0;return this.localFork().forEach(function(r){var a=t(r,i,n);e.push(a),i++}),e},t.merge=function(t){var e=this.diff(t);return this.patch(e),this},t.openChannel=function(t){var e=this;return s(function(n){var i=(e._request,c(t,e._findConnOptions()));i.then(function(){n({result:!0,channel:i})})})},t.patch=function(t){var e=this;return t.forEach(function(t){var n=e._client._transformCmdToNs(t);e._client.addCommand(n,!0)}),this},t.playback=function(t){var e=this.getChannelData();return e.playback(t)},t.pushToObjArray=function(t,e,n){var i,r,a,s=t.split("/"),o=this,c={};if(n){for(var _ in n)if(n.hasOwnProperty(_)){var f=n[_];this.isArray(f)?i=_:"{path}"==f?r=_:c[_]=f}if(i&&r){a=JSON.stringify(c),i||(i="items"),r||(r="title");var u=function(t,e){var n=s[t];if(!n)return e;e.hasOwn(i)||e.set(i,[]);var o;if(e[i].forEach(function(t){t.get(r)==n&&(o=t)}),!o){var c=JSON.parse(a);c[r]=n,c[i]=[],e[i].push(c),o=e[i].at(e[i].length()-1)}return o&&s.length<=t+1?o:u(t+1,o)},h=u(0,o);h&&h[i]&&h[i].push(e)}}},t.reconnect=function(){return this._client&&this._client.reconnect(),this},t.reduce=function(t,e){var n=(c([]),0),i=this.localFork(),r=e;return i.forEach(function(e){r=t(r,e,n,i),n++}),r},t.registerComponent=function(t,e){n||(n={}),n[t]||(n[t]=e)}}(this)},c=function(t,e,n,i,r,a,s,o){var _,f=this;if(!(f instanceof c))return new c(t,e,n,i,r,a,s,o);var u=[t,e,n,i,r,a,s,o];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,u)}),"function"==typeof _){if(_._classInfo.name!=c._classInfo.name)return new _(t,e,n,i,r,a,s,o)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};o.prototype=s.prototype,c._classInfo={name:"_data"},c.prototype=new o,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._data=c,this._data=c):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._data=c:this._data=c}.call(new Function("return this")());var _=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var e;t.constructClientToServer=function(t){var e=t.data;t.last_sent||(t.last_sent=[]);var n=t.last_sent[1]||0,i=e._journal.length;if(t.last_update){n<t.last_update[1]&&(n=t.last_update[1]);
var r=t.last_update[1]||0;if(r>=i)return null}if(n==i)return null;t.last_sent[0]=n,t.last_sent[1]=i;var a={cmd:"c2s",id:this.guid(),c:e._journal.slice(n,i),start:n,end:i,version:t.version};if(t.client)for(var s=0;s<a.c.length;s++){var o=a.c[s];a.c[s]=t.client._transformCmdFromNs(o)}return a},t.constructServerToClient=function(t){var e=t.data;t.last_update||(t.last_update=[]);var n=t.last_update[1]||0,i=e._journal.length;return n==i?null:(t.last_update[0]=n,t.last_update[1]=i,{cmd:"s2c",c:e._journal.slice(n,i),start:n,end:i,version:t.version})},t.deltaClientToServer=function(t,e){if(t){e._done||(e._done={});try{if(!t.id)return;if(e._done[t.id])return res;e._done[t.id]=!0;for(var n=e.data,i=[],r=0;r<t.c.length;r++){var a=t.c[r],s=n.execCmd(a);s!==!0&&i.push(s)}var o={errors:i};return o}catch(c){return c.message}}},t.deltaMasterToSlave=function(t,e){if(t){var n=e.data,i={goodCnt:0,oldCnt:0,newCnt:0,reverseCnt:0};console.log("deltaMasterToSlave");var r=t.start;if(e.needsRefresh)return void console.log("** serverState needs refresh **");if(t.start>n._journal.length)return console.log("--- setting refresh on because of ---- "),console.log(" updateFrame.start > data._journal.length "),e.needsRefresh=!0,i.fail=!0,i;for(var a=[],o=t.start;o<t.end;o++){var c=n.getJournalCmd(o),_=t.c[o-t.start],f=!0;if(c){if(13==c[0]&&13==_[0]&&c[4]==_[4]&&c[1]==_[1]){var u=c[2],h=_[2];if(u.length!=h.length)f=!1;else for(var l=0;l<u.length&&f;l++){for(var d=u[l],v=h[l],p=0;5>p;p++)if(d[p]!=v[p]){console.log("not same ",p,d[p],v[p]),f=!1;break}if(f)if(this.isArray(d[5])){for(var d=d[5],v=v[5],m=Math.max(d.length||0,v.length||0),p=0;m>p;p++)if(d[p]!=v[p]){console.log("not same array ",p),f=!1;break}}else d[5]!=v[5]&&(f=!1);f||(console.log("was not the same"),console.log(_,"vs",c))}}else for(var g=0;4>=g;g++)c[g]!=_[g]&&(f=!1,console.log("was not the same"),console.log(_[g],"vs",c[g]));if(!f)return console.log("Not same "),console.log(JSON.stringify(t.c)),s(function(a){n.reverseToLine(r);var s=t.journalSize;console.log("Truncating the journal to ",s,r),e.model.truncateJournalTo(s,r).then(function(){for(var s=[],o=r;o<t.end;o++){var c=t.c[o-t.start],_=n.execCmd(c);if(_!==!0)return console.log("--- there is need for a bigger refersh ---- "),console.log(JSON.stringify(_)),e.needsRefresh=!0,i.fail=!0,i.reason=_,a(i),i;s.push(c),i.reverseCnt++}return e.last_update[0]=0,e.last_update[1]=r,i})});r=o,i.goodCnt++,i.oldCnt++}else{var y=n.execCmd(_);if(y!==!0)return console.log("--- setting refresh on because of ---- "),console.log(JSON.stringify(y)),e.needsRefresh=!0,i.fail=!0,i.reason=y,i;r=o,i.goodCnt++,i.newCnt++,a.push(_)}}return console.log("server last update "+JSON.stringify(e.last_update)),console.log("server data length "+e.data._journal.length),a.length,i}},t.deltaServerToClient=function(t,n){if(t){var i=n.data;n.last_update||(n.last_update=[]);var r={goodCnt:0,oldCnt:0,newCnt:0,reverseCnt:0},a=t.start;if(n.needsRefresh)return void(e.onCancel&&e.onCancel({data:i,reason:g,clientState:n,updateFrame:t,serverCmds:t.c}));if(t.start>i._journal.length)return e.onError&&e.onError({data:i,reason:" updateFrame.start > data._journal.length ",clientState:n,updateFrame:t,serverCmds:t.c}),n.needsRefresh=!0,r.fail=!0,r;if(n.client)for(var s=t.start;s<t.end;s++){var o=t.c[s-t.start];t.c[s-t.start]=n.client._transformCmdToNs(o)}e.onServerData&&e.onServerData({data:i,clientState:n,updateFrame:t,serverCmds:t.c});for(var s=t.start;s<t.end;s++){var c=i.getJournalCmd(s),o=t.c[s-t.start],_=!0;if(c){if(13==c[0]&&13==o[0]&&c[4]==o[4]&&c[1]==o[1]){var f=c[2],u=o[2];if(f.length!=u.length)_=!1;else for(var h=0;h<f.length&&_;h++){for(var l=f[h],d=u[h],v=0;5>v;v++)if(l[v]!=d[v]){console.log("not same ",v,l[v],d[v]),_=!1;break}if(_)if(this.isArray(l[5])){for(var l=l[5],d=d[5],p=Math.max(l.length||0,d.length||0),v=0;p>v;v++)if(l[v]!=d[v]){console.log("not same array ",v),_=!1;break}}else l[5]!=d[5]&&(_=!1);_||(console.log("was not the same at array compare"),console.log(o,"vs",c))}}else for(var m=0;4>=m;m++)c[m]!=o[m]&&(_=!1,e.onError&&e.onError({data:i,reason:" server datas are different ",clientState:n,updateFrame:t,serverCmds:t.c}));if(!_){i.reverseToLine(a);for(var s=a;s<t.end;s++){var o=t.c[s-t.start],g=i.execCmd(o,!0);if(g!==!0)return console.log("--- setting refresh on because of ---- "),console.log(JSON.stringify(g)),e.onError&&e.onError({data:i,reason:g,clientState:n,updateFrame:t,serverCmds:t.c}),n.needsRefresh=!0,r.fail=!0,r.reason=g,r;r.reverseCnt++}return n.last_update[0]=t.start,n.last_update[1]=t.end,r}a=s,r.goodCnt++,r.oldCnt++}else{var g=i.execCmd(o,!0);if(g!==!0)return console.log("--- setting refresh on because of ---- "),console.log(JSON.stringify(g)),e.onError&&e.onError({data:i,reason:g,clientState:n,updateFrame:t,serverCmds:t.c}),n.needsRefresh=!0,r.fail=!0,r.reason=g,r;a=s,r.goodCnt++,r.newCnt++}}return n.last_update[0]=t.start,n.last_update[1]=t.end,r}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){e||(e={})}),t.setHook=function(t,n){e||(e={}),e[t]=n}}(this)},f=function(t,e,n,i,r,a,s,o){var c,_=this;if(!(_ instanceof f))return new f(t,e,n,i,r,a,s,o);var u=[t,e,n,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,u)}),"function"==typeof c){if(c._classInfo.name!=f._classInfo.name)return new c(t,e,n,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,u)}):"function"==typeof _.init&&_.init.apply(_,u)};f._classInfo={name:"_chPolicy"},f.prototype=new _,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._chPolicy=f,this._chPolicy=f):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._chPolicy=f:this._chPolicy=f}.call(new Function("return this")());var u=function(){!function(t){var e;t.fromAce=function(t){if(t&&t[0]&&(t[0].range||t[0].data||(e=!0)),e)return this.fromAce2(t);var n=[];return t.forEach(function(t){var e;e=t.data?t.data:t;var i=e.range;"insertText"==e.action&&n.push([1,i.start.row,i.start.column,i.end.row,i.end.column,e.text]),"removeText"==e.action&&n.push([2,i.start.row,i.start.column,i.end.row,i.end.column,e.text]),"insertLines"==e.action&&n.push([3,i.start.row,i.start.column,i.end.row,i.end.column,e.lines]),"removeLines"==e.action&&n.push([4,i.start.row,i.start.column,i.end.row,i.end.column,e.lines,e.nl])}),n},t.fromAce2=function(t){var e=[];return t.forEach(function(t){var n=t;"insert"==t.action&&1==t.lines.length&&e.push([1,n.start.row,n.start.column,n.end.row,n.end.column,t.lines[0]]),"remove"==t.action&&1==t.lines.length&&e.push([2,n.start.row,n.start.column,n.end.row,n.end.column,t.lines[0]]),"insert"==t.action&&t.lines.length>1&&e.push([3,n.start.row,n.start.column,n.end.row,n.end.column,t.lines]),"remove"==t.action&&t.lines.length>1&&e.push([4,n.start.row,n.start.column,n.end.row,n.end.column,t.lines,t.nl])}),e},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.reverse=function(t){var e=[];return t.forEach(function(t){{var n=t.slice();n[1],n[2],n[3],n[4]}return 1==n[0]?(n[0]=2,void e.unshift(n)):2==n[0]?(n[0]=1,void e.unshift(n)):3==n[0]?(n[0]=4,void e.unshift(n)):4==n[0]?(n[0]=3,void e.unshift(n)):void 0}),e},t.runToAce=function(t){if(e)return this.runToAce2(t);var n=[],i=["","insertText","removeText","insertLines","removeLines"];return t.forEach(function(t){var e={action:i[t[0]],range:{start:{row:t[1],column:t[2]},end:{row:t[3],column:t[4]}}};t[0]<3?e.text=t[5]:e.lines=t[5],4==t[0]&&(e.nl=t[6]||"\n"),n.push(e)}),n},t.runToAce2=function(t){var e=[],n=["","insert","remove","insert","remove"];return t.forEach(function(t){var i={action:n[t[0]],start:{row:t[1],column:t[2]},end:{row:t[3],column:t[4]}};i.lines=t[0]<3?[t[5]]:t[5],4==t[0]&&(i.nl=t[6]||"\n"),e.push(i)}),e},t.runToLineObj=function(t,e){e.forEach(function(e){var n=e[1],i=e[2],r=e[3],a=e[4];if(1==e[0])if("\n"==e[5]){var s=t.item(n);if(s){var o=s.text();s.text(o.slice(0,i));var c={text:o.slice(i)||""};t.insertAt(n+1,c)}else t.insertAt(n,{text:""}),t.insertAt(n+1,{text:""})}else{var s=t.item(n);if(s){var o=s.text();s.text(o.slice(0,i)+e[5]+o.slice(i))}else t.insertAt(n,{text:e[5]})}if(2==e[0])if("\n"==e[5]){var _=t.item(n),f=t.item(n+1),u="",h="";_&&(u=_.text()),f&&(h=f.text()),_?_.text(u+h):t.insertAt(n,{text:""}),f&&f.remove()}else{var s=t.item(n),o=s.text();s.text(o.slice(0,i)+o.slice(a))}if(3==e[0])for(var l=r-n,d=0;l>d;d++)t.insertAt(n+d,{text:e[5][d]});if(4==e[0])for(var l=r-n,d=0;l>d;d++){var s=t.item(n);s.remove()}})},t.runToString=function(t,e){if(!e||"undefined"==typeof t)return"";t+="";var n=t.split("\n");return e.forEach(function(t){var e=t[1],i=t[2],r=t[3],a=t[4];if(1==t[0])if("\n"==t[5]){var s=n[e]||"";n[e]=s.slice(0,i);var o=s.slice(i)||"";n.splice(e+1,0,o)}else{var s=n[e]||"";n[e]=s.slice(0,i)+t[5]+s.slice(i)}if(2==t[0])if("\n"==t[5]){var c=n[e]||"",_=n[e+1]||"";n[e]=c+_,n.splice(e+1,1)}else{var s=n[e]||"";n[e]=s.slice(0,i)+s.slice(a)}if(3==t[0])for(var f=r-e,u=0;f>u;u++)n.splice(e+u,0,t[5][u]);if(4==t[0])for(var f=r-e,u=0;f>u;u++)n.splice(e,1)}),n.join("\n")},t.setAceVersion=function(t){e=t},t.simplify=function(t){var e,n=[],i=null;return t.forEach(function(t){e&&1==t[0]&&1==e[0]&&t[3]==t[1]&&e[1]==t[1]&&e[3]==t[3]&&e[4]==t[2]?i?(i[3]=t[3],i[4]=t[4],i[5]=i[5]+t[5]):(i=[],i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=t[3],i[4]=t[4],i[5]=e[5]+t[5]):(i&&(n.push(i),i=null),1==t[0]?i=t.slice():n.push(t)),e=t}),i&&n.push(i),n}}(this)},h=function(t,e,n,i,r,a,s,o){var c,_=this;if(!(_ instanceof h))return new h(t,e,n,i,r,a,s,o);var f=[t,e,n,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,e,n,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};h._classInfo={name:"aceCmdConvert"},h.prototype=new u,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.aceCmdConvert=h,this.aceCmdConvert=h):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.aceCmdConvert=h:this.aceCmdConvert=h}.call(new Function("return this")());var l=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){var e,n,i,r,a,s,o;t._createModelCommands=function(t,e,n){n||(n=[]);var i;if(i=t.data&&t.__id?t.data:t,this.isObject(i)||this.isArray(i)){var r;if(r=t.__id?t:{data:i,__id:this.guid()},this.isArray(i))var a=[2,r.__fork||r.__id,[],null,r.__fork||r.__id];else var a=[1,r.__fork||r.__id,{},null,r.__fork||r.__id];e&&(r.__p=e.__id),n.push(a);for(var s in i)if(i.hasOwnProperty(s)){var o=i[s];if(this.isObject(o)||this.isArray(o)){var c=this._createModelCommands(o,r,n),a=[5,s,c.__fork||c.__id,null,r.__fork||r.__id];n.push(a)}else{var a=[4,s,o,null,r.__fork||r.__id];n.push(a)}}return r}},t.addedObjects=function(){var t=[];for(var e in i)i.hasOwnProperty(e)&&(n[e]||(t.push(e),s[e]=i[e]));return t},t.commonObjects=function(){var t=[];for(var r in e)n[r]&&i[r]&&t.push(r);return t},t.compareFiles=function(t,c){n={},i={},e={},r={},a={},s={},o={},this.findObjects(t,n),this.findObjects(c,i);var _={missing:this.missingObjects(),added:this.addedObjects(),common:this.commonObjects(),cMod:[],cmds:[]},f=this;_.common.forEach(function(t){var e=f.objectDiff(n[t],i[t]);_.cMod.push(e)});var f=this;return _.added.forEach(function(t){var n=[],i=e[t];f._createModelCommands(i,null,n),n.forEach(function(t){_.cmds.push(t)})}),_.cMod.forEach(function(t){t.cmds.forEach(function(t){_.cmds.push(t)})}),_},t.findObjects=function(t,n){if(t&&t.__id&&(n[t.__fork||t.__id]=t,e[t.__fork||t.__id]=t,r[t.__id]=t),t.data){var i=t.data;for(var a in i)if(i.hasOwnProperty(a)){var s=i[a];this.isObject(s)&&(o[s.__fork||s.__id]=t.__fork||t.__id,this.findObjects(s,n))}}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.missingObjects=function(){var t=[];for(var e in n)n.hasOwnProperty(e)&&(i[e]||(a[e]=n[e],t.push(e)));return t},t.objectDiff=function(t,n){var i={modified:[],posMoved:[],sourcesAndTargets:[],cmds:[]};if(t.data&&n.data&&this.isObject(t.data)&&!this.isArray(t.data)){var r=t.data,c={};for(var _ in n.data)if(n.data.hasOwnProperty(_)){var f=r[_],u=t.__fork||t.__id;if(!this.isObject(f)&&!this.isArray(f)){c[_]=!0;var h=n.data[_];n.data[_]!=f&&(this.isObject(f)||this.isObject(h)?i.cmds.push(h&&h.__id?[5,_,n.data[_].__id,null,u]:[10,_,f.__id,null,u]):(i.modified.push({id:u,prop:_,from:f,to:n.data[_]}),i.cmds.push([4,_,n.data[_],f,u])))}}for(var _ in t.data)if(t.data.hasOwnProperty(_)){if(c[_])continue;var f=t.data[_],u=t.__id;if(this.isObject(f)&&!this.isArray(f)){var h=n.data[_];!h&&f&&f.__id&&i.cmds.push([10,_,f.__id,null,u])}}}if(this.isArray(t.data)){for(var l=t.data,d=n.data,v=[],p=[],m=l.length,g=d.length,y=0;m>y;y++){var b=l[y];if(this.isObject(b)){var j=b.__fork||b.__id;a[j]?i.cmds.push([8,0,j,0,o[j]]):v.push(j)}}for(var O={},I={},C={},y=0;g>y;y++){var b=d[y];if(this.isObject(b)){var j=b.__fork||b.__id;O[j]=y,I[y]=j,s[j]&&(v.push(j),i.cmds.push([7,y,j,0,o[j]])),p.push(j)}}var w=[],y=0;v.forEach(function(t){w.push(O[t]),C[t]=y,y++}),i.restackIndex=O,i.restackList=w,i.reverseIndex=I,i.restack=this.restackOps(w);var x=[],D=v.slice();i.restack.forEach(function(t){if("a"==t[0]){var n=I[t[1]],r=I[t[2]],a=(O[r],D.indexOf(n));D.splice(a,1);var s=D.indexOf(r);D.splice(s,0,n);{e[n]}i.cmds.push([12,n,s,a,o[n]])}else{var n=I[t[1]],r=I[t[2]],a=(O[r],D.indexOf(n));D.splice(a,1);var s=D.indexOf(r)+1;D.splice(s,0,n),i.cmds.push([12,n,s,a,o[n]])}}),i.stackCmds=x,i.sourceArrayWork=D,i.sourcesAndTargets.push([v,p])}return i},t.restackOps=function(t){function e(t){for(var e=t.slice(0),i=t.slice(0),r=t.slice(0).sort(function(t,e){return t-e}),a={},s={},o=0;o<i.length;o++){var c=r.indexOf(i[o]);a[i[o]]=c,s[c]=i[o],e[o]=c}var _=e.slice(0).sort(function(t,e){return t-e}),f=e[0],u=e[0],h=[],l=0,d=function(){for(var t=0,n=e.length,i=0;n>t;t++){var r=e[t];r>u&&(u=r),f>r&&(f=r),t>0&&h.push(_[t]-_[t-1]),t>0&&(l+=Math.abs(_[t]-_[t-1])),i+=Math.abs(r-_[t])}return l/=n,i/n}();h.sort(function(t,e){return t-e});for(var v=(h[0],function(t){for(var n=function(n,i,r){var a=[],s=e.length;for(i||(i=0);s>n;n++){var o=e[n];if(o-r!=1){var c=n+i;0>c&&(c=0),c>=s&&(c=s-1),t(o,_[c],o,r,n,s)&&(e[n+1]&&e[n+1]<o&&e[n+1]>r||(a.push(o),r=o))}else a.push(o),r=o}return a},i=[],r=0;.1>r;){for(var a=-5;5>=a;a++)i.push(n(Math.floor(e.length*r),a,f-1));r+=.05}return i.sort(function(t,e){return e.length-t.length}),i[0]}),p=[v(function(t,e,n,i,r,a){return i>n?!1:r>0&&Math.abs(n-i)>h[r-1]?!1:Math.abs(n-i)>d?!1:Math.abs(t-e)<=d*(r/a)&&n>=i?!0:Math.abs(i-n)<=d*(r/a)&&n>=i?!0:!1}),v(function(t,e,n,i,r,a){return i>n?!1:Math.abs(n-i)>d?!1:Math.abs(t-e)<=d*(r/a)&&n>=i?!0:Math.abs(i-n)<=d*(r/a)&&n>=i?!0:!1}),v(function(t,e,n,i,r,a){return i>n?!1:Math.abs(n-i)>d?!1:Math.abs(t-e)<=d*(r/a)&&n>=i?!0:Math.abs(i-n)<=d*(r/a)&&n>=i?!0:!1}),v(function(t,e,n,i,r,a){return i>n?!1:Math.abs(t-e)<=d*(r/a)&&n>=i?!0:Math.abs(i-n)<=d*(r/a)&&n>=i?!0:!1}),v(function(t,e,n,i,r,a){return i>n?!1:Math.abs(t-e)<=d&&n>=i?!0:Math.abs(i-n)<=d*(r/a)&&n>=i?!0:!1}),v(function(t,e,n,i){return i>n?!1:Math.abs(n-i)<l?!0:Math.abs(t-e)<=l&&n>=i?!0:!1}),v(function(t,e,n,i){return n>i?!0:!1}),v(function(t,e,n,i){return i>n?!1:Math.abs(n-i)>d?!1:Math.abs(t-e)<=d&&n>=i?!0:!1}),v(function(t,e,n,i,r,a){return i>n?!1:r>0&&Math.abs(n-i)>d?!1:Math.abs(t-e)<=d*(r/a)&&n>=i?!0:r>0&&Math.abs(i-n)<=d*(r/a)&&n>=i?!0:!1}),v(function(t,e,n,i){if(i>n)return!1;if(i>=f){if(n>=i)return!0}else if(n==f)return!0;return!1})],m=[],g=0,o=0;o<p.length;o++){var y=p[o];y.length>g&&(m=y,g=y.length)}0==m.length&&(m=[_[Math.floor(_.length/2)]]);{var b=[],j=[];!function(){for(var t=f,n=m[0],i=m.length,r=e.indexOf(n),a=0,s=0,o=e.length;o>s;s++){var c=e[s];c>=t&&n>=c&&r>=s?(b.push(c),t=c):j.push(c),c==n&&(t=c,i-1>a?(a++,n=m[a],r=e.indexOf(n)):(n=u,r=o+1))}}()}j.sort(function(t,e){return t-e});!function(){for(var t=0,e=0,i=b[0],r=j.length;r>t;){var a=b[e],o=j[t];if("undefined"==typeof a){for(;r>t;)n.push(["b",s[o],s[i]]),i=o,t++,o=j[t];return}o>a?(i=a,e++):(n.push(["a",s[o],s[a]]),t++)}}();return e}var n=[];return e(t),n}}(this)},d=function(t,e,n,i,r,a,s,o){var c,_=this;if(!(_ instanceof d))return new d(t,e,n,i,r,a,s,o);var f=[t,e,n,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=d._classInfo.name)return new c(t,e,n,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};d._classInfo={name:"diffEngine"},d.prototype=new l;var v=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var e,n,i,a,o,c,_,f,u;t._cmd_aceCmd=function(t,e){var n=this._find(t[4]),r=t[1];if(!n||!r)return!1;if("string"!=typeof n.data[r])return!1;var a=h();n.data[r]=a.runToString(n.data[r],t[2]),i=e;var s=[4,r,n.data[r],null,t[4],t[5],t[6]];return this._cmd(s,n,null),e?this._cmd(t,n,null):(this._cmd(t,n,null),this.writeCommand(t)),i=!1,!0},t._cmd_createArray=function(t,e){var n=t[1];if(!n)return{error:21,cmd:t,text:"Object ID was null or undefined"};var i=this._getObjectHash();if(i[n])return{error:22,cmd:t,text:"Array with ID was already created"};var r,a=this._getRemovedHash();return a[n]?(r=a[n],r.__p=null):r={data:[],__id:n},i[r.__id]=r,this._data.__orphan.push(r),!0},t._cmd_createObject=function(t,e){var n=t[1];if(!n)return{error:11,cmd:t,text:"Object ID was null or undefined"};var i=this._getObjectHash();if(i[n])return{error:12,cmd:t,text:"Object ID was already created"};var r,a=this._getRemovedHash();return a[n]?(r=a[n],r.__p=null):r={data:{},__id:n},i[r.__id]=r,this._data.__orphan.push(r),!0},t._cmd_diffPatch=function(t,e){if(!f)return{error:141,cmd:t,text:"diff-match-patch not initialized"};var n=this._find(t[4]),r=t[1];if(!n)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!r)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var a=n.data[r];if(this.isObject(a)||this.isArray(a))return{error:145,cmd:t,text:"Trying to apply text diff/patch to  Object or Array"};var s=f.patch_fromText(t[2]),o=f.patch_apply(s,a);if(!this.isArray(o))return{error:146,cmd:t,text:"patch_apply failed"};var c=o[1];if(!c)return{error:146,cmd:t,text:"patch_apply failed"};for(var _=0;_<c.length;_++)if(!c[_])return{error:146,cmd:t,text:"patch_apply failed"};n.data[r]=o[0],i=e;var u=[4,r,n.data[r],a,t[4],t[5],t[6]];return this._cmd(u,n,null),e?this._cmd(t,n,null):this.writeCommand(t),i=!1,!0},t._cmd_moveToIndex=function(t){{var e,i=this._find(t[4]);i.data.length}if(!i)return{error:2,cmd:1,text:"Object with ID ("+t[4]+") did not exist"};var r,a=null,e=this._find(t[1]);if(r=a=i.data.indexOf(e),a!=t[3])return{error:121,cmd:t,text:"The old index was not what expected: "+a+" cmd have "+t[3]};if(!e)return{error:122,cmd:t,text:"Object to be moved ("+t[1]+") was not in the array"};var s=parseInt(t[2]);return isNaN(s)?{error:123,cmd:t,text:"Target index ("+s+") was not a number"}:i.data.length<=r||0>r?{error:124,cmd:t,text:"Invalid original index ("+r+") given"}:(n.fromIndex=r,i.data.splice(r,1),i.data.splice(s,0,e),this._cmd(t,null,t[1]),!0)},t._cmd_pushToArray=function(t,e){{var n=this._find(t[4]),i=this._find(t[2]),r=parseInt(t[1]);t[3],n.data.length}if(!n)return{error:71,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:72,cmd:t,text:"Did not find object with ID ("+t[2]+") "};if(i.__p)return i.__p==n.__id?(console.log("WARNING : Unnecessary pushToArray"),console.log(t),!0):{error:73,cmd:t,text:"The object already had a parent - need to remove first ("+t[2]+") "};if(isNaN(r))return{error:74,cmd:t,text:"toIndex was not a number"};if(!this.isArray(n.data))return{error:75,cmd:t,text:"Target Object was not an array"};if(r>n.data.length||0>r)return{error:76,cmd:t,text:"toIndex out of range, parent data len "+n.data.length};n.data.splice(r,0,i),i.__p=n.__id;var a=this._data.__orphan.indexOf(i);return a>=0&&this._data.__orphan.splice(a,1),this._cmd(t,null,t[2]),!0},t._cmd_removeObject=function(t,e){var n=this._find(t[4]),i=this._find(t[2]),r=parseInt(t[1]);if(!n)return{error:81,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:82,cmd:t,text:"Did not find object with ID ("+t[2]+") "};if(!i.__p)return{error:83,cmd:t,text:"The removed item did not have a parent ("+t[2]+") "};var a=n.data.indexOf(i);if(isNaN(r))return{error:84,cmd:t,text:"oldPosition was not a number"};if(r!=a)return{error:85,cmd:t,text:"oldPosition was not same as current position"};var s=this._getRemovedHash();s[t[2]]=i,n.data.splice(a,1),this._cmd(t,null,t[2]),i.__p=null;var o=this._data.__orphan.indexOf(i);return 0>o&&this._data.__orphan.push(i),!0},t._cmd_setMeta=function(t,e){var n=this._find(t[4]),i=t[1];return i?"data"==i?!1:"__id"==i?!1:n?n[i]==t[2]?!1:(n[i]=t[2],this._cmd(t,n,null),e||this.writeCommand(t),!0):!1:!1},t._cmd_setProperty=function(t,e){var n=this._find(t[4]),i=t[1];if(!n)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var r=n.data[i];if(r==t[2])return{error:43,cmd:t,text:"Trying to set the same value to the object twice"};if("undefined"==typeof r||null===r){if("undefined"!=typeof t[3]&&null!==t[3])return{error:44,cmd:t,text:"The old value "+r+" was not the same as the commands old value"}}else{if(this.isObject(r)||this.isArray(r))return{error:45,cmd:t,text:"Trying to set Object or Array value to a scalar property"};if(r!=t[3])return{error:44,cmd:t,text:"The old value "+r+" was not the same as the commands old value"}}return n.data[i]=t[2],this._cmd(t,n,null),!0},t._cmd_setPropertyObject=function(t,e){var n=this._find(t[4]),i=t[1],r=this._find(t[2]);if(!n)return{error:51,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:52,cmd:t,text:"The property was not defined ("+t[1]+") "};if(!r)return{error:53,cmd:t,text:"Could not find the Object to be set with ID ("+t[2]+") "};if("undefined"!=typeof n.data[i])return{error:54,cmd:t,text:"The property ("+t[1]+") was already set, try unsetting first "};if(!this.isObject(n.data)||this.isArray(n.data))return{error:55,cmd:t,text:"The object ("+t[2]+") was not of type Object "};n.data[i]=r,r.__p=n.__id,this._cmd(t,null,t[2]);var a=this._data.__orphan.indexOf(r);return a>=0&&this._data.__orphan.splice(a,1),e||this._moveCmdListToParent(r),!0},t._cmd_unsetProperty=function(t){var e=this._find(t[4]),n=t[1];return e?n?this.isArray(e.data[n])?{error:103,cmd:t,text:"The Object data was Array ("+t[4]+") "}:(delete e.data[n],!0):{error:102,cmd:t,text:"The property was not defined ("+t[1]+") "}:{error:101,cmd:t,text:"Did not find object with ID ("+t[4]+") "}},t._fireListener=function(t,n){if(e){var i=t.__id+"::"+n,r=e[i];r&&r.forEach(function(e){e(t,t.data[n])})}},t._moveCmdListToParent=function(){},t._reverse_aceCmd=function(t){var e=this._find(t[4]),n=t[1],i=h(),r=i.reverse(t[2]),a=[4,n,e.data[n],null,t[4]],s=[13,n,r,null,t[4]],o=i.runToString(e.data[n],r);e.data[n]=o,this._cmd(a),this._cmd(s)},t._reverse_createArray=function(t){var e=t[1],n=this._getObjectHash(),i=n[e],r=this._getRemovedHash();r[e]=i,delete n[e];var a=this._data.__orphan.indexOf(i);a>=0&&this._data.__orphan.splice(a,1)},t._reverse_createObject=function(t){var e=t[1],n=this._getObjectHash(),i=n[e],r=this._getRemovedHash();r[e]=i,delete n[e];var a=this._data.__orphan.indexOf(i);a>=0&&this._data.__orphan.splice(a,1)},t._reverse_diffPatch=function(t,e){if(!f)return{error:141,cmd:t,text:"diff-match-patch not initialized"};var n=this._find(t[4]),r=t[1];if(!n)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!r)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var a=n.data[r];if(this.isObject(a)||this.isArray(a))return{error:145,cmd:t,text:"Trying to apply text diff/patch to  Object or Array"};var s=f.patch_fromText(t[3]),o=f.patch_apply(s,a);if(!this.isArray(o))return{error:146,cmd:t,text:"patch_apply failed"};var c=o[1];if(!c)return{error:146,cmd:t,text:"patch_apply failed"};for(var _=0;_<c.length;_++)if(!c[_])return{error:146,cmd:t,text:"patch_apply failed"};n.data[r]=o[0],i=e;var u=[4,r,n.data[r],a,t[4],t[5],t[6]];return this._cmd(u,n,null),e?this._cmd(t,n,null):this.writeCommand(t),i=!1,!0},t._reverse_moveToIndex=function(t){var e,n=this._find(t[4]),i=n.data.length,r=0,a=null;for(r=0;i>r;r++){var s=n.data[r];if(s.__id==t[1]){e=s,a=r;break}}if(a!=t[2])throw"_reverse_moveToIndex with invalid index value";if(e){var o=parseInt(t[3]);n.data.splice(r,1),n.data.splice(o,0,e);var c=t.slice();c[2]=o,c[3]=t[2],this._cmd(c,null,c[1])}},t._reverse_pushToArray=function(t){{var e=this._find(t[4]),n=this._find(t[2]);e.data.length}if(e&&n){var i=e.data.length-1,r=e.data[i];if(r.__id==t[2]){var a=[8,i,r.__id,null,e.__id];e.data.splice(i,1),this._cmd(a,null,a[2])}}},t._reverse_removeObject=function(t){{var e=this._find(t[4]),n=this._find(t[2]),i=t[1];e.data.indexOf(n)}if(e&&n){e.data.splice(i,0,n);var r=[7,i,t[2],null,t[4]];this._cmd(r,null,t[2]);var a=this._data.__orphan.indexOf(n);a>=0&&this._data.__orphan.splice(a,1),n.__p=t[4]}},t._reverse_setMeta=function(t){var e=this._find(t[4]),n=t[1];if(e){var i=[3,n,t[3],t[2],t[4]];e[n]=t[3],this._cmd(i)}},t._reverse_setProperty=function(t){var e=this._find(t[4]),n=t[1];if(e){var i=[4,n,t[3],t[2],t[4]];e.data[n]=t[3],this._cmd(i)}},t._reverse_setPropertyObject=function(t){var e=this._find(t[4]),n=t[1],i=this._find(t[2]);if(e&&i){delete e.data[n],i.__p=null;var r=[10,n,null,null,t[4]];this._cmd(r)}},t._reverse_unsetProperty=function(t){var e=this._find(t[4]),n=this._find(t[2]),i=t[1];if("value"!=t[3]){if(e&&i&&n){e.data[i]=n,n.__p=e.__id;var r=[5,i,n.__id,0,t[4]];this._cmd(r,null,n.__id)}}else if(e&&i){var r=[4,i,t[2],null,t[4]];this._cmd(r,null,e.__id)}},t._updateHotBuffer=function(t){var e=(new Date).getTime();for(var n in _)if(_.hasOwnProperty(n)){var i=_[n];if(t||e-i.ms>c.hotMs){if(i.lastCmd){var r=i.firstCmd,a=i.lastCmd;i.chObj.writeLocalJournal([4,r[1],a[2],r[3],r[4]])}else i.chObj.writeLocalJournal(i.firstCmd);delete _[n]}}},t.execCmd=function(t,e,n){try{if(!this.isArray(t))return!1;var i=a[t[0]];if(this._playBackOnFn&&!n)return!1;if(console.log("cmd "+t),i){var r=i.apply(this,[t,e]);if(r!==!0&&(console.log("ERROR "+JSON.stringify(t)),console.log(JSON.stringify(r))),r===!0&&!n)if(e)this.writeLocalJournal(t);else if(4==t[0]&&c.hotMs){var s=t[4],o=s+":"+t[1],f=_[o];f?f.lastCmd=t:_[o]={ms:(new Date).getTime(),firstCmd:t,chObj:this}}else this._updateHotBuffer(!0),this.writeLocalJournal(t);return r}return{error:199,text:"Invalid command"}}catch(u){var h="";return u&&u.message&&(h=u.message),console.error(u,u.message),{error:199,cmd:t,text:"Exception raised "+h}}},t.getJournalCmd=function(t){return this._journal[t]},t.getJournalLine=function(){return this._journalPointer},t.getJournalRange=function(){return[0,this._journal.length]},t.getLocalJournal=function(){return this._journal},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(e||(e={},n={},c={},_={}),!a){if(!f)if("undefined"!=typeof diff_match_patch)f=new diff_match_patch;else if("undefined"!=typeof require){var t=require("diff-match-patch");f=new t}o=new Array(30),a=new Array(30),a[1]=this._cmd_createObject,a[2]=this._cmd_createArray,a[3]=this._cmd_setMeta,a[4]=this._cmd_setProperty,a[5]=this._cmd_setPropertyObject,a[7]=this._cmd_pushToArray,a[8]=this._cmd_removeObject,a[10]=this._cmd_unsetProperty,a[12]=this._cmd_moveToIndex,a[13]=this._cmd_aceCmd,a[14]=this._cmd_diffPatch,o[1]=this._reverse_createObject,o[2]=this._reverse_createArray,o[3]=this._reverse_setMeta,o[4]=this._reverse_setProperty,o[5]=this._reverse_setPropertyObject,o[7]=this._reverse_pushToArray,o[8]=this._reverse_removeObject,o[10]=this._reverse_unsetProperty,o[12]=this._reverse_moveToIndex,o[13]=this._reverse_aceCmd,o[14]=this._reverse_diffPatch;var i=this;r().every(.5,function(){i._updateHotBuffer()})}}),t.moveToLine=function(t){return this.reverseToLine(parseInt(t))},t.playback=function(t){t=t||{};var e=s(),n=this._journal[0][5];if(!n)return void console.error("journal does not have timestamps");var i,a=t.ms||2e3;i=t.journal?t.journal:this._journal.slice();var o=i.length;this.reverseToLine(0);var c=(new Date).getTime(),_=0,f=this,u=n,h=0,l=function(){for(var t,n=(new Date).getTime(),s=n-c,d=o,v=_;d>v;){var p=i[v][5],m=p-u;if(t&&p-t>a){var g=p-s-parseInt(a/2);u=g,m=p-u}if(!(s>m))break;try{f.redo(1,i)}catch(y){console.error(y)}h++,v++,t=p}_=v,_==d&&(r().removeFrameFn(l),f._journal=i,f._playBackOnFn=null,e.resolve(!0))};return this._playBackOnFn=l,r().onFrame(l),e},t.redo=function(t,e){var n=this.getJournalLine();for(t=t||1;t-->0;){var i;if(i=e?e[n]:this._journal[n],!i)return;var r=this.execCmd(i,!1,!0);r!==!0&&console.error(r),n++,this._journalPointer++}},t.redoStep=function(t){t=t||{};var e=t.ms||400,n=this.getJournalLine();if(this._journal[n]){for(var i=this._journal[n][5],r=0;this._journal[n];){var a=this._journal[n][5],s=Math.abs(a-i);if(s>e)break;n++,r++}r>0&&this.redo(r)}},t.reverseCmd=function(t){if(t){var e=o[t[0]];if(e){var n=e.apply(this,[t]);return n}}},t.reverseNLines=function(t){for(var e=this.getJournalLine();e-1>=0&&t-->0;){var n=this._journal[e-1];this.reverseCmd(n),e--,this._journalPointer--}},t.reverseToLine=function(t){var e=this.getJournalLine(),n=this._journal.length;if(!(0>t||t>n)&&t!=e){var i=-1;t>e&&(i=1);for(var r=e,a=this._journal.slice();r>=0&&n>=r;){if(t==r)return;if(0>i&&r>0)var s=a[r-1];else var s=a[r];if(!s)break;if(r+=i,0>r||r>n)break;if(i>0){this.execCmd(s,!1,!0)}else this.reverseCmd(s);this._journalPointer=r}}},t.setClearCreated=function(t){u=t},t.setHotMs=function(t){c.hotMs=t},t.undo=function(t){0!==t&&("undefined"==typeof t&&(t=1),this.reverseNLines(t))},t.undoStep=function(t){t=t||{};var e=t.ms||400,n=this.getJournalLine();if(0!=n){for(var i=this._journal[n-1][5],r=0;n-1>=0;){var a=this._journal[n-1][5],s=Math.abs(a-i);if(s>e)break;n--,r++}r>0&&this.undo(r)}},t.writeCommand=function(){},t.writeLocalJournal=function(t){this._journal&&(this._journal.length>this._journalPointer&&(this._journal.length=this._journalPointer),t[5]||(t[5]=(new Date).getTime()),this._journal.push(t),this._journalPointer++)}}(this),function(t){var e;t.callHook=function(t,n){if(e&&e[t])for(var i=e[t],r=0;r<i.length;r++)i[r](n)},t.hasHook=function(t){return e&&e[t]?e[t].length:void 0},t.removeHook=function(t,n){if(e&&e[t]){var i=e[t].indexOf(n);i>=0&&e[t].splice(i,1)}},t.setHook=function(t,n){e||(e={}),e[t]||(e[t]=[]),e[t].push(n)}}(this),function(t){var e,n;t._addToCache=function(t){t&&t.__id&&(this._objectHash[t.__id]=t)},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){return e||(e={}),e[t]?e[t]:void(e[t]=this)}),t._cmd=function(t,e,n){var i=t[0],r=t[4];this._wCmd(i,r,t),n&&n!=r&&this._wCmd(i,n,t),this._parentCmd(r,t)},t._createModelCommands=function(t,e,n){n||(n=[]);var i;if(i=t.data&&t.__id?t.data:t,this.isObject(i)||this.isArray(i)){var r;if(r=t.__id?t:{data:i,__id:this.guid()},this.isArray(i))var a=[2,r.__id,[],null,r.__id];
else var a=[1,r.__id,{},null,r.__id];e&&(r.__p=e.__id),n.push(a);for(var s in i)if(i.hasOwnProperty(s)){var o=i[s];if(this.isObject(o)||this.isArray(o)){var c=this._createModelCommands(o,r,n),a=[5,s,c.__id,null,r.__id];n.push(a)}else{var a=[4,s,o,null,r.__id];n.push(a)}}return r}},t._createNewModel=function(t,e){if(this.isObject(t)||this.isArray(t)){var n={data:t,__id:this.guid()};if(this._objectHash[n.__id]=n,this.isArray(t))var i=[2,n.__id,[],null,n.__id];else var i=[1,n.__id,{},null,n.__id];e&&(n.__p=e.__id),this.writeCommand(i,n);for(var r in t)if(t.hasOwnProperty(r)){var a=t[r];if(this.isObject(a)||this.isArray(a)){var s=this._createNewModel(a,n);n.data[r]=s;var i=[5,r,s.__id,null,n.__id];this.writeCommand(i,n),this._moveCmdListToParent(s)}else{var i=[4,r,a,null,n.__id];this.writeCommand(i,n)}}return n}},t._find=function(t){var e=this._objectHash[t];return e?e:this._removedHash[t]},t._findObjects=function(t,e){if(!t)return null;if(!this.isObject(t))return t;t=this._wrapData(t),t.__id&&(this._objectHash[t.__id]=t);if(e&&(t.__p=e),t.data){var n=t.data;for(var i in n)if(n.hasOwnProperty(i)){var r=n[i];if(this.isObject(r)){var a=this._findObjects(r,t.__id);a!==r&&(t.data[i]=a)}}}return t},t._getObjectHash=function(){return this._objectHash},t._getRemovedHash=function(){return this._removedHash},t._parentCmd=function(t,e,n){var i=this._find(t);i&&(this._wCmd(42,t,e),i.__p&&(n||(n=this._find(i.__p)),n&&this._parentCmd(i.__p,e,n)))},t._prepareData=function(t){var e=this._wrapData(t);return this._objectHash[e.__id]||(e=this._findObjects(e)),e},t._wCmd=function(t,e,i){if(this._workers[t]&&this._workers[t][e]){var r=this._workers[t][e],a=i[1],s=r["*"],o=r[a];s&&s.forEach(function(t){var e=t[0],r=t[1],a=n[e];a&&a(i,r)}),o&&o.forEach(function(t){var e=t[0],r=t[1],a=n[e];a&&a(i,r)})}},t._wrapData=function(t){if(t&&t._wrapData)return t._data;if(t.__id&&t.data)return t;var e=this._createNewModel(t);return e},t.createWorker=function(t,e,n){var i=e[0],r=e[4];this._workers[i]||(this._workers[i]={}),this._workers[i][r]||(this._workers[i][r]={});var a=this._workers[i][r],s=e[1];s||(s="*"),a[s]||(a[s]=[]),a[s].push([t,n])},t.getData=function(){return this._data},t.indexOf=function(t){if(t||(t=this._data),this.isObject(t)||(t=this._find(t)),t){var e=this._find(t.__p);if(e&&this.isArray(e.data))return e.data.indexOf(t)}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,e,n){if(e){this._objectHash||(this._objectHash={},this._removedHash={});var i=this;this._channelId=t,this._data=e,this._workers={},this._journal=n||[],this._journalPointer=this._journal.length;var r=this._findObjects(e);r!=e&&(this._data=r),this._data.__orphan||(this._data.__orphan=[]),n&&this.isArray(n)&&n.forEach(function(t){i.execCmd(t,!0)})}}),t.setWorkerCommands=function(t){n||(n={});for(var e in t)t.hasOwnProperty(e)&&(n[e]=t[e])},t.toPlainData=function(t,e){if("undefined"==typeof t)return e?t:t=this._data;if(!this.isFunction(t)&&"function"!=typeof t){if(!this.isObject(t))return t;var n;if(this.isArray(t.data)){n=[];for(var i=t.data.length,r=0;i>r;r++)n[r]=this.toPlainData(t.data[r],!0)}else{n={};for(var a in t.data)t.data.hasOwnProperty(a)&&(n[a]=this.toPlainData(t.data[a],!0))}return n}}}(this)},p=function(t,e,n,i,r,a,s,o){var c,_=this;if(!(_ instanceof p))return new p(t,e,n,i,r,a,s,o);var f=[t,e,n,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=p._classInfo.name)return new c(t,e,n,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};p._classInfo={name:"_channelData"},p.prototype=new v,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._channelData=p,this._channelData=p):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._channelData=p:this._channelData=p}.call(new Function("return this")());var m=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},g=function(t,e,n,i,r,a,s,o){var c,_=this;if(!(_ instanceof g))return new g(t,e,n,i,r,a,s,o);var f=[t,e,n,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=g._classInfo.name)return new c(t,e,n,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};g._classInfo={name:"channelObjects"},g.prototype=new m;var y=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var e;t._getNsFromUrl=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getNsShorthand=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getReflections=function(){return _localReflections},t._getReflectionsFor=function(t){if(_localReflections){var e=_localReflections[t];if(e)return e}return[]},t._getReverseNs=function(t){return _nsReverse[t]},t._idFromNs=function(t){if(t){var e=t.length;"#"==t[e-1]&&(t=t.split("@").shift())}return t},t._idToNs=function(t,e){if(t){var n=t.length;if("#"==t[n-1]){var i=t.indexOf("@"),r=t.substring(i+1,n-1);r!=e&&(t=t.substring(0,i)+"@"+e+"#")}else t=t+"@"+e+"#"}return t},t._nsFromId=function(t){var e;if(t){t+="";var n=t.length;"#"==t[n-1]&&(e=t.split("@").pop(),e=e.split("#").shift())}return e},t._transformCmdFromNs=function(t,n){n||(n=this._ns);var i=e,r=t.slice(),a=i[t[0]],s=this;return a&&a.forEach(function(t){r[t]=s._idFromNs(r[t],n)}),r},t._transformCmdToNs=function(t,n){n||(n=this._ns);var i=e,r=t.slice(),a=i[t[0]];if(a)for(var s=0;s<a.length;s++){var o=a[s];r[o]=this._idToNs(r[o],n)}return r},t._transformObjFromNs=function(t,e){if(e||(e=this._ns),t&&t.__id){t.__p&&(t.__p=this._idFromNs(t.__p,e)),t.__id=this._idFromNs(t.__id,e);for(var n in t.data)t.data.hasOwnProperty(n)&&this.isObject(t.data[n])&&this._transformObjFromNs(t.data[n],e)}return t},t._transformObjToNs=function(t,e){if(e||(e=this._ns),t&&t.__id){t.__id=this._idToNs(t.__id,e),t.__p&&(t.__p=this._idToNs(t.__p,e));for(var n in t.data)t.data.hasOwnProperty(n)&&this.isObject(t.data[n])&&this._transformObjToNs(t.data[n],e)}return t},t._transformToNsBeforeInsert=function(t,e){var n=t.__ctxCmdList,i=this._nsFromId(e.__id);console.log(" _transformToNsBeforeInsert ");var r=this;return i?(n&&n.forEach(function(t){t.cmd=r._transformCmdToNs(t.cmd,i)}),t=r._transformObjToNs(t,i),t.__ctxCmdList=n,this._addToCache(t),t):t},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){e||(e={1:[1],2:[1],4:[4],5:[2,4],7:[2,4],8:[2,4],10:[2,4],12:[1,4],13:[4],14:[4],16:[3,4]})})}(this),function(t){var e,n;t._checkout=function(t){var e=this,n=this._socket;return s(function(i){e._policy&&(e._disconnected||e._connected&&n.send("channelCommand",{channelId:t,cmd:"checkout",data:""}).then(function(t){console.log("Checkout tree "),console.log(t),i(t)}))})},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,n){return t&&n?(t+=n.getId(),e||(e={}),e[t]?e[t]:void(e[t]=this)):void 0}),t._createTransaction=function(){this._currentFrame={id:this.guid(),version:1,from:this._data.getJournalLine(),fail_tolastok:!0,commands:[]}},t._fetch=function(t){var e=this._idToNs(t,this._ns),n=this._data._find(e);return n?n:void 0},t._incoming=function(t){var e=this,n=(this._channelId,0);t.on("upgrade_"+this._channelId,function(t){if(e._upgradePending=!1,!e._disconnected&&t){if(t.partial){var i=e._clientState.data;i.reverseToLine(t.partialFrom);var r=0;i.setClearCreated(!0),t.partial.forEach(function(t){if(!(r>0)){var n,a=e._transformCmdToNs(t);(n=i.execCmd(a,!0))!==!0&&r++}}),i.setClearCreated(!1),0==r?(e._clientState.needsRefresh=!1,e._clientState.needsFullRefresh=!1,i._journal.length=t.partialEnds,e._clientState.last_update[0]=0,e._clientState.last_update[1]=i._journal.length,e._clientState.last_sent[0]=0,e._clientState.last_sent[1]=i._journal.length):e._clientState.needsFullRefresh=!0}if(t.data){var a=e._clientState.data.getData();e._transformObjToNs(t.data);var s=d().compareFiles(a,t.data);console.log("Diff obj , myData, cmd.data"),console.log(s),console.log(a),console.log(t.data);var i=e._clientState.data,r=0;i.setClearCreated(!0),s.cmds.forEach(function(t){if(console.log("Diff cmd ",t),!(r>0)){var e;(e=i.execCmd(t,!0))!==!0&&(console.error("Full error ",e),console.log("Return value from failed cmd: ",e),r++)}}),i.setClearCreated(!1),0==r?(e._clientState.needsRefresh=!1,e._clientState.needsFullRefresh=!1,console.log("** full update should have gone ok ** "),i._journal.length=0,i._journal.push.apply(i._journal,t.journal),e._clientState.needsRefresh=!1,e._clientState.version=t.version,e._clientState.last_update[0]=0,e._clientState.last_update[1]=i._journal.length,e._clientState.last_sent[0]=0,e._clientState.last_sent[1]=i._journal.length,console.log("Version ",e._clientState.version)):(n++,console.error("** errors with the full update ** "),n>0?(console.log("--- server command data ---"),console.log(t),console.log("--- the client state ---"),console.log(e._clientState),e._clientState.needsFullRefresh=!1):(e._clientState.needsFullRefresh=!0,e._clientState.fullUpgradeFailCnt=n))}e._slaveController&&e._slaveController._execCmd({cmd:"masterJournalUpgrade",data:t})}}),t.on("s2c_"+this._channelId,function(t){if(!e._disconnected&&t){{e._policy.deltaServerToClient(t,e._clientState)}if(e._slaveController){for(var n=[],i=0;i<t.c.length;i++){var r=t.c[i].slice();n.push(e._transformCmdFromNs(r))}t.c=n,e._slaveController._execCmd({cmd:"masterUpgrade",data:t})}}})},t._isNodeJs=function(){return new Function("try { return this === global; } catch(e) { return false; }")()},t._onFrameLoop=function(t){var e=this,n=this._channelId,i=function(){if(e._policy&&!e._disconnected&&e._connected&&e._clientState){e._clientState.needsRefresh&&(e._upgradePending||e.askUpgrade(e._clientState.needsFullRefresh),e._upgradePending=!0);var i=e._policy.constructClientToServer(e._clientState);i&&t.send("channelCommand",{channelId:n,cmd:"c2s",data:i}).then(function(t){if(t&&t.errors&&t.errors.length>0){var n=!1;t.errors.forEach(function(t){44==t.error&&(n=!0)}),n&&(e._clientState.needsRefresh=!0)}})}};r().onFrame(i)},t._onReconnect=function(){this._slave&&console.log("*** reconnect to the master ***");var t=this;console.log("_onReconnect"),t._slaveController&&(console.log("_slaveController -> trying to send data "),t._slaveController._sendUnsentToMaster());var e=t._policy.constructClientToServer(t._clientState),n=this._socket,i=this._channelId;e&&n.send("channelCommand",{channelId:i,cmd:"c2s",data:e}).then(function(){}),t.askUpgrade()},t.addCommand=function(t,e){var n=this._transformCmdToNs(t,this._ns);return this._data.execCmd(n,e)},t.askUpgrade=function(t){this._socket&&(this._clientState.fullUpgradeFailCnt||this._socket.send("channelCommand",{channelId:this._channelId,cmd:"upgradeRequest",data:{version:this._clientState.version,last_update:this._clientState.last_update,askFull:t}}).then(function(){}))},t.at=function(t,e){var n=this._idToNs(t,this._ns),i=this._data._find(n);return i?i.data[e]:void 0},t.createChannel=function(t,e,n){if(!this._isLocal){var i=JSON.parse(JSON.stringify(n)),r=p(this.guid(),i,[]);i=r.getData(),i=this._transformObjFromNs(i);var a={channelId:t,name:e,chData:i},o=this;return s(function(t){o._socket.send("channelCommand",{channelId:o._channelId,cmd:"createChannel",data:a}).then(function(e){t(e)})})}},t.diffSet=function(t,e,i){if(n){var r=this._idToNs(t,this._ns),a=this._data._find(r);if(a&&!this.isObject(i)){var s=a.data[e];if(s!=i){var o=n.diff_main(s,i),c=n.diff_main(i,s);n.diff_cleanupEfficiency(o),n.diff_cleanupEfficiency(c);var _=n.patch_toText(n.patch_make(s,o)),f=n.patch_toText(n.patch_make(i,c));this.addCommand([14,e,_,f,r])}}}},t.disconnect=function(){return this._disconnected=!0,this},t.fork=function(t,e){if(!this._isLocal){var n={version:this._channelStatus.version,channelId:t,name:e,journalLine:1};n.journalLine=this._clientState.last_update[1];var i=this;return s(function(t){i._socket.send("channelCommand",{channelId:i._channelId,cmd:"fork",data:n}).then(function(e){t(e)})})}},t.fromMaster=function(t){console.log("from master",JSON.stringify(t))},t.fromSlave=function(t){if(console.log("from slave",JSON.stringify(t)),"s2c"==t.cmd){var e=this;t.c.forEach(function(t){console.log(t);var n=e.addCommand(t);console.log(JSON.stringify(n)),console.log(JSON.stringify(e._data.getData()))})}},t.get=function(t,e){var n=this._idToNs(t,this._ns),i=this._data._find(n);return i?i.data[e]:void 0},t.getChannelData=function(){return this._data},t.getData=function(){return this._data.getData()},t.indexOf=function(t){var e=this._idToNs(t,this._ns),n=this._data._find(e);if(n){var i=this._fetch(n.__p);if(i&&i.data){var r=i.data.indexOf(n);return r}}return-1},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,e,i){if(!n)if("undefined"!=typeof diff_match_patch)n=new diff_match_patch;else if("undefined"!=typeof require){var r=require("diff-match-patch");n=new r}if(this._policy||(this._policy=f()),i&&i.localChannel){this._channelId=t,this._options=i,this._socketGUID=this.guid(),this._isLocal=!0,this._socket=O(this._socketGUID,1);var a=this._socket.getEnum();this._ns=a,this._id=t+this._socket.getId();var s=this,o=i.localData;o=s._transformObjToNs(i.localData,a);var c=p(s._id,o,[]);return s._data=c,void s.resolve({result:!0,channelId:t})}if(t&&e){this._channelId=t,this._socket=e,this._options=i,this._changeFrames=[],this._pendingFrames=[];var a=e.getEnum();this._ns=a,this._id=t+e.getId();var s=this;this._onFrameLoop(e,a),this._incoming(e,a),this._connCnt=0,e.on("disconnect",function(){s._connected=!1}),e.on("connect",function(){console.log("*** socket reconnect for "+t+" *** "),console.log("Connection count "+s._connCnt),s._connCnt++,i.auth&&e.send("auth",{userId:i.auth.username,password:i.auth.password}).then(function(n){return n.userId?(s._userId=n.userId,s._logged=!0,e.send("requestChannel",{channelId:t,initWithData:i.initWithData})):(s._logged=!1,!1)}).then(function(n){return n&&n.channelId==t?(s._connected=!0,s._connCnt>1?(s._onReconnect(),!1):e.send("channelCommand",{channelId:t,cmd:"readBuildTree",data:""})):!1}).then(function(e){if(e){var n=e.build;s._channelStatus=e.status;var i=n.pop();i=s._transformObjToNs(i,a);for(var r=p(s._id,i,[]),o=n.pop();o;)r._journalPointer=0,r._journal.length=0,o.forEach(function(t){r.execCmd(s._transformCmdToNs(t,a),!0)}),o=n.pop();s._clientState={data:r,client:s,needsRefresh:!1,version:s._channelStatus.version,last_update:[0,r.getJournalLine()],last_sent:[0,r.getJournalLine()]},s._data=r,s._createTransaction(),s.resolve({result:!0,channelId:t})}else s.resolve({result:!1,text:"Authorization or connection failed"})})})}}),t.isConnected=function(){return this._disconnected?!1:this._connCnt&&this._connected?!0:!1},t.isLocal=function(){return this._isLocal},t.length=function(t){var e=this._idToNs(t,this._ns),n=this._data._find(e);return n&&n.data?n.data.length||0:0},t.moveDown=function(t){var e=this._idToNs(t,this._ns),n=this._data._find(e);if(n){var i=this._fetch(n.__p);if(i&&i.data){var r=i.data.indexOf(n),a=r-1;a>=0&&r>=0&&r!=a&&i.data.length>a&&this.addCommand([12,e,a,r,i.__id])}}},t.moveTo=function(t,e){var n=this._idToNs(t,this._ns),i=this._data._find(n);if(i){var r=this._fetch(i.__p);if(r&&r.data){var a=r.data.indexOf(i);a>=0&&a!=e&&r.data.length>e&&this.addCommand([12,n,e,a,r.__id])}}},t.moveUp=function(t){var e=this._idToNs(t,this._ns),n=this._data._find(e);if(n){var i=this._fetch(n.__p);if(i&&i.data){var r=i.data.indexOf(n),a=r+1;a>=0&&r>=0&&r!=a&&i.data.length>a&&this.addCommand([12,e,a,r,i.__id])}}},t.reconnect=function(){return this._disconnected=!1,this},t.redo=function(t){this._data.redo(t)},t.redoStep=function(t){this._data.redoStep(t)},t.remove=function(t){var e=this._idToNs(t,this._ns),n=this._data._find(e);if(n){var i=this._fetch(n.__p);if(i&&i.data){var r=i.data.indexOf(n);r>=0&&this.addCommand([8,r,e,0,i.__id])}}},t.sendCommand=function(t,e){var n=this,i=this._channelId,r=this._socket;if(n._policy&&!n._disconnected&&n._connected&&r)return r.send("channelCommand",{channelId:i,cmd:t,data:e})},t.set=function(t,e,n){var i=this._idToNs(t,this._ns),r=this._data._find(i);if(r&&!this.isObject(n)){var a=r.data[e];a!=n&&(console.log("command 4 "+JSON.stringify([4,e,n,a,i])),this.addCommand([4,e,n,a,i]))}},t.setChannelModel=function(t){this._serverModel=t},t.setMasterConnection=function(t){this._master=t},t.setObject=function(t,e,n){var i=this._idToNs(t,this._ns),r=this._data._find(i);if(r&&this.isObject(n)&&n.__id){var a=r.data[e];a||this.addCommand([5,e,n.__id,null,i])}},t.setSlaveServer=function(t){this._slave=t},t.sync=function(t){var e=this._socket,n=this,i=this._channelId;return s(function(r){return n.isConnected()&&t&&t.out&&t.out.channelId?void e.send("channelCommand",{channelId:i,cmd:"sync",data:{sync:t}}).then(function(t){r(t)}):void r({success:!1})})},t.undo=function(t){this._data.undo(t)},t.undoStep=function(t){this._data.undoStep(t)},t.unset=function(t,e){var n=this._idToNs(t,this._ns),i=this._data._find(n);i&&i.data&&(this.isObject(i.data[e])?this.addCommand([10,e,i.data[e].__id,null,n]):i.data&&"undefined"!=typeof i.data[e]&&this.addCommand([10,e,i.data[e],"value",n]))},t.upgradeVersion=function(){this._socket.send("channelCommand",{channelId:this._channelId,cmd:"snapshot",data:{}}).then(function(){})}}(this)},b=function(t,e,n,i,r,a,s,o){var c,_=this;if(!(_ instanceof b))return new b(t,e,n,i,r,a,s,o);var f=[t,e,n,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=b._classInfo.name)return new c(t,e,n,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};y.prototype=s.prototype,b._classInfo={name:"channelClient"},b.prototype=new y,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.channelClient=b,this.channelClient=b):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.channelClient=b:this.channelClient=b}.call(new Function("return this")());var j=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.on=function(t,e){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(e),"connect"==t&&this._connected&&e(this._socket),this},t.removeListener=function(t,e){if(this._ev&&this._ev[t])for(var n=this._ev[t],i=0;i<n.length;i++)if(n[i]==e)return void n.splice(i,1)},t.trigger=function(t,e,n){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(e,n)}),this}}}(this),function(t){var e,i;t.disconnect=function(){this._socket.messageTo({disconnect:!0}),me._connected=!1},t.emit=function(t,e,n){var i={name:t,data:e};if(n){i._callBackId=this.guid();var r=this,a=function(t){n(t),r.removeListener(i._callBackId,a)};this.on(i._callBackId,a)}this._socket.messageTo(i)},t.getEnum=function(){var t=this.socketId;return e[t]||(e[t]=i++),e[t]},t.getId=function(){return this.socketId},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,r,a){e||(e={},i=1);var s=this,o=this.guid();if(this.socketId=o,e[this.socketId]||(e[this.socketId]=i++),a){var c,_,f=!1,u=function(){f?s.trigger("connect",s._socket):(c&&c.release(),_&&_.release(),c=n(t,r,"openConnection","client",a),_=n(t,r,o,"client",a),_.on("clientMessage",function(t,e){e.connected?(s._socket=_,s._connected=!0,s.trigger("connect",_)):s.trigger(e.name,e.data)}),c.messageTo({socketId:o}))},s=this;return a.on("disconnect",function(){s.trigger("disconnect")}),void(a.connected?u():a.on("connect",u))}var c=n(t,r,"openConnection","client",a),_=n(t,r,o,"client",a);_.on("clientMessage",function(t,e){e.connected?(s._socket=_,s._connected=!0,s.trigger("connect",_)):s.trigger(e.name,e.data)}),c.messageTo({socketId:o})}),t.send=function(t,e){var n=this;return s(function(i){n.emit(t,e,i)})}}(this)},O=function(t,e,n,i,r,a,s,o){var c,_=this;if(!(_ instanceof O))return new O(t,e,n,i,r,a,s,o);var f=[t,e,n,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=O._classInfo.name)return new c(t,e,n,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};O._classInfo={name:"_clientSocket"},O.prototype=new j,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._clientSocket=O,this._clientSocket=O):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._clientSocket=O:this._clientSocket=O}.call(new Function("return this")());var I=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},C=function(t,e,n,i,r,a,s,o){var c,_=this;if(!(_ instanceof C))return new C(t,e,n,i,r,a,s,o);var f=[t,e,n,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=C._classInfo.name)return new c(t,e,n,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};C._classInfo={name:"moshModule"},C.prototype=new I,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());