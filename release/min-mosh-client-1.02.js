(function(){var t={},n=function(){!function(t){t.clearEvents=function(){delete this._ev},t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){var i=this;return this._ev[t].forEach(function(t){t(i,n,e)}),this}}}(this),function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,e;t.close=function(){this.trigger("disconnect")},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,i,r,a){this._server=t,this._port=n,this._role=r,this._socketId=i,this._dbName="tcp://"+this._server+":"+this._port+":"+this._socketId,e||(e="undefined"!=typeof lokki?lokki("tcp"):{log:function(){},error:function(){}}),a?(this._socket=a,this.socketPump(r)):this.memoryPump(r)}),t.memoryPump=function(t){var i=this,a=this._dbName+":to",s=this._dbName+":from";n||(n={}),n[a]||(n[a]=[]),n[s]||(n[s]=[]);var o=function(){if("server"==t){var r=n[a].slice();r.forEach(function(t){e.log("server got message ",t),i.trigger("serverMessage",t),n[a].shift()})}if("client"==t){var r=n[s].slice();r.forEach(function(t){i.trigger("clientMessage",t),n[s].shift()})}};this._memoryFn=o,r().every(.1,o)},t.messageFrom=function(t){var e=this._socket;if(e)return void e.emit(this._dbName,t);var i=this._dbName+":from";n[i].push(t)},t.messageTo=function(t){var e=this._socket;if(e)return void e.emit(this._dbName,t);var i=this._dbName+":to";n[i].push(t)},t.release=function(){this.clearEvents();var t=this._socket;this._pumpListener&&t.removeListener(this._dbName,this._pumpListener),this._memoryFn&&this._memoryFn._release&&this._memoryFn._release()},t.socketPump=function(t){var n=this,e=this._socket;"server"==t&&(this._pumpListener=function(t){n.trigger("serverMessage",t)},e.on(this._dbName,this._pumpListener)),"client"==t&&(this._pumpListener=function(t){n.trigger("clientMessage",t)},e.on(this._dbName,this._pumpListener))}}(this)},e=function(t,n,i,r,a,s,o,c){var _,f=this;if(!(f instanceof e))return new e(t,n,i,r,a,s,o,c);var u=[t,n,i,r,a,s,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,u)}),"function"==typeof _){if(_._classInfo.name!=e._classInfo.name)return new _(t,n,i,r,a,s,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};e._classInfo={name:"_tcpEmu"},e.prototype=new n;var i=function(){!function(t){var n,e,i,r,a,s,o,c;t._easeFns=function(){o={easeIn:function(t){return t*t},easeOut:function(t){return-1*t*(t-2)},easeInOut:function(t){return.5>t?t*t:-1*t*(t-2)},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return(1-t)*(1-t)*(1-t)+1},pow:function(t){return Math.pow(t,parseFloat(1.5-t))},linear:function(t){return t}}},t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.addEasingFn=function(t,n){o[t]=n},t.after=function(t,n,e){e||(e="aft_"+s++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.ease=function(t,n,e,i){var r=o[t];r||(r=o.pow);var a="e_"+s++;c[a]={easeFn:r,duration:n,cb:e,over:i}},t.every=function(t,n,e){e||(e="t7491_"+s++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){this._easeFns(),s=1;var t,o;if("undefined"!=typeof window){var t=window.requestAnimationFrame,o=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],o=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}var _=new Function("try { return this == global; } catch(e) { return false; }")();_?t=function(t){return setImmediate(t)}:t||(t=function(t){return setTimeout(t,16)}),o||(o=function(t){clearTimeout(t)}),e=[],i={},r={},a=[],c={};var f=0,u=function(){var n=(new Date).getTime(),s=f-n;0==f&&(s=0);for(var o;o=e.shift();)"[object Array]"===Object.prototype.toString.call(o)?o[1].apply(o[0],o[2]):o();for(var _=0;_<a.length;_++){var h=a[_];h()}for(var l in c)if(c.hasOwnProperty(l)){var d=c[l];d.start||(d.start=n);var v=n-d.start,p=v/d.duration;p>=1&&(p=1,delete c[l]),d.cb(d.easeFn(p)),1==p&&d.over&&d.over()}for(var l in i)if(i.hasOwnProperty(l)){var d=i[l];d[0](d[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var d=r[l];d.nextTime<n&&(d.remove?d.nextTime>0?(d.fn(),delete r[l]):d.nextTime=n+d.step:(d.fn(),d.nextTime=n+d.step)),d.until&&d.until<n&&delete r[l]}t(u),f=n};u(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){a.push(t)},t.removeFrameFn=function(t){var n=a.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),a.splice(n,1),!0):!1}}(this)},r=function(t,n,e,i,a,s,o,c){var _,f=this;if(!(f instanceof r))return new r(t,n,e,i,a,s,o,c);var u=[t,n,e,i,a,s,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,u)}),"function"==typeof _){if(_._classInfo.name!=r._classInfo.name)return new _(t,n,e,i,a,s,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};r._classInfo={name:"later"},r.prototype=new i,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.later=r,this.later=r):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.later=r:this.later=r}.call(new Function("return this")());var a=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,r=[],a=new Array(e);return this.then(function(){var t=s();return 0==n.length&&t.resolve([]),n.forEach(function(n,s){n.then?(r.push(n),n.then(function(n){a[s]=n,i++,i==e&&t.resolve(a)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.genPlugin=function(t,n){this.plugin(t,function(){var t=Array.prototype.slice.call(arguments,0);console.log("Plugin args",t);var e=s();return this.then(function(){var i=Array.prototype.slice.call(arguments,0),r=t.concat(i),a=n.apply(this,r);e.resolve(a)},function(t){e.reject(t)}),e})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var e=this;r().asap(function(){t(function(t){e.resolve(t)},function(t){e.resolve(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var e=new s(t,n),i=this;return 1==this._state&&r().asap(function(){i.fulfill(i.value())}),2==this._state&&ater().asap(function(){i.reject(i.rejectReason())}),this._childPromises.push(e),e},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},s=function(t,n,e,i,r,a,o,c){var _,f=this;if(!(f instanceof s))return new s(t,n,e,i,r,a,o,c);var u=[t,n,e,i,r,a,o,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,u)}),"function"==typeof _){if(_._classInfo.name!=s._classInfo.name)return new _(t,n,e,i,r,a,o,c)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};s._classInfo={name:"_promise"},s.prototype=new a,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._promise=s,this._promise=s):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._promise=s:this._promise=s}.call(new Function("return this")());var o=function(){!function(t){var n,e,i;t.__dataTr=function(){},t._collectObject=function(t,n,e){this.isArray(n)||(n=n.split(","));var i={};n.forEach(function(n){i[n]=t[n](),t.on(n,function(){i[n]=t[n](),e(i)})}),e(i)},t._forMembers=function(t){var n=this;if(this.isArray())for(var e=0;e<this._data.length;e++){var i=this._data[e];this.isObject(i)&&i.__dataTr&&t(i)}else this._members.forEach(function(e){n[e]&&t(n[e])})},t._initializeData=function(t,n){if(t){this._data=t.data,this._docData=t;var e=this._client.getChannelData(),i=this._client._idToNs(this._docData.__id,this._client._ns);e.createWorker("_to_ch",[7,"*",null,null,i],{target:this}),e.createWorker("_to_ch",[5,"*",null,null,i],{target:this}),e.createWorker("_d_set",[4,"*",null,null,i],{target:this}),e.createWorker("_d_rem",[8,"*",null,null,i],{target:this}),e.createWorker("_d_ins",[7,"*",null,null,i],{target:this}),e.createWorker("_d_mv",[12,"*",null,null,i],{target:this}),e.createWorker("_d_cf",[5,"*",null,null,i],{obj:this}),e.createWorker("_d_cf",[4,"*",null,null,i],{obj:this}),e.createWorker("_d_ch",[42,"*",null,null,i],{target:this});var r=t.data;if(r instanceof Array){for(var a in r)this[a]=c(r[a],n,this._client);this._initIterator()}else for(var a in r)if(r.hasOwnProperty(a)){var s=r[a];if(this.isFunction(s))continue;if(!this.isFunction(s)&&(s===Object(s)||s instanceof Array)){this[a]=new c(s,n,this._client);continue}this.isFunction(s)||this.isObject(s)||this.isArray(s)||this[a]||this.createPropertyUpdateFn(a,s)}}},t._objectCreateCmds=function(t,n){if(n||(n=[]),this.isObject(t)&&t.data)if(this.isArray(t.data)){n.push([2,t.__id,"",null,t.__id]);for(var e=0;e<t.data.length;e++){var i=t.data[e];if(this.isObject(i)){this._objectCreateCmds(i,n);var r=[7,e,i.__id,null,t.__id];n.push(r)}}}else{n.push([1,t.__id,"",null,t.__id]);for(var a in t.data)if(t.data.hasOwnProperty(a)){var s=t.data[a];if(this.isObject(s)){this._objectCreateCmds(s,n);var r=[5,a,s.__id,null,t.__id];n.push(r)}else{var r=[4,a,s,null,t.__id];n.push(r)}}}return n},t._parseURL=function(t){var n=t.split("://"),e=n.shift(),i=n.shift(),r=i.split("/"),a=r.shift(),s=a.split(":"),o=s[0],c=s[1],_=r.shift(),f=r.pop(),u=r.join("/");return{url:t,ip:o,port:c,sandbox:_,path:u,file:f,protocol:e}},t._reGuidRawData=function(t){if(this.isArray(t)){var n=this;t.forEach(function(t){n._reGuidRawData(t)})}else if(this.isObject(t))for(var e in t)t.hasOwnProperty(e)&&("__id"!=e?(this.isObject(t[e])&&this._reGuidRawData(t[e]),this.isArray(t[e])&&this._reGuidRawData(t[e])):t[e]=this.guid())},t._wrapToData=function(t){var n;if(t.__id&&t.data)n=t;else var n={data:t,__id:this.guid()};if(n.data&&this.isObject(n.data))for(var e in n.data)if("__oid"!=e){if(n.data.hasOwnProperty(e)){var i=n.data[e];if(this.isFunction(i))continue;this.isObject(i)&&(n.data[e]=this._wrapToData(i))}}else delete n.data[e];return n},t.addController=function(){console.error("** askChannelQuestion ** not implemented now ")},t.askChannelQuestion=function(){console.error("** askChannelQuestion ** not implemented now ")},t.at=function(t){var n=this._docData.data[t];return n?c(n,null,this._client):void 0},t.clear=function(){for(var t=this.length();t--;)this.pop()},t.clone=function(){return c(this.serialize())},t.copyToData=function(){var t=this.toData();return this._reGuidRawData(t),t},t.createArrayField=function(t,n){return this.set(this._docData.__id,t,n)},t.createField=function(t,n){return this.set(t,n||""),this},t.createObjectField=function(t,n){return this.set(this._docData.__id,t,n)},t.createPropertyUpdateFn=function(n,i){if(this.isObject(i)||this.isObject(this._docData.data[n]))return void(this[n]=c(i,null,this._client));t[n]||(t[n]=function(t){return"undefined"==typeof t?this._client.get(this._docData.__id,n):(this._client.set(this._docData.__id,n,t),this)},e[n]=!0)},t.createWorker=function(t,n,e,r){n[4]=this._client._idToNs(n[4],this._client._ns);var a=this._client.getChannelData();if(a.createWorker(t,n,e),r&&(i||(i={}),!i[t])){var s={};s[t]=r,a.setWorkerCommands(s),i[t]=!0}return this},t.diff_set=function(t,n){return this.isObject(n)?this:(this._client.diffSet(this._docData.__id,t,n),this.createPropertyUpdateFn(t,n),this)},t.emitValue=function(t,n){if(this._processingEmit)return this;if(this._processingEmit=!0,this._controllers)for(var e=0,i=0;i<this._controllers.length;i++){var r=this._controllers[i];r[t]&&(r[t](n),e++)}this._valueFn&&this._valueFn[t]&&this._valueFn[t].forEach(function(t){t(n)}),this._parent&&this._parent.emitValue&&this._parent.emitValue(t,n),this._processingEmit=!1},t.extendWith=function(n){for(var e in n){var i=n[e];this.isFunction(i)&&(t[e]=i)}},t.find=function(){return console.error("*** FIND IS NOT IMPLEMENTED *** "),null},t.forEach=function(t){var n=this;this._docData.data.forEach(function(e){t(c(e,null,n._client))})},t.forTree=function(t,n){var e={},i=!1;if(n){var r=t.split(",");r.forEach(function(t){e[t.trim()]=!0,i=!0})}else n=t;n(this);var a=this;return this.isArray()?this.forEach(function(t){t.forTree(n)}):this.keys(function(t){if((!i||e[t])&&a[t]&&a.hasOwn(t)){var r=a[t];r.forTree&&r.forTree(n)}}),this},t.get=function(t){return console.log("Calling get for "+t),console.log("docData "+JSON.stringify(this._docData)),this._client.get(this._docData.__id,t)},t.getData=function(t){if(this._docData)var n=this._client._fetch(this._docData.__id);else{if(!this._client)return;var n=this._client.getData()}if(t){var e=JSON.parse(JSON.stringify(n));n=this._client._transformObjFromNs(e)}return n},t.getID=function(){return this._docData.__id},t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.hasOwn=function(t){return"undefined"!=typeof this._docData.data[t]&&this[t]?!0:!1},t.indexOf=function(){return this._client.indexOf(this._docData.__id)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={},e={})}),t.insertAt=function(t,n){return this.push(n,t)},t.isArray=function(t){return"undefined"==typeof t?this._docData&&this._docData.data?this.isArray(this._docData.data):!1:"[object Array]"===Object.prototype.toString.call(t)},t.isDataTrait=function(t){return t._docData?!0:void 0},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this._docData&&this._docData.data?this.isObject(this._docData.data):!1:t===Object(t)},t.item=function(t){return this.at(t)},t.keys=function(t){for(var n in this._docData.data)this._docData.data.hasOwnProperty(n)&&t(n,this._docData.data[n],this._docData.data);return this},t.length=function(){return this._docData&&this._docData.data?this._docData.data.length:0},t.moveDown=function(){return this._client.moveDown(this._docData.__id),this},t.moveToIndex=function(t){return this._client.moveTo(this._docData.__id,t),this},t.moveUp=function(){return this._client.moveUp(this._docData.__id),this},t.onValue=function(t,n){this._valueFn||(this._valueFn={}),this._valueFn[t]||(this._valueFn[t]=[]),this._valueFn[t].indexOf(n)<0&&this._valueFn[t].push(n)},t.parent=function(t){if("undefined"!=typeof t)return this;if(this._docData){var t=this._docData.__p;return t?c(t):void 0}},t.pop=function(){var t=this.length();if(t){var n=this.at(t-1);return n&&n.remove(),n}},t.push=function(t,n){if(!this.isArray())return this;var e,i=!1;if(t._wrapToData){t=t.getData();var r=this._client._fetch(t.__id);r&&(i=!0)}if(e=t.__id&&t.data?this._client._transformObjToNs(t,this._client._ns):this._wrapToData(t),!i)for(var a=this._objectCreateCmds(e),s=0;s<a.length;s++)this._client.addCommand(a[s]);var o;if("undefined"!=typeof n){o=n;var r=this._client._fetch(this._docData.__id);if(0>o||o>r.data.length)return}else{var r=this._client._fetch(this._docData.__id);o=r.data.length}return this._client.addCommand([7,o,e.__id,null,this._docData.__id]),this},t.redo=function(t){return this._client.redo(t),this},t.redoStep=function(t){return this._client.redoStep(t),this},t.remove=function(){return this._client.remove(this._docData.__id),this},t.removeListener=function(t,n){if(this._events&&this._events[t]){var e=this._events[t].indexOf(n);e>=0&&this._events[t].splice(e,1),0==this._events[t].length&&delete this._events[t]}},t.serialize=function(t){var n,e=this._docData.data;n=this.isArray(this._data)?[]:{};for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];if("undefined"==typeof r)continue;if(t&&(this.isObject(r)||this.isArray(r)))continue;n[i]=this.isObject(r)?c(r).serialize():r}return n},t.set=function(t,n){if(this.isFunction(n)){var e=this;return this.then(function(){return e.set(t,n(e.get(t)))}),this}if(this.isObject(n)){var i,r=n;r._wrapToData&&(r=r.getData()),i=r.__id&&r.data?this._client._transformObjToNs(r,this._client._ns):this._wrapToData(r);for(var a=this._objectCreateCmds(i),s=0;s<a.length;s++)this._client.addCommand(a[s]);this._client.setObject(this._docData.__id,t,i);var o=this._client._fetch(i.__id);return this.createPropertyUpdateFn(t,o),this}return console.log("value set "+t+" = "+n),this._client.set(this._docData.__id,t,n),this.createPropertyUpdateFn(t,n),this},t.toData=function(){var t=JSON.stringify(this._docData),n=JSON.parse(t);return n.__ctxCmdList&&delete n.__ctxCmdList,n.__cmdList&&delete n.__cmdList,n},t.toPlainData=function(){return this.getChannelData().toPlainData(this._docData)},t.undo=function(t){return this._client.undo(t),this},t.undoStep=function(t){return this._client.undoStep(t),this},t.unset=function(t){return this._client.unset(this._docData.__id,t),this},t.upgradeVersion=function(){return this._client.upgradeVersion(),this}}(this),function(t){var n;t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n=[])}),t.on=function(t,n){this._events||(this._events={}),this._events[t]||(this._events[t]=[]),this._events[t].push(n);var e=this;n._unbindEvent=function(){e.removeListener(t,n)}},t.removeListener=function(t,n){if(this._events&&this._events[t]){var e=this._events[t].indexOf(n);e>=0&&this._events[t].splice(e,1),0==this._events[t].length&&delete this._events[t]}},t.trigger=function(t,e){if(!(n.indexOf(t+this._guid)>=0)&&this._events&&this._events[t]){var i=this._events[t],r=this;n.push(t+this._guid);for(var a=i.length,s=0;a>s;s++)i[s](r,e);var o=n.indexOf(t+this._guid);n.splice(o,1)}}}(this),function(t){t.propWorker=function(t,n,e){return this.createWorker(n,[4,t,null,null,this.getID()],e),this}}(this),function(t){var n,e,i,r,a;t._addFactoryProperty=function(t){n||(n=[]),n.push(t)},t._atObserveEvent=function(t){a=t},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){if(i||(i={}),this.isObject(t)){if(t._objEventWorker)return t;if(t.data&&t.__id){var r=i[t.__id];if(r)return r}}else if("string"==typeof t){var r=i[t];if(r)return r}if(n&&e)for(var a=0;a<n.length;a++){var s,o=n[a];if(t&&t.data?s=t.data[o]:t&&(s=t[o]),s){var c=e[s];if(c)return c}}}),t._findConnOptions=function(){if(this._connectionOptions)return this._connectionOptions;var t=this.parent();return t?t._findConnOptions():void 0},t._initIterator=function(){var t=this;"undefined"!=typeof Symbol&&"undefined"!=typeof Symbol.iterator&&(t[Symbol.iterator]=function(){var n=0;return{next:function(){var e=t.at(n++);return e?{value:e,done:!1}:{done:!0}}}})},t._initWorkers=function(){var t=this;if(!r){var n=t._client.getChannelData();n.setWorkerCommands({_obs_4:function(t,n){a||(n.target[t[1]]=t[2])},_obs_7:function(t,n){if(!a){var e=t[1],i=c(t[2]);i.isFulfilled()&&(Array.unobserve(n.target,n.parentObserver),n.target[e]=i.toObservable(n.target,n.parentObserver),Array.observe(n.target,n.parentObserver))}},_obs_8:function(t,n){if(!a){var e=t[1];Array.unobserve(n.target,n.parentObserver),n.target.splice(e,1),Array.observe(n.target,n.parentObserver)}},_obs_12:function(t,n){if(!a){var e=parseInt(t[3]),i=parseInt(t[2]),r=n.target,s=r[e];Array.unobserve(r,n.parentObserver),r.splice(e,1),r.splice(i,0,s),Array.observe(r,n.parentObserver)}},_d_set:function(t,n){n.target.trigger(t[1],t[2])},_d_cf:function(t,n){var e=n.obj;if(4==t[0]&&(e[t[1]]||e.createPropertyUpdateFn(t[1],t[2])),5==t[0]&&!e[t[1]]){var i=e._docData.data[t[1]];i&&e.createPropertyUpdateFn(t[1],i)}},_d_rem:function(t,n){n.target.trigger("remove",t[1])},_to_ch:function(t,n){var e=n.target;if(e._client&&!e._client._isLocal){var i=e._client._fetch(t[2]);i&&c(i,null,e._client)}},_d_ins:function(t,n){n.target.trigger("insert",t[1])},_d_mv:function(t,n){n.target.trigger("move",{itemId:t[1],parentId:t[4],from:t[3],to:t[2]})},_d_ch:function(t,n){n.target.trigger("childChanged",t)}}),r=!0}},t._parseURL=function(t){var n=t.split("://"),e=n.shift(),i=n.shift(),r=i.split("/"),a=r.shift(),s=r.join("/"),o=a.split(":"),c=o[0],_=o[1],f=r.shift(),u=r.pop(),h=r.join("/"),l={protocol:e,ip:c,port:_,sandbox:f,fullPath:s,path:h,file:u};return l},t.addToCache=function(t,n){i||(i={}),t&&(i[t]=n)},t.channel=function(){return this._client},t.createChannel=function(t,n,e){var i=this;return s(function(r){e||(e={}),i._client.createChannel(t,n,e).then(function(n){if(n.result===!1)return void r(n);var e=i._request,a=c(e.protocol+"://"+e.ip+":"+e.port+"/"+t,i._initOptions);a.then(function(){r({result:!0,channel:a})})})})},t.createSubClass=function(t,n,e){var i=e,r=function(t,n,e,i,a,s,o,c){if(!(this instanceof r))return console.log("NOT instance of..."),new r(t,n,e,i,a,s,o,c);console.log("is instance of..."),console.log(this.__traitInit);var _=[t,n,e,i,a,s,o,c];if(this.__factoryClass){var f,u=this;if(this.__factoryClass.forEach(function(t){f=t.apply(u,_)}),"[object Function]"==Object.prototype.toString.call(f)){if(f._classInfo.name!=r._classInfo.name)return new f(t,n,e,i,a,s,o,c)}else if(f)return f}if(this.__traitInit){console.log("Calling the subclass trait init...");var u=this;this.__traitInit.forEach(function(t){t.apply(u,_)})}else"function"==typeof this.init&&this.init.apply(this,_)};return r._classInfo={name:this.guid()},i.prototype=c.prototype,r.prototype=new i,this.registerComponent(n,r),this._addFactoryProperty(t),r},t.diff=function(t){var n=h(),e=n.compareFiles(this.getData(!0),t.getData(!0));return e.cmds},t.disconnect=function(){return this._client&&this._client.disconnect(),this},t.filter=function(t){var n=c([]);return this.localFork().forEach(function(e){t(e)&&n.push(e.toData(!0))}),n},t.fork=function(t,n){if(!t||this._client._isLocal)return this.localFork();var e=this;return s(function(i){e._client.fork(t,n).then(function(n){if(n.result===!1)return void i(n);var r=e._request,a=c(r.protocol+"://"+r.ip+":"+r.port+"/"+t,e._initOptions);a.then(function(){i({result:!0,fork:a})})})})},t.getChannelClient=function(){return this._client},t.getChannelData=function(){return this._client.getChannelData()},t.getJournal=function(){var t=this.getChannelData();return t._journal.slice()},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){n=n||{};var i=this;if(this._initOptions=n,"string"==typeof t){if(!t.match("://"))return;var r=this._parseURL(t);this._request=r,this._connectionOptions=n,this._socket=b(r.protocol+"://"+r.ip,r.port,n.ioLib);var a={};a.auth=n.auth?n.auth:{},n.initWithData&&(a.initWithData=this._wrapToData(n.initWithData)),this._client=g(r.fullPath,this._socket,a),this._client.then(function(t){if(t.result===!1)return void i.trigger("login::failed");var n=i._client.getData();i._initializeData(n),i.addToCache(n.__id,i),i._initWorkers(),i.resolve(!0)})}else if(e)e&&!this._client&&(this._client=e),this.isObject(t)&&t.__id&&(this._initializeData(t),this.addToCache(t.__id,this)),i._initWorkers(),this.resolve(!0);else{this.isObject(t)&&!t.__id&&(t=this._wrapToData(t));var s=g(this.guid(),null,{localChannel:!0,localData:t});this._client=s;var i=this,o=i._client.getData();if(!o)return void i.resolve(!0);i._initializeData(o),i.addToCache(o.__id,i),i._initWorkers(),i.resolve(!0)}}),t.localFork=function(){var t=this.getData(!0);return c(t)},t.map=function(t){var n=c([]),e=this.localFork(),i=0;return this.localFork().forEach(function(r){var a=t(r,i,e);n.push(a),i++}),n},t.merge=function(t){var n=this.diff(t);return this.patch(n),this},t.openChannel=function(t){var n=this;return s(function(e){var i=(n._request,c(t,n._findConnOptions()));i.then(function(){e({result:!0,channel:i})})})},t.patch=function(t){var n=this;return t.forEach(function(t){var e=n._client._transformCmdToNs(t);n._client.addCommand(e,!0)}),this},t.playback=function(t){var n=this.getChannelData();return n.playback(t)},t.pushToObjArray=function(t,n,e){var i,r,a,s=t.split("/"),o=this,c={};if(e){for(var _ in e)if(e.hasOwnProperty(_)){var f=e[_];this.isArray(f)?i=_:"{path}"==f?r=_:c[_]=f}if(i&&r){a=JSON.stringify(c),i||(i="items"),r||(r="title");var u=function(t,n){var e=s[t];if(!e)return n;n.hasOwn(i)||n.set(i,[]);var o;if(n[i].forEach(function(t){t.get(r)==e&&(o=t)}),!o){var c=JSON.parse(a);c[r]=e,c[i]=[],n[i].push(c),o=n[i].at(n[i].length()-1)}return o&&s.length<=t+1?o:u(t+1,o)},h=u(0,o);h&&h[i]&&h[i].push(n)}}},t.reconnect=function(){return this._client&&this._client.reconnect(),this},t.reduce=function(t,n){var e=(c([]),0),i=this.localFork(),r=n;return i.forEach(function(n){r=t(r,n,e,i),e++}),r},t.registerComponent=function(t,n){e||(e={}),e[t]||(e[t]=n)}}(this)},c=function(t,n,e,i,r,a,s,o){var _,f=this;if(!(f instanceof c))return new c(t,n,e,i,r,a,s,o);var u=[t,n,e,i,r,a,s,o];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){_=t.apply(f,u)}),"function"==typeof _){if(_._classInfo.name!=c._classInfo.name)return new _(t,n,e,i,r,a,s,o)}else if(_)return _;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};o.prototype=s.prototype,c._classInfo={name:"_data"},c.prototype=new o,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._data=c,this._data=c):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._data=c:this._data=c}.call(new Function("return this")());var _=function(){!function(t){var n;t.fromAce=function(t){if(t&&t[0]&&(t[0].range||t[0].data||(n=!0)),n)return this.fromAce2(t);var e=[];return t.forEach(function(t){var n;n=t.data?t.data:t;var i=n.range;"insertText"==n.action&&e.push([1,i.start.row,i.start.column,i.end.row,i.end.column,n.text]),"removeText"==n.action&&e.push([2,i.start.row,i.start.column,i.end.row,i.end.column,n.text]),"insertLines"==n.action&&e.push([3,i.start.row,i.start.column,i.end.row,i.end.column,n.lines]),"removeLines"==n.action&&e.push([4,i.start.row,i.start.column,i.end.row,i.end.column,n.lines,n.nl])}),e},t.fromAce2=function(t){var n=[];return t.forEach(function(t){var e=t;"insert"==t.action&&1==t.lines.length&&n.push([1,e.start.row,e.start.column,e.end.row,e.end.column,t.lines[0]]),"remove"==t.action&&1==t.lines.length&&n.push([2,e.start.row,e.start.column,e.end.row,e.end.column,t.lines[0]]),"insert"==t.action&&t.lines.length>1&&n.push([3,e.start.row,e.start.column,e.end.row,e.end.column,t.lines]),"remove"==t.action&&t.lines.length>1&&n.push([4,e.start.row,e.start.column,e.end.row,e.end.column,t.lines,t.nl])}),n},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.reverse=function(t){var n=[];return t.forEach(function(t){{var e=t.slice();e[1],e[2],e[3],e[4]}return 1==e[0]?(e[0]=2,void n.unshift(e)):2==e[0]?(e[0]=1,void n.unshift(e)):3==e[0]?(e[0]=4,void n.unshift(e)):4==e[0]?(e[0]=3,void n.unshift(e)):void 0}),n},t.runToAce=function(t){if(n)return this.runToAce2(t);var e=[],i=["","insertText","removeText","insertLines","removeLines"];return t.forEach(function(t){var n={action:i[t[0]],range:{start:{row:t[1],column:t[2]},end:{row:t[3],column:t[4]}}};t[0]<3?n.text=t[5]:n.lines=t[5],4==t[0]&&(n.nl=t[6]||"\n"),e.push(n)}),e},t.runToAce2=function(t){var n=[],e=["","insert","remove","insert","remove"];return t.forEach(function(t){var i={action:e[t[0]],start:{row:t[1],column:t[2]},end:{row:t[3],column:t[4]}};i.lines=t[0]<3?[t[5]]:t[5],4==t[0]&&(i.nl=t[6]||"\n"),n.push(i)}),n},t.runToLineObj=function(t,n){n.forEach(function(n){var e=n[1],i=n[2],r=n[3],a=n[4];if(1==n[0])if("\n"==n[5]){var s=t.item(e);if(s){var o=s.text();s.text(o.slice(0,i));var c={text:o.slice(i)||""};t.insertAt(e+1,c)}else t.insertAt(e,{text:""}),t.insertAt(e+1,{text:""})}else{var s=t.item(e);if(s){var o=s.text();s.text(o.slice(0,i)+n[5]+o.slice(i))}else t.insertAt(e,{text:n[5]})}if(2==n[0])if("\n"==n[5]){var _=t.item(e),f=t.item(e+1),u="",h="";_&&(u=_.text()),f&&(h=f.text()),_?_.text(u+h):t.insertAt(e,{text:""}),f&&f.remove()}else{var s=t.item(e),o=s.text();s.text(o.slice(0,i)+o.slice(a))}if(3==n[0])for(var l=r-e,d=0;l>d;d++)t.insertAt(e+d,{text:n[5][d]});if(4==n[0])for(var l=r-e,d=0;l>d;d++){var s=t.item(e);s.remove()}})},t.runToString=function(t,n){if(!n||"undefined"==typeof t)return"";t+="";var e=t.split("\n");return n.forEach(function(t){var n=t[1],i=t[2],r=t[3],a=t[4];if(1==t[0])if("\n"==t[5]){var s=e[n]||"";e[n]=s.slice(0,i);var o=s.slice(i)||"";e.splice(n+1,0,o)}else{var s=e[n]||"";e[n]=s.slice(0,i)+t[5]+s.slice(i)}if(2==t[0])if("\n"==t[5]){var c=e[n]||"",_=e[n+1]||"";e[n]=c+_,e.splice(n+1,1)}else{var s=e[n]||"";e[n]=s.slice(0,i)+s.slice(a)}if(3==t[0])for(var f=r-n,u=0;f>u;u++)e.splice(n+u,0,t[5][u]);if(4==t[0])for(var f=r-n,u=0;f>u;u++)e.splice(n,1)}),e.join("\n")},t.setAceVersion=function(t){n=t},t.simplify=function(t){var n,e=[],i=null;return t.forEach(function(t){n&&1==t[0]&&1==n[0]&&t[3]==t[1]&&n[1]==t[1]&&n[3]==t[3]&&n[4]==t[2]?i?(i[3]=t[3],i[4]=t[4],i[5]=i[5]+t[5]):(i=[],i[0]=1,i[1]=n[1],i[2]=n[2],i[3]=t[3],i[4]=t[4],i[5]=n[5]+t[5]):(i&&(e.push(i),i=null),1==t[0]?i=t.slice():e.push(t)),n=t
}),i&&e.push(i),e}}(this)},f=function(t,n,e,i,r,a,s,o){var c,_=this;if(!(_ instanceof f))return new f(t,n,e,i,r,a,s,o);var u=[t,n,e,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,u)}),"function"==typeof c){if(c._classInfo.name!=f._classInfo.name)return new c(t,n,e,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,u)}):"function"==typeof _.init&&_.init.apply(_,u)};f._classInfo={name:"aceCmdConvert"},f.prototype=new _,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.aceCmdConvert=f,this.aceCmdConvert=f):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.aceCmdConvert=f:this.aceCmdConvert=f}.call(new Function("return this")());var u=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){var n,e,i,r,a,s,o;t._createModelCommands=function(t,n,e){e||(e=[]);var i;if(i=t.data&&t.__id?t.data:t,this.isObject(i)||this.isArray(i)){var r;if(r=t.__id?t:{data:i,__id:this.guid()},this.isArray(i))var a=[2,r.__fork||r.__id,[],null,r.__fork||r.__id];else var a=[1,r.__fork||r.__id,{},null,r.__fork||r.__id];n&&(r.__p=n.__id),e.push(a);for(var s in i)if(i.hasOwnProperty(s)){var o=i[s];if(this.isObject(o)||this.isArray(o)){var c=this._createModelCommands(o,r,e),a=[5,s,c.__fork||c.__id,null,r.__fork||r.__id];e.push(a)}else{var a=[4,s,o,null,r.__fork||r.__id];e.push(a)}}return r}},t.addedObjects=function(){var t=[];for(var n in i)i.hasOwnProperty(n)&&(e[n]||(t.push(n),s[n]=i[n]));return t},t.commonObjects=function(){var t=[];for(var r in n)e[r]&&i[r]&&t.push(r);return t},t.compareFiles=function(t,c){e={},i={},n={},r={},a={},s={},o={},this.findObjects(t,e),this.findObjects(c,i);var _={missing:this.missingObjects(),added:this.addedObjects(),common:this.commonObjects(),cMod:[],cmds:[]},f=this;_.common.forEach(function(t){var n=f.objectDiff(e[t],i[t]);_.cMod.push(n)});var f=this;return _.added.forEach(function(t){var e=[],i=n[t];f._createModelCommands(i,null,e),e.forEach(function(t){_.cmds.push(t)})}),_.cMod.forEach(function(t){t.cmds.forEach(function(t){_.cmds.push(t)})}),_},t.findObjects=function(t,e){if(t&&t.__id&&(e[t.__fork||t.__id]=t,n[t.__fork||t.__id]=t,r[t.__id]=t),t.data){var i=t.data;for(var a in i)if(i.hasOwnProperty(a)){var s=i[a];this.isObject(s)&&(o[s.__fork||s.__id]=t.__fork||t.__id,this.findObjects(s,e))}}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.missingObjects=function(){var t=[];for(var n in e)e.hasOwnProperty(n)&&(i[n]||(a[n]=e[n],t.push(n)));return t},t.objectDiff=function(t,e){var i={modified:[],posMoved:[],sourcesAndTargets:[],cmds:[]};if(t.data&&e.data&&this.isObject(t.data)&&!this.isArray(t.data)){var r=t.data,c={};for(var _ in e.data)if(e.data.hasOwnProperty(_)){var f=r[_],u=t.__fork||t.__id;if(!this.isObject(f)&&!this.isArray(f)){c[_]=!0;var h=e.data[_];e.data[_]!=f&&(this.isObject(f)||this.isObject(h)?i.cmds.push(h&&h.__id?[5,_,e.data[_].__id,null,u]:[10,_,f.__id,null,u]):(i.modified.push({id:u,prop:_,from:f,to:e.data[_]}),i.cmds.push([4,_,e.data[_],f,u])))}}for(var _ in t.data)if(t.data.hasOwnProperty(_)){if(c[_])continue;var f=t.data[_],u=t.__id;if(this.isObject(f)&&!this.isArray(f)){var h=e.data[_];!h&&f&&f.__id&&i.cmds.push([10,_,f.__id,null,u])}}}if(this.isArray(t.data)){for(var l=t.data,d=e.data,v=[],p=[],m=l.length,g=d.length,y=0;m>y;y++){var b=l[y];if(this.isObject(b)){var I=b.__fork||b.__id;a[I]?i.cmds.push([8,0,I,0,o[I]]):v.push(I)}}for(var j={},O={},C={},y=0;g>y;y++){var b=d[y];if(this.isObject(b)){var I=b.__fork||b.__id;j[I]=y,O[y]=I,s[I]&&(v.push(I),i.cmds.push([7,y,I,0,o[I]])),p.push(I)}}var w=[],y=0;v.forEach(function(t){w.push(j[t]),C[t]=y,y++}),i.restackIndex=j,i.restackList=w,i.reverseIndex=O,i.restack=this.restackOps(w);var x=[],D=v.slice();i.restack.forEach(function(t){if("a"==t[0]){var e=O[t[1]],r=O[t[2]],a=(j[r],D.indexOf(e));D.splice(a,1);var s=D.indexOf(r);D.splice(s,0,e);{n[e]}i.cmds.push([12,e,s,a,o[e]])}else{var e=O[t[1]],r=O[t[2]],a=(j[r],D.indexOf(e));D.splice(a,1);var s=D.indexOf(r)+1;D.splice(s,0,e),i.cmds.push([12,e,s,a,o[e]])}}),i.stackCmds=x,i.sourceArrayWork=D,i.sourcesAndTargets.push([v,p])}return i},t.restackOps=function(t){function n(t){for(var n=t.slice(0),i=t.slice(0),r=t.slice(0).sort(function(t,n){return t-n}),a={},s={},o=0;o<i.length;o++){var c=r.indexOf(i[o]);a[i[o]]=c,s[c]=i[o],n[o]=c}var _=n.slice(0).sort(function(t,n){return t-n}),f=n[0],u=n[0],h=[],l=0,d=function(){for(var t=0,e=n.length,i=0;e>t;t++){var r=n[t];r>u&&(u=r),f>r&&(f=r),t>0&&h.push(_[t]-_[t-1]),t>0&&(l+=Math.abs(_[t]-_[t-1])),i+=Math.abs(r-_[t])}return l/=e,i/e}();h.sort(function(t,n){return t-n});for(var v=(h[0],function(t){for(var e=function(e,i,r){var a=[],s=n.length;for(i||(i=0);s>e;e++){var o=n[e];if(o-r!=1){var c=e+i;0>c&&(c=0),c>=s&&(c=s-1),t(o,_[c],o,r,e,s)&&(n[e+1]&&n[e+1]<o&&n[e+1]>r||(a.push(o),r=o))}else a.push(o),r=o}return a},i=[],r=0;.1>r;){for(var a=-5;5>=a;a++)i.push(e(Math.floor(n.length*r),a,f-1));r+=.05}return i.sort(function(t,n){return n.length-t.length}),i[0]}),p=[v(function(t,n,e,i,r,a){return i>e?!1:r>0&&Math.abs(e-i)>h[r-1]?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/a)&&e>=i?!0:Math.abs(i-e)<=d*(r/a)&&e>=i?!0:!1}),v(function(t,n,e,i,r,a){return i>e?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/a)&&e>=i?!0:Math.abs(i-e)<=d*(r/a)&&e>=i?!0:!1}),v(function(t,n,e,i,r,a){return i>e?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/a)&&e>=i?!0:Math.abs(i-e)<=d*(r/a)&&e>=i?!0:!1}),v(function(t,n,e,i,r,a){return i>e?!1:Math.abs(t-n)<=d*(r/a)&&e>=i?!0:Math.abs(i-e)<=d*(r/a)&&e>=i?!0:!1}),v(function(t,n,e,i,r,a){return i>e?!1:Math.abs(t-n)<=d&&e>=i?!0:Math.abs(i-e)<=d*(r/a)&&e>=i?!0:!1}),v(function(t,n,e,i){return i>e?!1:Math.abs(e-i)<l?!0:Math.abs(t-n)<=l&&e>=i?!0:!1}),v(function(t,n,e,i){return e>i?!0:!1}),v(function(t,n,e,i){return i>e?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d&&e>=i?!0:!1}),v(function(t,n,e,i,r,a){return i>e?!1:r>0&&Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/a)&&e>=i?!0:r>0&&Math.abs(i-e)<=d*(r/a)&&e>=i?!0:!1}),v(function(t,n,e,i){if(i>e)return!1;if(i>=f){if(e>=i)return!0}else if(e==f)return!0;return!1})],m=[],g=0,o=0;o<p.length;o++){var y=p[o];y.length>g&&(m=y,g=y.length)}0==m.length&&(m=[_[Math.floor(_.length/2)]]);{var b=[],I=[];!function(){for(var t=f,e=m[0],i=m.length,r=n.indexOf(e),a=0,s=0,o=n.length;o>s;s++){var c=n[s];c>=t&&e>=c&&r>=s?(b.push(c),t=c):I.push(c),c==e&&(t=c,i-1>a?(a++,e=m[a],r=n.indexOf(e)):(e=u,r=o+1))}}()}I.sort(function(t,n){return t-n});!function(){for(var t=0,n=0,i=b[0],r=I.length;r>t;){var a=b[n],o=I[t];if("undefined"==typeof a){for(;r>t;)e.push(["b",s[o],s[i]]),i=o,t++,o=I[t];return}o>a?(i=a,n++):(e.push(["a",s[o],s[a]]),t++)}}();return n}var e=[];return n(t),e}}(this)},h=function(t,n,e,i,r,a,s,o){var c,_=this;if(!(_ instanceof h))return new h(t,n,e,i,r,a,s,o);var f=[t,n,e,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};h._classInfo={name:"diffEngine"},h.prototype=new u;var l=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,e,i,a,o,c,_,u,h;t._cmd_aceCmd=function(t,n){var e=this._find(t[4]),r=t[1];if(!e||!r)return!1;if("string"!=typeof e.data[r])return!1;var a=f();e.data[r]=a.runToString(e.data[r],t[2]),i=n;var s=[4,r,e.data[r],null,t[4],t[5],t[6]];return this._cmd(s,e,null),n?this._cmd(t,e,null):(this._cmd(t,e,null),this.writeCommand(t)),i=!1,!0},t._cmd_createArray=function(t,n){var e=t[1];if(!e)return{error:21,cmd:t,text:"Object ID was null or undefined"};var i=this._getObjectHash();if(i[e])return{error:22,cmd:t,text:"Array with ID was already created"};var r,a=this._getRemovedHash();return a[e]?(r=a[e],r.__p=null):r={data:[],__id:e},i[r.__id]=r,this._data.__orphan.push(r),!0},t._cmd_createObject=function(t,n){var e=t[1];if(!e)return{error:11,cmd:t,text:"Object ID was null or undefined"};var i=this._getObjectHash();if(i[e])return{error:12,cmd:t,text:"Object ID was already created"};var r,a=this._getRemovedHash();return a[e]?(r=a[e],r.__p=null):r={data:{},__id:e},i[r.__id]=r,this._data.__orphan.push(r),!0},t._cmd_diffPatch=function(t,n){if(!u)return{error:141,cmd:t,text:"diff-match-patch not initialized"};var e=this._find(t[4]),r=t[1];if(!e)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!r)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var a=e.data[r];if(this.isObject(a)||this.isArray(a))return{error:145,cmd:t,text:"Trying to apply text diff/patch to  Object or Array"};var s=u.patch_fromText(t[2]),o=u.patch_apply(s,a);if(!this.isArray(o))return{error:146,cmd:t,text:"patch_apply failed"};var c=o[1];if(!c)return{error:146,cmd:t,text:"patch_apply failed"};for(var _=0;_<c.length;_++)if(!c[_])return{error:146,cmd:t,text:"patch_apply failed"};e.data[r]=o[0],i=n;var f=[4,r,e.data[r],a,t[4],t[5],t[6]];return this._cmd(f,e,null),n?this._cmd(t,e,null):this.writeCommand(t),i=!1,!0},t._cmd_moveToIndex=function(t){{var n,i=this._find(t[4]);i.data.length}if(!i)return{error:2,cmd:1,text:"Object with ID ("+t[4]+") did not exist"};var r,a=null,n=this._find(t[1]);if(r=a=i.data.indexOf(n),a!=t[3])return{error:121,cmd:t,text:"The old index was not what expected: "+a+" cmd have "+t[3]};if(!n)return{error:122,cmd:t,text:"Object to be moved ("+t[1]+") was not in the array"};var s=parseInt(t[2]);return isNaN(s)?{error:123,cmd:t,text:"Target index ("+s+") was not a number"}:i.data.length<=r||0>r?{error:124,cmd:t,text:"Invalid original index ("+r+") given"}:(e.fromIndex=r,i.data.splice(r,1),i.data.splice(s,0,n),this._cmd(t,null,t[1]),!0)},t._cmd_pushToArray=function(t,n){{var e=this._find(t[4]),i=this._find(t[2]),r=parseInt(t[1]);t[3],e.data.length}if(!e)return{error:71,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:72,cmd:t,text:"Did not find object with ID ("+t[2]+") "};if(i.__p)return i.__p==e.__id?(console.log("WARNING : Unnecessary pushToArray"),console.log(t),!0):{error:73,cmd:t,text:"The object already had a parent - need to remove first ("+t[2]+") "};if(isNaN(r))return{error:74,cmd:t,text:"toIndex was not a number"};if(!this.isArray(e.data))return{error:75,cmd:t,text:"Target Object was not an array"};if(r>e.data.length||0>r)return{error:76,cmd:t,text:"toIndex out of range, parent data len "+e.data.length};e.data.splice(r,0,i),i.__p=e.__id;var a=this._data.__orphan.indexOf(i);return a>=0&&this._data.__orphan.splice(a,1),this._cmd(t,null,t[2]),!0},t._cmd_removeObject=function(t,n){var e=this._find(t[4]),i=this._find(t[2]),r=parseInt(t[1]);if(!e)return{error:81,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:82,cmd:t,text:"Did not find object with ID ("+t[2]+") "};if(!i.__p)return{error:83,cmd:t,text:"The removed item did not have a parent ("+t[2]+") "};var a=e.data.indexOf(i);if(isNaN(r))return{error:84,cmd:t,text:"oldPosition was not a number"};if(r!=a)return{error:85,cmd:t,text:"oldPosition was not same as current position"};var s=this._getRemovedHash();s[t[2]]=i,e.data.splice(a,1),this._cmd(t,null,t[2]),i.__p=null;var o=this._data.__orphan.indexOf(i);return 0>o&&this._data.__orphan.push(i),!0},t._cmd_setMeta=function(t,n){var e=this._find(t[4]),i=t[1];return i?"data"==i?!1:"__id"==i?!1:e?e[i]==t[2]?!1:(e[i]=t[2],this._cmd(t,e,null),n||this.writeCommand(t),!0):!1:!1},t._cmd_setProperty=function(t,n){var e=this._find(t[4]),i=t[1];if(!e)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var r=e.data[i];if(r==t[2])return{error:43,cmd:t,text:"Trying to set the same value to the object twice"};if("undefined"==typeof r||null===r){if("undefined"!=typeof t[3]&&null!==t[3])return{error:44,cmd:t,text:"The old value "+r+" was not the same as the commands old value"}}else{if(this.isObject(r)||this.isArray(r))return{error:45,cmd:t,text:"Trying to set Object or Array value to a scalar property"};if(r!=t[3])return{error:44,cmd:t,text:"The old value "+r+" was not the same as the commands old value"}}return e.data[i]=t[2],this._cmd(t,e,null),!0},t._cmd_setPropertyObject=function(t,n){var e=this._find(t[4]),i=t[1],r=this._find(t[2]);if(!e)return{error:51,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:52,cmd:t,text:"The property was not defined ("+t[1]+") "};if(!r)return{error:53,cmd:t,text:"Could not find the Object to be set with ID ("+t[2]+") "};if("undefined"!=typeof e.data[i])return{error:54,cmd:t,text:"The property ("+t[1]+") was already set, try unsetting first "};if(!this.isObject(e.data)||this.isArray(e.data))return{error:55,cmd:t,text:"The object ("+t[2]+") was not of type Object "};e.data[i]=r,r.__p=e.__id,this._cmd(t,null,t[2]);var a=this._data.__orphan.indexOf(r);return a>=0&&this._data.__orphan.splice(a,1),n||this._moveCmdListToParent(r),!0},t._cmd_unsetProperty=function(t){var n=this._find(t[4]),e=t[1];return n?e?this.isArray(n.data[e])?{error:103,cmd:t,text:"The Object data was Array ("+t[4]+") "}:(delete n.data[e],!0):{error:102,cmd:t,text:"The property was not defined ("+t[1]+") "}:{error:101,cmd:t,text:"Did not find object with ID ("+t[4]+") "}},t._fireListener=function(t,e){if(n){var i=t.__id+"::"+e,r=n[i];r&&r.forEach(function(n){n(t,t.data[e])})}},t._moveCmdListToParent=function(){},t._reverse_aceCmd=function(t){var n=this._find(t[4]),e=t[1],i=f(),r=i.reverse(t[2]),a=[4,e,n.data[e],null,t[4]],s=[13,e,r,null,t[4]],o=i.runToString(n.data[e],r);n.data[e]=o,this._cmd(a),this._cmd(s)},t._reverse_createArray=function(t){var n=t[1],e=this._getObjectHash(),i=e[n],r=this._getRemovedHash();r[n]=i,delete e[n];var a=this._data.__orphan.indexOf(i);a>=0&&this._data.__orphan.splice(a,1)},t._reverse_createObject=function(t){var n=t[1],e=this._getObjectHash(),i=e[n],r=this._getRemovedHash();r[n]=i,delete e[n];var a=this._data.__orphan.indexOf(i);a>=0&&this._data.__orphan.splice(a,1)},t._reverse_diffPatch=function(t,n){if(!u)return{error:141,cmd:t,text:"diff-match-patch not initialized"};var e=this._find(t[4]),r=t[1];if(!e)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!r)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var a=e.data[r];if(this.isObject(a)||this.isArray(a))return{error:145,cmd:t,text:"Trying to apply text diff/patch to  Object or Array"};var s=u.patch_fromText(t[3]),o=u.patch_apply(s,a);if(!this.isArray(o))return{error:146,cmd:t,text:"patch_apply failed"};var c=o[1];if(!c)return{error:146,cmd:t,text:"patch_apply failed"};for(var _=0;_<c.length;_++)if(!c[_])return{error:146,cmd:t,text:"patch_apply failed"};e.data[r]=o[0],i=n;var f=[4,r,e.data[r],a,t[4],t[5],t[6]];return this._cmd(f,e,null),n?this._cmd(t,e,null):this.writeCommand(t),i=!1,!0},t._reverse_moveToIndex=function(t){var n,e=this._find(t[4]),i=e.data.length,r=0,a=null;for(r=0;i>r;r++){var s=e.data[r];if(s.__id==t[1]){n=s,a=r;break}}if(a!=t[2])throw"_reverse_moveToIndex with invalid index value";if(n){var o=parseInt(t[3]);e.data.splice(r,1),e.data.splice(o,0,n);var c=t.slice();c[2]=o,c[3]=t[2],this._cmd(c,null,c[1])}},t._reverse_pushToArray=function(t){{var n=this._find(t[4]),e=this._find(t[2]);n.data.length}if(n&&e){var i=n.data.length-1,r=n.data[i];if(r.__id==t[2]){var a=[8,i,r.__id,null,n.__id];n.data.splice(i,1),this._cmd(a,null,a[2])}}},t._reverse_removeObject=function(t){{var n=this._find(t[4]),e=this._find(t[2]),i=t[1];n.data.indexOf(e)}if(n&&e){n.data.splice(i,0,e);var r=[7,i,t[2],null,t[4]];this._cmd(r,null,t[2]);var a=this._data.__orphan.indexOf(e);a>=0&&this._data.__orphan.splice(a,1),e.__p=t[4]}},t._reverse_setMeta=function(t){var n=this._find(t[4]),e=t[1];if(n){var i=[3,e,t[3],t[2],t[4]];n[e]=t[3],this._cmd(i)}},t._reverse_setProperty=function(t){var n=this._find(t[4]),e=t[1];if(n){var i=[4,e,t[3],t[2],t[4]];n.data[e]=t[3],this._cmd(i)}},t._reverse_setPropertyObject=function(t){var n=this._find(t[4]),e=t[1],i=this._find(t[2]);if(n&&i){delete n.data[e],i.__p=null;var r=[10,e,null,null,t[4]];this._cmd(r)}},t._reverse_unsetProperty=function(t){var n=this._find(t[4]),e=this._find(t[2]),i=t[1];if("value"!=t[3]){if(n&&i&&e){n.data[i]=e,e.__p=n.__id;var r=[5,i,e.__id,0,t[4]];this._cmd(r,null,e.__id)}}else if(n&&i){var r=[4,i,t[2],null,t[4]];this._cmd(r,null,n.__id)}},t._updateHotBuffer=function(t){var n=(new Date).getTime();for(var e in _)if(_.hasOwnProperty(e)){var i=_[e];if(t||n-i.ms>c.hotMs){if(i.lastCmd){var r=i.firstCmd,a=i.lastCmd;i.chObj.writeLocalJournal([4,r[1],a[2],r[3],r[4]])}else i.chObj.writeLocalJournal(i.firstCmd);delete _[e]}}},t.execCmd=function(t,n,e){try{if(!this.isArray(t))return!1;var i=a[t[0]];if(this._playBackOnFn&&!e)return!1;if(console.log("cmd "+t),i){var r=i.apply(this,[t,n]);if(r!==!0&&(console.log("ERROR "+JSON.stringify(t)),console.log(JSON.stringify(r))),r===!0&&!e)if(n)this.writeLocalJournal(t);else if(4==t[0]&&c.hotMs){var s=t[4],o=s+":"+t[1],f=_[o];f?f.lastCmd=t:_[o]={ms:(new Date).getTime(),firstCmd:t,chObj:this}}else this._updateHotBuffer(!0),this.writeLocalJournal(t);return r}return{error:199,text:"Invalid command"}}catch(u){var h="";return u&&u.message&&(h=u.message),console.error(u,u.message),{error:199,cmd:t,text:"Exception raised "+h}}},t.getJournalCmd=function(t){return this._journal[t]},t.getJournalLine=function(){return this._journalPointer},t.getJournalRange=function(){return[0,this._journal.length]},t.getLocalJournal=function(){return this._journal},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(n||(n={},e={},c={},_={}),!a){if(!u)if("undefined"!=typeof diff_match_patch)u=new diff_match_patch;else if("undefined"!=typeof require){var t=require("diff-match-patch");u=new t}o=new Array(30),a=new Array(30),a[1]=this._cmd_createObject,a[2]=this._cmd_createArray,a[3]=this._cmd_setMeta,a[4]=this._cmd_setProperty,a[5]=this._cmd_setPropertyObject,a[7]=this._cmd_pushToArray,a[8]=this._cmd_removeObject,a[10]=this._cmd_unsetProperty,a[12]=this._cmd_moveToIndex,a[13]=this._cmd_aceCmd,a[14]=this._cmd_diffPatch,o[1]=this._reverse_createObject,o[2]=this._reverse_createArray,o[3]=this._reverse_setMeta,o[4]=this._reverse_setProperty,o[5]=this._reverse_setPropertyObject,o[7]=this._reverse_pushToArray,o[8]=this._reverse_removeObject,o[10]=this._reverse_unsetProperty,o[12]=this._reverse_moveToIndex,o[13]=this._reverse_aceCmd,o[14]=this._reverse_diffPatch;var i=this;r().every(.5,function(){i._updateHotBuffer()})}}),t.moveToLine=function(t){return this.reverseToLine(parseInt(t))},t.playback=function(t){t=t||{};var n=s(),e=this._journal[0][5];if(!e)return void console.error("journal does not have timestamps");var i,a=t.ms||2e3;i=t.journal?t.journal:this._journal.slice();var o=i.length;this.reverseToLine(0);var c=(new Date).getTime(),_=0,f=this,u=e,h=0,l=function(){for(var t,e=(new Date).getTime(),s=e-c,d=o,v=_;d>v;){var p=i[v][5],m=p-u;if(t&&p-t>a){var g=p-s-parseInt(a/2);u=g,m=p-u}if(!(s>m))break;try{f.redo(1,i)}catch(y){console.error(y)}h++,v++,t=p}_=v,_==d&&(r().removeFrameFn(l),f._journal=i,f._playBackOnFn=null,n.resolve(!0))};return this._playBackOnFn=l,r().onFrame(l),n},t.redo=function(t,n){var e=this.getJournalLine();for(t=t||1;t-->0;){var i;if(i=n?n[e]:this._journal[e],!i)return;var r=this.execCmd(i,!1,!0);r!==!0&&console.error(r),e++,this._journalPointer++}},t.redoStep=function(t){t=t||{};var n=t.ms||400,e=this.getJournalLine();if(this._journal[e]){for(var i=this._journal[e][5],r=0;this._journal[e];){var a=this._journal[e][5],s=Math.abs(a-i);if(s>n)break;e++,r++}r>0&&this.redo(r)}},t.reverseCmd=function(t){if(t){var n=o[t[0]];if(n){var e=n.apply(this,[t]);return e}}},t.reverseNLines=function(t){for(var n=this.getJournalLine();n-1>=0&&t-->0;){var e=this._journal[n-1];this.reverseCmd(e),n--,this._journalPointer--}},t.reverseToLine=function(t){var n=this.getJournalLine(),e=this._journal.length;if(!(0>t||t>e)&&t!=n){var i=-1;t>n&&(i=1);for(var r=n,a=this._journal.slice();r>=0&&e>=r;){if(t==r)return;if(0>i&&r>0)var s=a[r-1];else var s=a[r];if(!s)break;if(r+=i,0>r||r>e)break;if(i>0){this.execCmd(s,!1,!0)}else this.reverseCmd(s);this._journalPointer=r}}},t.setClearCreated=function(t){h=t},t.setHotMs=function(t){c.hotMs=t},t.undo=function(t){0!==t&&("undefined"==typeof t&&(t=1),this.reverseNLines(t))},t.undoStep=function(t){t=t||{};var n=t.ms||400,e=this.getJournalLine();if(0!=e){for(var i=this._journal[e-1][5],r=0;e-1>=0;){var a=this._journal[e-1][5],s=Math.abs(a-i);if(s>n)break;e--,r++}r>0&&this.undo(r)}},t.writeCommand=function(){},t.writeLocalJournal=function(t){this._journal&&(this._journal.length>this._journalPointer&&(this._journal.length=this._journalPointer),t[5]||(t[5]=(new Date).getTime()),this._journal.push(t),this._journalPointer++)}}(this),function(t){var n;t.callHook=function(t,e){if(n&&n[t])for(var i=n[t],r=0;r<i.length;r++)i[r](e)},t.hasHook=function(t){return n&&n[t]?n[t].length:void 0},t.removeHook=function(t,e){if(n&&n[t]){var i=n[t].indexOf(e);i>=0&&n[t].splice(i,1)}},t.setHook=function(t,e){n||(n={}),n[t]||(n[t]=[]),n[t].push(e)}}(this),function(t){var n,e;t._addToCache=function(t){t&&t.__id&&(this._objectHash[t.__id]=t)},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){return n||(n={}),n[t]?n[t]:void(n[t]=this)}),t._cmd=function(t,n,e){var i=t[0],r=t[4];this._wCmd(i,r,t),e&&e!=r&&this._wCmd(i,e,t),this._parentCmd(r,t)},t._createModelCommands=function(t,n,e){e||(e=[]);var i;if(i=t.data&&t.__id?t.data:t,this.isObject(i)||this.isArray(i)){var r;if(r=t.__id?t:{data:i,__id:this.guid()},this.isArray(i))var a=[2,r.__id,[],null,r.__id];else var a=[1,r.__id,{},null,r.__id];n&&(r.__p=n.__id),e.push(a);for(var s in i)if(i.hasOwnProperty(s)){var o=i[s];if(this.isObject(o)||this.isArray(o)){var c=this._createModelCommands(o,r,e),a=[5,s,c.__id,null,r.__id];e.push(a)}else{var a=[4,s,o,null,r.__id];e.push(a)}}return r}},t._createNewModel=function(t,n){if(this.isObject(t)||this.isArray(t)){var e={data:t,__id:this.guid()};if(this._objectHash[e.__id]=e,this.isArray(t))var i=[2,e.__id,[],null,e.__id];else var i=[1,e.__id,{},null,e.__id];n&&(e.__p=n.__id),this.writeCommand(i,e);for(var r in t)if(t.hasOwnProperty(r)){var a=t[r];if(this.isObject(a)||this.isArray(a)){var s=this._createNewModel(a,e);e.data[r]=s;var i=[5,r,s.__id,null,e.__id];this.writeCommand(i,e),this._moveCmdListToParent(s)}else{var i=[4,r,a,null,e.__id];this.writeCommand(i,e)}}return e}},t._find=function(t){var n=this._objectHash[t];return n?n:this._removedHash[t]},t._findObjects=function(t,n){if(!t)return null;if(!this.isObject(t))return t;t=this._wrapData(t),t.__id&&(this._objectHash[t.__id]=t);if(n&&(t.__p=n),t.data){var e=t.data;for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];if(this.isObject(r)){var a=this._findObjects(r,t.__id);a!==r&&(t.data[i]=a)}}}return t},t._getObjectHash=function(){return this._objectHash},t._getRemovedHash=function(){return this._removedHash},t._parentCmd=function(t,n,e){var i=this._find(t);i&&(this._wCmd(42,t,n),i.__p&&(e||(e=this._find(i.__p)),e&&this._parentCmd(i.__p,n,e)))},t._prepareData=function(t){var n=this._wrapData(t);return this._objectHash[n.__id]||(n=this._findObjects(n)),n},t._wCmd=function(t,n,i){if(this._workers[t]&&this._workers[t][n]){var r=this._workers[t][n],a=i[1],s=r["*"],o=r[a];s&&s.forEach(function(t){var n=t[0],r=t[1],a=e[n];a&&a(i,r)}),o&&o.forEach(function(t){var n=t[0],r=t[1],a=e[n];a&&a(i,r)})}},t._wrapData=function(t){if(t&&t._wrapData)return t._data;if(t.__id&&t.data)return t;var n=this._createNewModel(t);return n},t.createWorker=function(t,n,e){var i=n[0],r=n[4];this._workers[i]||(this._workers[i]={}),this._workers[i][r]||(this._workers[i][r]={});var a=this._workers[i][r],s=n[1];s||(s="*"),a[s]||(a[s]=[]),a[s].push([t,e])},t.getData=function(){return this._data},t.indexOf=function(t){if(t||(t=this._data),this.isObject(t)||(t=this._find(t)),t){var n=this._find(t.__p);if(n&&this.isArray(n.data))return n.data.indexOf(t)}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){if(n){this._objectHash||(this._objectHash={},this._removedHash={});var i=this;this._channelId=t,this._data=n,this._workers={},this._journal=e||[],this._journalPointer=this._journal.length;var r=this._findObjects(n);r!=n&&(this._data=r),this._data.__orphan||(this._data.__orphan=[]),e&&this.isArray(e)&&e.forEach(function(t){i.execCmd(t,!0)})}}),t.setWorkerCommands=function(t){e||(e={});for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},t.toPlainData=function(t,n){if("undefined"==typeof t)return n?t:t=this._data;if(!this.isFunction(t)&&"function"!=typeof t){if(!this.isObject(t))return t;var e;if(this.isArray(t.data)){e=[];for(var i=t.data.length,r=0;i>r;r++)e[r]=this.toPlainData(t.data[r],!0)}else{e={};for(var a in t.data)t.data.hasOwnProperty(a)&&(e[a]=this.toPlainData(t.data[a],!0))}return e}}}(this)},d=function(t,n,e,i,r,a,s,o){var c,_=this;if(!(_ instanceof d))return new d(t,n,e,i,r,a,s,o);var f=[t,n,e,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=d._classInfo.name)return new c(t,n,e,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};d._classInfo={name:"_channelData"},d.prototype=new l,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._channelData=d,this._channelData=d):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._channelData=d:this._channelData=d}.call(new Function("return this")());var v=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},p=function(t,n,e,i,r,a,s,o){var c,_=this;if(!(_ instanceof p))return new p(t,n,e,i,r,a,s,o);var f=[t,n,e,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=p._classInfo.name)return new c(t,n,e,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};p._classInfo={name:"channelObjects"},p.prototype=new v;var m=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t._getNsFromUrl=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getNsShorthand=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getReflections=function(){return _localReflections},t._getReflectionsFor=function(t){if(_localReflections){var n=_localReflections[t];if(n)return n}return[]},t._getReverseNs=function(t){return _nsReverse[t]},t._idFromNs=function(t){if(t){var n=t.length;"#"==t[n-1]&&(t=t.split("@").shift())}return t},t._idToNs=function(t,n){if(t){var e=t.length;if("#"==t[e-1]){var i=t.indexOf("@"),r=t.substring(i+1,e-1);r!=n&&(t=t.substring(0,i)+"@"+n+"#")}else t=t+"@"+n+"#"}return t},t._nsFromId=function(t){var n;if(t){t+="";var e=t.length;"#"==t[e-1]&&(n=t.split("@").pop(),n=n.split("#").shift())}return n},t._transformCmdFromNs=function(t,e){e||(e=this._ns);var i=n,r=t.slice(),a=i[t[0]],s=this;return a&&a.forEach(function(t){r[t]=s._idFromNs(r[t],e)}),r},t._transformCmdToNs=function(t,e){e||(e=this._ns);var i=n,r=t.slice(),a=i[t[0]];if(a)for(var s=0;s<a.length;s++){var o=a[s];r[o]=this._idToNs(r[o],e)}return r},t._transformObjFromNs=function(t,n){if(n||(n=this._ns),t&&t.__id){t.__p&&(t.__p=this._idFromNs(t.__p,n)),t.__id=this._idFromNs(t.__id,n);for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjFromNs(t.data[e],n)}return t},t._transformObjToNs=function(t,n){if(n||(n=this._ns),t&&t.__id){t.__id=this._idToNs(t.__id,n),t.__p&&(t.__p=this._idToNs(t.__p,n));for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjToNs(t.data[e],n)}return t},t._transformToNsBeforeInsert=function(t,n){var e=t.__ctxCmdList,i=this._nsFromId(n.__id);console.log(" _transformToNsBeforeInsert ");var r=this;return i?(e&&e.forEach(function(t){t.cmd=r._transformCmdToNs(t.cmd,i)}),t=r._transformObjToNs(t,i),t.__ctxCmdList=e,this._addToCache(t),t):t},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={1:[1],2:[1],4:[4],5:[2,4],7:[2,4],8:[2,4],10:[2,4],12:[1,4],13:[4],14:[4],16:[3,4]})})}(this),function(t){var n,e;t._checkout=function(t){var n=this,e=this._socket;return s(function(i){n._policy&&(n._disconnected||n._connected&&e.send("channelCommand",{channelId:t,cmd:"checkout",data:""}).then(function(t){console.log("Checkout tree "),console.log(t),i(t)}))})},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t&&e?(t+=e.getId(),n||(n={}),n[t]?n[t]:void(n[t]=this)):void 0}),t._createTransaction=function(){this._currentFrame={id:this.guid(),version:1,from:this._data.getJournalLine(),fail_tolastok:!0,commands:[]}},t._fetch=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);return e?e:void 0},t._incoming=function(t){var n=this,e=(this._channelId,0);t.on("upgrade_"+this._channelId,function(t){if(n._upgradePending=!1,!n._disconnected&&t){if(t.partial){var i=n._clientState.data;i.reverseToLine(t.partialFrom);var r=0;i.setClearCreated(!0),t.partial.forEach(function(t){if(!(r>0)){var e,a=n._transformCmdToNs(t);(e=i.execCmd(a,!0))!==!0&&r++}}),i.setClearCreated(!1),0==r?(n._clientState.needsRefresh=!1,n._clientState.needsFullRefresh=!1,i._journal.length=t.partialEnds,n._clientState.last_update[0]=0,n._clientState.last_update[1]=i._journal.length,n._clientState.last_sent[0]=0,n._clientState.last_sent[1]=i._journal.length):n._clientState.needsFullRefresh=!0}if(t.data){var a=n._clientState.data.getData();n._transformObjToNs(t.data);var s=h().compareFiles(a,t.data);console.log("Diff obj , myData, cmd.data"),console.log(s),console.log(a),console.log(t.data);var i=n._clientState.data,r=0;i.setClearCreated(!0),s.cmds.forEach(function(t){if(console.log("Diff cmd ",t),!(r>0)){var n;(n=i.execCmd(t,!0))!==!0&&(console.error("Full error ",n),console.log("Return value from failed cmd: ",n),r++)}}),i.setClearCreated(!1),0==r?(n._clientState.needsRefresh=!1,n._clientState.needsFullRefresh=!1,console.log("** full update should have gone ok ** "),i._journal.length=0,i._journal.push.apply(i._journal,t.journal),n._clientState.needsRefresh=!1,n._clientState.version=t.version,n._clientState.last_update[0]=0,n._clientState.last_update[1]=i._journal.length,n._clientState.last_sent[0]=0,n._clientState.last_sent[1]=i._journal.length,console.log("Version ",n._clientState.version)):(e++,console.error("** errors with the full update ** "),e>0?(console.log("--- server command data ---"),console.log(t),console.log("--- the client state ---"),console.log(n._clientState),n._clientState.needsFullRefresh=!1):(n._clientState.needsFullRefresh=!0,n._clientState.fullUpgradeFailCnt=e))
}n._slaveController&&n._slaveController._execCmd({cmd:"masterJournalUpgrade",data:t})}}),t.on("s2c_"+this._channelId,function(t){if(!n._disconnected&&t){{n._policy.deltaServerToClient(t,n._clientState)}if(n._slaveController){for(var e=[],i=0;i<t.c.length;i++){var r=t.c[i].slice();e.push(n._transformCmdFromNs(r))}t.c=e,n._slaveController._execCmd({cmd:"masterUpgrade",data:t})}}})},t._isNodeJs=function(){return new Function("try { return this === global; } catch(e) { return false; }")()},t._onFrameLoop=function(t){var n=this,e=this._channelId,i=function(){if(n._policy&&!n._disconnected&&n._connected&&n._clientState){n._clientState.needsRefresh&&(n._upgradePending||n.askUpgrade(n._clientState.needsFullRefresh),n._upgradePending=!0);var i=n._policy.constructClientToServer(n._clientState);i&&t.send("channelCommand",{channelId:e,cmd:"c2s",data:i}).then(function(t){if(t&&t.errors&&t.errors.length>0){var e=!1;t.errors.forEach(function(t){44==t.error&&(e=!0)}),e&&(n._clientState.needsRefresh=!0)}})}};r().onFrame(i)},t._onReconnect=function(){this._slave&&console.log("*** reconnect to the master ***");var t=this;console.log("_onReconnect"),t._slaveController&&(console.log("_slaveController -> trying to send data "),t._slaveController._sendUnsentToMaster());var n=t._policy.constructClientToServer(t._clientState),e=this._socket,i=this._channelId;n&&e.send("channelCommand",{channelId:i,cmd:"c2s",data:n}).then(function(){}),t.askUpgrade()},t.addCommand=function(t,n){var e=this._transformCmdToNs(t,this._ns);return this._data.execCmd(e,n)},t.askUpgrade=function(t){this._socket&&(this._clientState.fullUpgradeFailCnt||this._socket.send("channelCommand",{channelId:this._channelId,cmd:"upgradeRequest",data:{version:this._clientState.version,last_update:this._clientState.last_update,askFull:t}}).then(function(){}))},t.at=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);return i?i.data[n]:void 0},t.createChannel=function(t,n,e){if(!this._isLocal){var i=JSON.parse(JSON.stringify(e)),r=d(this.guid(),i,[]);i=r.getData(),i=this._transformObjFromNs(i);var a={channelId:t,name:n,chData:i},o=this;return s(function(t){o._socket.send("channelCommand",{channelId:o._channelId,cmd:"createChannel",data:a}).then(function(n){t(n)})})}},t.diffSet=function(t,n,i){if(e){var r=this._idToNs(t,this._ns),a=this._data._find(r);if(a&&!this.isObject(i)){var s=a.data[n];if(s!=i){var o=e.diff_main(s,i),c=e.diff_main(i,s);e.diff_cleanupEfficiency(o),e.diff_cleanupEfficiency(c);var _=e.patch_toText(e.patch_make(s,o)),f=e.patch_toText(e.patch_make(i,c));this.addCommand([14,n,_,f,r])}}}},t.disconnect=function(){return this._disconnected=!0,this},t.fork=function(t,n){if(!this._isLocal){var e={version:this._channelStatus.version,channelId:t,name:n,journalLine:1};e.journalLine=this._clientState.last_update[1];var i=this;return s(function(t){i._socket.send("channelCommand",{channelId:i._channelId,cmd:"fork",data:e}).then(function(n){t(n)})})}},t.fromMaster=function(t){console.log("from master",JSON.stringify(t))},t.fromSlave=function(t){if(console.log("from slave",JSON.stringify(t)),"s2c"==t.cmd){var n=this;t.c.forEach(function(t){console.log(t);var e=n.addCommand(t);console.log(JSON.stringify(e)),console.log(JSON.stringify(n._data.getData()))})}},t.get=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);return i?i.data[n]:void 0},t.getChannelData=function(){return this._data},t.getData=function(){return this._data.getData()},t.indexOf=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e);return r}}return-1},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,i){if(!e)if("undefined"!=typeof diff_match_patch)e=new diff_match_patch;else if("undefined"!=typeof require){var r=require("diff-match-patch");e=new r}if(this._policy||(this._policy=j()),i&&i.localChannel){this._channelId=t,this._options=i,this._socketGUID=this.guid(),this._isLocal=!0,this._socket=b(this._socketGUID,1);var a=this._socket.getEnum();this._ns=a,this._id=t+this._socket.getId();var s=this,o=i.localData;o=s._transformObjToNs(i.localData,a);var c=d(s._id,o,[]);return s._data=c,void s.resolve({result:!0,channelId:t})}if(t&&n){this._channelId=t,this._socket=n,this._options=i,this._changeFrames=[],this._pendingFrames=[];var a=n.getEnum();this._ns=a,this._id=t+n.getId();var s=this;this._onFrameLoop(n,a),this._incoming(n,a),this._connCnt=0,n.on("disconnect",function(){s._connected=!1}),n.on("connect",function(){console.log("*** socket reconnect for "+t+" *** "),console.log("Connection count "+s._connCnt),s._connCnt++,i.auth&&n.send("auth",{userId:i.auth.username,password:i.auth.password}).then(function(e){return e.userId?(s._userId=e.userId,s._logged=!0,n.send("requestChannel",{channelId:t,initWithData:i.initWithData})):(s._logged=!1,!1)}).then(function(e){return e&&e.channelId==t?(s._connected=!0,s._connCnt>1?(s._onReconnect(),!1):n.send("channelCommand",{channelId:t,cmd:"readBuildTree",data:""})):!1}).then(function(n){if(n){var e=n.build;s._channelStatus=n.status;var i=e.pop();i=s._transformObjToNs(i,a);for(var r=d(s._id,i,[]),o=e.pop();o;)r._journalPointer=0,r._journal.length=0,o.forEach(function(t){r.execCmd(s._transformCmdToNs(t,a),!0)}),o=e.pop();s._clientState={data:r,client:s,needsRefresh:!1,version:s._channelStatus.version,last_update:[0,r.getJournalLine()],last_sent:[0,r.getJournalLine()]},s._data=r,s._createTransaction(),s.resolve({result:!0,channelId:t})}else s.resolve({result:!1,text:"Authorization or connection failed"})})})}}),t.isConnected=function(){return this._disconnected?!1:this._connCnt&&this._connected?!0:!1},t.isLocal=function(){return this._isLocal},t.length=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);return e&&e.data?e.data.length||0:0},t.moveDown=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e),a=r-1;a>=0&&r>=0&&r!=a&&i.data.length>a&&this.addCommand([12,n,a,r,i.__id])}}},t.moveTo=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);if(i){var r=this._fetch(i.__p);if(r&&r.data){var a=r.data.indexOf(i);a>=0&&a!=n&&r.data.length>n&&this.addCommand([12,e,n,a,r.__id])}}},t.moveUp=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e),a=r+1;a>=0&&r>=0&&r!=a&&i.data.length>a&&this.addCommand([12,n,a,r,i.__id])}}},t.reconnect=function(){return this._disconnected=!1,this},t.redo=function(t){this._data.redo(t)},t.redoStep=function(t){this._data.redoStep(t)},t.remove=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e);r>=0&&this.addCommand([8,r,n,0,i.__id])}}},t.sendCommand=function(t,n){var e=this,i=this._channelId,r=this._socket;if(e._policy&&!e._disconnected&&e._connected&&r)return r.send("channelCommand",{channelId:i,cmd:t,data:n})},t.set=function(t,n,e){var i=this._idToNs(t,this._ns),r=this._data._find(i);if(r&&!this.isObject(e)){var a=r.data[n];a!=e&&(console.log("command 4 "+JSON.stringify([4,n,e,a,i])),this.addCommand([4,n,e,a,i]))}},t.setChannelModel=function(t){this._serverModel=t},t.setMasterConnection=function(t){this._master=t},t.setObject=function(t,n,e){var i=this._idToNs(t,this._ns),r=this._data._find(i);if(r&&this.isObject(e)&&e.__id){var a=r.data[n];a||this.addCommand([5,n,e.__id,null,i])}},t.setSlaveServer=function(t){this._slave=t},t.sync=function(t){var n=this._socket,e=this,i=this._channelId;return s(function(r){return e.isConnected()&&t&&t.out&&t.out.channelId?void n.send("channelCommand",{channelId:i,cmd:"sync",data:{sync:t}}).then(function(t){r(t)}):void r({success:!1})})},t.undo=function(t){this._data.undo(t)},t.undoStep=function(t){this._data.undoStep(t)},t.unset=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);i&&i.data&&(this.isObject(i.data[n])?this.addCommand([10,n,i.data[n].__id,null,e]):i.data&&"undefined"!=typeof i.data[n]&&this.addCommand([10,n,i.data[n],"value",e]))},t.upgradeVersion=function(){this._socket.send("channelCommand",{channelId:this._channelId,cmd:"snapshot",data:{}}).then(function(){})}}(this)},g=function(t,n,e,i,r,a,s,o){var c,_=this;if(!(_ instanceof g))return new g(t,n,e,i,r,a,s,o);var f=[t,n,e,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=g._classInfo.name)return new c(t,n,e,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};m.prototype=s.prototype,g._classInfo={name:"channelClient"},g.prototype=new m,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.channelClient=g,this.channelClient=g):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.channelClient=g:this.channelClient=g}.call(new Function("return this")());var y=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),"connect"==t&&this._connected&&n(this._socket),this},t.removeListener=function(t,n){if(this._ev&&this._ev[t])for(var e=this._ev[t],i=0;i<e.length;i++)if(e[i]==n)return void e.splice(i,1)},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,i;t.disconnect=function(){this._socket.messageTo({disconnect:!0}),me._connected=!1},t.emit=function(t,n,e){var i={name:t,data:n};if(e){i._callBackId=this.guid();var r=this,a=function(t){e(t),r.removeListener(i._callBackId,a)};this.on(i._callBackId,a)}this._socket.messageTo(i)},t.getEnum=function(){var t=this.socketId;return n[t]||(n[t]=i++),n[t]},t.getId=function(){return this.socketId},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,r,a){n||(n={},i=1);var s=this,o=this.guid();if(this.socketId=o,n[this.socketId]||(n[this.socketId]=i++),a){var c,_,f=!1,u=function(){f?s.trigger("connect",s._socket):(c&&c.release(),_&&_.release(),c=e(t,r,"openConnection","client",a),_=e(t,r,o,"client",a),_.on("clientMessage",function(t,n){n.connected?(s._socket=_,s._connected=!0,s.trigger("connect",_)):s.trigger(n.name,n.data)}),c.messageTo({socketId:o}))},s=this;return a.on("disconnect",function(){s.trigger("disconnect")}),void(a.connected?u():a.on("connect",u))}var c=e(t,r,"openConnection","client",a),_=e(t,r,o,"client",a);_.on("clientMessage",function(t,n){n.connected?(s._socket=_,s._connected=!0,s.trigger("connect",_)):s.trigger(n.name,n.data)}),c.messageTo({socketId:o})}),t.send=function(t,n){var e=this;return s(function(i){e.emit(t,n,i)})}}(this)},b=function(t,n,e,i,r,a,s,o){var c,_=this;if(!(_ instanceof b))return new b(t,n,e,i,r,a,s,o);var f=[t,n,e,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=b._classInfo.name)return new c(t,n,e,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};b._classInfo={name:"_clientSocket"},b.prototype=new y,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._clientSocket=b,this._clientSocket=b):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._clientSocket=b:this._clientSocket=b}.call(new Function("return this")());var I=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.constructClientToServer=function(t){var n=t.data;t.last_sent||(t.last_sent=[]);var e=t.last_sent[1]||0,i=n._journal.length;if(t.last_update){e<t.last_update[1]&&(e=t.last_update[1]);var r=t.last_update[1]||0;if(r>=i)return null}if(e==i)return null;t.last_sent[0]=e,t.last_sent[1]=i;var a={cmd:"c2s",id:this.guid(),c:n._journal.slice(e,i),start:e,end:i,version:t.version};if(t.client)for(var s=0;s<a.c.length;s++){var o=a.c[s];a.c[s]=t.client._transformCmdFromNs(o)}return a},t.deltaServerToClient=function(t,e){if(t){var i=e.data;e.last_update||(e.last_update=[]);var r={goodCnt:0,oldCnt:0,newCnt:0,reverseCnt:0},a=t.start;if(e.needsRefresh)return void(n.onCancel&&n.onCancel({data:i,reason:g,clientState:e,updateFrame:t,serverCmds:t.c}));if(t.start>i._journal.length)return n.onError&&n.onError({data:i,reason:" updateFrame.start > data._journal.length ",clientState:e,updateFrame:t,serverCmds:t.c}),e.needsRefresh=!0,r.fail=!0,r;if(e.client)for(var s=t.start;s<t.end;s++){var o=t.c[s-t.start];t.c[s-t.start]=e.client._transformCmdToNs(o)}n.onServerData&&n.onServerData({data:i,clientState:e,updateFrame:t,serverCmds:t.c});for(var s=t.start;s<t.end;s++){var c=i.getJournalCmd(s),o=t.c[s-t.start],_=!0;if(c){if(13==c[0]&&13==o[0]&&c[4]==o[4]&&c[1]==o[1]){var f=c[2],u=o[2];if(f.length!=u.length)_=!1;else for(var h=0;h<f.length&&_;h++){for(var l=f[h],d=u[h],v=0;5>v;v++)if(l[v]!=d[v]){console.log("not same ",v,l[v],d[v]),_=!1;break}if(_)if(this.isArray(l[5])){for(var l=l[5],d=d[5],p=Math.max(l.length||0,d.length||0),v=0;p>v;v++)if(l[v]!=d[v]){console.log("not same array ",v),_=!1;break}}else l[5]!=d[5]&&(_=!1);_||(console.log("was not the same at array compare"),console.log(o,"vs",c))}}else for(var m=0;4>=m;m++)c[m]!=o[m]&&(_=!1,n.onError&&n.onError({data:i,reason:" server datas are different ",clientState:e,updateFrame:t,serverCmds:t.c}));if(!_){i.reverseToLine(a);for(var s=a;s<t.end;s++){var o=t.c[s-t.start],g=i.execCmd(o,!0);if(g!==!0)return console.log("--- setting refresh on because of ---- "),console.log(JSON.stringify(g)),n.onError&&n.onError({data:i,reason:g,clientState:e,updateFrame:t,serverCmds:t.c}),e.needsRefresh=!0,r.fail=!0,r.reason=g,r;r.reverseCnt++}return e.last_update[0]=t.start,e.last_update[1]=t.end,r}a=s,r.goodCnt++,r.oldCnt++}else{var g=i.execCmd(o,!0);if(g!==!0)return console.log("--- setting refresh on because of ---- "),console.log(JSON.stringify(g)),n.onError&&n.onError({data:i,reason:g,clientState:e,updateFrame:t,serverCmds:t.c}),e.needsRefresh=!0,r.fail=!0,r.reason=g,r;a=s,r.goodCnt++,r.newCnt++}}return e.last_update[0]=t.start,e.last_update[1]=t.end,r}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},j=function(t,n,e,i,r,a,s,o){var c,_=this;if(!(_ instanceof j))return new j(t,n,e,i,r,a,s,o);var f=[t,n,e,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=j._classInfo.name)return new c(t,n,e,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};j._classInfo={name:"_chPolicy"},j.prototype=new I,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._chPolicy=j,this._chPolicy=j):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._chPolicy=j:this._chPolicy=j}.call(new Function("return this")());var O=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},C=function(t,n,e,i,r,a,s,o){var c,_=this;if(!(_ instanceof C))return new C(t,n,e,i,r,a,s,o);var f=[t,n,e,i,r,a,s,o];if(_.__factoryClass)if(_.__factoryClass.forEach(function(t){c=t.apply(_,f)}),"function"==typeof c){if(c._classInfo.name!=C._classInfo.name)return new c(t,n,e,i,r,a,s,o)}else if(c)return c;_.__traitInit?_.__traitInit.forEach(function(t){t.apply(_,f)}):"function"==typeof _.init&&_.init.apply(_,f)};C._classInfo={name:"moshModule"},C.prototype=new O,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());