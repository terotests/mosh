(function(){var t={},n=function(){!function(t){var n,e,i,r,o,a,s,c;t._easeFns=function(){s={easeIn:function(t){return t*t},easeOut:function(t){return-1*t*(t-2)},easeInOut:function(t){return.5>t?t*t:-1*t*(t-2)},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return(1-t)*(1-t)*(1-t)+1},pow:function(t){return Math.pow(t,parseFloat(1.5-t))},linear:function(t){return t}}},t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.addEasingFn=function(t,n){s[t]=n},t.after=function(t,n,e){e||(e="aft_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.ease=function(t,n,e,i){var r=s[t];r||(r=s.pow);var o="e_"+a++;c[o]={easeFn:r,duration:n,cb:e,over:i}},t.every=function(t,n,e){e||(e="t7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){this._easeFns(),a=1;var t,s;if("undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}var u=new Function("try { return this == global; } catch(e) { return false; }")();u?t=function(t){return setImmediate(t)}:t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},r={},o=[],c={};var f=0,l=function(){var n=(new Date).getTime(),a=f-n;0==f&&(a=0);for(var s;s=e.shift();)"[object Array]"===Object.prototype.toString.call(s)?s[1].apply(s[0],s[2]):s();for(var u=0;u<o.length;u++){var h=o[u];h()}for(var _ in c)if(c.hasOwnProperty(_)){var d=c[_];d.start||(d.start=n);var v=n-d.start,p=v/d.duration;p>=1&&(p=1,delete c[_]),d.cb(d.easeFn(p)),1==p&&d.over&&d.over()}for(var _ in i)if(i.hasOwnProperty(_)){var d=i[_];d[0](d[1]),delete i[_]}for(var _ in r)if(r.hasOwnProperty(_)){var d=r[_];d.nextTime<n&&(d.remove?d.nextTime>0?(d.fn(),delete r[_]):d.nextTime=n+d.step:(d.fn(),d.nextTime=n+d.step)),d.until&&d.until<n&&delete r[_]}t(l),f=n};l(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var u,f=this;if(!(f instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=e._classInfo.name)return new u(t,n,i,r,o,a,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};e._classInfo={name:"later"},e.prototype=new n,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.later=e,this.later=e):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.later=e:this.later=e}.call(new Function("return this")());var i=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,o=[],a=new Array(e);return this.then(function(){var t=r();return 0==n.length&&t.resolve([]),n.forEach(function(n,r){n.then?(o.push(n),n.then(function(n){a[r]=n,i++,i==e&&t.resolve(a)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var o=i.length,a=!1,s=!1,c=0,u=[],f=e||{};return this.then(function(){var n=r();return i.forEach(function(e){e.then?(u.push(e),e.then(function(e){c++,a=t(e,f),(a&&!s||0==s&&o==c)&&(n.resolve(f),s=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.genPlugin=function(t,n){this.plugin(t,function(){var t=Array.prototype.slice.call(arguments,0);console.log("Plugin args",t);var e=r();return this.then(function(){var i=Array.prototype.slice.call(arguments,0),r=t.concat(i),o=n.apply(this,r);e.resolve(o)},function(t){e.reject(t)}),e})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){t(function(t){i.resolve(t)},function(t){i.resolve(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.nodeStyle=function(t,n){this.plugin(t,function(){var t,e,i=Array.prototype.slice.call(arguments,0),r=0;i.length>=0&&(t=i[i.length-1],"[object Function]"==Object.prototype.toString.call(t)&&(e=t,r=i.length-1));var o=wishes().pending();return this.then(function(){var t=wishes().pending(),a=Array.prototype.slice.call(arguments,0);console.log("Orig args",i),console.log("Then args",a);var s;0==i.length&&(s=a),0==a.length&&(s=i),s||(s=a.concat(i)),r=s.length,e&&r--,s[r]=function(n){if(n)return console.log("Got error ",n),t.reject(n),void o.reject(n);if(e){var i=Array.prototype.slice.call(arguments),r=e.apply(this,i);o.resolve(r)}else{var i=Array.prototype.slice.call(arguments,1);o.resolve.apply(o,i)}},t.then(function(t){o.resolve(t)}),console.log("nodeStyle after concat",s);n.apply(this,s);return t},function(t){o.reject(t)}),o})},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.plugin=function(n,e){return t[n]=e,this},t.props=function(t){var n=[];for(var e in t)t.hasOwnProperty(e)&&n.push({name:e,promise:t[e]});var i=n.length,r=0,o=[],a={};return this.then(function(){var t=wishes().pending();return n.forEach(function(n){var e=n.promise,s=n.name;e.then?(o.push(e),e.then(function(n){a[s]=n,r++,r==i&&t.resolve(a)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new r(t,n),o=this;return 1==this._state&&e().asap(function(){o.fulfill(o.value())}),2==this._state&&ater().asap(function(){o.reject(o.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},r=function(t,n,e,i,o,a,s,c){var u,f=this;if(!(f instanceof r))return new r(t,n,e,i,o,a,s,c);var l=[t,n,e,i,o,a,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=r._classInfo.name)return new u(t,n,e,i,o,a,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};r._classInfo={name:"_promise"},r.prototype=new i,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._promise=r,this._promise=r):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._promise=r:this._promise=r}.call(new Function("return this")());var o=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),"connect"==t&&this._connected&&n(this._socket),this},t.removeListener=function(t,n){if(this._ev&&this._ev[t])for(var e=this._ev[t],i=0;i<e.length;i++)if(e[i]==n)return void e.splice(i,1)},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.disconnect=function(){this._socket.messageTo({disconnect:!0}),me._connected=!1},t.emit=function(t,n,e){var i={name:t,data:n};if(e){i._callBackId=this.guid();var r=this,o=function(t){e(t),r.removeListener(i._callBackId,o)};this.on(i._callBackId,o)}this._socket.messageTo(i)},t.getEnum=function(){var t=this.socketId;return n[t]||(n[t]=e++),n[t]},t.getId=function(){return this.socketId},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,i,r){n||(n={},e=1);var o=this,a=this.guid();if(this.socketId=a,n[this.socketId]||(n[this.socketId]=e++),r){var s,c,u=!1,l=function(){u?o.trigger("connect",o._socket):(s&&s.release(),c&&c.release(),s=f(t,i,"openConnection","client",r),c=f(t,i,a,"client",r),c.on("clientMessage",function(t,n){n.connected?(o._socket=c,o._connected=!0,o.trigger("connect",c)):o.trigger(n.name,n.data)}),s.messageTo({socketId:a}))},o=this;return r.on("disconnect",function(){o.trigger("disconnect")}),void(r.connected?l():r.on("connect",l))}var s=f(t,i,"openConnection","client",r),c=f(t,i,a,"client",r);c.on("clientMessage",function(t,n){n.connected?(o._socket=c,o._connected=!0,o.trigger("connect",c)):o.trigger(n.name,n.data)}),s.messageTo({socketId:a})}),t.send=function(t,n){var e=this;return r(function(i){e.emit(t,n,i)})}}(this)},a=function(t,n,e,i,r,o,s,c){var u,f=this;if(!(f instanceof a))return new a(t,n,e,i,r,o,s,c);var l=[t,n,e,i,r,o,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=a._classInfo.name)return new u(t,n,e,i,r,o,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};a._classInfo={name:"_clientSocket"},a.prototype=new o,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._clientSocket=a,this._clientSocket=a):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._clientSocket=a:this._clientSocket=a}.call(new Function("return this")());var s=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.getPrefix=function(){return this._ip+":"+this._port},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,i,r){e||(e={},n={});var o=this;if(this._ip=t,this._port=i,this._ioLib=r,r)return void r.on("connection",function(e){console.log("socket.io got connection"),console.log("ip, port",t,i);var r=f(t,i,"openConnection","server",e),a=[];e.on("disconnect",function(){console.log("ioLib at server sent disconnect, closing opened connections"),a.forEach(function(t){t.close()})}),r.on("serverMessage",function(r,s){if(s.socketId){var c=f(t,i,s.socketId,"server",e);a.push(c);var u=h(c,o);n[s.socketId]=u,o.trigger("connect",u),u.isConnected()&&c.messageFrom({connected:!0,socketId:s.socketId})}})});var a=f(t,i,"openConnection","server");a.on("serverMessage",function(e,r){if(r.socketId){var a=f(t,i,r.socketId,"server"),s=h(a,o);n[r.socketId]=s,o.trigger("connect",s),o.trigger("connection",s),s.isConnected()&&a.messageFrom({connected:!0,socketId:r.socketId})}})})}(this)},c=function(t,n,e,i,r,o,a,s){var u,f=this;if(!(f instanceof c))return new c(t,n,e,i,r,o,a,s);var l=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=c._classInfo.name)return new u(t,n,e,i,r,o,a,s)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};c._classInfo={name:"_serverSocket"},c.prototype=new s,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._serverSocket=c,this._serverSocket=c):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._serverSocket=c:this._serverSocket=c}.call(new Function("return this")());var u=function(){!function(t){t.clearEvents=function(){delete this._ev},t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){var i=this;return this._ev[t].forEach(function(t){t(i,n,e)}),this}}}(this),function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,i;t.close=function(){this.trigger("disconnect")},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e,r,o){this._server=t,this._port=n,this._role=r,this._socketId=e,this._dbName="tcp://"+this._server+":"+this._port+":"+this._socketId,i||(i="undefined"!=typeof lokki?lokki("tcp"):{log:function(){},error:function(){}}),o?(this._socket=o,this.socketPump(r)):this.memoryPump(r)}),t.memoryPump=function(t){var r=this,o=this._dbName+":to",a=this._dbName+":from";n||(n={}),n[o]||(n[o]=[]),n[a]||(n[a]=[]);var s=function(){if("server"==t){var e=n[o].slice();e.forEach(function(t){i.log("server got message ",t),r.trigger("serverMessage",t),n[o].shift()})}if("client"==t){var e=n[a].slice();e.forEach(function(t){r.trigger("clientMessage",t),n[a].shift()})}};this._memoryFn=s,e().every(.1,s)},t.messageFrom=function(t){var e=this._socket;if(e)return void e.emit(this._dbName,t);var i=this._dbName+":from";n[i].push(t)},t.messageTo=function(t){var e=this._socket;if(e)return void e.emit(this._dbName,t);var i=this._dbName+":to";n[i].push(t)},t.release=function(){this.clearEvents();var t=this._socket;this._pumpListener&&t.removeListener(this._dbName,this._pumpListener),this._memoryFn&&this._memoryFn._release&&this._memoryFn._release()},t.socketPump=function(t){var n=this,e=this._socket;"server"==t&&(this._pumpListener=function(t){n.trigger("serverMessage",t)},e.on(this._dbName,this._pumpListener)),"client"==t&&(this._pumpListener=function(t){n.trigger("clientMessage",t)},e.on(this._dbName,this._pumpListener))}}(this)},f=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof f))return new f(t,n,e,i,r,o,a,s);var l=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,l)}),"function"==typeof c){if(c._classInfo.name!=f._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};f._classInfo={name:"_tcpEmu"},f.prototype=new u;var l=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.delegateToRoom=function(t,e,i){var r=this._roomPrefix+":"+t;if(n&&n[r]){var o=this;n[r].forEach(function(t){t!=o&&t.emit(e,i)})}},t.disconnect=function(){var t=this;t._disconnected=!0,console.log("_serverSocketWrap disconnecting"),t.leaveFromRooms(),console.log("_serverSocketWrap left from rooms"),t.trigger("disconnect",t),t._disconnected=!0},t.emit=function(t,n){this._tcp.messageFrom({name:t,data:n})},t.getId=function(){return this._tcp._socketId},t.getUserId=function(){return this._userId},t.getUserRoles=function(){return this._roles},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){var e=this;this._roomPrefix=n.getPrefix(),this._server=n,this._tcp=t,t.on("disconnect",function(){console.log("tcpEmu sent disconnect"),e.disconnect()});t.on("serverMessage",function(t,n){return e._disconnected?void 0:n.disconnect?void e.disconnect():void(n._callBackId?e.trigger(n.name,n.data,function(t){e.emit(n._callBackId,t)}):e.trigger(n.name,n.data))}),this.broadcast={to:function(t){return{emit:function(n,i){e.delegateToRoom(t,n,i)}}}}}),t.isConnected=function(){return this._disconnected?!1:!0},t.isInRoom=function(t){return e?e[this.getId()].indexOf(t)>=0:!1},t.join=function(t){var i=this._roomPrefix+":"+t;n||(n={}),n[i]||(n[i]=[]),n[i].indexOf(this)<0&&(n[i].push(this),e||(e={}),e[this.getId()]||(e[this.getId()]=[]),e[this.getId()].push(t))},t.leave=function(t){var i=this._roomPrefix+":"+t;n||(n={}),n[i]||(n[i]=[]);var r;if((r=n[i].indexOf(this))>=0){n[i].splice(r,1);var o=this.getId(),a=e[o].indexOf(t);a>=0&&e[o].splice(a,1)}},t.leaveFromRooms=function(){var t=this.getId(),n=this;e&&e[t]&&e[t].forEach(function(t){n.leave(t)})},t.removeListener=function(){},t.setAuthInfo=function(t,n){this._userId=t,this._roles=n},t.to=function(t){var e=this._roomPrefix+":"+t;return{emit:function(t,i){n&&n[e]&&n[e].forEach(function(n){n.emit(t,i)})}}}}(this)},h=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof h))return new h(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};h._classInfo={name:"_serverSocketWrap"},h.prototype=new l;var _=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},d=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof d))return new d(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=d._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};d._classInfo={name:"socketEmulator"},d.prototype=new _;var v=function(){!function(t){var n,e,i;t.__dataTr=function(){},t._collectObject=function(t,n,e){this.isArray(n)||(n=n.split(","));var i={};n.forEach(function(n){i[n]=t[n](),t.on(n,function(){i[n]=t[n](),e(i)})}),e(i)},t._forMembers=function(t){var n=this;if(this.isArray())for(var e=0;e<this._data.length;e++){var i=this._data[e];this.isObject(i)&&i.__dataTr&&t(i)}else this._members.forEach(function(e){n[e]&&t(n[e])})},t._initializeData=function(t,n){if(t){this._data=t.data,this._docData=t;var e=this._client.getChannelData(),i=this._client._idToNs(this._docData.__id,this._client._ns);e.createWorker("_to_ch",[7,"*",null,null,i],{target:this}),e.createWorker("_to_ch",[5,"*",null,null,i],{target:this}),e.createWorker("_d_set",[4,"*",null,null,i],{target:this}),e.createWorker("_d_rem",[8,"*",null,null,i],{target:this}),e.createWorker("_d_ins",[7,"*",null,null,i],{target:this}),e.createWorker("_d_mv",[12,"*",null,null,i],{target:this}),e.createWorker("_d_cf",[5,"*",null,null,i],{obj:this}),e.createWorker("_d_cf",[4,"*",null,null,i],{obj:this}),e.createWorker("_d_ch",[42,"*",null,null,i],{target:this});var r=t.data;if(r instanceof Array){for(var o in r)this[o]=p(r[o],n,this._client);this._initIterator()}else for(var o in r)if(r.hasOwnProperty(o)){var a=r[o];if(this.isFunction(a))continue;if(!this.isFunction(a)&&(a===Object(a)||a instanceof Array)){this[o]=new p(a,n,this._client);continue}this.isFunction(a)||this.isObject(a)||this.isArray(a)||this[o]||this.createPropertyUpdateFn(o,a)}}},t._objectCreateCmds=function(t,n){if(n||(n=[]),this.isObject(t)&&t.data)if(this.isArray(t.data)){n.push([2,t.__id,"",null,t.__id]);for(var e=0;e<t.data.length;e++){var i=t.data[e];if(this.isObject(i)){this._objectCreateCmds(i,n);var r=[7,e,i.__id,null,t.__id];n.push(r)}}}else{n.push([1,t.__id,"",null,t.__id]);for(var o in t.data)if(t.data.hasOwnProperty(o)){var a=t.data[o];if(this.isObject(a)){this._objectCreateCmds(a,n);var r=[5,o,a.__id,null,t.__id];n.push(r)}else{var r=[4,o,a,null,t.__id];n.push(r)}}}return n},t._parseURL=function(t){var n=t.split("://"),e=n.shift(),i=n.shift(),r=i.split("/"),o=r.shift(),a=o.split(":"),s=a[0],c=a[1],u=r.shift(),f=r.pop(),l=r.join("/");return{url:t,ip:s,port:c,sandbox:u,path:l,file:f,protocol:e}},t._reGuidRawData=function(t){if(this.isArray(t)){var n=this;t.forEach(function(t){n._reGuidRawData(t)})}else if(this.isObject(t))for(var e in t)t.hasOwnProperty(e)&&("__id"!=e?(this.isObject(t[e])&&this._reGuidRawData(t[e]),this.isArray(t[e])&&this._reGuidRawData(t[e])):t[e]=this.guid())},t._wrapToData=function(t){var n;if(t.__id&&t.data)n=t;else var n={data:t,__id:this.guid()};if(n.data&&this.isObject(n.data))for(var e in n.data)if("__oid"!=e){if(n.data.hasOwnProperty(e)){var i=n.data[e];if(this.isFunction(i))continue;this.isObject(i)&&(n.data[e]=this._wrapToData(i))}}else delete n.data[e];return n},t.addController=function(){console.error("** askChannelQuestion ** not implemented now ")},t.askChannelQuestion=function(){console.error("** askChannelQuestion ** not implemented now ")},t.at=function(t){var n=this._docData.data[t];return n?p(n,null,this._client):void 0},t.clear=function(){for(var t=this.length();t--;)this.pop()},t.clone=function(){return p(this.serialize())},t.copyToData=function(){var t=this.toData();return this._reGuidRawData(t),t},t.createArrayField=function(t,n){return this.set(this._docData.__id,t,n)},t.createField=function(t,n){return this.set(t,n||""),this},t.createObjectField=function(t,n){return this.set(this._docData.__id,t,n)},t.createPropertyUpdateFn=function(n,i){if(this.isObject(i)||this.isObject(this._docData.data[n]))return void(this[n]=p(i,null,this._client));t[n]||(t[n]=function(t){return"undefined"==typeof t?this._client.get(this._docData.__id,n):(this._client.set(this._docData.__id,n,t),this)},e[n]=!0)},t.createWorker=function(t,n,e,r){n[4]=this._client._idToNs(n[4],this._client._ns);var o=this._client.getChannelData();if(o.createWorker(t,n,e),r&&(i||(i={}),!i[t])){var a={};a[t]=r,o.setWorkerCommands(a),i[t]=!0}return this},t.diff_set=function(t,n){return this.isObject(n)?this:(this._client.diffSet(this._docData.__id,t,n),this.createPropertyUpdateFn(t,n),this)},t.emitValue=function(t,n){if(this._processingEmit)return this;if(this._processingEmit=!0,this._controllers)for(var e=0,i=0;i<this._controllers.length;i++){var r=this._controllers[i];r[t]&&(r[t](n),e++)}this._valueFn&&this._valueFn[t]&&this._valueFn[t].forEach(function(t){t(n)}),this._parent&&this._parent.emitValue&&this._parent.emitValue(t,n),this._processingEmit=!1},t.extendWith=function(n){for(var e in n){var i=n[e];this.isFunction(i)&&(t[e]=i)}},t.find=function(){return console.error("*** FIND IS NOT IMPLEMENTED *** "),null},t.forEach=function(t){var n=this;this._docData.data.forEach(function(e){t(p(e,null,n._client))})},t.forTree=function(t,n){var e={},i=!1;if(n){var r=t.split(",");r.forEach(function(t){e[t.trim()]=!0,i=!0})}else n=t;n(this);var o=this;return this.isArray()?this.forEach(function(t){t.forTree(n)}):this.keys(function(t){if((!i||e[t])&&o[t]&&o.hasOwn(t)){var r=o[t];r.forTree&&r.forTree(n)}}),this},t.get=function(t){return console.log("Calling get for "+t),console.log("docData "+JSON.stringify(this._docData)),this._client.get(this._docData.__id,t)},t.getData=function(t){if(this._docData)var n=this._client._fetch(this._docData.__id);else{if(!this._client)return;var n=this._client.getData()}if(t){var e=JSON.parse(JSON.stringify(n));n=this._client._transformObjFromNs(e)}return n},t.getID=function(){return this._docData.__id},t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.hasOwn=function(t){return"undefined"!=typeof this._docData.data[t]&&this[t]?!0:!1},t.indexOf=function(){return this._client.indexOf(this._docData.__id)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={},e={})}),t.insertAt=function(t,n){return this.push(n,t)},t.isArray=function(t){return"undefined"==typeof t?this._docData&&this._docData.data?this.isArray(this._docData.data):!1:"[object Array]"===Object.prototype.toString.call(t)},t.isDataTrait=function(t){return t._docData?!0:void 0},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this._docData&&this._docData.data?this.isObject(this._docData.data):!1:t===Object(t)},t.item=function(t){return this.at(t)},t.keys=function(t){for(var n in this._docData.data)this._docData.data.hasOwnProperty(n)&&t(n,this._docData.data[n],this._docData.data);return this},t.length=function(){return this._docData&&this._docData.data?this._docData.data.length:0},t.moveDown=function(){return this._client.moveDown(this._docData.__id),this},t.moveToIndex=function(t){return this._client.moveTo(this._docData.__id,t),this},t.moveUp=function(){return this._client.moveUp(this._docData.__id),this},t.onValue=function(t,n){this._valueFn||(this._valueFn={}),this._valueFn[t]||(this._valueFn[t]=[]),this._valueFn[t].indexOf(n)<0&&this._valueFn[t].push(n)},t.parent=function(t){if("undefined"!=typeof t)return this;if(this._docData){var t=this._docData.__p;return t?p(t):void 0}},t.pick=function(t){var n=simpleStream(),e=this;return this.then(function(){e._collectObject(e,t,function(t){n.pushValue(t)})}),n},t.pop=function(){var t=this.length();if(t){var n=this.at(t-1);return n&&n.remove(),n}},t.push=function(t,n){if(!this.isArray())return this;var e,i=!1;if(t._wrapToData){t=t.getData();var r=this._client._fetch(t.__id);r&&(i=!0)}if(e=t.__id&&t.data?this._client._transformObjToNs(t,this._client._ns):this._wrapToData(t),!i)for(var o=this._objectCreateCmds(e),a=0;a<o.length;a++)this._client.addCommand(o[a]);var s;if("undefined"!=typeof n){s=n;var r=this._client._fetch(this._docData.__id);if(0>s||s>r.data.length)return}else{var r=this._client._fetch(this._docData.__id);s=r.data.length}return this._client.addCommand([7,s,e.__id,null,this._docData.__id]),this},t.redo=function(t){return this._client.redo(t),this},t.redoStep=function(t){return this._client.redoStep(t),this},t.remove=function(){return this._client.remove(this._docData.__id),this},t.removeListener=function(t,n){if(this._events&&this._events[t]){var e=this._events[t].indexOf(n);e>=0&&this._events[t].splice(e,1),0==this._events[t].length&&delete this._events[t]}},t.renderTemplate=function(){console.error("RenderTemplate not implemented")},t.serialize=function(t){var n,e=this._docData.data;n=this.isArray(this._data)?[]:{};for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];if("undefined"==typeof r)continue;if(t&&(this.isObject(r)||this.isArray(r)))continue;n[i]=this.isObject(r)?p(r).serialize():r}return n},t.set=function(t,n){if(this.isFunction(n)){var e=this;return this.then(function(){return e.set(t,n(e.get(t)))}),this}if(this.isObject(n)){var i,r=n;r._wrapToData&&(r=r.getData()),i=r.__id&&r.data?this._client._transformObjToNs(r,this._client._ns):this._wrapToData(r);for(var o=this._objectCreateCmds(i),a=0;a<o.length;a++)this._client.addCommand(o[a]);this._client.setObject(this._docData.__id,t,i);var s=this._client._fetch(i.__id);return this.createPropertyUpdateFn(t,s),this}return console.log("value set "+t+" = "+n),this._client.set(this._docData.__id,t,n),this.createPropertyUpdateFn(t,n),this},t.toData=function(){var t=JSON.stringify(this._docData),n=JSON.parse(t);return n.__ctxCmdList&&delete n.__ctxCmdList,n.__cmdList&&delete n.__cmdList,n},t.toPlainData=function(){return this.getChannelData().toPlainData(this._docData)},t.undo=function(t){return this._client.undo(t),this},t.undoStep=function(t){return this._client.undoStep(t),this},t.unset=function(t){return this._client.unset(this._docData.__id,t),this},t.upgradeVersion=function(){return this._client.upgradeVersion(),this}}(this),function(t){var n;t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n=[])}),t.on=function(t,n){this._events||(this._events={}),this._events[t]||(this._events[t]=[]),this._events[t].push(n);var e=this;n._unbindEvent=function(){e.removeListener(t,n)}},t.removeListener=function(t,n){if(this._events&&this._events[t]){var e=this._events[t].indexOf(n);e>=0&&this._events[t].splice(e,1),0==this._events[t].length&&delete this._events[t]}},t.trigger=function(t,e){if(!(n.indexOf(t+this._guid)>=0)&&this._events&&this._events[t]){var i=this._events[t],r=this;n.push(t+this._guid);for(var o=i.length,a=0;o>a;a++)i[a](r,e);var s=n.indexOf(t+this._guid);n.splice(s,1)}}}(this),function(t){t.propWorker=function(t,n,e){return this.createWorker(n,[4,t,null,null,this.getID()],e),this}}(this),function(t){var n,e,i,o,s;t._addFactoryProperty=function(t){n||(n=[]),n.push(t)},t._atObserveEvent=function(t){s=t},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){if(i||(i={}),this.isObject(t)){if(t._objEventWorker)return t;if(t.data&&t.__id){var r=i[t.__id];if(r)return r}}else if("string"==typeof t){var r=i[t];if(r)return r}if(n&&e)for(var o=0;o<n.length;o++){var a,s=n[o];if(t&&t.data?a=t.data[s]:t&&(a=t[s]),a){var c=e[a];if(c)return c}}}),t._findConnOptions=function(){if(this._connectionOptions)return this._connectionOptions;var t=this.parent();return t?t._findConnOptions():void 0},t._initIterator=function(){var t=this;"undefined"!=typeof Symbol&&"undefined"!=typeof Symbol.iterator&&(t[Symbol.iterator]=function(){var n=0;return{next:function(){var e=t.at(n++);return e?{value:e,done:!1}:{done:!0}}}})},t._initWorkers=function(){var t=this;if(!o){var n=t._client.getChannelData();n.setWorkerCommands({_obs_4:function(t,n){s||(n.target[t[1]]=t[2])},_obs_7:function(t,n){if(!s){var e=t[1],i=p(t[2]);i.isFulfilled()&&(Array.unobserve(n.target,n.parentObserver),n.target[e]=i.toObservable(n.target,n.parentObserver),Array.observe(n.target,n.parentObserver))
}},_obs_8:function(t,n){if(!s){var e=t[1];Array.unobserve(n.target,n.parentObserver),n.target.splice(e,1),Array.observe(n.target,n.parentObserver)}},_obs_12:function(t,n){if(!s){var e=parseInt(t[3]),i=parseInt(t[2]),r=n.target,o=r[e];Array.unobserve(r,n.parentObserver),r.splice(e,1),r.splice(i,0,o),Array.observe(r,n.parentObserver)}},_d_set:function(t,n){n.target.trigger(t[1],t[2])},_d_cf:function(t,n){var e=n.obj;if(4==t[0]&&(e[t[1]]||e.createPropertyUpdateFn(t[1],t[2])),5==t[0]&&!e[t[1]]){var i=e._docData.data[t[1]];i&&e.createPropertyUpdateFn(t[1],i)}},_d_rem:function(t,n){n.target.trigger("remove",t[1])},_to_ch:function(t,n){var e=n.target;if(e._client&&!e._client._isLocal){var i=e._client._fetch(t[2]);i&&p(i,null,e._client)}},_d_ins:function(t,n){n.target.trigger("insert",t[1])},_d_mv:function(t,n){n.target.trigger("move",{itemId:t[1],parentId:t[4],from:t[3],to:t[2]})},_d_ch:function(t,n){n.target.trigger("childChanged",t)}}),o=!0}},t._objEventWorker=function(){if(change){if(4==change[0]){var t=_docUp(),n=p();n.createPropertyUpdateFn(change[1],null);var e=t._find(options.modelid);if(e.__undone)return;options&&options.eventObj&&change[3]!=change[2]&&options.eventObj.trigger(change[1],change[2])}if(options2){options=options2}if(5==change[0]){var t=_docUp(),e=t._find(change[2]),i=t._find(change[4]);if(e.__undone)return;if(i.__undone)return;var r=p();if(r.findFromCache(change[4])){var n=p(change[4]),o=p(change[2]),a=change[1];if(!n)return;if(!o)return;n[a]=o}}if(8==change[0]){var t=_docUp(),e=t._find(change[2]);if(e.__undone)return;options.bListenMVC&&options.eventObj&&options.eventObj.trigger("remove",e.__removedAt)}if(7==change[0]){var t=_docUp(),s=t._find(change[4]),c=t._find(change[2]);if(s.__undone)return;if(c.__undone)return;var u=s.data.indexOf(c);options.bListenMVC&&options.eventObj&&options.eventObj.trigger("insert",u)}if(12==change[0]){var t=_docUp(),s=t._find(change[4]),u=parseInt(change[2]),f=s.data.length;if(s.__undone)return;for(var l=0;f>l;l++){var h=s.data[l];if(h.__id==change[1]){targetObj=h;break}}if(targetObj&&targetObj.__undone)return;var _=targetObj.__fromIndex;if(targetObj){var d=parseInt(change[2]);options.bListenMVC&&options.eventObj&&options.eventObj.trigger("move",{from:_,to:d})}}}},t._parseURL=function(t){var n=t.split("://"),e=n.shift(),i=n.shift(),r=i.split("/"),o=r.shift(),a=r.join("/"),s=o.split(":"),c=s[0],u=s[1],f=r.shift(),l=r.pop(),h=r.join("/"),_={protocol:e,ip:c,port:u,sandbox:f,fullPath:a,path:h,file:l};return _},t.addToCache=function(t,n){i||(i={}),t&&(i[t]=n)},t.channel=function(){return this._client},t.createChannel=function(t,n,e){var i=this;return r(function(r){e||(e={}),i._client.createChannel(t,n,e).then(function(n){if(n.result===!1)return void r(n);var e=i._request,o=p(e.protocol+"://"+e.ip+":"+e.port+"/"+t,i._initOptions);o.then(function(){r({result:!0,channel:o})})})})},t.createSubClass=function(t,n,e){var i=e,r=function(t,n,e,i,o,a,s,c){if(!(this instanceof r))return console.log("NOT instance of..."),new r(t,n,e,i,o,a,s,c);console.log("is instance of..."),console.log(this.__traitInit);var u=[t,n,e,i,o,a,s,c];if(this.__factoryClass){var f,l=this;if(this.__factoryClass.forEach(function(t){f=t.apply(l,u)}),"[object Function]"==Object.prototype.toString.call(f)){if(f._classInfo.name!=r._classInfo.name)return new f(t,n,e,i,o,a,s,c)}else if(f)return f}if(this.__traitInit){console.log("Calling the subclass trait init...");var l=this;this.__traitInit.forEach(function(t){t.apply(l,u)})}else"function"==typeof this.init&&this.init.apply(this,u)};return r._classInfo={name:this.guid()},i.prototype=p.prototype,r.prototype=new i,this.registerComponent(n,r),this._addFactoryProperty(t),r},t.diff=function(t){var n=T(),e=n.compareFiles(this.getData(!0),t.getData(!0));return e.cmds},t.disconnect=function(){return this._client&&this._client.disconnect(),this},t.filter=function(t){var n=p([]);return this.localFork().forEach(function(e){t(e)&&n.push(e.toData(!0))}),n},t.fork=function(t,n){if(!t||this._client._isLocal)return this.localFork();var e=this;return r(function(i){e._client.fork(t,n).then(function(n){if(n.result===!1)return void i(n);var r=e._request,o=p(r.protocol+"://"+r.ip+":"+r.port+"/"+t,e._initOptions);o.then(function(){i({result:!0,fork:o})})})})},t.getChannelClient=function(){return this._client},t.getChannelData=function(){return this._client.getChannelData()},t.getJournal=function(){var t=this.getChannelData();return t._journal.slice()},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){n=n||{};var i=this;if(this._initOptions=n,"string"==typeof t){if(!t.match("://"))return;var r=this._parseURL(t);this._request=r,this._connectionOptions=n,this._socket=a(r.protocol+"://"+r.ip,r.port,n.ioLib);var o={};o.auth=n.auth?n.auth:{},n.initWithData&&(o.initWithData=this._wrapToData(n.initWithData)),this._client=O(r.fullPath,this._socket,o),this._client.then(function(t){if(t.result===!1)return void i.trigger("login::failed");var n=i._client.getData();i._initializeData(n),i.addToCache(n.__id,i),i._initWorkers(),i.resolve(!0)})}else if(e)e&&!this._client&&(this._client=e),this.isObject(t)&&t.__id&&(this._initializeData(t),this.addToCache(t.__id,this)),i._initWorkers(),this.resolve(!0);else{this.isObject(t)&&!t.__id&&(t=this._wrapToData(t));var s=O(this.guid(),null,{localChannel:!0,localData:t});this._client=s;var i=this,c=i._client.getData();if(!c)return void i.resolve(!0);i._initializeData(c),i.addToCache(c.__id,i),i._initWorkers(),i.resolve(!0)}}),t.localFork=function(){var t=this.getData(!0);return p(t)},t.map=function(t){var n=p([]),e=this.localFork(),i=0;return this.localFork().forEach(function(r){var o=t(r,i,e);n.push(o),i++}),n},t.merge=function(t){var n=this.diff(t);return this.patch(n),this},t.openChannel=function(t){var n=this;return r(function(e){var i=(n._request,p(t,n._findConnOptions()));i.then(function(){e({result:!0,channel:i})})})},t.patch=function(t){var n=this;return t.forEach(function(t){var e=n._client._transformCmdToNs(t);n._client.addCommand(e,!0)}),this},t.playback=function(t){var n=this.getChannelData();return n.playback(t)},t.pushToObjArray=function(t,n,e){var i,r,o,a=t.split("/"),s=this,c={};if(e){for(var u in e)if(e.hasOwnProperty(u)){var f=e[u];this.isArray(f)?i=u:"{path}"==f?r=u:c[u]=f}if(i&&r){o=JSON.stringify(c),i||(i="items"),r||(r="title");var l=function(t,n){var e=a[t];if(!e)return n;n.hasOwn(i)||n.set(i,[]);var s;if(n[i].forEach(function(t){t.get(r)==e&&(s=t)}),!s){var c=JSON.parse(o);c[r]=e,c[i]=[],n[i].push(c),s=n[i].at(n[i].length()-1)}return s&&a.length<=t+1?s:l(t+1,s)},h=l(0,s);h&&h[i]&&h[i].push(n)}}},t.reconnect=function(){return this._client&&this._client.reconnect(),this},t.reduce=function(t,n){var e=(p([]),0),i=this.localFork(),r=n;return i.forEach(function(n){r=t(r,n,e,i),e++}),r},t.registerComponent=function(t,n){e||(e={}),e[t]||(e[t]=n)}}(this)},p=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof p))return new p(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=p._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};v.prototype=r.prototype,p._classInfo={name:"_data"},p.prototype=new v,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._data=p,this._data=p):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._data=p:this._data=p}.call(new Function("return this")());var m=function(){!function(t){t.addPermission=function(t,n){for(var e=0;e<n.length;e++){var i=n[e];t.permissions.indexOf(i)<0&&(t.permissions+=i)}},t.allowGroup=function(t,n){var e=!1,i=this;this.map(function(r){return r.principal!=t||r.flags.indexOf("g")>=0||("A"==r.type&&(e=!0,i.addPermission(r,n)),"D"==r.type&&i.removePermission(r,n)),r}),e||this.push("A:g:"+t+":"+n)},t.allowUser=function(t,n){var e=!1,i=this;this.map(function(r){return r.principal!=t||r.flags.indexOf("g")>=0||("A"==r.type&&(e=!0,i.addPermission(r,n)),"D"==r.type&&i.removePermission(r,n)),r}),e||this.push("A::"+t+":"+n)},t.denyGroup=function(t,n){var e=!1,i=this;this.map(function(r){return r.principal!=t||r.flags.indexOf("g")>=0||(e=!0,"A"==r.type&&i.removePermission(r,n),"D"==r.type&&i.addPermission(r,n)),r}),e||this.push("D:g:"+t+":"+n)},t.denyUser=function(t,n){var e=!1,i=this;this.map(function(r){return r.principal!=t||r.flags.indexOf("g")>=0||("A"==r.type&&i.removePermission(r,n),"D"==r.type&&(e=!0,i.addPermission(r,n))),r}),e||this.push("D::"+t+":"+n)},t.filter=function(t){var n=this._acl.split("\n");return n.filter(t),this._acl=n.join("\n"),this},t.find=function(t,n,e){return this.has(t,n,e)},t.fromObject=function(t){return t.type+":"+t.flags+":"+t.principal+":"+t.permissions},t.getACL=function(){return this._acl},t.has=function(t,n,e){for(var i,r,o=0,a=0,s=0,c=this._acl.length,u=!1,f=0,l=!1,h=!1,_=0,d=0,v=!1;c>o;)if(":"!=this._acl.charAt(o))if("\n"!=this._acl.charAt(o))if(0!=a)1!=s?2!=s?3!=s?(a++,o++):(!l||h||v||e.indexOf(this._acl.charAt(o))>=0&&d++,a++,o++):(u?this._acl.charAt(o)==n.charAt(f++)?l=!0:(l=!1,h=!0):this._acl.charAt(o)==t.charAt(f++)?l=!0:(l=!1,h=!0),a++,o++):(r=this._acl.charAt(o),"g"==r&&(u=!0),"i"==r&&(v=!0),a++,o++);else{if(d>0&&e.length==d){if("A"==i)return!0;if("D"==i)return!1}v=!1,i=this._acl.charAt(o),a++,o++,l=!1,h=!1,f=0,_=0,d=0,u=!1}else a=0,s=0,o++;else a++,s++,o++;if(d>0&&e.length==d){if("A"==i)return!0;if("D"==i)return!1}return!1},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t){this._acl=t.trim()}),t.map=function(t){if(0==this._acl.length)return this;var n=this._acl.split("\n"),e=n.map(this.toObject).map(t).map(this.fromObject);return this._acl=e.join("\n").trim(),this},t.push=function(t){var n=this._acl.length;this._acl+=0==n||"\n"==this._acl.charAt(n-1)?t:"\n"+t,this._acl=this._acl.trim()},t.reduce=function(t,n){var e=this._acl.split("\n");return e.reduce(t,n),this._acl=e.join("\n"),this},t.removeAll=function(){this._acl=""},t.removePermission=function(t,n){for(var e=0;e<n.length;e++){var i=n[e];t.permissions.indexOf(i)>=0&&(t.permissions=t.permissions.replace(i,""))}},t.replaceLines=function(t){for(var n=this._acl.split("\n"),e=0;e<n.length;e++){var i=t(n[e]);i&&(n[e]=i)}},t.toObject=function(t){var n={};if(!t)return n;var e=t.split(":");return t.length>0&&(n.type=t.charAt(0),n.flags=e[1],n.principal=e[2],n.permissions=e[3]),n}}(this)},g=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof g))return new g(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=g._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};g._classInfo={name:"nfs4_acl"},g.prototype=new m,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.nfs4_acl=g,this.nfs4_acl=g):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.nfs4_acl=g:this.nfs4_acl=g}.call(new Function("return this")());var y=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.constructServerToClient=function(t){var n=t.data;t.last_update||(t.last_update=[]);var e=t.last_update[1]||0,i=n._journal.length;return e==i?null:(t.last_update[0]=e,t.last_update[1]=i,{cmd:"s2c",c:n._journal.slice(e,i),start:e,end:i,version:t.version})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={})}),t.setHook=function(t,e){n||(n={}),n[t]=e}}(this)},I=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof I))return new I(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=I._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};I._classInfo={name:"_chPolicy"},I.prototype=new y,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._chPolicy=I,this._chPolicy=I):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._chPolicy=I:this._chPolicy=I}.call(new Function("return this")());var b=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t._getNsFromUrl=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getNsShorthand=function(t){return _nsShortcuts[t]?_nsShortcuts[t]:(_nsReverse[_nsIndex]=t,_nsShortcuts[t]=_nsIndex++,_nsShortcuts[t])},t._getReflections=function(){return _localReflections},t._getReflectionsFor=function(t){if(_localReflections){var n=_localReflections[t];if(n)return n}return[]},t._getReverseNs=function(t){return _nsReverse[t]},t._idFromNs=function(t){if(t){var n=t.length;"#"==t[n-1]&&(t=t.split("@").shift())}return t},t._idToNs=function(t,n){if(t){var e=t.length;if("#"==t[e-1]){var i=t.indexOf("@"),r=t.substring(i+1,e-1);r!=n&&(t=t.substring(0,i)+"@"+n+"#")}else t=t+"@"+n+"#"}return t},t._nsFromId=function(t){var n;if(t){t+="";var e=t.length;"#"==t[e-1]&&(n=t.split("@").pop(),n=n.split("#").shift())}return n},t._transformCmdFromNs=function(t,e){e||(e=this._ns);var i=n,r=t.slice(),o=i[t[0]],a=this;return o&&o.forEach(function(t){r[t]=a._idFromNs(r[t],e)}),r},t._transformCmdToNs=function(t,e){e||(e=this._ns);var i=n,r=t.slice(),o=i[t[0]];if(o)for(var a=0;a<o.length;a++){var s=o[a];r[s]=this._idToNs(r[s],e)}return r},t._transformObjFromNs=function(t,n){if(n||(n=this._ns),t&&t.__id){t.__p&&(t.__p=this._idFromNs(t.__p,n)),t.__id=this._idFromNs(t.__id,n);for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjFromNs(t.data[e],n)}return t},t._transformObjToNs=function(t,n){if(n||(n=this._ns),t&&t.__id){t.__id=this._idToNs(t.__id,n),t.__p&&(t.__p=this._idToNs(t.__p,n));for(var e in t.data)t.data.hasOwnProperty(e)&&this.isObject(t.data[e])&&this._transformObjToNs(t.data[e],n)}return t},t._transformToNsBeforeInsert=function(t,n){var e=t.__ctxCmdList,i=this._nsFromId(n.__id);console.log(" _transformToNsBeforeInsert ");var r=this;return i?(e&&e.forEach(function(t){t.cmd=r._transformCmdToNs(t.cmd,i)}),t=r._transformObjToNs(t,i),t.__ctxCmdList=e,this._addToCache(t),t):t},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){n||(n={1:[1],2:[1],4:[4],5:[2,4],7:[2,4],8:[2,4],10:[2,4],12:[1,4],13:[4],14:[4],16:[3,4]})})}(this),function(t){var n,i;t._checkout=function(t){var n=this,e=this._socket;return r(function(i){n._policy&&(n._disconnected||n._connected&&e.send("channelCommand",{channelId:t,cmd:"checkout",data:""}).then(function(t){console.log("Checkout tree "),console.log(t),i(t)}))})},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t&&e?(t+=e.getId(),n||(n={}),n[t]?n[t]:void(n[t]=this)):void 0}),t._createTransaction=function(){this._currentFrame={id:this.guid(),version:1,from:this._data.getJournalLine(),fail_tolastok:!0,commands:[]}},t._fetch=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);return e?e:void 0},t._incoming=function(t){var n=this,e=(this._channelId,0);t.on("upgrade_"+this._channelId,function(t){if(n._upgradePending=!1,!n._disconnected&&t){if(t.partial){var i=n._clientState.data;i.reverseToLine(t.partialFrom);var r=0;i.setClearCreated(!0),t.partial.forEach(function(t){if(!(r>0)){var e,o=n._transformCmdToNs(t);(e=i.execCmd(o,!0))!==!0&&r++}}),i.setClearCreated(!1),0==r?(n._clientState.needsRefresh=!1,n._clientState.needsFullRefresh=!1,i._journal.length=t.partialEnds,n._clientState.last_update[0]=0,n._clientState.last_update[1]=i._journal.length,n._clientState.last_sent[0]=0,n._clientState.last_sent[1]=i._journal.length):n._clientState.needsFullRefresh=!0}if(t.data){var o=n._clientState.data.getData();n._transformObjToNs(t.data);var a=T().compareFiles(o,t.data);console.log("Diff obj , myData, cmd.data"),console.log(a),console.log(o),console.log(t.data);var i=n._clientState.data,r=0;i.setClearCreated(!0),a.cmds.forEach(function(t){if(console.log("Diff cmd ",t),!(r>0)){var n;(n=i.execCmd(t,!0))!==!0&&(console.error("Full error ",n),console.log("Return value from failed cmd: ",n),r++)}}),i.setClearCreated(!1),0==r?(n._clientState.needsRefresh=!1,n._clientState.needsFullRefresh=!1,console.log("** full update should have gone ok ** "),i._journal.length=0,i._journal.push.apply(i._journal,t.journal),n._clientState.needsRefresh=!1,n._clientState.version=t.version,n._clientState.last_update[0]=0,n._clientState.last_update[1]=i._journal.length,n._clientState.last_sent[0]=0,n._clientState.last_sent[1]=i._journal.length,console.log("Version ",n._clientState.version)):(e++,console.error("** errors with the full update ** "),e>0?(console.log("--- server command data ---"),console.log(t),console.log("--- the client state ---"),console.log(n._clientState),n._clientState.needsFullRefresh=!1):(n._clientState.needsFullRefresh=!0,n._clientState.fullUpgradeFailCnt=e))}n._slaveController&&n._slaveController._execCmd({cmd:"masterJournalUpgrade",data:t})}}),t.on("s2c_"+this._channelId,function(t){if(!n._disconnected&&t){{n._policy.deltaServerToClient(t,n._clientState)}if(n._slaveController){for(var e=[],i=0;i<t.c.length;i++){var r=t.c[i].slice();e.push(n._transformCmdFromNs(r))}t.c=e,n._slaveController._execCmd({cmd:"masterUpgrade",data:t})}}})},t._isNodeJs=function(){return new Function("try { return this === global; } catch(e) { return false; }")()},t._onFrameLoop=function(t){var n=this,i=this._channelId,r=function(){if(n._policy&&!n._disconnected&&n._connected&&n._clientState){n._clientState.needsRefresh&&(n._upgradePending||n.askUpgrade(n._clientState.needsFullRefresh),n._upgradePending=!0);var e=n._policy.constructClientToServer(n._clientState);e&&t.send("channelCommand",{channelId:i,cmd:"c2s",data:e}).then(function(t){if(t&&t.errors&&t.errors.length>0){var e=!1;t.errors.forEach(function(t){44==t.error&&(e=!0)}),e&&(n._clientState.needsRefresh=!0)}})}};e().onFrame(r)},t._onReconnect=function(){this._slave&&console.log("*** reconnect to the master ***");var t=this;console.log("_onReconnect"),t._slaveController&&(console.log("_slaveController -> trying to send data "),t._slaveController._sendUnsentToMaster());var n=t._policy.constructClientToServer(t._clientState),e=this._socket,i=this._channelId;n&&e.send("channelCommand",{channelId:i,cmd:"c2s",data:n}).then(function(){}),t.askUpgrade()},t.addCommand=function(t,n){var e=this._transformCmdToNs(t,this._ns);return this._data.execCmd(e,n)},t.askUpgrade=function(t){this._socket&&(this._clientState.fullUpgradeFailCnt||this._socket.send("channelCommand",{channelId:this._channelId,cmd:"upgradeRequest",data:{version:this._clientState.version,last_update:this._clientState.last_update,askFull:t}}).then(function(){}))},t.at=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);return i?i.data[n]:void 0},t.createChannel=function(t,n,e){if(!this._isLocal){var i=JSON.parse(JSON.stringify(e)),o=E(this.guid(),i,[]);i=o.getData(),i=this._transformObjFromNs(i);var a={channelId:t,name:n,chData:i},s=this;return r(function(t){s._socket.send("channelCommand",{channelId:s._channelId,cmd:"createChannel",data:a}).then(function(n){t(n)})})}},t.diffSet=function(t,n,e){if(i){var r=this._idToNs(t,this._ns),o=this._data._find(r);if(o&&!this.isObject(e)){var a=o.data[n];if(a!=e){var s=i.diff_main(a,e),c=i.diff_main(e,a);i.diff_cleanupEfficiency(s),i.diff_cleanupEfficiency(c);var u=i.patch_toText(i.patch_make(a,s)),f=i.patch_toText(i.patch_make(e,c));this.addCommand([14,n,u,f,r])}}}},t.disconnect=function(){return this._disconnected=!0,this},t.fork=function(t,n){if(!this._isLocal){var e={version:this._channelStatus.version,channelId:t,name:n,journalLine:1};e.journalLine=this._clientState.last_update[1];var i=this;return r(function(t){i._socket.send("channelCommand",{channelId:i._channelId,cmd:"fork",data:e}).then(function(n){t(n)})})}},t.fromMaster=function(t){console.log("from master",JSON.stringify(t))},t.fromSlave=function(t){if(console.log("from slave",JSON.stringify(t)),"s2c"==t.cmd){var n=this;t.c.forEach(function(t){console.log(t);var e=n.addCommand(t);console.log(JSON.stringify(e)),console.log(JSON.stringify(n._data.getData()))})}},t.get=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);return i?i.data[n]:void 0},t.getChannelData=function(){return this._data},t.getData=function(){return this._data.getData()},t.indexOf=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e);return r}}return-1},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){if(!i)if("undefined"!=typeof diff_match_patch)i=new diff_match_patch;else if("undefined"!=typeof require){var r=require("diff-match-patch");i=new r}if(this._policy||(this._policy=I()),e&&e.localChannel){this._channelId=t,this._options=e,this._socketGUID=this.guid(),this._isLocal=!0,this._socket=a(this._socketGUID,1);var o=this._socket.getEnum();this._ns=o,this._id=t+this._socket.getId();var s=this,c=e.localData;c=s._transformObjToNs(e.localData,o);var u=E(s._id,c,[]);return s._data=u,void s.resolve({result:!0,channelId:t})}if(t&&n){this._channelId=t,this._socket=n,this._options=e,this._changeFrames=[],this._pendingFrames=[];var o=n.getEnum();this._ns=o,this._id=t+n.getId();var s=this;this._onFrameLoop(n,o),this._incoming(n,o),this._connCnt=0,n.on("disconnect",function(){s._connected=!1}),n.on("connect",function(){console.log("*** socket reconnect for "+t+" *** "),console.log("Connection count "+s._connCnt),s._connCnt++,e.auth&&n.send("auth",{userId:e.auth.username,password:e.auth.password}).then(function(i){return i.userId?(s._userId=i.userId,s._logged=!0,n.send("requestChannel",{channelId:t,initWithData:e.initWithData})):(s._logged=!1,!1)}).then(function(e){return e&&e.channelId==t?(s._connected=!0,s._connCnt>1?(s._onReconnect(),!1):n.send("channelCommand",{channelId:t,cmd:"readBuildTree",data:""})):!1}).then(function(n){if(n){var e=n.build;s._channelStatus=n.status;var i=e.pop();i=s._transformObjToNs(i,o);for(var r=E(s._id,i,[]),a=e.pop();a;)r._journalPointer=0,r._journal.length=0,a.forEach(function(t){r.execCmd(s._transformCmdToNs(t,o),!0)}),a=e.pop();s._clientState={data:r,client:s,needsRefresh:!1,version:s._channelStatus.version,last_update:[0,r.getJournalLine()],last_sent:[0,r.getJournalLine()]},s._data=r,s._createTransaction(),s.resolve({result:!0,channelId:t})}else s.resolve({result:!1,text:"Authorization or connection failed"})})})}}),t.isConnected=function(){return this._disconnected?!1:this._connCnt&&this._connected?!0:!1},t.isLocal=function(){return this._isLocal},t.length=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);return e&&e.data?e.data.length||0:0},t.moveDown=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e),o=r-1;o>=0&&r>=0&&r!=o&&i.data.length>o&&this.addCommand([12,n,o,r,i.__id])}}},t.moveTo=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);if(i){var r=this._fetch(i.__p);if(r&&r.data){var o=r.data.indexOf(i);o>=0&&o!=n&&r.data.length>n&&this.addCommand([12,e,n,o,r.__id])}}},t.moveUp=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e),o=r+1;o>=0&&r>=0&&r!=o&&i.data.length>o&&this.addCommand([12,n,o,r,i.__id])}}},t.reconnect=function(){return this._disconnected=!1,this},t.redo=function(t){this._data.redo(t)},t.redoStep=function(t){this._data.redoStep(t)},t.remove=function(t){var n=this._idToNs(t,this._ns),e=this._data._find(n);if(e){var i=this._fetch(e.__p);if(i&&i.data){var r=i.data.indexOf(e);r>=0&&this.addCommand([8,r,n,0,i.__id])}}},t.sendCommand=function(t,n){var e=this,i=this._channelId,r=this._socket;if(e._policy&&!e._disconnected&&e._connected&&r)return r.send("channelCommand",{channelId:i,cmd:t,data:n})},t.set=function(t,n,e){var i=this._idToNs(t,this._ns),r=this._data._find(i);if(r&&!this.isObject(e)){var o=r.data[n];o!=e&&(console.log("command 4 "+JSON.stringify([4,n,e,o,i])),this.addCommand([4,n,e,o,i]))}},t.setChannelModel=function(t){this._serverModel=t},t.setMasterConnection=function(t){this._master=t},t.setObject=function(t,n,e){var i=this._idToNs(t,this._ns),r=this._data._find(i);if(r&&this.isObject(e)&&e.__id){var o=r.data[n];o||this.addCommand([5,n,e.__id,null,i])}},t.setSlaveServer=function(t){this._slave=t},t.sync=function(t){var n=this._socket,e=this,i=this._channelId;return r(function(r){return e.isConnected()&&t&&t.out&&t.out.channelId?void n.send("channelCommand",{channelId:i,cmd:"sync",data:{sync:t}}).then(function(t){r(t)}):void r({success:!1})})},t.undo=function(t){this._data.undo(t)},t.undoStep=function(t){this._data.undoStep(t)},t.unset=function(t,n){var e=this._idToNs(t,this._ns),i=this._data._find(e);i&&i.data&&(this.isObject(i.data[n])?this.addCommand([10,n,i.data[n].__id,null,e]):i.data&&"undefined"!=typeof i.data[n]&&this.addCommand([10,n,i.data[n],"value",e]))},t.upgradeVersion=function(){this._socket.send("channelCommand",{channelId:this._channelId,cmd:"snapshot",data:{}}).then(function(){})}}(this)},O=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof O))return new O(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=O._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};b.prototype=r.prototype,O._classInfo={name:"channelClient"},O.prototype=new b,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.channelClient=O,this.channelClient=O):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.channelClient=O:this.channelClient=O}.call(new Function("return this")());var w=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t===!1&&e?void 0:(n||(n={}),n[t]?n[t]:void(n[t]=this))}),t.addCommands=function(t,n){if(this.isArray(t)){var e=this;return t.forEach(function(t){e.addCommands(t)}),this}this._commands.push({fnCmd:t,fnFail:n,async:!0})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._commands||(this._commands=[],this.waitingList=[],this._index=0);var i=this;if(!n){var r=function(){i.step()},o=new Function("try { return this === global; } catch(e) { return false; }")();o?e().onFrame(r):e().every(1/30,r)}}),t.step=function(){var t=this._index,n=this._commands.length;if(t!=n){for(var e=r(),i=e,o=r(),a=this;n>t;){var s=this._commands[t];!function(t){i=i.then(function(){var n=r();return t.fnCmd(function(){n.resolve(!0)},function(e){n.resolve(!0),t.fnFail&&t.fnFail(e)}),n}).fail(function(n){t.fnFail&&t.fnFail(n)})}(s),this._index++,t++}return i.then(function(){if(a.waitingList.shift(),o.resolve(!0),a.waitingList.length){var t=a.waitingList[0];t.resolve(!0)}}).fail(function(){}),this.waitingList.push(e),1==this.waitingList.length&&e.resolve(!0),o}}}(this)},j=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof j))return new j(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=j._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};j._classInfo={name:"sequenceStepper"},j.prototype=new w;var F=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t._getGroupNames=function(t,n){var e=r(),i=e,o=[],a=this._groups;return t.forEach(function(t){return n.indexOf(t)>=0?void o.push({id:t,name:t}):void(i=i.then(function(){return a.readFile(t)}).then(function(n){return o.push({id:t,name:n}),o}).fail(function(n){console.error("Error reading group index with "+n+" FOR "+t)}))}),i=i.then(function(){return o}),e.resolve(!0),i},t.addUserToGroup=function(t,n){var e=this,i=e._udata;return r(function(e){i.readFile(t).then(function(e){var r=JSON.parse(e);return r.groups.indexOf(n)<0&&r.groups.push(n),i.writeFile(t,JSON.stringify(r))}).then(function(){e({result:!0,text:"User added to the group"})})})},t.changePassword=function(t,n){var e=this._users,i=this,o=i._udata;return r(function(r){o.readFile(t).then(function(r){var o=JSON.parse(r);return e.writeFile(o.hash,i.hash(n)+":"+t+":"+o.domain)}).then(function(){r({result:!0,text:"Password changed"})}).fail(function(){r([])})})},t.changeUsername=function(t,n,e){var i=this._users,o=this,a=o._udata;return r(function(r){var s,c,u,f;a.readFile(t).then(function(t){return c=JSON.parse(t),f=e||c.domain,i.readFile(c.hash)}).then(function(t){return s=t,s?i.removeFile(c.hash):void 0}).then(function(){return s?(u=o.hash(n+":"+f),i.writeFile(u,s)):void 0}).then(function(){return s?(c.hash=u,c.userName=n,c.domain=f,a.writeFile(t,JSON.stringify(c))):void 0}).then(function(){r(s?{result:!0,text:"Username changed"}:{result:!1,text:"Could not change the username"})}).fail(function(){r({result:!1,text:"Could not change the username"})})})},t.createUser=function(t,n,e,i){i=i||"",e||(e=this.guid());var o=this.hash(t+":"+i),a=this,s={userName:t,domain:i,hash:o,groups:[]};return r(function(t){a.then(function(){var r=a._users,c=a._udata;r.isFile(o).then(function(u){u?r.readFile(o).then(function(n){var e=n.split(":");t({result:!0,userId:e[1]})}):r.writeFile(o,a.hash(n)+":"+e+":"+i).then(function(){return c.writeFile(e,JSON.stringify(s))}).then(function(){t({result:!0,userId:e})})})})})},t.getUserData=function(t){var n=this,e=n._udata;return r(function(n){e.readFile(t).then(function(t){var e=JSON.parse(t);n(e)}).fail(function(){n(null)})})},t.getUserGroups=function(t){var n=(this._users,this),e=(n._users,n._udata);return r(function(n){e.readFile(t).then(function(t){var e=JSON.parse(t);n(e.groups)}).fail(function(){n([])})})},t.hash=function(t){return x().sha3_256(t+this._salt)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._salt=n?n:"31337",this._fs=t;
var e=this;this._fs.createDir("users").then(function(){return e._fs.createDir("groups")}).then(function(){return e._fs.createDir("domains")}).then(function(){return e._fs.createDir("udata")}).then(function(){e._users=t.getFolder("users"),e._groups=t.getFolder("groups"),e._domains=t.getFolder("domains"),e._udata=t.getFolder("udata"),e.resolve(!0)})}),t.login=function(t,n,e){var i=this;e||(e="");var o=this.hash(t+":"+e);return r(function(t){i.then(function(){var e,r=i._users,a=i._udata,s=!1;r.readFile(o).then(function(t){var r=t.split(":"),o=r[0],c=r[1],u=o==i.hash(n);return u?(s=!0,e=c,a.readFile(c)):void 0}).then(function(n){s?(n=JSON.parse(n),t({result:!0,userId:e,groups:n.groups,text:"Login successful"})):t({result:!1,text:"Login failed"})}).fail(function(){t({result:!1,text:"Login failed"})})})})},t.removeUserGroup=function(t,n){var e=this,i=e._udata;return r(function(e){i.readFile(t).then(function(e){var r=JSON.parse(e),o=r.groups.indexOf(n);return r.groups.indexOf(n)>=0&&r.groups.splice(o,1),i.writeFile(t,JSON.stringify(r))}).then(function(){e({result:!0,text:"Removed user from group"})})})}}(this)},C=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof C))return new C(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=C._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};F.prototype=r.prototype,C._classInfo={name:"authFuzz"},C.prototype=new F,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.authFuzz=C,this.authFuzz=C):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.authFuzz=C:this.authFuzz=C}.call(new Function("return this")());var S=function(){!function(t){var n,e,i,r,o,a,s;t._initSha=function(){o||(n="0123456789abcdef".split(""),e=[1,256,65536,16777216],i=[6,1536,393216,100663296],r=[0,8,16,24],o=[1,0,32898,0,32906,2147483648,2147516416,2147483648,32907,0,2147483649,0,2147516545,2147483648,32777,2147483648,138,0,136,0,2147516425,0,2147483658,0,2147516555,0,139,2147483648,32905,2147483648,32771,2147483648,32770,2147483648,128,2147483648,32778,0,2147483658,2147483648,2147516545,2147483648,32896,2147483648,2147483649,0,2147516424,2147483648],a=[],s=[])},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){this._initSha()}),t.keccak=function(t,i,c){var u="string"!=typeof t;u&&t.constructor==root.ArrayBuffer&&(t=new Uint8Array(t)),void 0===i&&(i=512,c=e);var f,l,h,_,d,v,p,m,g,y,I,b,O,w,j,F,C,S,x,k,D,A,T,P,E,N,M,L,R,J,U,W,V,B,z,H,q,G,K,Q,X,Y,Z,$,tn,nn,en,rn,on,an,sn,cn,un,fn,ln,hn,_n,dn,vn,pn,mn,gn,yn,In,bn,On,wn=!1,jn=0,Fn=0,Cn=t.length,Sn=(1600-2*i)/32,xn=4*Sn;for(_=0;50>_;++_)s[_]=0;f=0;do{for(a[0]=f,_=1;Sn+1>_;++_)a[_]=0;if(u)for(_=Fn;Cn>jn&&xn>_;++jn)a[_>>2]|=t[jn]<<r[3&_++];else for(_=Fn;Cn>jn&&xn>_;++jn)l=t.charCodeAt(jn),128>l?a[_>>2]|=l<<r[3&_++]:2048>l?(a[_>>2]|=(192|l>>6)<<r[3&_++],a[_>>2]|=(128|63&l)<<r[3&_++]):55296>l||l>=57344?(a[_>>2]|=(224|l>>12)<<r[3&_++],a[_>>2]|=(128|l>>6&63)<<r[3&_++],a[_>>2]|=(128|63&l)<<r[3&_++]):(l=65536+((1023&l)<<10|1023&t.charCodeAt(++jn)),a[_>>2]|=(240|l>>18)<<r[3&_++],a[_>>2]|=(128|l>>12&63)<<r[3&_++],a[_>>2]|=(128|l>>6&63)<<r[3&_++],a[_>>2]|=(128|63&l)<<r[3&_++]);for(Fn=_-xn,jn==Cn&&(a[_>>2]|=c[3&_],++jn),f=a[Sn],jn>Cn&&xn>_&&(a[Sn-1]|=2147483648,wn=!0),_=0;Sn>_;++_)s[_]^=a[_];for(h=0;48>h;h+=2)p=s[0]^s[10]^s[20]^s[30]^s[40],m=s[1]^s[11]^s[21]^s[31]^s[41],g=s[2]^s[12]^s[22]^s[32]^s[42],y=s[3]^s[13]^s[23]^s[33]^s[43],I=s[4]^s[14]^s[24]^s[34]^s[44],b=s[5]^s[15]^s[25]^s[35]^s[45],O=s[6]^s[16]^s[26]^s[36]^s[46],w=s[7]^s[17]^s[27]^s[37]^s[47],j=s[8]^s[18]^s[28]^s[38]^s[48],F=s[9]^s[19]^s[29]^s[39]^s[49],d=j^(g<<1|y>>>31),v=F^(y<<1|g>>>31),s[0]^=d,s[1]^=v,s[10]^=d,s[11]^=v,s[20]^=d,s[21]^=v,s[30]^=d,s[31]^=v,s[40]^=d,s[41]^=v,d=p^(I<<1|b>>>31),v=m^(b<<1|I>>>31),s[2]^=d,s[3]^=v,s[12]^=d,s[13]^=v,s[22]^=d,s[23]^=v,s[32]^=d,s[33]^=v,s[42]^=d,s[43]^=v,d=g^(O<<1|w>>>31),v=y^(w<<1|O>>>31),s[4]^=d,s[5]^=v,s[14]^=d,s[15]^=v,s[24]^=d,s[25]^=v,s[34]^=d,s[35]^=v,s[44]^=d,s[45]^=v,d=I^(j<<1|F>>>31),v=b^(F<<1|j>>>31),s[6]^=d,s[7]^=v,s[16]^=d,s[17]^=v,s[26]^=d,s[27]^=v,s[36]^=d,s[37]^=v,s[46]^=d,s[47]^=v,d=O^(p<<1|m>>>31),v=w^(m<<1|p>>>31),s[8]^=d,s[9]^=v,s[18]^=d,s[19]^=v,s[28]^=d,s[29]^=v,s[38]^=d,s[39]^=v,s[48]^=d,s[49]^=v,C=s[0],S=s[1],on=s[11]<<4|s[10]>>>28,an=s[10]<<4|s[11]>>>28,U=s[20]<<3|s[21]>>>29,W=s[21]<<3|s[20]>>>29,yn=s[31]<<9|s[30]>>>23,In=s[30]<<9|s[31]>>>23,tn=s[40]<<18|s[41]>>>14,nn=s[41]<<18|s[40]>>>14,q=s[2]<<1|s[3]>>>31,G=s[3]<<1|s[2]>>>31,x=s[13]<<12|s[12]>>>20,k=s[12]<<12|s[13]>>>20,sn=s[22]<<10|s[23]>>>22,cn=s[23]<<10|s[22]>>>22,V=s[33]<<13|s[32]>>>19,B=s[32]<<13|s[33]>>>19,bn=s[42]<<2|s[43]>>>30,On=s[43]<<2|s[42]>>>30,_n=s[5]<<30|s[4]>>>2,dn=s[4]<<30|s[5]>>>2,K=s[14]<<6|s[15]>>>26,Q=s[15]<<6|s[14]>>>26,D=s[25]<<11|s[24]>>>21,A=s[24]<<11|s[25]>>>21,un=s[34]<<15|s[35]>>>17,fn=s[35]<<15|s[34]>>>17,z=s[45]<<29|s[44]>>>3,H=s[44]<<29|s[45]>>>3,M=s[6]<<28|s[7]>>>4,L=s[7]<<28|s[6]>>>4,vn=s[17]<<23|s[16]>>>9,pn=s[16]<<23|s[17]>>>9,X=s[26]<<25|s[27]>>>7,Y=s[27]<<25|s[26]>>>7,T=s[36]<<21|s[37]>>>11,P=s[37]<<21|s[36]>>>11,ln=s[47]<<24|s[46]>>>8,hn=s[46]<<24|s[47]>>>8,en=s[8]<<27|s[9]>>>5,rn=s[9]<<27|s[8]>>>5,R=s[18]<<20|s[19]>>>12,J=s[19]<<20|s[18]>>>12,mn=s[29]<<7|s[28]>>>25,gn=s[28]<<7|s[29]>>>25,Z=s[38]<<8|s[39]>>>24,$=s[39]<<8|s[38]>>>24,E=s[48]<<14|s[49]>>>18,N=s[49]<<14|s[48]>>>18,s[0]=C^~x&D,s[1]=S^~k&A,s[10]=M^~R&U,s[11]=L^~J&W,s[20]=q^~K&X,s[21]=G^~Q&Y,s[30]=en^~on&sn,s[31]=rn^~an&cn,s[40]=_n^~vn&mn,s[41]=dn^~pn&gn,s[2]=x^~D&T,s[3]=k^~A&P,s[12]=R^~U&V,s[13]=J^~W&B,s[22]=K^~X&Z,s[23]=Q^~Y&$,s[32]=on^~sn&un,s[33]=an^~cn&fn,s[42]=vn^~mn&yn,s[43]=pn^~gn&In,s[4]=D^~T&E,s[5]=A^~P&N,s[14]=U^~V&z,s[15]=W^~B&H,s[24]=X^~Z&tn,s[25]=Y^~$&nn,s[34]=sn^~un&ln,s[35]=cn^~fn&hn,s[44]=mn^~yn&bn,s[45]=gn^~In&On,s[6]=T^~E&C,s[7]=P^~N&S,s[16]=V^~z&M,s[17]=B^~H&L,s[26]=Z^~tn&q,s[27]=$^~nn&G,s[36]=un^~ln&en,s[37]=fn^~hn&rn,s[46]=yn^~bn&_n,s[47]=In^~On&dn,s[8]=E^~C&x,s[9]=N^~S&k,s[18]=z^~M&R,s[19]=H^~L&J,s[28]=tn^~q&K,s[29]=nn^~G&Q,s[38]=ln^~en&on,s[39]=hn^~rn&an,s[48]=bn^~_n&vn,s[49]=On^~dn&pn,s[0]^=o[h],s[1]^=o[h+1]}while(!wn);var kn="";for(_=0,h=i/32;h>_;++_)d=s[_],kn+=n[d>>4&15]+n[15&d]+n[d>>12&15]+n[d>>8&15]+n[d>>20&15]+n[d>>16&15]+n[d>>28&15]+n[d>>24&15];return kn},t.keccak_224=function(t){return this.keccak(t,224,e)},t.keccak_256=function(t){return this.keccak(t,256,e)},t.keccak_512=function(t){return this.keccak(t,512,e)},t.sha3_224=function(t){return this.keccak(t,224,i)},t.sha3_256=function(t){return this.keccak(t,256,i)},t.sha3_512=function(t){return this.keccak(t,512,i)}}(this)},x=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof x))return new x(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=x._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};x._classInfo={name:"_sha3"},x.prototype=new S,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._sha3=x,this._sha3=x):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._sha3=x:this._sha3=x}.call(new Function("return this")());var k=function(){!function(t){var n;t.fromAce=function(t){if(t&&t[0]&&(t[0].range||t[0].data||(n=!0)),n)return this.fromAce2(t);var e=[];return t.forEach(function(t){var n;n=t.data?t.data:t;var i=n.range;"insertText"==n.action&&e.push([1,i.start.row,i.start.column,i.end.row,i.end.column,n.text]),"removeText"==n.action&&e.push([2,i.start.row,i.start.column,i.end.row,i.end.column,n.text]),"insertLines"==n.action&&e.push([3,i.start.row,i.start.column,i.end.row,i.end.column,n.lines]),"removeLines"==n.action&&e.push([4,i.start.row,i.start.column,i.end.row,i.end.column,n.lines,n.nl])}),e},t.fromAce2=function(t){var n=[];return t.forEach(function(t){var e=t;"insert"==t.action&&1==t.lines.length&&n.push([1,e.start.row,e.start.column,e.end.row,e.end.column,t.lines[0]]),"remove"==t.action&&1==t.lines.length&&n.push([2,e.start.row,e.start.column,e.end.row,e.end.column,t.lines[0]]),"insert"==t.action&&t.lines.length>1&&n.push([3,e.start.row,e.start.column,e.end.row,e.end.column,t.lines]),"remove"==t.action&&t.lines.length>1&&n.push([4,e.start.row,e.start.column,e.end.row,e.end.column,t.lines,t.nl])}),n},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.reverse=function(t){var n=[];return t.forEach(function(t){{var e=t.slice();e[1],e[2],e[3],e[4]}return 1==e[0]?(e[0]=2,void n.unshift(e)):2==e[0]?(e[0]=1,void n.unshift(e)):3==e[0]?(e[0]=4,void n.unshift(e)):4==e[0]?(e[0]=3,void n.unshift(e)):void 0}),n},t.runToAce=function(t){if(n)return this.runToAce2(t);var e=[],i=["","insertText","removeText","insertLines","removeLines"];return t.forEach(function(t){var n={action:i[t[0]],range:{start:{row:t[1],column:t[2]},end:{row:t[3],column:t[4]}}};t[0]<3?n.text=t[5]:n.lines=t[5],4==t[0]&&(n.nl=t[6]||"\n"),e.push(n)}),e},t.runToAce2=function(t){var n=[],e=["","insert","remove","insert","remove"];return t.forEach(function(t){var i={action:e[t[0]],start:{row:t[1],column:t[2]},end:{row:t[3],column:t[4]}};i.lines=t[0]<3?[t[5]]:t[5],4==t[0]&&(i.nl=t[6]||"\n"),n.push(i)}),n},t.runToLineObj=function(t,n){n.forEach(function(n){var e=n[1],i=n[2],r=n[3],o=n[4];if(1==n[0])if("\n"==n[5]){var a=t.item(e);if(a){var s=a.text();a.text(s.slice(0,i));var c={text:s.slice(i)||""};t.insertAt(e+1,c)}else t.insertAt(e,{text:""}),t.insertAt(e+1,{text:""})}else{var a=t.item(e);if(a){var s=a.text();a.text(s.slice(0,i)+n[5]+s.slice(i))}else t.insertAt(e,{text:n[5]})}if(2==n[0])if("\n"==n[5]){var u=t.item(e),f=t.item(e+1),l="",h="";u&&(l=u.text()),f&&(h=f.text()),u?u.text(l+h):t.insertAt(e,{text:""}),f&&f.remove()}else{var a=t.item(e),s=a.text();a.text(s.slice(0,i)+s.slice(o))}if(3==n[0])for(var _=r-e,d=0;_>d;d++)t.insertAt(e+d,{text:n[5][d]});if(4==n[0])for(var _=r-e,d=0;_>d;d++){var a=t.item(e);a.remove()}})},t.runToString=function(t,n){if(!n||"undefined"==typeof t)return"";t+="";var e=t.split("\n");return n.forEach(function(t){var n=t[1],i=t[2],r=t[3],o=t[4];if(1==t[0])if("\n"==t[5]){var a=e[n]||"";e[n]=a.slice(0,i);var s=a.slice(i)||"";e.splice(n+1,0,s)}else{var a=e[n]||"";e[n]=a.slice(0,i)+t[5]+a.slice(i)}if(2==t[0])if("\n"==t[5]){var c=e[n]||"",u=e[n+1]||"";e[n]=c+u,e.splice(n+1,1)}else{var a=e[n]||"";e[n]=a.slice(0,i)+a.slice(o)}if(3==t[0])for(var f=r-n,l=0;f>l;l++)e.splice(n+l,0,t[5][l]);if(4==t[0])for(var f=r-n,l=0;f>l;l++)e.splice(n,1)}),e.join("\n")},t.setAceVersion=function(t){n=t},t.simplify=function(t){var n,e=[],i=null;return t.forEach(function(t){n&&1==t[0]&&1==n[0]&&t[3]==t[1]&&n[1]==t[1]&&n[3]==t[3]&&n[4]==t[2]?i?(i[3]=t[3],i[4]=t[4],i[5]=i[5]+t[5]):(i=[],i[0]=1,i[1]=n[1],i[2]=n[2],i[3]=t[3],i[4]=t[4],i[5]=n[5]+t[5]):(i&&(e.push(i),i=null),1==t[0]?i=t.slice():e.push(t)),n=t}),i&&e.push(i),e}}(this)},D=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof D))return new D(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=D._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};D._classInfo={name:"aceCmdConvert"},D.prototype=new k,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.aceCmdConvert=D,this.aceCmdConvert=D):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.aceCmdConvert=D:this.aceCmdConvert=D}.call(new Function("return this")());var A=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){var n,e,i,r,o,a,s;t._createModelCommands=function(t,n,e){e||(e=[]);var i;if(i=t.data&&t.__id?t.data:t,this.isObject(i)||this.isArray(i)){var r;if(r=t.__id?t:{data:i,__id:this.guid()},this.isArray(i))var o=[2,r.__fork||r.__id,[],null,r.__fork||r.__id];else var o=[1,r.__fork||r.__id,{},null,r.__fork||r.__id];n&&(r.__p=n.__id),e.push(o);for(var a in i)if(i.hasOwnProperty(a)){var s=i[a];if(this.isObject(s)||this.isArray(s)){var c=this._createModelCommands(s,r,e),o=[5,a,c.__fork||c.__id,null,r.__fork||r.__id];e.push(o)}else{var o=[4,a,s,null,r.__fork||r.__id];e.push(o)}}return r}},t.addedObjects=function(){var t=[];for(var n in i)i.hasOwnProperty(n)&&(e[n]||(t.push(n),a[n]=i[n]));return t},t.commonObjects=function(){var t=[];for(var r in n)e[r]&&i[r]&&t.push(r);return t},t.compareFiles=function(t,c){e={},i={},n={},r={},o={},a={},s={},this.findObjects(t,e),this.findObjects(c,i);var u={missing:this.missingObjects(),added:this.addedObjects(),common:this.commonObjects(),cMod:[],cmds:[]},f=this;u.common.forEach(function(t){var n=f.objectDiff(e[t],i[t]);u.cMod.push(n)});var f=this;return u.added.forEach(function(t){var e=[],i=n[t];f._createModelCommands(i,null,e),e.forEach(function(t){u.cmds.push(t)})}),u.cMod.forEach(function(t){t.cmds.forEach(function(t){u.cmds.push(t)})}),u},t.findObjects=function(t,e){if(t&&t.__id&&(e[t.__fork||t.__id]=t,n[t.__fork||t.__id]=t,r[t.__id]=t),t.data){var i=t.data;for(var o in i)if(i.hasOwnProperty(o)){var a=i[o];this.isObject(a)&&(s[a.__fork||a.__id]=t.__fork||t.__id,this.findObjects(a,e))}}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.missingObjects=function(){var t=[];for(var n in e)e.hasOwnProperty(n)&&(i[n]||(o[n]=e[n],t.push(n)));return t},t.objectDiff=function(t,e){var i={modified:[],posMoved:[],sourcesAndTargets:[],cmds:[]};if(t.data&&e.data&&this.isObject(t.data)&&!this.isArray(t.data)){var r=t.data,c={};for(var u in e.data)if(e.data.hasOwnProperty(u)){var f=r[u],l=t.__fork||t.__id;if(!this.isObject(f)&&!this.isArray(f)){c[u]=!0;var h=e.data[u];e.data[u]!=f&&(this.isObject(f)||this.isObject(h)?i.cmds.push(h&&h.__id?[5,u,e.data[u].__id,null,l]:[10,u,f.__id,null,l]):(i.modified.push({id:l,prop:u,from:f,to:e.data[u]}),i.cmds.push([4,u,e.data[u],f,l])))}}for(var u in t.data)if(t.data.hasOwnProperty(u)){if(c[u])continue;var f=t.data[u],l=t.__id;if(this.isObject(f)&&!this.isArray(f)){var h=e.data[u];!h&&f&&f.__id&&i.cmds.push([10,u,f.__id,null,l])}}}if(this.isArray(t.data)){for(var _=t.data,d=e.data,v=[],p=[],m=_.length,g=d.length,y=0;m>y;y++){var I=_[y];if(this.isObject(I)){var b=I.__fork||I.__id;o[b]?i.cmds.push([8,0,b,0,s[b]]):v.push(b)}}for(var O={},w={},j={},y=0;g>y;y++){var I=d[y];if(this.isObject(I)){var b=I.__fork||I.__id;O[b]=y,w[y]=b,a[b]&&(v.push(b),i.cmds.push([7,y,b,0,s[b]])),p.push(b)}}var F=[],y=0;v.forEach(function(t){F.push(O[t]),j[t]=y,y++}),i.restackIndex=O,i.restackList=F,i.reverseIndex=w,i.restack=this.restackOps(F);var C=[],S=v.slice();i.restack.forEach(function(t){if("a"==t[0]){var e=w[t[1]],r=w[t[2]],o=(O[r],S.indexOf(e));S.splice(o,1);var a=S.indexOf(r);S.splice(a,0,e);{n[e]}i.cmds.push([12,e,a,o,s[e]])}else{var e=w[t[1]],r=w[t[2]],o=(O[r],S.indexOf(e));S.splice(o,1);var a=S.indexOf(r)+1;S.splice(a,0,e),i.cmds.push([12,e,a,o,s[e]])}}),i.stackCmds=C,i.sourceArrayWork=S,i.sourcesAndTargets.push([v,p])}return i},t.restackOps=function(t){function n(t){for(var n=t.slice(0),i=t.slice(0),r=t.slice(0).sort(function(t,n){return t-n}),o={},a={},s=0;s<i.length;s++){var c=r.indexOf(i[s]);o[i[s]]=c,a[c]=i[s],n[s]=c}var u=n.slice(0).sort(function(t,n){return t-n}),f=n[0],l=n[0],h=[],_=0,d=function(){for(var t=0,e=n.length,i=0;e>t;t++){var r=n[t];r>l&&(l=r),f>r&&(f=r),t>0&&h.push(u[t]-u[t-1]),t>0&&(_+=Math.abs(u[t]-u[t-1])),i+=Math.abs(r-u[t])}return _/=e,i/e}();h.sort(function(t,n){return t-n});for(var v=(h[0],function(t){for(var e=function(e,i,r){var o=[],a=n.length;for(i||(i=0);a>e;e++){var s=n[e];if(s-r!=1){var c=e+i;0>c&&(c=0),c>=a&&(c=a-1),t(s,u[c],s,r,e,a)&&(n[e+1]&&n[e+1]<s&&n[e+1]>r||(o.push(s),r=s))}else o.push(s),r=s}return o},i=[],r=0;.1>r;){for(var o=-5;5>=o;o++)i.push(e(Math.floor(n.length*r),o,f-1));r+=.05}return i.sort(function(t,n){return n.length-t.length}),i[0]}),p=[v(function(t,n,e,i,r,o){return i>e?!1:r>0&&Math.abs(e-i)>h[r-1]?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),v(function(t,n,e,i,r,o){return i>e?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),v(function(t,n,e,i,r,o){return i>e?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),v(function(t,n,e,i,r,o){return i>e?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),v(function(t,n,e,i,r,o){return i>e?!1:Math.abs(t-n)<=d&&e>=i?!0:Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),v(function(t,n,e,i){return i>e?!1:Math.abs(e-i)<_?!0:Math.abs(t-n)<=_&&e>=i?!0:!1}),v(function(t,n,e,i){return e>i?!0:!1}),v(function(t,n,e,i){return i>e?!1:Math.abs(e-i)>d?!1:Math.abs(t-n)<=d&&e>=i?!0:!1}),v(function(t,n,e,i,r,o){return i>e?!1:r>0&&Math.abs(e-i)>d?!1:Math.abs(t-n)<=d*(r/o)&&e>=i?!0:r>0&&Math.abs(i-e)<=d*(r/o)&&e>=i?!0:!1}),v(function(t,n,e,i){if(i>e)return!1;if(i>=f){if(e>=i)return!0}else if(e==f)return!0;return!1})],m=[],g=0,s=0;s<p.length;s++){var y=p[s];y.length>g&&(m=y,g=y.length)}0==m.length&&(m=[u[Math.floor(u.length/2)]]);{var I=[],b=[];!function(){for(var t=f,e=m[0],i=m.length,r=n.indexOf(e),o=0,a=0,s=n.length;s>a;a++){var c=n[a];c>=t&&e>=c&&r>=a?(I.push(c),t=c):b.push(c),c==e&&(t=c,i-1>o?(o++,e=m[o],r=n.indexOf(e)):(e=l,r=s+1))}}()}b.sort(function(t,n){return t-n});!function(){for(var t=0,n=0,i=I[0],r=b.length;r>t;){var o=I[n],s=b[t];if("undefined"==typeof o){for(;r>t;)e.push(["b",a[s],a[i]]),i=s,t++,s=b[t];return}s>o?(i=o,n++):(e.push(["a",a[s],a[o]]),t++)}}();return n}var e=[];return n(t),e}}(this)},T=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof T))return new T(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=T._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};T._classInfo={name:"diffEngine"},T.prototype=new A;var P=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return t instanceof Array},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,i,o,a,s,c,u,f,l;t._cmd_aceCmd=function(t,n){var e=this._find(t[4]),i=t[1];if(!e||!i)return!1;if("string"!=typeof e.data[i])return!1;var r=D();e.data[i]=r.runToString(e.data[i],t[2]),o=n;var a=[4,i,e.data[i],null,t[4],t[5],t[6]];return this._cmd(a,e,null),n?this._cmd(t,e,null):(this._cmd(t,e,null),this.writeCommand(t)),o=!1,!0},t._cmd_createArray=function(t,n){var e=t[1];if(!e)return{error:21,cmd:t,text:"Object ID was null or undefined"};var i=this._getObjectHash();if(i[e])return{error:22,cmd:t,text:"Array with ID was already created"};var r,o=this._getRemovedHash();return o[e]?(r=o[e],r.__p=null):r={data:[],__id:e},i[r.__id]=r,this._data.__orphan.push(r),!0},t._cmd_createObject=function(t,n){var e=t[1];if(!e)return{error:11,cmd:t,text:"Object ID was null or undefined"};var i=this._getObjectHash();if(i[e])return{error:12,cmd:t,text:"Object ID was already created"};var r,o=this._getRemovedHash();return o[e]?(r=o[e],r.__p=null):r={data:{},__id:e},i[r.__id]=r,this._data.__orphan.push(r),!0},t._cmd_diffPatch=function(t,n){if(!f)return{error:141,cmd:t,text:"diff-match-patch not initialized"};var e=this._find(t[4]),i=t[1];if(!e)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var r=e.data[i];if(this.isObject(r)||this.isArray(r))return{error:145,cmd:t,text:"Trying to apply text diff/patch to  Object or Array"};var a=f.patch_fromText(t[2]),s=f.patch_apply(a,r);if(!this.isArray(s))return{error:146,cmd:t,text:"patch_apply failed"};var c=s[1];if(!c)return{error:146,cmd:t,text:"patch_apply failed"};for(var u=0;u<c.length;u++)if(!c[u])return{error:146,cmd:t,text:"patch_apply failed"};e.data[i]=s[0],o=n;var l=[4,i,e.data[i],r,t[4],t[5],t[6]];return this._cmd(l,e,null),n?this._cmd(t,e,null):this.writeCommand(t),o=!1,!0},t._cmd_moveToIndex=function(t){{var n,e=this._find(t[4]);e.data.length}if(!e)return{error:2,cmd:1,text:"Object with ID ("+t[4]+") did not exist"};var r,o=null,n=this._find(t[1]);if(r=o=e.data.indexOf(n),o!=t[3])return{error:121,cmd:t,text:"The old index was not what expected: "+o+" cmd have "+t[3]};if(!n)return{error:122,cmd:t,text:"Object to be moved ("+t[1]+") was not in the array"};var a=parseInt(t[2]);return isNaN(a)?{error:123,cmd:t,text:"Target index ("+a+") was not a number"}:e.data.length<=r||0>r?{error:124,cmd:t,text:"Invalid original index ("+r+") given"}:(i.fromIndex=r,e.data.splice(r,1),e.data.splice(a,0,n),this._cmd(t,null,t[1]),!0)},t._cmd_pushToArray=function(t,n){{var e=this._find(t[4]),i=this._find(t[2]),r=parseInt(t[1]);t[3],e.data.length}if(!e)return{error:71,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:72,cmd:t,text:"Did not find object with ID ("+t[2]+") "};if(i.__p)return i.__p==e.__id?(console.log("WARNING : Unnecessary pushToArray"),console.log(t),!0):{error:73,cmd:t,text:"The object already had a parent - need to remove first ("+t[2]+") "};if(isNaN(r))return{error:74,cmd:t,text:"toIndex was not a number"};if(!this.isArray(e.data))return{error:75,cmd:t,text:"Target Object was not an array"};if(r>e.data.length||0>r)return{error:76,cmd:t,text:"toIndex out of range, parent data len "+e.data.length};e.data.splice(r,0,i),i.__p=e.__id;var o=this._data.__orphan.indexOf(i);return o>=0&&this._data.__orphan.splice(o,1),this._cmd(t,null,t[2]),!0},t._cmd_removeObject=function(t,n){var e=this._find(t[4]),i=this._find(t[2]),r=parseInt(t[1]);if(!e)return{error:81,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:82,cmd:t,text:"Did not find object with ID ("+t[2]+") "};if(!i.__p)return{error:83,cmd:t,text:"The removed item did not have a parent ("+t[2]+") "};var o=e.data.indexOf(i);if(isNaN(r))return{error:84,cmd:t,text:"oldPosition was not a number"};r!=o&&(t[1]=o);var a=this._getRemovedHash();a[t[2]]=i,e.data.splice(o,1),this._cmd(t,null,t[2]),i.__p=null;var s=this._data.__orphan.indexOf(i);return 0>s&&this._data.__orphan.push(i),!0},t._cmd_setMeta=function(t,n){var e=this._find(t[4]),i=t[1];return i?"data"==i?!1:"__id"==i?!1:e?e[i]==t[2]?!1:(e[i]=t[2],this._cmd(t,e,null),n||this.writeCommand(t),!0):!1:!1},t._cmd_setProperty=function(t,n){var e=this._find(t[4]),i=t[1];if(!e)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var r=e.data[i];if(r==t[2])return{error:43,cmd:t,text:"Trying to set the same value to the object twice"};if("undefined"==typeof r||null===r){if("undefined"!=typeof t[3]&&null!==t[3])return{error:44,cmd:t,text:"The old value "+r+" was not the same as the commands old value"}}else{if(this.isObject(r)||this.isArray(r))return{error:45,cmd:t,text:"Trying to set Object or Array value to a scalar property"};if(r!=t[3])return{error:44,cmd:t,text:"The old value "+r+" was not the same as the commands old value"}}return e.data[i]=t[2],this._cmd(t,e,null),!0},t._cmd_setPropertyObject=function(t,n){var e=this._find(t[4]),i=t[1],r=this._find(t[2]);if(!e)return{error:51,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:52,cmd:t,text:"The property was not defined ("+t[1]+") "};if(!r)return{error:53,cmd:t,text:"Could not find the Object to be set with ID ("+t[2]+") "};if("undefined"!=typeof e.data[i])return{error:54,cmd:t,text:"The property ("+t[1]+") was already set, try unsetting first "};if(!this.isObject(e.data)||this.isArray(e.data))return{error:55,cmd:t,text:"The object ("+t[2]+") was not of type Object "};e.data[i]=r,r.__p=e.__id,this._cmd(t,null,t[2]);var o=this._data.__orphan.indexOf(r);return o>=0&&this._data.__orphan.splice(o,1),n||this._moveCmdListToParent(r),!0},t._cmd_unsetProperty=function(t){var n=this._find(t[4]),e=t[1];return n?e?this.isArray(n.data[e])?{error:103,cmd:t,text:"The Object data was Array ("+t[4]+") "}:(delete n.data[e],!0):{error:102,cmd:t,text:"The property was not defined ("+t[1]+") "}:{error:101,cmd:t,text:"Did not find object with ID ("+t[4]+") "}},t._fireListener=function(t,e){if(n){var i=t.__id+"::"+e,r=n[i];r&&r.forEach(function(n){n(t,t.data[e])})}},t._moveCmdListToParent=function(){},t._reverse_aceCmd=function(t){var n=this._find(t[4]),e=t[1],i=D(),r=i.reverse(t[2]),o=[4,e,n.data[e],null,t[4]],a=[13,e,r,null,t[4]],s=i.runToString(n.data[e],r);n.data[e]=s,this._cmd(o),this._cmd(a)},t._reverse_createArray=function(t){var n=t[1],e=this._getObjectHash(),i=e[n],r=this._getRemovedHash();r[n]=i,delete e[n];var o=this._data.__orphan.indexOf(i);o>=0&&this._data.__orphan.splice(o,1)},t._reverse_createObject=function(t){var n=t[1],e=this._getObjectHash(),i=e[n],r=this._getRemovedHash();r[n]=i,delete e[n];var o=this._data.__orphan.indexOf(i);o>=0&&this._data.__orphan.splice(o,1)},t._reverse_diffPatch=function(t,n){if(!f)return{error:141,cmd:t,text:"diff-match-patch not initialized"};var e=this._find(t[4]),i=t[1];if(!e)return{error:41,cmd:t,text:"Did not find object with ID ("+t[4]+") "};if(!i)return{error:42,cmd:t,text:"The property was not defined ("+t[1]+") "};var r=e.data[i];if(this.isObject(r)||this.isArray(r))return{error:145,cmd:t,text:"Trying to apply text diff/patch to  Object or Array"};var a=f.patch_fromText(t[3]),s=f.patch_apply(a,r);if(!this.isArray(s))return{error:146,cmd:t,text:"patch_apply failed"};var c=s[1];if(!c)return{error:146,cmd:t,text:"patch_apply failed"};for(var u=0;u<c.length;u++)if(!c[u])return{error:146,cmd:t,text:"patch_apply failed"};e.data[i]=s[0],o=n;var l=[4,i,e.data[i],r,t[4],t[5],t[6]];return this._cmd(l,e,null),n?this._cmd(t,e,null):this.writeCommand(t),o=!1,!0},t._reverse_moveToIndex=function(t){var n,e=this._find(t[4]),i=e.data.length,r=0,o=null;for(r=0;i>r;r++){var a=e.data[r];if(a.__id==t[1]){n=a,o=r;break}}if(o!=t[2])throw"_reverse_moveToIndex with invalid index value";if(n){var s=parseInt(t[3]);e.data.splice(r,1),e.data.splice(s,0,n);var c=t.slice();c[2]=s,c[3]=t[2],this._cmd(c,null,c[1])}},t._reverse_pushToArray=function(t){{var n=this._find(t[4]),e=this._find(t[2]);n.data.length}if(n&&e){var i=n.data.length-1,r=n.data[i];if(r.__id==t[2]){var o=[8,i,r.__id,null,n.__id];n.data.splice(i,1),this._cmd(o,null,o[2])}}},t._reverse_removeObject=function(t){{var n=this._find(t[4]),e=this._find(t[2]),i=t[1];n.data.indexOf(e)}if(n&&e){n.data.splice(i,0,e);var r=[7,i,t[2],null,t[4]];this._cmd(r,null,t[2]);var o=this._data.__orphan.indexOf(e);o>=0&&this._data.__orphan.splice(o,1),e.__p=t[4]}},t._reverse_setMeta=function(t){var n=this._find(t[4]),e=t[1];if(n){var i=[3,e,t[3],t[2],t[4]];n[e]=t[3],this._cmd(i)}},t._reverse_setProperty=function(t){var n=this._find(t[4]),e=t[1];if(n){var i=[4,e,t[3],t[2],t[4]];n.data[e]=t[3],this._cmd(i)}},t._reverse_setPropertyObject=function(t){var n=this._find(t[4]),e=t[1],i=this._find(t[2]);if(n&&i){delete n.data[e],i.__p=null;var r=[10,e,null,null,t[4]];this._cmd(r)}},t._reverse_unsetProperty=function(t){var n=this._find(t[4]),e=this._find(t[2]),i=t[1];if("value"!=t[3]){if(n&&i&&e){n.data[i]=e,e.__p=n.__id;var r=[5,i,e.__id,0,t[4]];this._cmd(r,null,e.__id)}}else if(n&&i){var r=[4,i,t[2],null,t[4]];this._cmd(r,null,n.__id)}},t._updateHotBuffer=function(t){var n=(new Date).getTime();for(var e in u)if(u.hasOwnProperty(e)){var i=u[e];if(t||n-i.ms>c.hotMs){if(i.lastCmd){var r=i.firstCmd,o=i.lastCmd;i.chObj.writeLocalJournal([4,r[1],o[2],r[3],r[4]])}else i.chObj.writeLocalJournal(i.firstCmd);delete u[e]}}},t.execCmd=function(t,n,e){try{if(!this.isArray(t))return!1;var i=a[t[0]];if(this._playBackOnFn&&!e)return!1;if(i){var r=i.apply(this,[t,n]);if(r!==!0&&(console.log("ERROR "+JSON.stringify(t)),console.log(JSON.stringify(r))),r===!0&&!e)if(n)this.writeLocalJournal(t);else if(4==t[0]&&c.hotMs){var o=t[4],s=o+":"+t[1],f=u[s];f?f.lastCmd=t:u[s]={ms:(new Date).getTime(),firstCmd:t,chObj:this}}else this._updateHotBuffer(!0),this.writeLocalJournal(t);return r}return{error:199,text:"Invalid command"}}catch(l){var h="";return l&&l.message&&(h=l.message),console.error(l,l.message),{error:199,cmd:t,text:"Exception raised "+h}}},t.getJournalCmd=function(t){return this._journal[t]},t.getJournalLine=function(){return this._journalPointer},t.getJournalRange=function(){return[0,this._journal.length]},t.getLocalJournal=function(){return this._journal},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(n||(n={},i={},c={},u={}),!a){if(!f)if("undefined"!=typeof diff_match_patch)f=new diff_match_patch;else if("undefined"!=typeof require){var t=require("diff-match-patch");f=new t}s=new Array(30),a=new Array(30),a[1]=this._cmd_createObject,a[2]=this._cmd_createArray,a[3]=this._cmd_setMeta,a[4]=this._cmd_setProperty,a[5]=this._cmd_setPropertyObject,a[7]=this._cmd_pushToArray,a[8]=this._cmd_removeObject,a[10]=this._cmd_unsetProperty,a[12]=this._cmd_moveToIndex,a[13]=this._cmd_aceCmd,a[14]=this._cmd_diffPatch,s[1]=this._reverse_createObject,s[2]=this._reverse_createArray,s[3]=this._reverse_setMeta,s[4]=this._reverse_setProperty,s[5]=this._reverse_setPropertyObject,s[7]=this._reverse_pushToArray,s[8]=this._reverse_removeObject,s[10]=this._reverse_unsetProperty,s[12]=this._reverse_moveToIndex,s[13]=this._reverse_aceCmd,s[14]=this._reverse_diffPatch;var r=this;e().every(.5,function(){r._updateHotBuffer()})}}),t.moveToLine=function(t){return this.reverseToLine(parseInt(t))},t.playback=function(t){t=t||{};var n=r(),i=this._journal[0][5];if(!i)return void console.error("journal does not have timestamps");var o,a=t.ms||2e3;o=t.journal?t.journal:this._journal.slice();var s=o.length;this.reverseToLine(0);var c=(new Date).getTime(),u=0,f=this,l=i,h=0,_=function(){for(var t,i=(new Date).getTime(),r=i-c,d=s,v=u;d>v;){var p=o[v][5],m=p-l;if(t&&p-t>a){var g=p-r-parseInt(a/2);l=g,m=p-l}if(!(r>m))break;try{f.redo(1,o)}catch(y){console.error(y)}h++,v++,t=p}u=v,u==d&&(e().removeFrameFn(_),f._journal=o,f._playBackOnFn=null,n.resolve(!0))};return this._playBackOnFn=_,e().onFrame(_),n},t.redo=function(t,n){var e=this.getJournalLine();for(t=t||1;t-->0;){var i;if(i=n?n[e]:this._journal[e],!i)return;var r=this.execCmd(i,!1,!0);r!==!0&&console.error(r),e++,this._journalPointer++}},t.redoStep=function(t){t=t||{};var n=t.ms||400,e=this.getJournalLine();if(this._journal[e]){for(var i=this._journal[e][5],r=0;this._journal[e];){var o=this._journal[e][5],a=Math.abs(o-i);if(a>n)break;e++,r++}r>0&&this.redo(r)}},t.reverseCmd=function(t){if(t){var n=s[t[0]];if(n){var e=n.apply(this,[t]);return e}}},t.reverseNLines=function(t){for(var n=this.getJournalLine();n-1>=0&&t-->0;){var e=this._journal[n-1];this.reverseCmd(e),n--,this._journalPointer--}},t.reverseToLine=function(t){var n=this.getJournalLine(),e=this._journal.length;if(!(0>t||t>e)&&t!=n){var i=-1;t>n&&(i=1);for(var r=n,o=this._journal.slice();r>=0&&e>=r;){if(t==r)return;if(0>i&&r>0)var a=o[r-1];
else var a=o[r];if(!a)break;if(r+=i,0>r||r>e)break;if(i>0){this.execCmd(a,!1,!0)}else this.reverseCmd(a);this._journalPointer=r}}},t.setClearCreated=function(t){l=t},t.setHotMs=function(t){c.hotMs=t},t.undo=function(t){0!==t&&("undefined"==typeof t&&(t=1),this.reverseNLines(t))},t.undoStep=function(t){t=t||{};var n=t.ms||400,e=this.getJournalLine();if(0!=e){for(var i=this._journal[e-1][5],r=0;e-1>=0;){var o=this._journal[e-1][5],a=Math.abs(o-i);if(a>n)break;e--,r++}r>0&&this.undo(r)}},t.writeCommand=function(){},t.writeLocalJournal=function(t){this._journal&&(this._journal.length>this._journalPointer&&(this._journal.length=this._journalPointer),t[5]||(t[5]=(new Date).getTime()),this._journal.push(t),this._journalPointer++)}}(this),function(t){var n;t.callHook=function(t,e){if(n&&n[t])for(var i=n[t],r=0;r<i.length;r++)i[r](e)},t.hasHook=function(t){return n&&n[t]?n[t].length:void 0},t.removeHook=function(t,e){if(n&&n[t]){var i=n[t].indexOf(e);i>=0&&n[t].splice(i,1)}},t.setHook=function(t,e){n||(n={}),n[t]||(n[t]=[]),n[t].push(e)}}(this),function(t){var n,e;t._addToCache=function(t){t&&t.__id&&(this._objectHash[t.__id]=t)},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){return n||(n={}),n[t]?n[t]:void(n[t]=this)}),t._cmd=function(t,n,e){var i=t[0],r=t[4];this._wCmd(i,r,t),e&&e!=r&&this._wCmd(i,e,t),this._parentCmd(r,t)},t._createModelCommands=function(t,n,e){e||(e=[]);var i;if(i=t.data&&t.__id?t.data:t,this.isObject(i)||this.isArray(i)){var r;if(r=t.__id?t:{data:i,__id:this.guid()},this.isArray(i))var o=[2,r.__id,[],null,r.__id];else var o=[1,r.__id,{},null,r.__id];n&&(r.__p=n.__id),e.push(o);for(var a in i)if(i.hasOwnProperty(a)){var s=i[a];if(this.isObject(s)||this.isArray(s)){var c=this._createModelCommands(s,r,e),o=[5,a,c.__id,null,r.__id];e.push(o)}else{var o=[4,a,s,null,r.__id];e.push(o)}}return r}},t._createNewModel=function(t,n){if(this.isObject(t)||this.isArray(t)){var e={data:t,__id:this.guid()};if(this._objectHash[e.__id]=e,this.isArray(t))var i=[2,e.__id,[],null,e.__id];else var i=[1,e.__id,{},null,e.__id];n&&(e.__p=n.__id),this.writeCommand(i,e);for(var r in t)if(t.hasOwnProperty(r)){var o=t[r];if(this.isObject(o)||this.isArray(o)){var a=this._createNewModel(o,e);e.data[r]=a;var i=[5,r,a.__id,null,e.__id];this.writeCommand(i,e),this._moveCmdListToParent(a)}else{var i=[4,r,o,null,e.__id];this.writeCommand(i,e)}}return e}},t._find=function(t){var n=this._objectHash[t];return n?n:this._removedHash[t]},t._findObjects=function(t,n){if(!t)return null;if(!this.isObject(t))return t;t=this._wrapData(t),t.__id&&(this._objectHash[t.__id]=t);if(n&&(t.__p=n),t.data){var e=t.data;for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];if(this.isObject(r)){var o=this._findObjects(r,t.__id);o!==r&&(t.data[i]=o)}}}return t},t._getObjectHash=function(){return this._objectHash},t._getRemovedHash=function(){return this._removedHash},t._parentCmd=function(t,n,e){var i=this._find(t);i&&(this._wCmd(42,t,n),i.__p&&(e||(e=this._find(i.__p)),e&&this._parentCmd(i.__p,n,e)))},t._prepareData=function(t){var n=this._wrapData(t);return this._objectHash[n.__id]||(n=this._findObjects(n)),n},t._wCmd=function(t,n,i){if(this._workers[t]&&this._workers[t][n]){var r=this._workers[t][n],o=i[1],a=r["*"],s=r[o];a&&a.forEach(function(t){var n=t[0],r=t[1],o=e[n];o&&o(i,r)}),s&&s.forEach(function(t){var n=t[0],r=t[1],o=e[n];o&&o(i,r)})}},t._wrapData=function(t){if(t&&t._wrapData)return t._data;if(t.__id&&t.data)return t;var n=this._createNewModel(t);return n},t.createWorker=function(t,n,e){var i=n[0],r=n[4];this._workers[i]||(this._workers[i]={}),this._workers[i][r]||(this._workers[i][r]={});var o=this._workers[i][r],a=n[1];a||(a="*"),o[a]||(o[a]=[]),o[a].push([t,e])},t.getData=function(){return this._data},t.indexOf=function(t){if(t||(t=this._data),this.isObject(t)||(t=this._find(t)),t){var n=this._find(t.__p);if(n&&this.isArray(n.data))return n.data.indexOf(t)}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){if(n){this._objectHash||(this._objectHash={},this._removedHash={});var i=this;this._channelId=t,this._data=n,this._workers={},this._journal=e||[],this._journalPointer=this._journal.length;var r=this._findObjects(n);r!=n&&(this._data=r),this._data.__orphan||(this._data.__orphan=[]),e&&this.isArray(e)&&e.forEach(function(t){i.execCmd(t,!0)})}}),t.setWorkerCommands=function(t){e||(e={});for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},t.toPlainData=function(t,n){if("undefined"==typeof t)return n?t:t=this._data;if(!this.isFunction(t)&&"function"!=typeof t){if(!this.isObject(t))return t;var e;if(this.isArray(t.data)){e=[];for(var i=t.data.length,r=0;i>r;r++)e[r]=this.toPlainData(t.data[r],!0)}else{e={};for(var o in t.data)t.data.hasOwnProperty(o)&&(e[o]=this.toPlainData(t.data[o],!0))}return e}}}(this)},E=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof E))return new E(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=E._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};E._classInfo={name:"_channelData"},E.prototype=new P,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._channelData=E,this._channelData=E):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._channelData=E:this._channelData=E}.call(new Function("return this")());var N=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},M=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof M))return new M(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=M._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};M._classInfo={name:"channelObjects"},M.prototype=new N;var L=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return n||(n={}),t+=e.id(),n[t]?n[t]:void(n[t]=this)}),t._createChannelDir=function(t){var n=t;"/"==n.charAt(0)&&(n=n.substring(1));var e=n.split("/"),i=this._fs,o=i,a=r(),s=a,c=this;return e.forEach(function(t){t=t.trim(),0!=t.length&&(a=a.then(function(){return o.isFolder(t)}).then(function(n){return n?!0:o.createDir(t)}).then(function(){return o.getFolder(t)}).then(function(t){o=t}))}),a=a.then(function(){c._folder=o}),s.resolve(!0),a},t._createChannelSettings=function(){var t=this._folder,n=this;return r(function(e){var i=!1;t.isFile("ch.settings").then(function(e){return e?!0:(i=!0,t.writeFile("ch.settings",JSON.stringify({version:1,name:"Automatic first version",utc:(new Date).getTime(),channelId:n._channelId,journalLine:0})))}).then(function(){return t.readFile("ch.settings")}).then(function(t){var i=JSON.parse(t);n._settings=i,e(n._settings)})})},t._isFreeToFork=function(t){var n=t;"/"==n.charAt(0)&&(n=n.substring(1));var e=n.split("/"),i=this._fs,o=i,a=r(),s=a,c=!1;return e.forEach(function(t){t=t.trim(),0!=t.length&&(a=a.then(function(){return c?c:o.isFolder(t)}).then(function(t){return c?void 0:t?c:c=!0}).then(function(){return c?c:o.getFolder(t)}).then(function(t){return c?c:void(o=t)}))}),a=a.then(function(){return c}),s.resolve(!0),a},t._textLinesToArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t._writeSettings=function(){return this._folder.writeFile("ch.settings",JSON.stringify(this._settings))},t.childForkTree=function(){var t=(this._folder,this);return r(function(n){t.getForks().then(function(e){var i=[],o=[];if(!e||0==e.length)return void n([]);e.forEach(function(n){var e=R(n.to,t._fs);i.push(e.childForkTree())});var a=r();a.all(i).then(function(t){e.forEach(function(n,e){n.children=t[e],o.push(n)}),n(o)}),a.resolve(!0)})})},t.createChannel=function(t){var n,e=(this._folder,this);return r(function(i){if(n=t.chData,n||(n={data:{},__id:e.guid(),__acl:t.__acl}),n&&!n.__acl&&(n.__acl=t.__acl),!t.channelId||!t._userId)return void i({result:!1,text:"Could not create the channel, missing information"});var r={version:2,channelId:t.channelId,userId:t._userId,name:t.name||"",utc:(new Date).getTime()};e._isFreeToFork(t.channelId).then(function(o){if(1==o){var a=R(t.channelId,e._fs);a.then(function(){return a.writeFile("file.2",JSON.stringify(n))}).then(function(){return a.set(r)}).then(function(){i({result:!0,channelId:t.channelId})}).fail(function(t){var n="";t&&t.message&&(n=t.message),i({result:!1,text:"Failed to create channel "+n})})}else console.error("Channel already created"),i({result:!1,text:"Channel is already in use"})}).fail(function(t){console.error(t),i({result:!1,text:"Creating the new channel failed"})})})},t.createSyncedModel=function(t){var n=this;return console.log("** startin createSyncedModel with data **"),console.log(JSON.stringify(t)),r(function(e,i){var o,s=t.sync;if("memory.socket"==s.out.method&&(o=a(s.out.protocol+"://"+s.out.ip,s.out.port)),"node.socket"==s.out.method){var c=require("socket.io-client"),u=c.connect(s.out.protocol+"://"+s.out.ip+":"+(s.out.extPort||s.out.port));o=a(s.out.protocol+"://"+s.out.ip,s.out.port,u)}var f=O(s.out.channelId,o,{auth:{username:s.out.username,password:s.out.password}});f.then(function(){f._checkout(s.out.channelId).then(function(t){console.log("Checkout returned "),console.log(JSON.stringify(t));var o=r(),a=o,c=n.getFilesystem();t.build&&t.build.forEach(function(t){var n;o=o.then(function(){var e=t.ch;return t.ch==s.out.channelId&&(e=s["in"].channelId),n=R(e,c)}).then(function(){return n.folder().isFile(t.file)}).then(function(e){if("ch.settings"==t.file){var i=JSON.parse(t.data);return i.channelId=s["in"].channelId,n.writeFile(t.file,JSON.stringify(i))}return e?e:n.writeFile(t.file,t.data)})});var u=n.folder();o.then(function(){return u.isFile("sync")}).then(function(t){return t?void 0:u.writeFile("sync",JSON.stringify(s))}).then(function(){return u.isFile("master-sync")}).then(function(t){if(!t){var n=[f._clientState.version,f._clientState.data.getJournalLine()];return u.writeFile("master-sync",JSON.stringify(n))}}).then(function(){return n._createChannelSettings()}).then(function(){e(s)}).fail(i),a.resolve(!0)}).fail(i)}).fail(i)})},t.folder=function(){return this._folder},t.fork=function(t){var n=this._folder,e=this;return r(function(i){var r=e._settings,o=r.journalLine||0;"undefined"!=typeof t.journalLine&&(o=t.journalLine);var a={fromJournalLine:o,version:1,channelId:t.channelId,fromVersion:r.version,from:e._channelId,to:t.channelId,userId:t._userId,name:t.name,utc:(new Date).getTime()};console.log("fork called with "),console.log(a),e._isFreeToFork(t.channelId).then(function(r){1==r?n.appendFile("forks",JSON.stringify(a)+"\n").then(function(){var n=R(t.channelId,e._fs);n.then(function(){return n.set(a)}).then(function(){i(a)})}):(console.error("Channel already created"),i({result:!1,text:"Channel is already in use"}))}).fail(function(t){console.error(t),i({result:!1,text:"Creating the fork failed"})})})},t.get=function(t){var n=this._db,e=this;return r(function(i){e.then(function(){var e=n.table("settings");e.get(t).then(function(t){i(t.value)})})})},t.getCurrentVersion=function(){var t=(this._folder,this);return r(function(n){n(t._settings.version)})},t.getFilesystem=function(){return this._fs},t.getForks=function(){var t=this._folder,n=this;return r(function(e){n.then(function(){return t.readFile("forks")}).then(function(t){e(t?n._textLinesToArray(t):[])}).fail(function(){e([])})})},t.getJournalSize=function(){return this._settings.journalSize},t.incrementVersion=function(){var t=(this._folder,this);return r(function(n){t.then(function(){var e=t._settings;e.version++,e.journalLine=0,t._writeSettings().then(function(){n(e.version)})})})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._channelId=t,this._latestVersion=1,this._fs=n;var e=this;t&&e._createChannelDir(t).then(function(){return e._createChannelSettings()}).then(function(){e.resolve(!0)}).fail(function(t){console.error(t)})}),t.readBuildTree=function(t,n,e){var i=(this._folder,this);return r(t?function(r){var o=R(t,i._fs);o.then(function(){o.readBuildTree(null,n,null).then(function(t){var n=t[0].length;n>e&&t[0].splice(e,n-e),r(t)})})}:function(t){var e,r,o=[];i.then(function(){return i.readMain(n)}).then(function(t){return t&&(e=JSON.parse(t)),i.readJournal(n)}).then(function(n){if(r=n,i._settings.from&&!e){var a=i._settings;i.readBuildTree(a.from,a.fromVersion,a.fromJournalLine).then(function(e){o.push(n),e.forEach(function(t){o.push(t)}),t(o)})}else t([n,e])}).fail(function(t){console.error(t)})})},t.readCheckoutData=function(t,n){var e=this._folder,i=this,o=n||i._settings.version;return r(t?function(e){var r=R(t,i._fs);r.then(function(){r.readCheckoutData(null,n).then(function(t){e(t)})})}:function(n){var r,a=[];i.then(function(){return 1==o?null:e.readFile("file."+o)}).then(function(n){return n&&(r=n,a.push({ch:t||i._channelId,file:"file."+o,data:n})),e.readFile("journal."+o)}).then(function(n){return n&&a.push({ch:t||i._channelId,file:"journal."+o,data:n}),e.readFile("ch.settings")}).then(function(e){if(e&&a.push({ch:t||i._channelId,file:"ch.settings",data:e}),i._settings.from&&!r){var o=i._settings;i.readCheckoutData(o.from,o.fromVersion).then(function(t){t.forEach(function(t){a.push(t)}),n(a)})}else n(a)}).fail(function(t){console.error(t)})})},t.readFile=function(t){var n=this._folder;return n.readFile(t)},t.readJournal=function(t){var n=this._folder,e=this,i=t||e._settings.version;return r(function(t){n.readFile("journal."+i).then(function(n){return n?(e._settings.journalSize=n.length,void t(e._textLinesToArray(n))):(e._settings.journalSize=0,void t([]))}).fail(function(){t([])})})},t.readMain=function(t){var n=this._folder,e=this,i=t||e._settings.version;return 1==i?r(function(t){t(null)}):n.readFile("file."+i)},t.set=function(t,n){var e=(this._folder,this._settings);if(this.isObject(t))for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);else e[t]=n;return this._writeSettings(e)},t.snapshot=function(t){var n=(this._folder,this);return r(function(e){var i;n.incrementVersion().then(function(e){return i=e-1,n.writeMain(t)}).then(function(){e(!0)})})},t.status=function(){var t=(this._folder,this);return r(function(n){t.then(function(){n(t._settings)})})},t.syncData=function(){var t=this._folder;return r(function(n){t.isFile("sync").then(function(e){return e?void t.readFile("sync").then(n):void n(null)})})},t.treeOfLife=function(t){var n=(this._folder,this);if(t){var e=R(t,this._fs);return e.treeOfLife()}return r(function(t){n.then(function(){n._settings.from?n.treeOfLife(n._settings.from).then(t):n.childForkTree().then(t)})})},t.truncateJournalTo=function(t,n){var e=this._folder,i=this;return r(function(r){e.truncateFile("journal."+i._settings.version,t).then(function(){i._settings.journalSize=t,i._settings.journalLine=n,i._writeSettings(),r(!0)})})},t.writeFile=function(t,n){var e=this._folder;return"string"!=typeof n&&(n=JSON.stringify(n)),e.writeFile(t,n)},t.writeMain=function(t,n){var e=this._folder,i=this,r=n||i._settings.version;return"string"!=typeof t&&(t=JSON.stringify(t)),e.writeFile("file."+r,t)},t.writeToJournal=function(t){var n=this._folder,e=this;if(this.isArray(t[0])){var i="",o=0;return t.forEach(function(t){i+=JSON.stringify(t)+"\n",o++}),r(function(t){n.appendFile("journal."+e._settings.version,i).then(function(){e._settings.journalSize+=i.length,e._settings.journalLine+=o,e._writeSettings(),t(!0)})})}return r(function(i){var r=JSON.stringify(t)+"\n";n.appendFile("journal."+e._settings.version,r).then(function(){e._settings.journalSize+=r.length,e._settings.journalLine++,e._writeSettings(),i(!0)})})}}(this)},R=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof R))return new R(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=R._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};L.prototype=r.prototype,R._classInfo={name:"_localChannelModel"},R.prototype=new L,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._localChannelModel=R,this._localChannelModel=R):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._localChannelModel=R:this._localChannelModel=R}.call(new Function("return this")());var J=function(){!function(t){var n,e,i,r;t._findCmd=function(t){return r[t]},t.addSocketToCh=function(t,n){this._channelSockets[t]||(this._channelSockets[t]=[]),this._channelSockets[t].indexOf(n)<0&&(this._channelSockets[t].push(n),console.log("-- client joined "+t+", now  "+this._channelSockets[t].length+" connected"))},t.cmd=function(t,n){r||(r={}),r[t]=n},t.getAccessManager=function(){return e},t.getServerSocket=function(){return this._server},t.getSocketsFromCh=function(t){return this._channelSockets[t]?this._channelSockets[t]:[]},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,e,o){r||(r={}),this._server=t,this._auth=o,this._channelSockets={};var a=this;this._server.on("connect",function(t){var r;t.__channels||(t.__channels=[]),t.on("requestChannel",function(n,o){e.findPath(n.channelId).then(function(s){s?(r=V(n.channelId,e,a),r.then(function(){r._groupACL(t,"r")?(t.join(n.channelId),a.addSocketToCh(n.channelId,t),t.__channels.push(n.channelId),o({success:!0,channelId:n.channelId})):o({success:!1,channelId:null})})):i?(console.log("** Starting to autocreate channel **"+n.channelId),i(n,t,function(i,s){if(i&&s){var c=R(null,e);c.createChannel({chData:s,_userId:t.getUserId(),name:"autocreated",channelId:n.channelId}).then(function(i){return i.result?(r=V(n.channelId,e,a),void r.then(function(){r._groupACL(t,"r")?(console.log("** autocreated a channel **"+n.channelId),t.join(n.channelId),a.addSocketToCh(n.channelId,t),t.__channels.push(n.channelId),o({success:!0,channelId:n.channelId})):o({success:!1,channelId:null})})):void o({success:!1,channelId:null})})}else o({success:!1,channelId:null})})):o({success:!1,channelId:null})})}),t.on("disconnect",function(){console.log("Socket is in "+t.__channels.length+" channels "),t.__channels.forEach(function(n){a.removeSocketFromCh(n,t)})}),t.on("auth",function(e,i){if(n)try{n(e,function(n,e,r){if(n===!0){var o=e;console.log("custom authentication into ",r),t.setAuthInfo(o,r),i({success:!0,userId:t.getUserId(),groups:r})}else i({success:!1,userId:null})})}catch(r){i({success:!1,userId:null})}else o?o.login(e.userId,e.password).then(function(n){if(n.result===!0){var e=n.userId,r=n.groups;console.log("AUTH groups ",n.groups),t.setAuthInfo(e,r),i({success:!0,userId:t.getUserId(),groups:n.groups})}else i({success:!1,userId:null})}):i({success:!1,userId:null})}),t.on("channelCommand",function(n,e){if(!t.getUserId())return void e({success:!1,reason:"socket is not authenticated."});if(!t.isInRoom(n.channelId))return void e({success:!1,reason:"not in room"});console.time("cmd_emit_done");var i=(new Date).getTime();r.run(n,function(t){var r=(new Date).getTime();console.log("Command "+n.cmd+" took "+(r-i)),e&&e(t)},t)})})}),t.removeSocketFromCh=function(t,n){if(this._channelSockets[t]){var e=this._channelSockets[t],i=e.indexOf(n);i>=0&&e.splice(i,1),console.log(0==e.length?"-- all clients have left "+t+" => should close the channel --- ":"-- client left "+t+" still  "+e.length+" connected")}},t.setAccessManager=function(t){e=t},t.setAuthExtension=function(t){n=t},t.setAutoCreateFn=function(t){i=t}}(this)},U=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof U))return new U(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=U._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};U._classInfo={name:"_serverChannelMgr"},U.prototype=new J,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._serverChannelMgr=U,this._serverChannelMgr=U):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._serverChannelMgr=U:this._serverChannelMgr=U}.call(new Function("return this")());var W=function(){!function(t){var n,i;t._askChUpgrade=function(){var t=this._chManager.getSocketsFromCh(this._channelId),n=this;t.forEach(function(t){n._serverState.upgrade||(n._serverState.upgrade={}),n._serverState.upgrade[t.getId()]={askFull:!0,socket:t}})},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return n||(n={}),t+=e.id(),n[t]?n[t]:void(n[t]=this)}),t._createSyncCh=function(t){var n=this;return console.log("** startin _createSyncCh with data **"),console.log(JSON.stringify(t)),r(function(e,i){var o,s=t.sync;if("memory.socket"==s.out.method&&(o=a(s.out.protocol+"://"+s.out.ip,s.out.port)),"node.socket"==s.out.method){var c=require("socket.io-client"),u=c.connect(s.out.protocol+"://"+s.out.ip+":"+(s.out.extPort||s.out.port));o=a(s.out.protocol+"://"+s.out.ip,s.out.port,u)}var f=O(s.out.channelId,o,{auth:{username:s.out.username,password:s.out.password}});f.then(function(){f._checkout(s.out.channelId).then(function(t){var o=r(),a=n._model.getFilesystem();t.build&&t.build.forEach(function(t){var n;o=o.then(function(){return n=R(t.ch,a)}).then(function(){return n.folder().isFile(t.ch)}).then(function(e){return e?e:n.writeFile(t.file,t.data)})});var c=n._model.folder();o=o.then(function(){return c.isFile("sync")}).then(function(t){return t?void 0:c.writeFile("sync",JSON.stringify(s))}).then(function(){return c.isFile("master-sync")}).then(function(t){if(!t){var n=[f._clientState.version,f._clientState.data.getJournalLine()];return c.writeFile("master-sync",JSON.stringify(n))}}).then(function(){e(s)}).fail(i)}).fail(i)}).fail(i)})},t._doClientUpdate=function(){var t,n=this;if(n._serverState){if(n._serverState.upgrade)for(var e in n._serverState.upgrade)if(n._serverState.upgrade.hasOwnProperty(e)){var i=n._serverState.upgrade[e];if(i.socket){if(i.version!=n._serverState.version||i.askFull){var r=n._serverState.data.getData();i.socket.emit("upgrade_"+n._channelId,{version:n._serverState.version,journal:n._serverState.data._journal,data:r})}else{var o=i.last_update[1];i.socket.emit("upgrade_"+n._channelId,{partialFrom:o,partialEnds:n._serverState.data._journal.length,partial:n._serverState.data._journal.slice(o)})}delete n._serverState.upgrade[e]}}if(n._broadcastSocket&&n._policy){var a=n._policy.constructServerToClient(n._serverState);if(a){console.time("emit_start"),t||(t=n._broadcastSocket.to(n._channelId));var s=n._model.getJournalSize();a.journalSize=s,t.emit("s2c_"+n._channelId,a),console.timeEnd("emit_start"),console.timeEnd("cmd_emit_done");{(new Date).getTime()}n._syncConnection&&n._syncConnection.isConnected()&&(a.c&&a.c.forEach(function(t){n._syncConnection.addCommand(t)}),n._masterSync=[n._serverState.version,n._serverState.data.getJournalLine()],n._model.folder().writeFile("master-sync",JSON.stringify(n._masterSync))),n._model.writeToJournal(a.c).then(function(){})}}}},t._execCmd=function(t){var n=this;return r(function(e){if(!t||!t.cmd)return void e(null);var i=n._cmds[t.cmd];i?n._commands.addCommands(function(n){i(t,function(t){e(t),n()},{_adminSocket:!0})}):e(null)})},t._groupACL=function(t,n,e){if(t._adminSocket)return!0;var i=this._chManager.getAccessManager();if(i)return i(this,t,e);var r=this;if(!r._acl)return!1;for(var o=t.getUserRoles(),a=!1,s=0;s<o.length;s++)if(r._acl.find("",o[s]+"@",n)){a=!0;break}return a},t._initCmds=function(){if(i||(i={}),!this._cmds){var t=this;this._cmds={treeOfLife:function(n,e,i){return t._groupACL(i,"r",n)?void t._model.treeOfLife().then(function(t){e(t)}):void e(null)},sync:function(n,e,i){if(!t._groupACL(i,"w",n))return void e(null);if(!(n&&n.data&&n.data.sync&&n.data.sync.out&&n.data.sync["in"]))return console.log("ERROR: Sync failed"),console.log(JSON.stringify(n)),void e({success:!1});var r=n.data.sync.out,o=i;if(o._ip==r.ip&&o._ioLib){var a=o._ioLib;if(a.handshake){var s=a.handshake.address;if(s&&s.port==r.extPort)return void e({success:!1})}}var c=R(n.data.sync["in"].channelId,t._model.getFilesystem());c.then(function(){return c.createSyncedModel(n.data)}).then(function(){e({success:!0})}).fail(function(){e({success:!1})})},checkout:function(n,e,i){return t._groupACL(i,"r",n)?void t._model.readCheckoutData().then(function(t){e({build:t})}):void e(null)},readBuildTree:function(n,e,i){return t._groupACL(i,"r",n)?void t._model.readBuildTree().then(function(n){t._model.status().then(function(t){e({status:t,build:n})})}):void e(null)},getForks:function(n,e,i){return t._groupACL(i,"r",n)?void t._model.getForks().then(function(t){e(t)}):void e(null)},channelStatus:function(n,e,i){return t._groupACL(i,"tc",n)?void t._model.status().then(function(t){e(t)}):void e(null)},raw:function(n,e,i){e(t._groupACL(i,"tc")?t._chData.getData():null)},createChannel:function(n,e,i){if(!t._groupACL(i,"w",n))return void e(null);if(!n.data)return void e({ok:!1});if(!n.data.__acl){var r=t._serverState.data.getData();if(!r||!r.__acl)return void e({ok:!1});n.data.__acl=r.__acl}n.data._userId=i.getUserId(),t._model.createChannel(n.data).then(function(t){e(t)})},fork:function(n,e,i){return t._groupACL(i,"w",n)?n.data?(n.data._userId=i.getUserId(),void t._model.fork(n.data).then(function(t){e(t)})):void e({ok:!1}):void e(null)},snapshot:function(n,e,i){if(console.log("got snapshot command"),!t._groupACL(i,"w",n))return void e(null);var r=t._serverState.data.getData();r.__orphan&&(r.__orphan.length=0),t._doClientUpdate(),t._model.snapshot(r).then(function(){t._serverState.version++,t._serverState.data._journal.length=0,t._serverState.last_update[0]=0,t._serverState.last_update[1]=0,t._masterSync?(t._masterSync=[t._serverState.version,0],t._model.folder().writeFile("master-sync",JSON.stringify(t._masterSync)).then(function(){t._askChUpgrade(t._channelId),e({ok:!0})})):(t._askChUpgrade(t._channelId),e({ok:!0}))})},writeMain:function(n,e,i){return t._groupACL(i,"w",n)?void t._model.writeFile("main",n.data).then(function(){e({ok:!0})}):void e(null)},readMain:function(n,e,i){return t._groupACL(i,"r",n)?void t._model.readMain().then(function(t){e(t)}):void e(null)},readMainVersion:function(n,e,i){return t._groupACL(i,"r",n)?void t._model.readMain(n.data).then(function(t){e(t)}):void e(null)},upgradeRequest:function(n,e,i){return t._groupACL(i,"r",n)?(t._serverState.upgrade||(t._serverState.upgrade={}),n.data.socket=i,t._serverState.upgrade[i.getId()]=n.data,void e({result:!0})):void e(null)},chCmd:function(n,e,i){if(console.log("chCmd command "),!t._groupACL(i,"w",n))return void e(null);try{!t._broadcastSocket&&i.getUserId&&(t._broadcastSocket=i);var r=n.data.cmdList;if(r)for(var o=0;o<r.length;o++){var a=r[o],s=t._serverState.data,c=a.cmd,u=t._chManager._findCmd(c);u&&u.apply(s,[a.params])}e(!0)}catch(f){console.log("chCmd failed with "+f.message),e(!1)}},sendCmds:function(n,e,i){if(console.log("sendCmds command "),!t._groupACL(i,"w",n))return void e(null);try{for(var r=t._serverState.data,o=n.data.commands,a=0;a<o.length;a++){var s=r.execCmd(o[a]);if(s!==!0)break}e(!0)}catch(c){e(c.message)}},c2s:function(n,e,i){if(!t._groupACL(i,"w",n))return void e(null);if(i.getUserId)for(var r=i.getUserId(),o=n.data.c.length,a=n.data.c,s=(new Date).getTime(),c=0;o>c;c++)a[c][5]=s,a[c][6]=r;var u={};try{for(var f=n.data,l=t._serverState.data,c=0;c<f.c.length;c++){var h=f.c[c];l.execCmd(h)}}catch(_){}!t._broadcastSocket&&i.getUserId&&(t._broadcastSocket=i),e(u)},masterUpgrade:function(n,e,i){if(!t._groupACL(i,"w",n))return void e(null);if(console.log("creating a master upgrade with "),console.log(JSON.stringify(n)),i.getUserId)for(var r=i.getUserId(),o=n.data.c.length,a=n.data.c,s=(new Date).getTime(),c=0;o>c;c++)a[c][5]=s,a[c][6]=r;var u=t._policy.deltaMasterToSlave(n.data,t._serverState);return!t._broadcastSocket&&i.getUserId&&(t._broadcastSocket=i),u&&u.then?void e({upgradeingMaster:!0}):(console.log("result of master upgrade "),console.log(JSON.stringify(u)),void e(u))}}}},t._sendUnsentToMaster=function(){var t=this;if(t._syncConnection&&t._syncConnection.isConnected()&&t._masterSync){var n=t._masterSync[1],e=t._serverState.data.getJournalLine();if(e>n){console.log("--- _sendUnsentToMaster --- ");var i=t._serverState.data._journal.slice(n,e);i.forEach(function(n){t._syncConnection.addCommand(n)}),t._masterSync=[0,e],t._model.folder().writeFile("master-sync",JSON.stringify(t._masterSync))}}},t._startSync=function(){var t=this;return r(function(n){t._model.syncData().then(function(e){if(!e)return void n(!1);if(e){console.log("Sync data"),console.log(e);var i=JSON.parse(e),r=i.out;if("memory.socket"==r.method)var o=a(r.protocol+"://"+r.ip,r.port);if("node.socket"==r.method)var s=require("socket.io-client"),c=s.connect(r.protocol+"://"+r.ip+":"+(r.extPort||r.port)),o=a(r.protocol+"://"+r.ip,r.port,c);var u=O(r.channelId,o,{auth:{username:r.username,password:r.password}});u.then(function(){return console.log("out done, checking for master-sync"),t._model.folder().isFile("master-sync")}).then(function(n){return n?0:(console.log("master-sync missing"),t._model.writeFile("master-sync",JSON.stringify([t._serverState.version,0])))}).then(function(){return console.log("reading master-sync missing"),t._model.readFile("master-sync")}).then(function(n){return console.log(n),t._masterSync=JSON.parse(n),n}).then(function(){u._slaveController=t,t._syncConnection=u,t._sendUnsentToMaster(),console.log("sync: ---- in / out connection ready --- "),n(!0)})}})})},t._updateLoop=function(){var t=this;e().onFrame(function(){t._doClientUpdate()})},t.channelId=function(){return this._channelId},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){this._channelId=t,this._commands=j(t+n.id()),this._chManager=e,this._model=R(t,n);var i=this;this._model.readBuildTree().then(function(e){for(var r=e.pop(),o=E(t+n.id(),r,[]),a=e.pop();a;)o._journalPointer=0,o._journal.length=0,a.forEach(function(t){o.execCmd(t)}),a=e.pop();i._serverState={model:i._model,data:o,version:i._model._settings.version,last_update:[0,o.getJournalLine()],_done:{}};var s=o.getData();s.__acl&&(i._acl=g(s.__acl)),i._policy=I(),i._updateLoop(),i._chData=o,i._startSync().then(function(){i.resolve(!0)})}),this._initCmds()}),t.run=function(t,n,e){var i=this._cmds[t.cmd];i&&this._commands.addCommands(function(r){i(t,function(t){n(t),r()},e)})}}(this)},V=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof V))return new V(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=V._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;
u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};W.prototype=r.prototype,V._classInfo={name:"_channelController"},V.prototype=new W,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._channelController=V,this._channelController=V):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._channelController=V:this._channelController=V}.call(new Function("return this")());var n=function(){!function(t){var n,e,i,r,o,a,s,c;t._easeFns=function(){s={easeIn:function(t){return t*t},easeOut:function(t){return-1*t*(t-2)},easeInOut:function(t){return.5>t?t*t:-1*t*(t-2)},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return(1-t)*(1-t)*(1-t)+1},pow:function(t){return Math.pow(t,parseFloat(1.5-t))},linear:function(t){return t}}},t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.addEasingFn=function(t,n){s[t]=n},t.after=function(t,n,e){e||(e="aft_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.ease=function(t,n,e,i){var r=s[t];r||(r=s.pow);var o="e_"+a++;c[o]={easeFn:r,duration:n,cb:e,over:i}},t.every=function(t,n,e){e||(e="t7491_"+a++),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){this._easeFns(),a=1;var t,s;if("undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}var u=new Function("try { return this == global; } catch(e) { return false; }")();u?t=function(t){return setImmediate(t)}:t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},r={},o=[],c={};var f=0,l=function(){var n=(new Date).getTime(),a=f-n;0==f&&(a=0);for(var s;s=e.shift();)"[object Array]"===Object.prototype.toString.call(s)?s[1].apply(s[0],s[2]):s();for(var u=0;u<o.length;u++){var h=o[u];h()}for(var _ in c)if(c.hasOwnProperty(_)){var d=c[_];d.start||(d.start=n);var v=n-d.start,p=v/d.duration;p>=1&&(p=1,delete c[_]),d.cb(d.easeFn(p)),1==p&&d.over&&d.over()}for(var _ in i)if(i.hasOwnProperty(_)){var d=i[_];d[0](d[1]),delete i[_]}for(var _ in r)if(r.hasOwnProperty(_)){var d=r[_];d.nextTime<n&&(d.remove?d.nextTime>0?(d.fn(),delete r[_]):d.nextTime=n+d.step:(d.fn(),d.nextTime=n+d.step)),d.until&&d.until<n&&delete r[_]}t(l),f=n};l(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var u,f=this;if(!(f instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=e._classInfo.name)return new u(t,n,i,r,o,a,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};e._classInfo={name:"later"},e.prototype=new n,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.later=e,this.later=e):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.later=e:this.later=e}.call(new Function("return this")());var i=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,o=[],a=new Array(e);return this.then(function(){var t=r();return 0==n.length&&t.resolve([]),n.forEach(function(n,r){n.then?(o.push(n),n.then(function(n){a[r]=n,i++,i==e&&t.resolve(a)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var o=i.length,a=!1,s=!1,c=0,u=[],f=e||{};return this.then(function(){var n=r();return i.forEach(function(e){e.then?(u.push(e),e.then(function(e){c++,a=t(e,f),(a&&!s||0==s&&o==c)&&(n.resolve(f),s=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){t(function(t){i.resolve(t)},function(t){i.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new r(t,n),o=this;return 1==this._state&&e().asap(function(){o.fulfill(o.value())}),2==this._state&&e().asap(function(){o.reject(o.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},r=function(t,n,e,i,o,a,s,c){var u,f=this;if(!(f instanceof r))return new r(t,n,e,i,o,a,s,c);var l=[t,n,e,i,o,a,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=r._classInfo.name)return new u(t,n,e,i,o,a,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};r._classInfo={name:"_promise"},r.prototype=new i;var B=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t._cursorAction=function(t,n,e){var i,o=r(),a=this._db.transaction(this._table,t),s=a.objectStore(this._table);if(n){var c,u;for(var f in n)n.hasOwnProperty(f)&&(u=f,c=IDBKeyRange.only(n[f]));if(!u)return void o.reject("invalid index key");var l=s.index(u);i=l.openCursor(c)}else i=s.openCursor();return a.oncomplete=function(){o.resolve(!0)},i.onerror=function(t){console.log(t)},i.onsuccess=function(t){var n=t.target.result;n&&(e(n),n.continue())},o},t.addRows=function(t){var n=r(),e=this._db.transaction([this._table],"readwrite");e.oncomplete=function(){n.resolve(!0)},e.onerror=function(t){n.reject(t)};var i=e.objectStore(this._table);for(var o in t){var a=i.add(t[o]);a.onsuccess=function(){}}return n},t.clear=function(){var t=r(),n=this._db.transaction(this._table,"readwrite"),e=n.objectStore(this._table),i=e.clear();return i.onerror=function(n){t.fail(n.target.errorCode)},i.onsuccess=function(){t.resolve(!0)},t},t.count=function(){var t=r(),n=this._db.transaction([this._table],"readonly");return n.objectStore(this._table).count().onsuccess=function(n){t.resolve(n.target.result)},t},t.forEach=function(t,n){return this._cursorAction("readonly",n,function(n){t(n.value,n)})},t.get=function(t){var n=r(),e=this._db.transaction(this._table,"readonly"),i=e.objectStore(this._table),o=i.get(t);return o.onerror=function(e){console.log("Could not get ",t),n.fail(e.target.errorCode)},o.onsuccess=function(){n.resolve(o.result)},n},t.getAll=function(t){var n=[],e=this;return r(function(i,r){e._cursorAction("readonly",t,function(t){n.push(t.value)}).then(function(){i(n)}).fail(r)})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._db=t,this._table=n}),t.readAndDelete=function(t){var n=[],e=this;return r(function(i,r){e._cursorAction("readwrite",t,function(t){n.push(t.value),t.delete()}).then(function(){i(n)}).fail(r)})},t.remove=function(t){var n=this;return r(function(e,i){n._cursorAction("readwrite",t,function(t){t.delete()}).then(function(){e(!0)}).fail(i)})},t.update=function(t,n){var e=r(),i=this,o=this._db.transaction([this._table],"readwrite"),a=o.objectStore(this._table);try{var s=a.get(t);s.onerror=function(t){return s.result?void e.fail(t.target.errorCode):void i.addRows([n]).then(function(){e.resolve(n)})},s.onsuccess=function(){if(!s.result)return void i.addRows([n]).then(function(){e.resolve(n)});var t=a.put(n);t.onerror=function(){e.fail("update failed ")},t.onsuccess=function(){e.resolve(n)}}}catch(c){return this.addRows([n])}return e}}(this)},z=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof z))return new z(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=z._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};z._classInfo={name:"dbTable"},z.prototype=new B;var H=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,e,i;t._initDB=function(){i||(i=window.indexedDB,n=!0,e=q("sys.db",{tables:{databases:{createOptions:{keyPath:"name"}}}}))},t.clearDatabases=function(t){e.then(function(){var n=e.table("databases");n.forEach(function(n,e){t(n)&&(i.deleteDatabase(n.name),e.delete())})})},t.getDB=function(){return this._db},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(!this._db&&(this._initDB(),t)){var r=this,o=i.open(t,4);o.onerror=function(t){console.error(t.target.errorCode)},o.onsuccess=function(n){e.then(function(){var n=e.table("databases");n.addRows([{name:t}])}),r._db=n.target.result,r.resolve(!0)},o.onupgradeneeded=function(t){var e=t.target.result;if(r._db=e,n&&n.tables)for(var i in n.tables)if(n.tables.hasOwnProperty(i)){var o=n.tables[i],a=e.createObjectStore(i,o.createOptions);if(o.indexes)for(var s in o.indexes)if(o.indexes.hasOwnProperty(s)){var c=o.indexes[s];a.createIndex(s,s,c)}}}}}),t.table=function(t){return z(this._db,t)}}(this)},q=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof q))return new q(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=q._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};H.prototype=r.prototype,q._classInfo={name:"_localDB"},q.prototype=new H;var G=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t._isFile=function(t){var n=this._pathObj;return"undefined"==typeof n[t]||this.isObject(n[t])?!1:!0},t._isFolder=function(t){var n=this._pathObj;return"undefined"!=typeof n[t]&&this.isObject(n[t])?!0:!1},t.appendFile=function(t,n){var e=this;return r(function(i,r){var o=e._pathObj;return"string"!=typeof n?void r({result:!1,text:"Only string writes are accepted"}):void(e._isFile(t)?(o[t]+=n,i({result:!0})):(o[t]=n,i({result:!0,text:"Created the file"})))})},t.createDir=function(t){var n=this;return r(function(e){var i=n._pathObj;n._isFile(t)||n._isFolder(t)||(i[t]={}),e({result:!0})})},t.findPath=function(t){"/"==t.charAt(0)&&(t=t.substring(0));var n=t.trim().split("/"),e=this;return r(function(t){if(!n[0])return void t(e);var i,r;n.forEach(function(n){if(n&&0!=n.trim().length){if(!e)return void t(!1);i?i=i.then(function(t){return r=t,t?t.isFolder(n):!1}):(r=e,i=e.isFolder(n)),i=i.then(function(t){return t?r.getFolder(n):!1})}}),i.then(t)})},t.fromData=function(t){var n=this;return r(function(e,i){n._pathObj||(n._pathObj={});var o=[],a=r();for(var s in t)if(n.isObject(t[s])){n._pathObj[s]&&n._isFolder(s)||(n._pathObj[s]={});var c=K(n._server,n._pathObj[s]);o.push(c.fromData(t[s]))}else t[s]===!0||(n._pathObj[s]=t[s]);a.all(o).then(function(){e(!0)}).fail(i),a.resolve(!0)})},t.getFolder=function(t){return this.getSubFolderObj(t)},t.getSubFolderObj=function(t){return this.isObject(this._pathObj[t])?K(this._server,this._pathObj[t]):void 0},t.getTree=function(){var t=this.toData({getData:!1});return t},t.id=function(){return this._id},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._server=t,this._pathObj=n,this._id=this.guid()}),t.isFile=function(t){var n=this;return r(function(e){e(n._isFile(t))})},t.isFolder=function(t){var n=this;return r(function(e){e(n._isFolder(t))})},t.linesToJsonArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t.listFiles=function(){var t=this;return r(function(n){var e=t._pathObj,i=[];for(var r in e)t._isFile(r)&&i.push(r);n(i)})},t.listFolders=function(){var t=this;return r(function(n){var e=t._pathObj,i=[];for(var r in e)t._isFolder(r)&&i.push(r);n(i)})},t.readFile=function(t){var n=this;return r(function(e,i){var r=n._pathObj;return n._isFile(t)?void e(r[t]):void i("File does not exist")})},t.removeFile=function(t){var n=this;return r(function(e){var i=n._pathObj;n._isFile(t)&&delete i[t],e({result:!0,text:"file "+t+" removed"})})},t.toData=function(t){var n=(this._rootDir,this),t=t||{},e=t.fileFilter,i=t.dirFilter;return"undefined"==typeof t.getData&&(t.getData=!0),r(function(o){var a={};n.listFiles().then(function(i){var o=i.length,s=0,c=r();return i.forEach(function(i){return e&&!e(i)?(s++,void(s==o&&c.resolve(!0))):void(t.getData?n.readFile(i).then(function(t){a[i]=t,s++,s==o&&c.resolve(!0)}):(a[i]=!0,s++,s==o&&c.resolve(!0)))}),0==o&&c.resolve(!0),c}).then(function(){return n.listFolders()}).then(function(t){var o=t.length,s=0,c=r();return t.forEach(function(t){if(i&&!i(t))return s++,void(s==o&&c.resolve(!0));var r=n.getSubFolderObj(t);r.toData(e,i).then(function(n){a[t]=n,s++,s==o&&c.resolve(!0)})}),0==o&&c.resolve(!0),c}).then(function(){o(a)}).fail(function(){o({})})})},t.truncateFile=function(t,n){var e=this;return r(function(i){var r=e._pathObj;r[t]&&(r[t]=r[t].substring(0,n)),i({result:!0})})},t.writeFile=function(t,n){var e=this;return r(function(i,r){var o=e._pathObj;return"string"!=typeof n?void r({result:!1,text:"Only string writes are accepted"}):e._isFolder(t)?void r({result:!1,text:"Modifying the file failed"}):(o[t]=n,void i({result:!0}))})}}(this)},K=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof K))return new K(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=K._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};K._classInfo={name:"memoryFsFolder"},K.prototype=new G,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.memoryFsFolder=K,this.memoryFsFolder=K):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.memoryFsFolder=K:this.memoryFsFolder=K}.call(new Function("return this")());var Q=function(){!function(t){var n;t._initServers=function(){n||(n={})},t.getRootFolder=function(){var t=this;return K(t,t._fsData)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._serverName=t,this._initServers(),this._fsData=n||{},this.resolve(!0)})}(this)},X=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof X))return new X(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=X._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};Q.prototype=r.prototype,X._classInfo={name:"fsServerMemory"},X.prototype=new Q,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.fsServerMemory=X,this.fsServerMemory=X):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.fsServerMemory=X:this.fsServerMemory=X}.call(new Function("return this")());var Y=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,e;t._mkDir=function(t){if("string"!=typeof t)throw console.log(JSON.stringiry(t)),console.log("--- is not object"),"WRROR";n.existsSync(t)||n.mkdirSync(t,502,function(){})},t.appendFile=function(t,i){var o=this._rootDir;return r(function(r,a){if("string"!=typeof i)return void a({result:!1,text:"Only string writes are accepted"});t=e.basename(t);var s=o+"/"+t;n.appendFile(s,i,function(t){return t?void a(t):void r({result:!0,text:"File written"})})})},t.createDir=function(t){var n=this._rootDir,i=this;return r(function(r){var o=e.basename(t);i._mkDir(n+"/"+o),r({result:!0,text:"Directory created"})})},t.findPath=function(t){"/"==t.charAt(0)&&(t=t.substring(0));var n=t.trim().split("/"),e=this;return r(function(t){if(!n[0])return void t(e);var i,r;n.forEach(function(n){if(n&&0!=n.trim().length){if(!e)return void t(!1);i?i=i.then(function(t){return r=t,t?t.isFolder(n):!1}):(r=e,i=e.isFolder(n)),i=i.then(function(t){return t?r.getFolder(n):!1})}}),i.then(t)})},t.fromData=function(t){{var n=this;this._rootDir}return r(function(i,o){var a=[],s=r();for(var c in t){if(c.indexOf("..")>=0)return void o(".. symbol is not allowed in the file or path names");var u=e.basename(c);n.isObject(t[u])?!function(t,e){var i=r();a.push(i),n.createDir(e).then(function(){var i=n.getSubFolderObj(e);return i.fromData(t[e])}).then(function(){i.resolve()}).fail(function(){i.resolve()})}(t,u):"string"==typeof t[u]&&a.push(n.writeFile(u,t[u]))}s.all(a).then(function(){i(!0)}).fail(o),s.resolve(!0)})},t.getFolder=function(t){return this.getSubFolderObj(t)},t.getSubFolderObj=function(t){return Z(this._rootDir+"/"+t)},t.getTree=function(){return this.toData({getData:!1})},t.id=function(){return this._id},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t){if(this._rootDir=t,this._id=this.guid(),!t)throw" The directory must be specified ";if("string"!=typeof t)throw" The directory must be string ";if(t.indexOf("..")>=0||t.indexOf("~")>=0)throw"The directory must not contain relative path parts";n||(n=require("fs"),e=require("path"))}),t.isFile=function(t){var i=this._rootDir;return r(function(r){t=e.basename(t),n.stat(i+"/"+t,function(t,n){return t||!n.isFile()?void r(!1):void r(!0)})})},t.isFolder=function(t){var i=this._rootDir;return r(function(r){t=e.basename(t),n.stat(i+"/"+t,function(t,n){return t||!n.isDirectory()?void r(!1):void r(!0)})})},t.linesToJsonArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t.listFiles=function(){var t=this._rootDir;return r(function(e,i){n.readdir(t,function(r,o){if(r)return void i(r);var a=o.length,s=[];0==a&&e(s),o.forEach(function(i){n.stat(t+"/"+i,function(t,n){!t&&n.isFile()&&s.push(i),a--,0==a&&e(s)})})})})},t.listFolders=function(){var t=this._rootDir;return r(function(e,i){n.readdir(t,function(r,o){if(console.log(o),r)return void i(r);var a=o.length,s=[];0==a&&e(s),o.forEach(function(i){n.stat(t+"/"+i,function(t,n){!t&&n.isDirectory()&&(console.log("Dir "+i),s.push(i)),a--,0==a&&(console.log("Cnt == 0"),e(s))})})})})},t.readFile=function(t){var i=this._rootDir;return r(function(r,o){t=e.basename(t),n.readFile(i+"/"+t,"utf8",function(t,n){return t?void o(t):void r(n)})})},t.removeFile=function(t){var i=this._rootDir;return r(function(r,o){t=e.basename(t),n.unlink(i+"/"+t,function(n){return n?void o(n):void r({result:!0,text:"file "+t+" removed"})})})},t.toData=function(t){var n=(this._rootDir,this),t=t||{},e=t.fileFilter,i=t.dirFilter;return"undefined"==typeof t.getData&&(t.getData=!0),r(function(o){var a={};n.listFiles().then(function(i){var o=i.length,s=0,c=r();return i.forEach(function(i){return e&&!e(i)?(s++,void(s==o&&c.resolve(!0))):void(t.getData?n.readFile(i).then(function(t){a[i]=t,s++,s==o&&c.resolve(!0)}):(a[i]=!0,s++,s==o&&c.resolve(!0)))}),0==o&&c.resolve(!0),c}).then(function(){return n.listFolders()}).then(function(t){var o=t.length,s=0,c=r();return t.forEach(function(t){if(i&&!i(t))return s++,void(s==o&&c.resolve(!0));var r=n.getSubFolderObj(t);r.toData(e,i).then(function(n){a[t]=n,s++,s==o&&c.resolve(!0)})}),0==o&&c.resolve(!0),c}).then(function(){o(a)}).fail(function(){o({})})})},t.truncateFile=function(t,i){var o=this._rootDir;return r(function(r,a){return"string"!=typeof fileFilename?void a({result:!1,text:"Only string filenames are accepted"}):(t=e.basename(t),void n.truncate(o+"/"+t,i,function(t){return t?void a(t):void r({result:!0,text:"File truncated"})}))})},t.writeFile=function(t,i){var o=this._rootDir;return r(function(r,a){return"string"!=typeof i?void a({result:!1,text:"Only string writes are accepted"}):(t=e.basename(t),void n.writeFile(o+"/"+t,i,function(t){return t?void a(t):void r({result:!0,text:"File written"})}))})}}(this)},Z=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof Z))return new Z(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=Z._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};Z._classInfo={name:"nodeFsFolder"},Z.prototype=new Y,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.nodeFsFolder=Z,this.nodeFsFolder=Z):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.nodeFsFolder=Z:this.nodeFsFolder=Z}.call(new Function("return this")());var $=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){var i=t.getID()+e;return n||(n={}),n[i]?n[i]:void(n[i]=this)}),t._filePath=function(t){var n=this._path+"/"+t;return n=n.replace("//","/")},t._initCreateDir=function(t){{var n=this,e=this._db;this._server}return r(function(i,r){n._isFolder(t).then(function(i){if(i)return"OK";var r={name:n._normalize(n._path+t+"/"),parentFolder:n._path};return e.table("folders").addRows([r])}).then(function(){i({result:!0,text:"folder "+t+" created"})}).fail(r)})},t._initFromData=function(t){{var n=this;this._db,this._server}return r(function(e,i){var o=[],a=r();for(var s in t){if(s.indexOf("..")>=0)return i(".. symbol is not allowed in the file or path names"),void e(!1);var c=s;n.isObject(t[c])?!function(t,e){var i=r();o.push(i),n._initCreateDir(e).then(function(){var i=n.getSubFolderObj(e);return i._initFromData(t[e])}).then(function(){i.resolve()}).fail(function(){i.resolve()})}(t,c):"string"==typeof t[c]&&o.push(n._writeFile(c,t[c]))}a.all(o).then(function(){e(!0)}).fail(i),a.resolve(!0)})},t._isFile=function(t){var n=this;return r(function(e,i){n._loadFiles().then(function(n){for(var i=0;i<n.length;i++)if(n[i].name==t)return void e(!0);e(!1)}).fail(i)})},t._isFolder=function(t){var n=this;return r(function(e,i){t=n._normalize(n._path+"/"+t+"/"),n._loadFolders().then(function(n){for(var i=0;i<n.length;i++)if(n[i].name==t)return void e(!0);e(!1)}).fail(i)})},t._lastPath=function(t){for(var n=t.split("/"),t=n.pop();n.length>0;){if(t.length>0)return t;t=n.pop()}return t},t._loadFiles=function(){var t=this._db,n=this;return r(function(e){t.table("files").getAll({folderName:n._path}).then(function(t){n._fileCache=t,e(n._fileCache)})})},t._loadFolders=function(){var t=this._db,n=this;return r(function(e){t.table("folders").getAll({parentFolder:n._path}).then(function(t){n._folderCache=t,e(n._folderCache)})})},t._normalize=function(t){var n=t.replace("//","/");return n},t._onlyClearWrites=function(t){var n=this,e=this._db,i=this._server;return r(function(r,o){i.then(function(){return n._isFile(t)}).then(function(i){return i?"OK":e.table("files").addRows([{name:t,folderName:n._path}])}).then(function(){return e.table("fileWrites").remove({filePath:n._filePath(t)})}).then(function(){r({result:!0,text:"writes cleared"})}).fail(o)})},t._removeFileFromCache=function(t){if(this._fileCache)for(var n=0;n<this._fileCache.length;n++)if(this._fileCache[n].name==t)return void this._fileCache.splice(n,1)},t._removeFolderFromCache=function(t){if(this._folderCache)for(var n=0;n<this._fileCache.length;n++)if(this._folderCache[n].name==t)return void this._folderCache.splice(n,1)},t._writeFile=function(t,n){{var e=this,i=this._db;this._server}return console.log("writeFile ",t,n),r(function(r,o){return"string"!=typeof n?void o({result:!1,text:"Only string writes are accepted"}):void e._isFile(t).then(function(n){return n?"OK":i.table("files").addRows([{name:t,folderName:e._path}])}).then(function(){return i.table("fileWrites").remove({filePath:e._filePath(t)})}).then(function(){return i.table("fileWrites").addRows([{filePath:e._filePath(t),data:n}])}).then(function(){r({result:!0,text:"file "+t+" written"})}).fail(o)})},t.appendFile=function(t,n){var e=this,i=this._db,o=this._server;return r(function(r,a){return"string"!=typeof n?void a({result:!1,text:"Only string writes are accepted"}):void o.then(function(){return e._isFile(t)}).then(function(n){return n?"OK":i.table("files").addRows([{name:t,folderName:e._path}])}).then(function(){return i.table("fileWrites").addRows([{filePath:e._filePath(t),data:n}])}).then(function(){r({result:!0,text:"file "+t+" written"})}).fail(a)})},t.createDir=function(t){var n=this,e=this._db,i=this._server;return r(function(r,o){i.then(function(){return n._isFolder(t)}).then(function(i){if(i)return"OK";var r={name:n._normalize(n._path+t+"/"),parentFolder:n._path};return e.table("folders").addRows([r])}).then(function(){r({result:!0,text:"folder "+t+" created"})}).fail(o)})},t.findPath=function(t){"/"==t.charAt(0)&&(t=t.substring(0));var n=t.trim().split("/"),e=this;return r(function(t){if(!n[0])return void t(e);var i,r;n.forEach(function(n){if(n&&0!=n.trim().length){if(!e)return void t(!1);i?i=i.then(function(t){return r=t,t?t.isFolder(n):!1}):(r=e,i=e.isFolder(n)),i=i.then(function(t){return t?r.getFolder(n):!1})}}),i.then(t)})},t.fromData=function(t){var n=this,e=(this._db,this._server);return r(function(i,o){var a=[],s=r();e.then(function(){for(var e in t){if(e.indexOf("..")>=0)return void o(".. symbol is not allowed in the file or path names");var c=e;n.isObject(t[c])?!function(){var e=r();a.push(e),n.createDir(c).then(function(){var e=n.getSubFolderObj(c);return e.fromData(t[c])}).then(function(){e.resolve()}).fail(function(){e.resolve()})}():"string"==typeof t[c]&&a.push(n.writeFile(c,t[c]))}s.all(a).then(function(){i(!0)}).fail(o),s.resolve(!0)})})},t.getFolder=function(t){return this.getSubFolderObj(t)},t.getSubFolderObj=function(t){var n=this._normalize(this._path+t+"/");return tn(this._server,n)},t.getTree=function(){var t=this.toData({getData:!1});return t},t.id=function(){return this._id},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._server=t,this._path=n,this._id=this.guid(),this._db=t.getDb()}),t.isFile=function(t){var n=this;return r(function(e){e(n._isFile(t))})},t.isFolder=function(t){var n=this;return r(function(e){e(n._isFolder(t))})},t.linesToJsonArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t.listFiles=function(){var t=this,n=(this._db,this._server);return r(function(e,i){n.then(function(){t._loadFiles().then(function(t){var n=[];t.forEach(function(t){n.push(t.name)}),e(n)})}).fail(i)})},t.listFolders=function(){var t=this,n=(this._db,this._server);return r(function(e,i){n.then(function(){t._loadFolders().then(function(t){var n=[];t.forEach(function(t){n.push(t.name)}),e(n)})}).fail(i)})},t.readFile=function(t){var n=this,e=this._db,i=this._server;return r(function(r,o){i.then(function(){return n._isFile(t)}).then(function(t){if(t)return"OK";throw"The file does not exist"}).then(function(){return e.table("fileWrites").getAll({filePath:n._filePath(t)})}).then(function(t){var n="";t.forEach(function(t){n+=t.data}),r(n)}).fail(o)})},t.removeFile=function(t){var n=this,e=this._db,i=this._server;
return r(function(r,o){var a=!1;i.then(function(){return n._isFile(t)}).then(function(i){return a=i,i?e.table("fileWrites").remove({filePath:n._filePath(t)}):"OK"}).then(function(){return a?e.table("files")._cursorAction("readwrite",{folderName:n._path},function(e){var i=e.value;i.name==t&&(e.delete(),n._removeFileFromCache(t))}):"OK"}).then(function(){r({result:!0,text:"file "+t+" removed"})}).fail(o)})},t.toData=function(t){var n=this,t=t||{},e=t.fileFilter,i=t.dirFilter;return"undefined"==typeof t.getData&&(t.getData=!0),r(function(o){var a={};n.listFiles().then(function(i){var o=i.length,s=0,c=r();return i.forEach(function(i){return e&&!e(i)?(s++,void(s==o&&c.resolve(!0))):void(t.getData?n.readFile(i).then(function(t){a[i]=t,s++,s==o&&c.resolve(!0)}):(a[i]=!0,s++,s==o&&c.resolve(!0)))}),0==o&&c.resolve(!0),c}).then(function(){return n.listFolders()}).then(function(t){var o=t.length,s=0,c=r();return t.forEach(function(t){if(i&&!i(t))return s++,void(s==o&&c.resolve(!0));var r=n._lastPath(t),u=n.getSubFolderObj(r);u.toData(e,i).then(function(t){a[r]=t,s++,s==o&&c.resolve(!0)})}),0==o&&c.resolve(!0),c}).then(function(){o(a)}).fail(function(){o({})})})},t.writeFile=function(t,n){var e=this,i=this._db,o=this._server;return r(function(r,a){return"string"!=typeof n?void a({result:!1,text:"Only string writes are accepted"}):void o.then(function(){return e._isFile(t)}).then(function(n){return n?"OK":i.table("files").addRows([{name:t,folderName:e._path}])}).then(function(){return i.table("fileWrites").remove({filePath:e._filePath(t)})}).then(function(){return i.table("fileWrites").addRows([{filePath:e._filePath(t),data:n}])}).then(function(){r({result:!0,text:"file "+t+" written"})}).fail(a)})}}(this)},tn=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof tn))return new tn(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=tn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};tn._classInfo={name:"indexedDBFsFolder"},tn.prototype=new $,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.indexedDBFsFolder=tn,this.indexedDBFsFolder=tn):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.indexedDBFsFolder=tn:this.indexedDBFsFolder=tn}.call(new Function("return this")());var nn=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){return n||(n={}),n[t]?n[t]:void(n[t]=this)}),t.createFrom=function(){},t.getDb=function(){return this._db},t.getID=function(){return this._id||(this._id=this.guid()),this._id},t.getRootFolder=function(){return tn(this,"/")},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){var e=this;this._serverName=t,this._dbName="vserver://"+t,this._db=q(this._dbName,{tables:{folders:{createOptions:{keyPath:"name"},indexes:{parentFolder:{unique:!1}}},files:{createOptions:{autoIncrement:!0},indexes:{folderName:{unique:!1}}},fileWrites:{createOptions:{autoIncrement:!0},indexes:{filePath:{unique:!1}}}}}),this._db.then(function(){e._db.table("folders").count().then(function(t){t>=1?n?e.getRootFolder()._initFromData(n).then(function(){e.resolve(!0)}):e.resolve(!0):e._db.table("folders").addRows([{name:"/"}]).then(function(){n?e.getRootFolder()._initFromData(n).then(function(){e.resolve(!0)}):e.resolve(!0)})})})})}(this)},en=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof en))return new en(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=en._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};nn.prototype=r.prototype,en._classInfo={name:"fsServerIndexedDB"},en.prototype=new nn,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.fsServerIndexedDB=en,this.fsServerIndexedDB=en):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.fsServerIndexedDB=en:this.fsServerIndexedDB=en}.call(new Function("return this")());var rn=function(){!function(t){var n;t._initServers=function(){n||(n={})},t.getRootFolder=function(){var t=this._fsRoot;if(!t||t.length<15||t.indexOf("..")>=0)throw"Invalid root folder";var n=this;return Z(n._fsRoot)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(!t||t.length<15||t.indexOf("..")>=0)throw"Invalid root folder";this._fsRoot=t;var e=this;n?this.getRootFolder().fromData(n).then(function(){e.resolve(!0)}):this.resolve(!0)})}(this)},on=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof on))return new on(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=on._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};rn.prototype=r.prototype,on._classInfo={name:"fsServerNode"},on.prototype=new rn,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t.fsServerNode=on,this.fsServerNode=on):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports.fsServerNode=on:this.fsServerNode=on}.call(new Function("return this")());var an=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},sn=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof sn))return new sn(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=sn._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};sn._classInfo={name:"localFs"},sn.prototype=new an;var cn=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},un=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof un))return new un(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=un._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};un._classInfo={name:"moshModule"},un.prototype=new cn,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());